<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ†Ô∏è DirectOS v10.1 - Pipeline Builder Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* UI Utilities */
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .flow-line { background: linear-gradient(90deg, #334155 0%, #3b82f6 50%, #334155 100%); background-size: 200% 100%; animation: flowAnimation 2s infinite linear; }
        @keyframes flowAnimation { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .tool-checkbox:checked + div { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); }
        .tool-checkbox:checked + div .check-icon { opacity: 1; }

        /* ARQUITECTO VISUAL STYLES */
        .draggable-tool { cursor: grab; user-select: none; transition: all 0.2s; }
        .draggable-tool:active { cursor: grabbing; transform: scale(0.98); }
        
        /* Colores de Categor√≠a */
        .cat-frontend { border-left-color: #f97316; } 
        .cat-backend { border-left-color: #22c55e; }  
        .cat-ai { border-left-color: #a855f7; }       
        .cat-storage { border-left-color: #eab308; }  
        .cat-process { border-left-color: #ec4899; }  

        .flow-arrow::after { content: '‚¨á'; display: block; text-align: center; color: #64748b; font-size: 1.2rem; margin: 0.5rem 0; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-5px);} 60% {transform: translateY(-3px);} }
        .flow-node:last-child .flow-arrow::after { display: none; }

        .interactive-node { cursor: pointer; transition: all 0.3s ease; }
        .interactive-node:hover { transform: scale(1.03); box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); border-color: #60a5fa; }

        /* MONITOR STYLES */
        .terminal-line { font-family: 'Courier New', monospace; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; }
        .status-online { background-color: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .status-offline { background-color: #ef4444; box-shadow: 0 0 10px #ef4444; }

        /* ESTADOS DE MAESTR√çA */
        .status-badge { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 9999px; text-transform: uppercase; letter-spacing: 0.05em; }
        .status-used { background-color: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
        .status-learning { background-color: rgba(234, 179, 8, 0.2); color: #eab308; border: 1px solid rgba(234, 179, 8, 0.3); }
        .status-new { background-color: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }

        /* Categor√≠a DevOps */
        .cat-devops { border-left-color: #f97316; }
        .cat-trigger { border-left-color: #10b981; background: linear-gradient(90deg, rgba(16,185,129,0.1) 0%, transparent 100%); }
        /* Categor√≠a Output */
        .cat-output { border-left-color: #f97316; background: linear-gradient(90deg, rgba(249,115,22,0.1) 0%, transparent 100%); }
        /* Categor√≠a Flow (Control) */
        .cat-flow { border-left-color: #a855f7; background: linear-gradient(90deg, rgba(168,85,247,0.1) 0%, transparent 100%); }

        /* HITL indicator on nodes */
        .has-hitl { box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.4); }
        .has-hitl::after {
            content: '';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: #22d3ee;
            border-radius: 50%;
            animation: pulse-hitl 2s infinite;
        }
        @keyframes pulse-hitl {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* ============================================
           PIPELINE BUILDER PRO - Canvas Styles
           ============================================ */

        /* Grid de fondo del canvas */
        .canvas-grid {
            background-image:
                linear-gradient(rgba(71, 85, 105, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(71, 85, 105, 0.3) 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: -1px -1px;
        }

        /* Canvas transformable (zoom + pan) */
        .canvas-transform {
            transform-origin: 0 0;
            transition: transform 0.1s ease-out;
        }

        /* Nodo draggable */
        .pipeline-node-pro {
            position: absolute;
            cursor: grab;
            user-select: none;
            transition: box-shadow 0.2s, transform 0.1s;
        }
        .pipeline-node-pro:active {
            cursor: grabbing;
        }
        .pipeline-node-pro.dragging {
            z-index: 1000 !important;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            transform: scale(1.02);
        }
        .pipeline-node-pro.selected {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        /* Puertos de conexi√≥n */
        .node-port {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #1e293b;
            cursor: crosshair;
            transition: transform 0.15s, box-shadow 0.15s;
            z-index: 10;
        }
        .node-port:hover {
            transform: scale(1.3);
            box-shadow: 0 0 10px currentColor;
        }
        .node-port.port-in {
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
            background: #22c55e;
        }
        .node-port.port-out {
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            background: #3b82f6;
        }
        .node-port.port-in:hover { transform: translateY(-50%) scale(1.3); }
        .node-port.port-out:hover { transform: translateY(-50%) scale(1.3); }
        .node-port.connecting {
            background: #eab308 !important;
            animation: pulse-port 0.5s infinite;
        }

        @keyframes pulse-port {
            0%, 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); }
            50% { box-shadow: 0 0 0 6px rgba(234, 179, 8, 0); }
        }

        /* L√≠nea temporal de conexi√≥n */
        .connection-line-temp {
            stroke: #eab308;
            stroke-width: 2;
            stroke-dasharray: 5, 5;
            fill: none;
            pointer-events: none;
        }

        /* Conexiones establecidas */
        .connection-line {
            stroke: #3b82f6;
            stroke-width: 2;
            fill: none;
            transition: stroke 0.2s;
        }
        .connection-line:hover {
            stroke: #ef4444;
            cursor: pointer;
        }

        /* Minimap */
        .canvas-minimap {
            position: absolute;
            bottom: 100px;
            right: 16px;
            width: 150px;
            height: 100px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid #334155;
            border-radius: 8px;
            overflow: hidden;
            z-index: 25;
        }
        .minimap-viewport {
            position: absolute;
            border: 1px solid #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            pointer-events: none;
        }

        /* Line clamp para tarjetas de flujo */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Flow cards hover effects */
        .flow-card {
            transition: all 0.3s ease;
        }

        /* Drag & Drop Workflow */
        .pb-workflow-step {
            transition: all 0.2s ease;
            border-radius: 0.375rem;
            padding: 0.25rem;
        }
        .pb-workflow-step:hover {
            background: rgba(30, 41, 59, 0.5);
        }
        .pb-workflow-step.dragging {
            opacity: 0.4;
        }
        .pb-workflow-step.drag-over {
            border-top: 2px solid #22c55e;
        }
        .drag-handle {
            cursor: grab;
        }
        .drag-handle:active {
            cursor: grabbing;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .toast-success { background: #166534; color: #bbf7d0; border: 1px solid #22c55e; }
        .toast-error { background: #991b1b; color: #fecaca; border: 1px solid #ef4444; }
        .toast-info { background: #1e40af; color: #bfdbfe; border: 1px solid #3b82f6; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 h-screen flex overflow-hidden selection:bg-blue-500 selection:text-white">

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- SIDEBAR -->
    <aside class="w-64 bg-slate-900 border-r border-slate-800 flex-shrink-0 flex flex-col transition-all duration-300">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-xl font-bold text-white tracking-tight flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-blue-500"></i>
                Director<span class="text-slate-500">OS</span>
            </h1>
            <p class="text-xs text-slate-500 mt-1">v10.1 - Pipeline Builder Pro</p>
        </div>
        
        <nav class="flex-1 overflow-y-auto p-4 space-y-2">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 pl-2">Dise√±o</p>
            <button onclick="switchView('architect')" id="btn-architect" class="w-full text-left px-3 py-2.5 rounded-lg text-sm transition font-medium flex items-center gap-3 bg-blue-600 text-white shadow-lg shadow-blue-900/20"><i class="fa-solid fa-diagram-project"></i> Pipeline Builder</button>
            <button onclick="switchView('flow')" id="btn-flow" class="w-full text-left px-3 py-2.5 rounded-lg hover:bg-slate-800 text-slate-400 text-sm transition font-medium flex items-center gap-3"><i class="fa-solid fa-store"></i> Recetas</button>
            <button onclick="switchView('generator')" id="btn-generator" class="w-full text-left px-3 py-2.5 rounded-lg hover:bg-slate-800 text-slate-400 text-sm transition font-medium flex items-center gap-3"><i class="fa-solid fa-wand-magic-sparkles"></i> Patrones</button>
            <button onclick="switchView('prompt-builder')" id="btn-prompt-builder" class="w-full text-left px-3 py-2.5 rounded-lg hover:bg-slate-800 text-slate-400 text-sm transition font-medium flex items-center gap-3"><i class="fa-solid fa-hammer"></i> Prompt Builder <span class="text-[9px] bg-green-500/20 text-green-400 px-1.5 py-0.5 rounded">PRO</span></button>
            
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 pl-2 mt-6">Operaciones</p>
            <button onclick="switchView('agent')" id="btn-agent" class="w-full text-left px-3 py-2.5 rounded-lg hover:bg-slate-800 text-slate-400 text-sm transition font-medium flex items-center gap-3"><i class="fa-solid fa-bolt"></i> Automatizaciones <span id="agent-status-dot" class="w-2 h-2 rounded-full bg-slate-600"></span></button>
            <button onclick="switchView('monitor')" id="btn-monitor" class="w-full text-left px-3 py-2.5 rounded-lg hover:bg-slate-800 text-slate-400 text-sm transition font-medium flex items-center gap-3"><i class="fa-solid fa-heart-pulse"></i> Monitor Sistema</button>
            <button onclick="switchView('grid')" id="btn-grid" class="w-full text-left px-3 py-2.5 rounded-lg hover:bg-slate-800 text-slate-400 text-sm transition font-medium flex items-center gap-3"><i class="fa-solid fa-boxes-stacked"></i> Glosario</button>
            <button onclick="switchView('projects')" id="btn-projects" class="w-full text-left px-3 py-2.5 rounded-lg hover:bg-slate-800 text-slate-400 text-sm transition font-medium flex items-center gap-3"><i class="fa-solid fa-folder-open"></i> Proyectos</button>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col min-w-0 relative bg-slate-950">
        
        <!-- Header -->
        <header class="bg-slate-900/50 backdrop-blur border-b border-slate-800 p-4 h-16 flex justify-between items-center sticky top-0 z-20">
            <div class="flex items-center gap-4">
                <h2 id="page-title" class="text-lg font-semibold text-white">Arquitecto Pro</h2>
                <!-- Dynamic Header Content -->
                <div id="header-tools" class="hidden flex gap-2">
                    <button onclick="importFromCodeModal()" class="bg-blue-600 hover:bg-blue-500 text-xs px-3 py-1.5 rounded border border-blue-500 transition flex items-center gap-2" title="Importar desde c√≥digo"><i class="fa-solid fa-file-import"></i> Importar</button>
                    <button onclick="saveArchitecture()" class="bg-slate-800 hover:bg-slate-700 text-xs px-3 py-1.5 rounded border border-slate-700 transition flex items-center gap-2" title="Guardar"><i class="fa-solid fa-floppy-disk"></i> Guardar</button>
                    <button onclick="loadArchitectureModal()" class="bg-slate-800 hover:bg-slate-700 text-xs px-3 py-1.5 rounded border border-slate-700 transition flex items-center gap-2" title="Cargar"><i class="fa-solid fa-folder-open"></i> Cargar</button>
                    <button onclick="exportDiagram()" class="bg-slate-800 hover:bg-slate-700 text-xs px-3 py-1.5 rounded border border-slate-700 transition flex items-center gap-2" title="Exportar"><i class="fa-solid fa-camera"></i> PNG</button>
                </div>
            </div>
            <div class="flex gap-3 items-center">
                <span id="sync-status" class="text-xs font-medium px-2 py-1 rounded bg-slate-700 text-slate-400 border border-slate-600">
                    <i class="fa-solid fa-circle-notch fa-spin mr-1"></i> Checking...
                </span>
                <span class="text-xs font-mono text-slate-500 bg-slate-900 px-2 py-1 rounded border border-slate-800" id="clock">00:00</span>
            </div>
        </header>

        <!-- VISTA 0: PIPELINE BUILDER PRO -->
        <div id="view-architect" class="flex-1 overflow-hidden flex relative">
            <!-- Sidebar Herramientas -->
            <div class="w-64 bg-slate-900 border-r border-slate-800 p-4 overflow-y-auto flex-shrink-0">
                <div class="mb-6">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Patrones</h3>
                    <select id="preset-selector" onchange="loadPreset(this.value)" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-sm text-slate-300 mb-2">
                        <option value="">-- Seleccionar patr√≥n --</option>
                    </select>
                    <div id="preset-info" class="hidden bg-slate-950/50 border border-slate-800 rounded-lg p-3 text-xs">
                        <p id="preset-desc" class="text-slate-400 mb-2"></p>
                        <p id="preset-flow" class="text-blue-400 font-mono text-[10px]"></p>
                        <p id="preset-usecase" class="text-slate-500 mt-2 italic"></p>
                    </div>
                </div>
                <div class="border-t border-slate-800 pt-4">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Herramientas</h3>
                    <div id="architect-toolbox" class="space-y-3 max-h-[60vh] overflow-y-auto"></div>
                </div>
            </div>

            <!-- Canvas Principal -->
            <div class="flex-1 bg-slate-950 overflow-hidden relative bg-[radial-gradient(#1e293b_1px,transparent_1px)] [background-size:20px_20px]">
                <!-- Barra Superior -->
                <div class="absolute top-4 left-4 right-4 z-20 flex justify-between items-center bg-slate-900/95 backdrop-blur p-3 rounded-xl border border-slate-800 shadow-lg">
                    <div class="flex gap-4 text-[10px] uppercase font-bold tracking-wider text-slate-500">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> Trigger</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-500"></span> Front</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> Back</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-purple-500"></span> IA</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> DB</span>
                    </div>
                    <div class="flex gap-2">
                        <button id="btn-undo" onclick="canvasUndo()" class="text-xs px-2.5 py-1.5 rounded-lg hover:bg-slate-700 text-slate-500 hover:text-slate-300 transition border border-slate-700 disabled:opacity-30 disabled:cursor-not-allowed" title="Deshacer (Ctrl+Z)" disabled><i class="fa-solid fa-rotate-left"></i></button>
                        <button id="btn-redo" onclick="canvasRedo()" class="text-xs px-2.5 py-1.5 rounded-lg hover:bg-slate-700 text-slate-500 hover:text-slate-300 transition border border-slate-700 disabled:opacity-30 disabled:cursor-not-allowed" title="Rehacer (Ctrl+Shift+Z)" disabled><i class="fa-solid fa-rotate-right"></i></button>
                        <div class="w-px bg-slate-700 mx-1"></div>
                        <!-- Controles de Zoom -->
                        <button onclick="canvasZoomOut()" class="text-xs px-2 py-1.5 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-slate-200 transition border border-slate-700" title="Alejar (-)"><i class="fa-solid fa-minus"></i></button>
                        <span id="zoom-level" class="text-xs text-slate-500 px-2 py-1.5 min-w-[50px] text-center">100%</span>
                        <button onclick="canvasZoomIn()" class="text-xs px-2 py-1.5 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-slate-200 transition border border-slate-700" title="Acercar (+)"><i class="fa-solid fa-plus"></i></button>
                        <button onclick="canvasZoomReset()" class="text-xs px-2 py-1.5 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-slate-200 transition border border-slate-700" title="Reset zoom"><i class="fa-solid fa-expand"></i></button>
                        <div class="w-px bg-slate-700 mx-1"></div>
                        <button onclick="autoLayoutNodes()" class="text-xs px-3 py-1.5 rounded-lg hover:bg-slate-700 text-slate-300 transition flex items-center gap-1.5 border border-slate-700" title="Organizar nodos"><i class="fa-solid fa-wand-magic-sparkles text-purple-400"></i> Auto</button>
                        <button onclick="validateFlowRealtime()" class="text-xs px-3 py-1.5 rounded-lg hover:bg-slate-700 text-slate-300 transition flex items-center gap-1.5 border border-slate-700"><i class="fa-solid fa-check-circle text-green-400"></i> Validar</button>
                        <button onclick="exportPipelineJSON()" class="text-xs px-3 py-1.5 rounded-lg hover:bg-slate-700 text-slate-300 transition flex items-center gap-1.5 border border-slate-700" title="Exportar JSON (Ctrl+E)"><i class="fa-solid fa-file-export text-blue-400"></i></button>
                        <button onclick="clearCanvas()" class="text-xs px-3 py-1.5 rounded-lg hover:bg-red-600/20 text-slate-300 hover:text-red-400 transition flex items-center gap-1.5 border border-slate-700 hover:border-red-500/50"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>

                <!-- Canvas SVG + Nodos (Pipeline Builder Pro) -->
                <div id="pipeline-canvas" class="absolute inset-0 pt-20 pb-28 overflow-hidden bg-slate-950">
                    <!-- Capa de Grid -->
                    <div id="canvas-grid" class="absolute inset-0 canvas-grid" style="width: 3000px; height: 2000px;"></div>

                    <!-- Capa transformable (zoom + pan) -->
                    <div id="canvas-transform" class="canvas-transform absolute" style="width: 3000px; height: 2000px;">
                        <!-- SVG para conexiones -->
                        <svg id="connections-svg" class="absolute top-0 left-0" style="width: 100%; height: 100%; z-index: 5; pointer-events: none;">
                            <defs>
                                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
                                </marker>
                                <marker id="arrowhead-hover" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#ef4444"/>
                                </marker>
                            </defs>
                            <!-- L√≠nea temporal mientras se conecta -->
                            <path id="temp-connection" class="connection-line-temp" d="" style="display: none;"/>
                        </svg>

                        <!-- Contenedor de nodos -->
                        <div id="nodes-container" class="relative" style="width: 100%; height: 100%;">
                            <div id="canvas-placeholder" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 border-2 border-dashed border-slate-800 rounded-2xl flex flex-col items-center justify-center text-slate-600 p-12">
                                <i class="fa-solid fa-diagram-project text-4xl mb-3 text-slate-700"></i>
                                <p class="text-sm font-medium">Arrastra herramientas aqu√≠</p>
                                <p class="text-xs mt-1 text-slate-700">Scroll para zoom ‚Ä¢ Arrastra para mover</p>
                            </div>
                        </div>
                    </div>

                    <!-- Minimap -->
                    <div id="canvas-minimap" class="canvas-minimap hidden">
                        <div id="minimap-nodes"></div>
                        <div id="minimap-viewport" class="minimap-viewport"></div>
                    </div>
                </div>

                <!-- Panel de Validaci√≥n Flotante -->
                <div id="validation-panel" class="hidden absolute top-20 right-4 w-80 bg-slate-900/95 backdrop-blur border border-slate-700 rounded-xl shadow-2xl z-30 overflow-hidden">
                    <div class="p-3 border-b border-slate-800 flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                            <i class="fa-solid fa-clipboard-check text-blue-400"></i> Validaci√≥n
                        </span>
                        <button onclick="document.getElementById('validation-panel').classList.add('hidden')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
                    </div>
                    <div id="validation-messages" class="p-3 space-y-2 max-h-64 overflow-y-auto"></div>
                </div>

                <!-- Panel de Configuraci√≥n de Nodo -->
                <div id="node-config-panel" class="hidden absolute top-20 right-4 w-96 bg-slate-900/98 backdrop-blur border border-slate-700 rounded-xl shadow-2xl z-40 overflow-hidden max-h-[calc(100vh-200px)]">
                    <div class="p-3 border-b border-slate-800 flex justify-between items-center bg-slate-800/50">
                        <div class="flex items-center gap-2">
                            <div id="config-node-icon" class="w-8 h-8 rounded-lg bg-slate-900 flex items-center justify-center border border-slate-700">
                                <i class="fa-solid fa-gear text-slate-400"></i>
                            </div>
                            <div>
                                <h3 id="config-node-name" class="font-bold text-white text-sm">Nodo</h3>
                                <span id="config-node-tag" class="text-[10px] text-slate-500 uppercase tracking-wider">Categor√≠a</span>
                            </div>
                        </div>
                        <button onclick="hideNodeConfig()" class="text-slate-500 hover:text-white p-1"><i class="fa-solid fa-times"></i></button>
                    </div>

                    <div class="overflow-y-auto max-h-[400px]">
                        <!-- Descripci√≥n -->
                        <div class="p-3 border-b border-slate-800">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider block mb-1">Descripci√≥n</label>
                            <p id="config-node-desc" class="text-xs text-slate-400 leading-relaxed"></p>
                        </div>

                        <!-- Par√°metros del Nodo -->
                        <div class="p-3 border-b border-slate-800">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider block mb-2">Par√°metros</label>
                            <div id="config-node-params" class="space-y-2">
                                <!-- Los par√°metros se generan din√°micamente -->
                            </div>
                        </div>

                        <!-- C√≥digo de Ejemplo -->
                        <div class="p-3 border-b border-slate-800">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">C√≥digo</label>
                                <button onclick="copyNodeCode()" class="text-[10px] text-blue-400 hover:text-blue-300 flex items-center gap-1">
                                    <i class="fa-solid fa-copy"></i> Copiar
                                </button>
                            </div>
                            <pre id="config-node-code" class="bg-slate-950 border border-slate-800 rounded-lg p-2 text-[10px] text-green-400 font-mono overflow-x-auto max-h-32"></pre>
                        </div>

                        <!-- Conexiones -->
                        <div class="p-3 border-b border-slate-800">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider block mb-2">Conexiones</label>
                            <div class="flex gap-4 text-xs">
                                <div>
                                    <span class="text-slate-500">Entradas:</span>
                                    <span id="config-node-inputs" class="text-green-400 ml-1">0</span>
                                </div>
                                <div>
                                    <span class="text-slate-500">Salidas:</span>
                                    <span id="config-node-outputs" class="text-blue-400 ml-1">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Acciones -->
                    <div class="p-3 bg-slate-800/30 flex gap-2">
                        <button onclick="duplicateSelectedNode()" class="flex-1 py-2 px-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs font-medium transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-clone"></i> Duplicar
                        </button>
                        <button onclick="deleteSelectedNode()" class="flex-1 py-2 px-3 rounded-lg bg-red-500/20 hover:bg-red-500/30 text-red-400 text-xs font-medium transition flex items-center justify-center gap-2 border border-red-500/30">
                            <i class="fa-solid fa-trash"></i> Eliminar
                        </button>
                    </div>
                </div>

                <!-- Barra Inferior -->
                <div class="absolute bottom-4 left-4 right-4 z-20">
                    <div class="bg-slate-900/95 backdrop-blur border border-slate-700 p-4 rounded-xl shadow-2xl flex gap-4 items-center justify-between">
                        <div class="flex items-center gap-6">
                            <div class="text-sm">
                                <span id="node-count" class="font-bold text-white text-lg">0</span>
                                <span class="text-slate-500 text-xs ml-1">nodos</span>
                            </div>
                            <div class="text-sm">
                                <span id="connection-count" class="font-bold text-blue-400 text-lg">0</span>
                                <span class="text-slate-500 text-xs ml-1">conexiones</span>
                            </div>
                            <div id="flow-status" class="hidden"></div>
                        </div>
                        <div class="flex gap-3">
                            <button id="dry-run-btn" onclick="dryRunPipeline()" class="bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white font-bold py-2.5 px-5 rounded-lg shadow-lg flex items-center gap-2 transition text-sm">
                                <i class="fa-solid fa-flask"></i> Simular
                            </button>
                            <button id="run-pipeline-btn" onclick="runPipelineFromBuilder()" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold py-2.5 px-5 rounded-lg shadow-lg flex items-center gap-2 transition text-sm">
                                <i class="fa-solid fa-play"></i> Ejecutar
                            </button>
                            <button onclick="generateScaffold()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2.5 px-5 rounded-lg shadow-lg flex items-center gap-2 transition text-sm">
                                <i class="fa-solid fa-folder-plus"></i> Crear Proyecto
                            </button>
                            <button onclick="compileArchitecture()" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-2.5 px-5 rounded-lg shadow-lg flex items-center gap-2 transition text-sm">
                                <i class="fa-solid fa-code"></i> Generar C√≥digo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modales -->
        <div id="architect-output-modal" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-3xl shadow-2xl flex flex-col max-h-full">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center"><h3 class="font-bold text-white">Resultado</h3><button onclick="closeModal('architect-output-modal')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button></div>
                <div class="p-6 overflow-y-auto flex-1 bg-slate-950"><pre id="architect-prompt-output" class="font-mono text-xs text-slate-300 whitespace-pre-wrap leading-relaxed"></pre></div>
                <div class="p-4 border-t border-slate-800 bg-slate-900 flex justify-end"><button onclick="copyArchitectPrompt()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-4 py-2 rounded-lg font-medium transition">Copiar</button></div>
            </div>
        </div>

        <div id="load-modal" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-96 shadow-2xl">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center"><h3 class="font-bold text-white">Cargar Arquitectura</h3><button onclick="closeModal('load-modal')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button></div>
                <div id="load-list" class="p-2 max-h-64 overflow-y-auto space-y-1"></div>
            </div>
        </div>

        <!-- Modal Importar desde C√≥digo -->
        <div id="import-modal" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-xl shadow-2xl">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <h3 class="font-bold text-white"><i class="fa-solid fa-file-import mr-2 text-blue-400"></i>Importar desde C√≥digo</h3>
                    <button onclick="closeModal('import-modal')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-4">
                    <p class="text-sm text-slate-400 mb-3">Pega c√≥digo Python y detectar√© autom√°ticamente las herramientas usadas.</p>
                    <textarea id="import-code" rows="12" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-sm font-mono text-slate-300 focus:border-blue-500 focus:outline-none" placeholder="# Pega tu c√≥digo Python aqu√≠...
from fastapi import FastAPI
from anthropic import Anthropic
import sqlite3
..."></textarea>
                    <div id="import-preview" class="hidden mt-3 p-3 bg-slate-800 rounded-lg">
                        <p class="text-xs text-slate-400 mb-2">Herramientas detectadas:</p>
                        <div id="import-detected" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-800 flex justify-between">
                    <button onclick="analyzeImports()" class="bg-slate-700 hover:bg-slate-600 text-sm px-4 py-2 rounded transition"><i class="fa-solid fa-search mr-2"></i>Analizar</button>
                    <button onclick="applyImportedArchitecture()" class="bg-blue-600 hover:bg-blue-500 text-sm px-4 py-2 rounded transition"><i class="fa-solid fa-check mr-2"></i>Aplicar al Canvas</button>
                </div>
            </div>
        </div>

        <!-- Modal Crear Proyecto -->
        <div id="scaffold-modal" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh]">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-folder-plus text-emerald-400 text-xl"></i>
                        <h3 class="font-bold text-white text-lg">Crear Proyecto</h3>
                    </div>
                    <button onclick="closeModal('scaffold-modal')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-6 overflow-y-auto flex-1 space-y-5">
                    <!-- Nombre del proyecto -->
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Nombre del Proyecto</label>
                        <input type="text" id="project-name" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-slate-200 placeholder-slate-600" placeholder="mi_proyecto_rag" value="">
                    </div>
                    <!-- Ruta -->
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Directorio Base</label>
                        <input type="text" id="project-path" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-slate-200 font-mono text-sm" value="~/Desktop">
                    </div>
                    <!-- Estructura Preview -->
                    <div class="bg-slate-950 border border-slate-800 rounded-xl p-4">
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-folder-tree text-amber-400"></i> Estructura a Crear
                        </h4>
                        <pre id="scaffold-preview" class="text-xs text-emerald-400 font-mono leading-relaxed"></pre>
                    </div>
                    <!-- Opciones -->
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="opt-git" checked class="w-4 h-4 rounded bg-slate-800 border-slate-600 text-blue-500">
                            <span class="text-sm text-slate-300">Inicializar Git</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="opt-venv" checked class="w-4 h-4 rounded bg-slate-800 border-slate-600 text-blue-500">
                            <span class="text-sm text-slate-300">Crear venv</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="opt-readme" checked class="w-4 h-4 rounded bg-slate-800 border-slate-600 text-blue-500">
                            <span class="text-sm text-slate-300">README.md</span>
                        </label>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-800 bg-slate-900 flex justify-between items-center">
                    <p class="text-xs text-slate-500"><i class="fa-solid fa-info-circle mr-1"></i> Se copiar√° el comando al portapapeles</p>
                    <div class="flex gap-2">
                        <button onclick="copyScaffoldCommand()" class="bg-slate-700 hover:bg-slate-600 text-white text-sm px-4 py-2 rounded-lg font-medium transition flex items-center gap-2">
                            <i class="fa-solid fa-copy"></i> Copiar Comando
                        </button>
                        <button onclick="downloadScaffoldScript()" class="bg-emerald-600 hover:bg-emerald-500 text-white text-sm px-4 py-2 rounded-lg font-medium transition flex items-center gap-2">
                            <i class="fa-solid fa-download"></i> Descargar Script
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Patr√≥n Detalle -->
        <div id="pattern-modal" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh]">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <span id="pattern-modal-emoji" class="text-2xl"></span>
                        <h3 id="pattern-modal-title" class="font-bold text-white text-lg"></h3>
                    </div>
                    <button onclick="closeModal('pattern-modal')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-6 overflow-y-auto flex-1 space-y-5">
                    <!-- Problema -->
                    <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-red-400 uppercase tracking-widest mb-2 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> Problema</h4>
                        <p id="pattern-modal-problem" class="text-sm text-slate-300"></p>
                    </div>
                    <!-- Prompt -->
                    <div class="bg-slate-950 border border-slate-800 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-2 flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> Prompt</h4>
                        <pre id="pattern-modal-prompt" class="text-sm text-slate-300 whitespace-pre-wrap font-mono leading-relaxed"></pre>
                    </div>
                    <!-- Flujo T√°ctico -->
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-purple-400 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-diagram-project"></i> Flujo T√°ctico</h4>
                        <p id="pattern-modal-flowdesc" class="text-xs text-slate-400 mb-3 font-mono"></p>
                        <div id="pattern-modal-flow" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-800 bg-slate-900 flex gap-3">
                    <button onclick="loadPatternToPrompt()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-sm px-4 py-2 rounded-lg font-medium transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-copy"></i> Usar Prompt
                    </button>
                    <button onclick="loadPatternToArchitect()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white text-sm px-4 py-2 rounded-lg font-medium transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-pen-ruler"></i> Abrir en Arquitecto
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Ficha T√©cnica (Tool Detail) -->
        <div id="tool-modal" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh]">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <i id="tool-modal-icon" class="fa-solid text-2xl"></i>
                        <div>
                            <h3 id="tool-modal-title" class="font-bold text-white text-lg"></h3>
                            <span id="tool-modal-tag" class="text-xs text-slate-500"></span>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="tool-modal-status" class="status-badge"></span>
                        <button onclick="closeModal('tool-modal')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
                    </div>
                </div>
                <div class="p-6 overflow-y-auto flex-1 space-y-5">
                    <!-- Qu√© es -->
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 flex items-center gap-2"><i class="fa-solid fa-circle-info text-blue-400"></i> Qu√© es</h4>
                        <p id="tool-modal-desc" class="text-sm text-slate-300 leading-relaxed"></p>
                    </div>
                    <!-- Por qu√© me importa -->
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-purple-400 uppercase tracking-widest mb-2 flex items-center gap-2"><i class="fa-solid fa-lightbulb"></i> Por qu√© me importa</h4>
                        <p id="tool-modal-why" class="text-sm text-slate-300 leading-relaxed"></p>
                    </div>
                    <!-- Casos de Uso -->
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 flex items-center gap-2"><i class="fa-solid fa-folder-open text-amber-400"></i> Casos de uso en minerOS</h4>
                        <div id="tool-modal-cases" class="flex flex-wrap gap-2"></div>
                    </div>
                    <!-- C√≥digo -->
                    <div class="bg-slate-950 border border-slate-800 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-green-400 uppercase tracking-widest mb-2 flex items-center gap-2"><i class="fa-solid fa-code"></i> Snippet de c√≥digo</h4>
                        <pre id="tool-modal-code" class="text-xs text-green-400 font-mono whitespace-pre-wrap overflow-x-auto"></pre>
                    </div>
                </div>
                <!-- Cambiar estado -->
                <div class="p-4 border-t border-slate-800 bg-slate-900/50">
                    <p class="text-xs text-slate-500 mb-2">Cambiar estado:</p>
                    <div class="flex gap-2">
                        <button onclick="changeToolStatus(currentTool.id, 'new')" class="flex-1 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 text-xs py-2 rounded-lg font-medium transition border border-blue-500/30">
                            üÜï Por descubrir
                        </button>
                        <button onclick="changeToolStatus(currentTool.id, 'learning')" class="flex-1 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 text-xs py-2 rounded-lg font-medium transition border border-yellow-500/30">
                            üöß En progreso
                        </button>
                        <button onclick="changeToolStatus(currentTool.id, 'used')" class="flex-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 text-xs py-2 rounded-lg font-medium transition border border-green-500/30">
                            ‚úÖ Dominada
                        </button>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-800 bg-slate-900 flex gap-3">
                    <button onclick="addToolToArchitect()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-sm px-4 py-2 rounded-lg font-medium transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> A√±adir al Arquitecto
                    </button>
                    <button onclick="copyToolCode()" class="bg-slate-700 hover:bg-slate-600 text-white text-sm px-4 py-2 rounded-lg font-medium transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-copy"></i> Copiar c√≥digo
                    </button>
                </div>
            </div>
        </div>

        <!-- VISTA 1: MONITOR -->
        <div id="view-monitor" class="hidden flex-1 overflow-y-auto p-8 bg-slate-950 relative">
            <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 space-y-6">
                    <!-- Health Check -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-heart-pulse text-6xl text-blue-500"></i></div>
                        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Salud Backend</h3>
                        <div class="flex items-end gap-3 mb-2"><span id="health-metric" class="text-4xl font-bold text-white">--</span><span class="text-sm text-slate-500 mb-1">ms</span></div>
                        <p id="health-msg" class="text-xs text-slate-500">Conectando...</p>
                        <div class="mt-4 h-1 w-full bg-slate-800 rounded-full overflow-hidden"><div id="health-bar" class="h-full bg-blue-500 w-0 transition-all duration-500"></div></div>
                    </div>
                    <!-- Scout Panel -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-6">
                        <div class="flex items-center gap-2 mb-4">
                            <i class="fa-solid fa-robot text-purple-400"></i>
                            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest">Scout</h3>
                            <span class="text-[10px] bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded-full">IA</span>
                        </div>
                        <p class="text-xs text-slate-500 mb-3">Pega un error y Scout te sugerir√° la soluci√≥n</p>
                        <textarea id="scout-input" rows="4" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-xs font-mono text-slate-300 placeholder-slate-600" placeholder="TypeError: 'NoneType' object..."></textarea>
                        <button onclick="analyzeWithScout()" id="scout-btn" class="mt-3 w-full bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold py-2 rounded-lg transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-magnifying-glass-chart"></i> Analizar Error
                        </button>
                    </div>
                </div>
                <div class="lg:col-span-2 flex flex-col h-[600px]">
                    <div class="bg-slate-950 border border-slate-800 rounded-t-xl p-3 flex justify-between items-center bg-slate-900/50">
                        <div class="flex gap-2"><div id="term-dot" class="w-3 h-3 rounded-full bg-red-500/20"></div><div class="w-3 h-3 rounded-full bg-yellow-500/20"></div><div class="w-3 h-3 rounded-full bg-green-500/20"></div></div><span class="text-xs font-mono text-slate-500">directos.log</span>
                    </div>
                    <div id="terminal-window" class="flex-1 bg-black/80 border-x border-b border-slate-800 rounded-b-xl p-4 font-mono text-xs overflow-y-auto space-y-1 shadow-inner"></div>
                </div>
            </div>
        </div>

        <!-- VISTA 2: FLUJOS T√ÅCTICOS - APP STORE -->
        <div id="view-flow" class="hidden flex-1 overflow-y-auto p-6 bg-slate-950 relative">
            <div class="max-w-7xl mx-auto">
                <!-- Header -->
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-white mb-2">Recetas de Arquitectura</h2>
                    <p class="text-slate-400">Selecciona un flujo y cl√≥nalo directamente al Arquitecto Pro.</p>
                </div>

                <!-- Filtros por Categor√≠a -->
                <div class="flex flex-wrap justify-center gap-2 mb-8">
                    <button onclick="filterFlows('all')" id="flow-filter-all" class="flow-filter-btn bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <i class="fa-solid fa-grid-2"></i> Todos
                        <span class="bg-white/20 px-1.5 py-0.5 rounded text-[10px]" id="flow-count-all">12</span>
                    </button>
                    <button onclick="filterFlows('knowledge')" id="flow-filter-knowledge" class="flow-filter-btn bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 border border-slate-700">
                        <i class="fa-solid fa-brain text-purple-400"></i> Conocimiento
                        <span class="bg-slate-700 px-1.5 py-0.5 rounded text-[10px]" id="flow-count-knowledge">3</span>
                    </button>
                    <button onclick="filterFlows('media')" id="flow-filter-media" class="flow-filter-btn bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 border border-slate-700">
                        <i class="fa-solid fa-photo-film text-pink-400"></i> Media
                        <span class="bg-slate-700 px-1.5 py-0.5 rounded text-[10px]" id="flow-count-media">3</span>
                    </button>
                    <button onclick="filterFlows('automation')" id="flow-filter-automation" class="flow-filter-btn bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 border border-slate-700">
                        <i class="fa-solid fa-robot text-amber-400"></i> Automatizaci√≥n
                        <span class="bg-slate-700 px-1.5 py-0.5 rounded text-[10px]" id="flow-count-automation">3</span>
                    </button>
                    <button onclick="filterFlows('devops')" id="flow-filter-devops" class="flow-filter-btn bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 border border-slate-700">
                        <i class="fa-solid fa-shield-halved text-green-400"></i> DevOps
                        <span class="bg-slate-700 px-1.5 py-0.5 rounded text-[10px]" id="flow-count-devops">3</span>
                    </button>
                </div>

                <!-- Grid de Flujos -->
                <div id="flows-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
                    <!-- Las tarjetas se generan din√°micamente -->
                </div>
            </div>
        </div>

        <!-- Modal Detalle de Flujo -->
        <div id="flow-detail-modal" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-3xl shadow-2xl flex flex-col max-h-[90vh]">
                <!-- Header -->
                <div class="p-5 border-b border-slate-800 flex justify-between items-start">
                    <div class="flex items-center gap-4">
                        <span id="flow-modal-emoji" class="text-4xl"></span>
                        <div>
                            <h3 id="flow-modal-title" class="font-bold text-white text-xl"></h3>
                            <div class="flex items-center gap-2 mt-1">
                                <span id="flow-modal-category" class="text-xs px-2 py-0.5 rounded border"></span>
                                <span id="flow-modal-complexity" class="text-xs px-2 py-0.5 rounded border"></span>
                                <span id="flow-modal-cost" class="text-xs px-2 py-0.5 rounded border"></span>
                            </div>
                        </div>
                    </div>
                    <button onclick="closeModal('flow-detail-modal')" class="text-slate-500 hover:text-white p-1">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Body -->
                <div class="p-6 overflow-y-auto flex-1 space-y-5">
                    <!-- Descripci√≥n -->
                    <div>
                        <p id="flow-modal-desc" class="text-slate-300 leading-relaxed"></p>
                    </div>

                    <!-- Caso de uso -->
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-lightbulb"></i> Caso de Uso
                        </h4>
                        <p id="flow-modal-usecase" class="text-sm text-slate-300"></p>
                    </div>

                    <!-- Flujo de Datos -->
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-purple-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-diagram-project"></i> Flujo de Datos
                        </h4>
                        <p id="flow-modal-flowdesc" class="text-sm text-slate-300 font-mono mb-4"></p>
                        <!-- Stack visual -->
                        <div id="flow-modal-stack" class="flex flex-wrap gap-2"></div>
                    </div>

                    <!-- Prompt T√°ctico -->
                    <div class="bg-slate-950 border border-slate-800 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-green-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-terminal"></i> Prompt T√°ctico
                        </h4>
                        <pre id="flow-modal-prompt" class="text-xs text-slate-300 whitespace-pre-wrap font-mono leading-relaxed max-h-48 overflow-y-auto"></pre>
                    </div>
                </div>

                <!-- Footer con acciones -->
                <div class="p-4 border-t border-slate-800 bg-slate-900 flex gap-3">
                    <button onclick="cloneFlowToArchitect()" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white text-sm px-4 py-3 rounded-lg font-bold transition flex items-center justify-center gap-2 shadow-lg">
                        <i class="fa-solid fa-clone"></i> Clonar al Arquitecto
                    </button>
                    <button onclick="copyFlowPrompt()" class="bg-slate-700 hover:bg-slate-600 text-white text-sm px-4 py-3 rounded-lg font-medium transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-copy"></i> Copiar Prompt
                    </button>
                </div>
            </div>
        </div>

        <!-- VISTA 3: GENERADOR -->
        <div id="view-generator" class="hidden flex-1 overflow-y-auto p-8 relative">
             <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4 space-y-6">
                    <!-- BIBLIOTECA DE PATRONES -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-5">
                        <div class="flex items-center gap-2 mb-4">
                            <i class="fa-solid fa-book text-amber-400"></i>
                            <h3 class="font-bold text-white text-sm">Biblioteca de Patrones</h3>
                            <span class="text-[10px] bg-amber-500/20 text-amber-400 px-2 py-0.5 rounded-full">15</span>
                        </div>
                        <div id="patterns-accordion" class="space-y-2"></div>
                    </div>

                    <!-- Modo Libre -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-5">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fa-solid fa-pen text-slate-400"></i>
                            <h3 class="font-bold text-white text-sm">Modo Libre</h3>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-slate-500 mb-1 block">Rol</label>
                                <select id="prompt-role" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-sm text-slate-300">
                                    <option>Arquitecto de Software Senior</option>
                                    <option>Ingeniero de Datos y RAG</option>
                                    <option>Experto en Debugging y Python</option>
                                    <option>Desarrollador Frontend Minimalista</option>
                                    <option>Ingeniero DevOps</option>
                                    <option>Ingeniero de QA</option>
                                    <option>Technical Writer</option>
                                    <option>Ingeniero de Seguridad</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 mb-1 block">Objetivo</label>
                                <textarea id="prompt-goal" rows="3" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2.5 text-sm text-slate-300" placeholder="Describe qu√© quieres lograr..."></textarea>
                            </div>
                            <div class="flex flex-wrap gap-1">
                                <button onclick="setGoal('Generar andamiaje (scaffold) inicial de proyecto')" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-slate-400 px-2 py-1 rounded border border-slate-700 transition">üèóÔ∏è Scaffold</button>
                                <button onclick="setGoal('Explicar este c√≥digo l√≠nea por l√≠nea')" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-slate-400 px-2 py-1 rounded border border-slate-700 transition">üìñ Explicar</button>
                                <button onclick="setGoal('Optimizar para rendimiento y concurrencia')" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-slate-400 px-2 py-1 rounded border border-slate-700 transition">üöÄ Optimizar</button>
                            </div>
                        </div>
                    </div>
                    <button onclick="generatePrompt()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition active:scale-95">Generar Orden</button>
                </div>
                <div class="lg:col-span-4 bg-slate-900 border border-slate-800 rounded-xl p-5 flex flex-col h-[calc(100vh-8rem)]"><div id="stack-selector" class="overflow-y-auto pr-2 space-y-2 flex-1"></div></div>
                <div class="lg:col-span-4 flex flex-col h-[calc(100vh-8rem)]">
                    <div class="bg-slate-800 border border-slate-700 rounded-xl p-1 flex-1 flex flex-col relative group">
                        <div class="absolute top-4 right-4 z-10 opacity-0 group-hover:opacity-100 transition"><button onclick="copyToClipboard()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1.5 rounded-md shadow-lg font-medium transition">Copiar</button></div>
                        <div class="bg-slate-950 rounded-lg p-4 flex-1 overflow-y-auto text-xs font-mono text-slate-300 whitespace-pre-wrap" id="prompt-output"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISTA: PROMPT BUILDER PRO -->
        <div id="view-prompt-builder" class="hidden flex-1 overflow-y-auto p-6">
            <div class="max-w-6xl mx-auto">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-hammer text-green-400"></i>
                            Prompt Builder Pro
                        </h2>
                        <p class="text-sm text-slate-400 mt-1">Crea prompts ag√©nticos con estructura de 6 secciones</p>
                    </div>
                    <div class="flex gap-2">
                        <select id="pb-template" onchange="loadPromptTemplate(this.value)" class="bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-300">
                            <option value="">-- Cargar plantilla --</option>
                            <option value="code-review">üìã Code Review</option>
                            <option value="doc">üìù Documentation</option>
                            <option value="test">üß™ Test Runner</option>
                            <option value="security">üõ°Ô∏è Security Audit</option>
                            <option value="refactor">üîß Refactor</option>
                            <option value="vault">üì¶ Vault</option>
                            <option value="scan-projects">üîç Scan Projects</option>
                            <option value="update-context">üìù Update Context</option>
                            <option value="blank">üìÑ En blanco</option>
                        </select>
                        <button onclick="clearPromptBuilder()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-2 rounded-lg text-sm transition border border-slate-700" title="Limpiar formulario">
                            <i class="fa-solid fa-eraser"></i>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Columna izquierda: Formulario -->
                    <div class="space-y-4">
                        <!-- 1. METADATA -->
                        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="w-6 h-6 rounded-full bg-blue-600 text-white text-xs flex items-center justify-center font-bold">1</span>
                                <h3 class="font-bold text-white text-sm">Metadata</h3>
                            </div>
                            <div class="space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs text-slate-500 mb-1 block">Nombre del comando</label>
                                        <input type="text" id="pb-name" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-sm text-slate-300" placeholder="ej: code-review">
                                    </div>
                                    <div>
                                        <label class="text-xs text-slate-500 mb-1 block">Argument hint</label>
                                        <input type="text" id="pb-arg-hint" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-sm text-slate-300" placeholder="ej: [archivo o directorio]">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500 mb-1 block">Description (qu√© hace + cu√°ndo usarlo)</label>
                                    <input type="text" id="pb-description" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-sm text-slate-300" placeholder="ej: Code review de calidad y seguridad. Usa despu√©s de escribir c√≥digo.">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500 mb-1 block">Allowed tools</label>
                                    <div class="flex flex-wrap gap-2 mt-1">
                                        <label class="flex items-center gap-1 text-xs text-slate-400 bg-slate-950 px-2 py-1 rounded border border-slate-700 cursor-pointer hover:border-blue-500 transition">
                                            <input type="checkbox" class="pb-tool" value="Read" checked> Read
                                        </label>
                                        <label class="flex items-center gap-1 text-xs text-slate-400 bg-slate-950 px-2 py-1 rounded border border-slate-700 cursor-pointer hover:border-blue-500 transition">
                                            <input type="checkbox" class="pb-tool" value="Write"> Write
                                        </label>
                                        <label class="flex items-center gap-1 text-xs text-slate-400 bg-slate-950 px-2 py-1 rounded border border-slate-700 cursor-pointer hover:border-blue-500 transition">
                                            <input type="checkbox" class="pb-tool" value="Edit"> Edit
                                        </label>
                                        <label class="flex items-center gap-1 text-xs text-slate-400 bg-slate-950 px-2 py-1 rounded border border-slate-700 cursor-pointer hover:border-blue-500 transition">
                                            <input type="checkbox" class="pb-tool" value="Glob" checked> Glob
                                        </label>
                                        <label class="flex items-center gap-1 text-xs text-slate-400 bg-slate-950 px-2 py-1 rounded border border-slate-700 cursor-pointer hover:border-blue-500 transition">
                                            <input type="checkbox" class="pb-tool" value="Grep" checked> Grep
                                        </label>
                                        <label class="flex items-center gap-1 text-xs text-slate-400 bg-slate-950 px-2 py-1 rounded border border-slate-700 cursor-pointer hover:border-blue-500 transition">
                                            <input type="checkbox" class="pb-tool" value="Bash"> Bash
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. VARIABLES -->
                        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="w-6 h-6 rounded-full bg-purple-600 text-white text-xs flex items-center justify-center font-bold">2</span>
                                    <h3 class="font-bold text-white text-sm">Variables</h3>
                                </div>
                                <button onclick="addVariable()" class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-2 py-1 rounded border border-slate-700 transition">+ A√±adir</button>
                            </div>
                            <div id="pb-variables" class="space-y-2">
                                <div class="grid grid-cols-12 gap-2 items-center pb-variable-row">
                                    <input type="text" class="col-span-3 bg-slate-950 border border-slate-700 rounded p-1.5 text-xs text-slate-300 font-mono" value="$ARGUMENTS" readonly>
                                    <select class="col-span-3 bg-slate-950 border border-slate-700 rounded p-1.5 text-xs text-slate-300">
                                        <option value="din√°mico" selected>din√°mico</option>
                                        <option value="est√°tico">est√°tico</option>
                                    </select>
                                    <input type="text" class="col-span-5 bg-slate-950 border border-slate-700 rounded p-1.5 text-xs text-slate-300" placeholder="Descripci√≥n..." value="Target del comando">
                                    <button class="col-span-1 text-slate-500 hover:text-red-400 transition opacity-50 cursor-not-allowed" disabled><i class="fa-solid fa-times"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- 3. WORKFLOW -->
                        <div class="bg-slate-900 border border-green-800/50 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="w-6 h-6 rounded-full bg-green-600 text-white text-xs flex items-center justify-center font-bold">3</span>
                                    <h3 class="font-bold text-white text-sm">Workflow</h3>
                                    <span class="text-[9px] bg-green-500/20 text-green-400 px-1.5 py-0.5 rounded font-bold">S-TIER</span>
                                </div>
                                <button onclick="addWorkflowStep()" class="text-xs bg-green-800 hover:bg-green-700 text-green-200 px-2 py-1 rounded border border-green-700 transition">+ Paso</button>
                            </div>
                            <div id="pb-workflow" class="space-y-2">
                                <!-- Se llena din√°micamente con addWorkflowStepRow -->
                            </div>
                            <p class="text-[10px] text-slate-500 mt-2 italic">Define QU√â hace el agente, paso a paso secuencial</p>
                        </div>

                        <!-- 4. INSTRUCTIONS -->
                        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="w-6 h-6 rounded-full bg-cyan-600 text-white text-xs flex items-center justify-center font-bold">4</span>
                                    <h3 class="font-bold text-white text-sm">Instructions</h3>
                                </div>
                                <button onclick="addInstruction()" class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-2 py-1 rounded border border-slate-700 transition">+ Instrucci√≥n</button>
                            </div>
                            <div id="pb-instructions" class="space-y-2">
                                <div class="flex items-center gap-2 pb-instruction-row">
                                    <span class="text-cyan-400">‚Ä¢</span>
                                    <input type="text" class="flex-1 bg-slate-950 border border-slate-700 rounded p-1.5 text-xs text-slate-300" placeholder="Regla o gu√≠a..." value="M√°ximo 10 issues por archivo">
                                    <button onclick="removeInstruction(this)" class="text-slate-500 hover:text-red-400 transition text-xs"><i class="fa-solid fa-times"></i></button>
                                </div>
                            </div>
                            <p class="text-[10px] text-slate-500 mt-2 italic">Define C√ìMO ejecutar el workflow (reglas, l√≠mites, edge cases)</p>
                        </div>

                        <!-- 5. REPORT -->
                        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="w-6 h-6 rounded-full bg-pink-600 text-white text-xs flex items-center justify-center font-bold">5</span>
                                <h3 class="font-bold text-white text-sm">Report (formato de salida)</h3>
                            </div>
                            <textarea id="pb-report" rows="6" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2.5 text-xs text-slate-300 font-mono" placeholder="```
üìã REPORTE: {target}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìç ubicaci√≥n
üè∑Ô∏è [ETIQUETA] Categor√≠a
...

üìä RESUMEN
```"></textarea>
                        </div>
                    </div>

                    <!-- Columna derecha: Preview y Validaci√≥n -->
                    <div class="space-y-4">
                        <!-- Validaci√≥n -->
                        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fa-solid fa-check-circle text-slate-400"></i>
                                <h3 class="font-bold text-white text-sm">Validaci√≥n</h3>
                            </div>
                            <div id="pb-validation" class="space-y-1.5 text-xs">
                                <div class="flex items-center gap-2 text-slate-500"><i class="fa-solid fa-circle w-3"></i> Metadata completo</div>
                                <div class="flex items-center gap-2 text-slate-500"><i class="fa-solid fa-circle w-3"></i> Variables definidas</div>
                                <div class="flex items-center gap-2 text-slate-500"><i class="fa-solid fa-circle w-3"></i> Workflow tiene 4+ pasos</div>
                                <div class="flex items-center gap-2 text-slate-500"><i class="fa-solid fa-circle w-3"></i> Instructions definidas</div>
                                <div class="flex items-center gap-2 text-slate-500"><i class="fa-solid fa-circle w-3"></i> Report definido</div>
                            </div>
                        </div>

                        <!-- Comandos Instalados -->
                        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-terminal text-blue-400"></i>
                                    <h3 class="font-bold text-white text-sm">Instalados</h3>
                                </div>
                                <button onclick="loadInstalledCommands()" class="text-slate-500 hover:text-blue-400 text-xs" title="Refrescar">
                                    <i class="fa-solid fa-refresh"></i>
                                </button>
                            </div>
                            <div id="installed-commands-list" class="space-y-2 max-h-40 overflow-y-auto">
                                <p class="text-slate-500 text-xs">Cargando...</p>
                            </div>
                        </div>

                        <!-- Preview -->
                        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4 flex flex-col" style="height: calc(100vh - 380px);">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-eye text-blue-400"></i>
                                    <h3 class="font-bold text-white text-sm">Preview</h3>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="generatePromptPreview()" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded border border-blue-500 transition">
                                        <i class="fa-solid fa-refresh mr-1"></i> Generar
                                    </button>
                                    <button onclick="copyPromptBuilder()" class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1.5 rounded border border-slate-600 transition">
                                        <i class="fa-solid fa-copy mr-1"></i> Copiar
                                    </button>
                                </div>
                            </div>
                            <div class="flex-1 bg-slate-950 rounded-lg p-3 overflow-y-auto">
                                <pre id="pb-preview" class="text-xs text-slate-300 font-mono whitespace-pre-wrap leading-relaxed"></pre>
                            </div>
                        </div>

                        <!-- Guardar -->
                        <div class="bg-gradient-to-r from-green-900/30 to-emerald-900/30 border border-green-800/50 rounded-xl p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="font-bold text-green-400 text-sm">Guardar comando</h3>
                                    <p class="text-[10px] text-slate-400 mt-0.5">Instala directo o descarga .md</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="installPromptCommand()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2" title="Instalar directo en ~/.claude/commands/">
                                        <i class="fa-solid fa-bolt"></i> Instalar
                                    </button>
                                    <button onclick="exportPromptCommand()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2" title="Descargar archivo .md">
                                        <i class="fa-solid fa-download"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISTA 4: GLOSARIO + KNOWLEDGE BASE -->
        <div id="view-grid" class="hidden flex-1 overflow-y-auto p-6">
            <div class="max-w-7xl mx-auto">
                <!-- Header con progreso -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-white mb-1">Glosario de Herramientas</h2>
                        <p class="text-sm text-slate-400">Tu stack tecnol√≥gico personal</p>
                    </div>
                    <!-- Contador de progreso -->
                    <div id="progress-card" class="bg-slate-900 border border-slate-800 rounded-xl p-4 flex items-center gap-4">
                        <div class="relative w-14 h-14">
                            <svg class="w-14 h-14 transform -rotate-90">
                                <circle cx="28" cy="28" r="24" stroke="#1e293b" stroke-width="4" fill="none"/>
                                <circle id="progress-circle" cx="28" cy="28" r="24" stroke="#22c55e" stroke-width="4" fill="none" stroke-linecap="round" stroke-dasharray="150.8" stroke-dashoffset="150.8"/>
                            </svg>
                            <span id="progress-percent" class="absolute inset-0 flex items-center justify-center text-sm font-bold text-white">0%</span>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 uppercase tracking-wider">Progreso</p>
                            <p class="text-sm text-white font-medium"><span id="progress-count">0</span> / <span id="progress-total">0</span> dominadas</p>
                        </div>
                    </div>
                </div>

                <!-- Barra de b√∫squeda y filtros -->
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-4 mb-6">
                    <div class="flex flex-col lg:flex-row gap-4">
                        <!-- B√∫squeda -->
                        <div class="flex-1">
                            <div class="relative">
                                <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"></i>
                                <input type="text" id="tools-search" oninput="filterTools()" class="w-full bg-slate-950 border border-slate-700 rounded-lg pl-10 pr-4 py-2.5 text-sm text-slate-300 placeholder-slate-600" placeholder="Buscar herramienta...">
                            </div>
                        </div>
                        <!-- Filtros -->
                        <div class="flex flex-wrap gap-2">
                            <!-- Por categor√≠a -->
                            <select id="filter-category" onchange="filterTools()" class="bg-slate-950 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-slate-300">
                                <option value="all">Todas las categor√≠as</option>
                                <option value="Frontend">Frontend</option>
                                <option value="Backend">Backend</option>
                                <option value="IA Model">IA Model</option>
                                <option value="Storage">Storage</option>
                                <option value="Process">Process</option>
                                <option value="DevOps">DevOps</option>
                            </select>
                            <!-- Por estado -->
                            <select id="filter-status" onchange="filterTools()" class="bg-slate-950 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-slate-300">
                                <option value="all">Todos los estados</option>
                                <option value="used">‚úÖ Dominadas</option>
                                <option value="learning">üöß En progreso</option>
                                <option value="new">üÜï Por descubrir</option>
                            </select>
                        </div>
                    </div>
                    <!-- Filtros r√°pidos por estado -->
                    <div class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-slate-800">
                        <button onclick="setStatusFilter('all')" class="status-filter-btn bg-slate-800 text-slate-300 px-3 py-1.5 rounded-lg text-xs font-medium transition flex items-center gap-2 border border-slate-700" data-status="all">
                            Todos <span id="count-all" class="bg-slate-700 px-1.5 py-0.5 rounded">0</span>
                        </button>
                        <button onclick="setStatusFilter('used')" class="status-filter-btn bg-slate-800 text-slate-300 px-3 py-1.5 rounded-lg text-xs font-medium transition flex items-center gap-2 border border-slate-700" data-status="used">
                            <span class="w-2 h-2 rounded-full bg-green-500"></span> Dominadas <span id="count-used" class="bg-green-500/20 text-green-400 px-1.5 py-0.5 rounded">0</span>
                        </button>
                        <button onclick="setStatusFilter('learning')" class="status-filter-btn bg-slate-800 text-slate-300 px-3 py-1.5 rounded-lg text-xs font-medium transition flex items-center gap-2 border border-slate-700" data-status="learning">
                            <span class="w-2 h-2 rounded-full bg-yellow-500"></span> En progreso <span id="count-learning" class="bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">0</span>
                        </button>
                        <button onclick="setStatusFilter('new')" class="status-filter-btn bg-slate-800 text-slate-300 px-3 py-1.5 rounded-lg text-xs font-medium transition flex items-center gap-2 border border-slate-700" data-status="new">
                            <span class="w-2 h-2 rounded-full bg-blue-500"></span> Por descubrir <span id="count-new" class="bg-blue-500/20 text-blue-400 px-1.5 py-0.5 rounded">0</span>
                        </button>
                    </div>
                </div>

                <!-- Knowledge Base RAG (colapsado) -->
                <details class="bg-slate-900 border border-slate-800 rounded-xl mb-6 group">
                    <summary class="p-4 cursor-pointer flex items-center justify-between hover:bg-slate-800/50 transition rounded-xl">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-brain text-blue-400"></i>
                            <span class="text-sm font-bold text-white">Knowledge Base</span>
                            <span class="text-[10px] bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded-full">RAG</span>
                        </div>
                        <i class="fa-solid fa-chevron-down text-slate-500 group-open:rotate-180 transition-transform"></i>
                    </summary>
                    <div class="p-4 pt-0 border-t border-slate-800">
                        <div class="flex gap-2">
                            <input type="text" id="kb-search" class="flex-1 bg-slate-950 border border-slate-700 rounded-lg px-4 py-2 text-sm text-slate-300 placeholder-slate-600" placeholder="Buscar en tus notas... (ej: ¬øc√≥mo funciona RAG?)">
                            <button onclick="searchKnowledgeBase()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                                <i class="fa-solid fa-search"></i> Buscar
                            </button>
                            <button onclick="indexKnowledgeBase()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg text-sm transition" title="Indexar archivos">
                                <i class="fa-solid fa-rotate"></i>
                            </button>
                        </div>
                        <div id="kb-results" class="hidden mt-4 space-y-3"></div>
                    </div>
                </details>

                <!-- Grid de herramientas -->
                <div id="tools-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>

                <!-- Mensaje cuando no hay resultados -->
                <div id="no-results" class="hidden text-center py-12">
                    <i class="fa-solid fa-search text-4xl text-slate-700 mb-4"></i>
                    <p class="text-slate-500">No se encontraron herramientas con esos filtros</p>
                </div>
            </div>
        </div>

        <!-- VISTA 5: PROYECTOS -->
        <div id="view-projects" class="hidden flex-1 overflow-y-auto p-6 bg-slate-950 relative">
            <div class="max-w-7xl mx-auto">
                <!-- Header -->
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-white mb-2">Proyectos minerOS</h2>
                    <p class="text-slate-400">Portfolio de proyectos reales con m√©tricas y aprendizajes documentados</p>
                    <button onclick="createLocalProject()" class="mt-4 bg-blue-600 hover:bg-blue-500 text-white font-medium py-2 px-4 rounded-lg transition flex items-center gap-2 mx-auto">
                        <i class="fa-solid fa-plus"></i> Nuevo Proyecto
                    </button>
                </div>

                <!-- Grid de Proyectos -->
                <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    <!-- Las tarjetas se generan din√°micamente -->
                </div>
            </div>
        </div>

        <!-- VISTA 6: AGENT MODE -->
        <div id="view-agent" class="hidden flex-1 overflow-y-auto p-6 bg-slate-950 relative">
            <div class="max-w-6xl mx-auto">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                            <i class="fa-solid fa-bolt text-yellow-400"></i> Automatizaciones
                            <span id="agent-version-badge" class="text-xs px-2 py-1 rounded bg-blue-500/20 text-blue-400 border border-blue-500/30">v10.1 Pro</span>
                        </h2>
                        <p class="text-slate-400 text-sm mt-1">Automatiza pipelines con watches, schedules y notificaciones</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="startAllAgents()" class="bg-green-600 hover:bg-green-500 text-white text-sm px-4 py-2 rounded-lg transition flex items-center gap-2">
                            <i class="fa-solid fa-play"></i> Iniciar Todo
                        </button>
                        <button onclick="stopAllAgents()" class="bg-red-600/20 hover:bg-red-600/40 text-red-400 text-sm px-4 py-2 rounded-lg transition flex items-center gap-2 border border-red-500/30">
                            <i class="fa-solid fa-stop"></i> Detener
                        </button>
                    </div>
                </div>

                <!-- Status Cards -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <!-- Executor -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-slate-400 text-sm">Executor</span>
                            <i class="fa-solid fa-play-circle text-blue-400"></i>
                        </div>
                        <p id="agent-executor-runs" class="text-2xl font-bold text-white">0</p>
                        <p class="text-xs text-slate-500">ejecuciones activas</p>
                    </div>
                    <!-- Watchdog -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-slate-400 text-sm">Watchdog</span>
                            <span id="agent-watchdog-status" class="w-2 h-2 rounded-full bg-slate-600"></span>
                        </div>
                        <p id="agent-watchdog-count" class="text-2xl font-bold text-white">0</p>
                        <p class="text-xs text-slate-500">watches activos</p>
                    </div>
                    <!-- Scheduler -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-slate-400 text-sm">Scheduler</span>
                            <span id="agent-scheduler-status" class="w-2 h-2 rounded-full bg-slate-600"></span>
                        </div>
                        <p id="agent-scheduler-count" class="text-2xl font-bold text-white">0</p>
                        <p class="text-xs text-slate-500">tareas programadas</p>
                    </div>
                    <!-- Notifications -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-slate-400 text-sm">Notificaciones</span>
                            <i class="fa-solid fa-bell text-yellow-400"></i>
                        </div>
                        <p id="agent-notif-count" class="text-2xl font-bold text-white">0</p>
                        <p class="text-xs text-slate-500">sin leer</p>
                    </div>
                </div>

                <!-- Main Content Grid -->
                <div class="grid grid-cols-2 gap-6">
                    <!-- Watches Section -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                        <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                            <h3 class="font-semibold text-white flex items-center gap-2">
                                <i class="fa-solid fa-eye text-cyan-400"></i> Watches
                            </h3>
                            <button onclick="showCreateWatchModal()" class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded transition">
                                <i class="fa-solid fa-plus mr-1"></i> Nuevo
                            </button>
                        </div>
                        <div id="agent-watches-list" class="p-4 space-y-2 max-h-64 overflow-y-auto">
                            <p class="text-slate-500 text-sm text-center py-4">No hay watches configurados</p>
                        </div>
                    </div>

                    <!-- Schedules Section -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                        <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                            <h3 class="font-semibold text-white flex items-center gap-2">
                                <i class="fa-solid fa-clock text-orange-400"></i> Tareas Programadas
                            </h3>
                            <button onclick="showCreateScheduleModal()" class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded transition">
                                <i class="fa-solid fa-plus mr-1"></i> Nueva
                            </button>
                        </div>
                        <div id="agent-schedules-list" class="p-4 space-y-2 max-h-64 overflow-y-auto">
                            <p class="text-slate-500 text-sm text-center py-4">No hay tareas programadas</p>
                        </div>
                    </div>

                    <!-- Recent Runs -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                        <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                            <h3 class="font-semibold text-white flex items-center gap-2">
                                <i class="fa-solid fa-history text-green-400"></i> Ejecuciones Recientes
                            </h3>
                            <button onclick="refreshAgentRuns()" class="text-xs text-slate-400 hover:text-white transition">
                                <i class="fa-solid fa-refresh"></i>
                            </button>
                        </div>
                        <div id="agent-runs-list" class="p-4 space-y-2 max-h-64 overflow-y-auto">
                            <p class="text-slate-500 text-sm text-center py-4">No hay ejecuciones recientes</p>
                        </div>
                    </div>

                    <!-- Notifications -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                        <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                            <h3 class="font-semibold text-white flex items-center gap-2">
                                <i class="fa-solid fa-bell text-yellow-400"></i> Notificaciones
                            </h3>
                            <button onclick="markAllNotificationsRead()" class="text-xs text-slate-400 hover:text-white transition">
                                Marcar le√≠das
                            </button>
                        </div>
                        <div id="agent-notifications-list" class="p-4 space-y-2 max-h-64 overflow-y-auto">
                            <p class="text-slate-500 text-sm text-center py-4">No hay notificaciones</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="mt-6 bg-slate-900 border border-slate-800 rounded-xl p-4">
                    <h3 class="font-semibold text-white mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-bolt text-yellow-400"></i> Acciones R√°pidas
                    </h3>
                    <div class="flex gap-3 flex-wrap">
                        <button onclick="executeCurrentPipeline()" class="bg-blue-600 hover:bg-blue-500 text-white text-sm px-4 py-2 rounded-lg transition flex items-center gap-2">
                            <i class="fa-solid fa-rocket"></i> Ejecutar Pipeline Actual
                        </button>
                        <button onclick="testNotification()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm px-4 py-2 rounded-lg transition flex items-center gap-2">
                            <i class="fa-solid fa-bell"></i> Test Notificaci√≥n
                        </button>
                        <button onclick="toggleWatchdogService()" id="btn-toggle-watchdog" class="bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm px-4 py-2 rounded-lg transition flex items-center gap-2">
                            <i class="fa-solid fa-eye"></i> <span>Iniciar Watchdog</span>
                        </button>
                        <button onclick="toggleSchedulerService()" id="btn-toggle-scheduler" class="bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm px-4 py-2 rounded-lg transition flex items-center gap-2">
                            <i class="fa-solid fa-clock"></i> <span>Iniciar Scheduler</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Crear Watch -->
        <div id="create-watch-modal" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-md shadow-2xl">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <h3 class="font-bold text-white"><i class="fa-solid fa-eye mr-2 text-cyan-400"></i>Nuevo Watch</h3>
                    <button onclick="closeModal('create-watch-modal')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-4 space-y-4">
                    <div>
                        <label class="text-sm text-slate-400 block mb-1">Nombre</label>
                        <input id="watch-name" type="text" placeholder="PDFs en Descargas" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:border-cyan-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="text-sm text-slate-400 block mb-1">Directorio</label>
                        <input id="watch-directory" type="text" placeholder="~/Downloads" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:border-cyan-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="text-sm text-slate-400 block mb-1">Patrones (separados por coma)</label>
                        <input id="watch-patterns" type="text" placeholder="*.pdf, *.jpg" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:border-cyan-500 focus:outline-none">
                    </div>
                </div>
                <div class="p-4 border-t border-slate-800 flex justify-end gap-2">
                    <button onclick="closeModal('create-watch-modal')" class="bg-slate-800 hover:bg-slate-700 text-sm px-4 py-2 rounded transition">Cancelar</button>
                    <button onclick="createWatch()" class="bg-cyan-600 hover:bg-cyan-500 text-sm px-4 py-2 rounded transition">Crear Watch</button>
                </div>
            </div>
        </div>

        <!-- Modal Crear Schedule -->
        <div id="create-schedule-modal" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-md shadow-2xl">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <h3 class="font-bold text-white"><i class="fa-solid fa-clock mr-2 text-orange-400"></i>Nueva Tarea Programada</h3>
                    <button onclick="closeModal('create-schedule-modal')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-4 space-y-4">
                    <div>
                        <label class="text-sm text-slate-400 block mb-1">Nombre</label>
                        <input id="schedule-name" type="text" placeholder="Backup diario" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:border-orange-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="text-sm text-slate-400 block mb-1">Tipo</label>
                        <select id="schedule-type" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:border-orange-500 focus:outline-none">
                            <option value="cron">Cron (horario espec√≠fico)</option>
                            <option value="interval">Intervalo (cada X tiempo)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-slate-400 block mb-1">Horario</label>
                        <input id="schedule-schedule" type="text" placeholder="0 9 * * * (9am diario) o 15m (cada 15 min)" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:border-orange-500 focus:outline-none">
                        <p class="text-xs text-slate-500 mt-1">Cron: min hora d√≠a mes dow | Intervalo: 15m, 1h, 1d</p>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-800 flex justify-end gap-2">
                    <button onclick="closeModal('create-schedule-modal')" class="bg-slate-800 hover:bg-slate-700 text-sm px-4 py-2 rounded transition">Cancelar</button>
                    <button onclick="createSchedule()" class="bg-orange-600 hover:bg-orange-500 text-sm px-4 py-2 rounded transition">Crear Tarea</button>
                </div>
            </div>
        </div>

        <!-- Modal Detalle de Proyecto -->
        <div id="project-detail-modal" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-4xl shadow-2xl flex flex-col max-h-[90vh]">
                <!-- Header -->
                <div class="p-5 border-b border-slate-800 flex justify-between items-start">
                    <div>
                        <h3 id="project-modal-name" class="font-bold text-white text-2xl mb-2"></h3>
                        <div class="flex items-center gap-2">
                            <span id="project-modal-version" class="text-xs px-2 py-1 rounded bg-blue-500/20 text-blue-400 border border-blue-500/30"></span>
                            <span id="project-modal-status" class="text-xs px-2 py-1 rounded"></span>
                        </div>
                    </div>
                    <button onclick="closeModal('project-detail-modal')" class="text-slate-500 hover:text-white p-1">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Body -->
                <div class="p-6 overflow-y-auto flex-1 space-y-5">
                    <!-- Descripci√≥n -->
                    <div>
                        <p id="project-modal-desc" class="text-slate-300 leading-relaxed text-lg"></p>
                    </div>

                    <!-- Stack T√©cnico -->
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-purple-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-layer-group"></i> Stack T√©cnico
                        </h4>
                        <div id="project-modal-stack" class="flex flex-wrap gap-2"></div>
                    </div>

                    <!-- Repositorio -->
                    <div class="bg-slate-950 border border-slate-800 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-green-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                            <i class="fa-brands fa-git-alt"></i> Repositorio
                        </h4>
                        <code id="project-modal-repo" class="text-sm text-slate-300 font-mono"></code>
                    </div>

                    <!-- Contenido Markdown -->
                    <div class="bg-slate-950 border border-slate-800 rounded-lg p-4 max-h-96 overflow-y-auto">
                        <pre id="project-modal-content" class="text-sm text-slate-300 whitespace-pre-wrap font-mono leading-relaxed"></pre>
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-4 border-t border-slate-800 bg-slate-900 flex gap-3">
                    <button onclick="copyProjectContent()" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white text-sm px-4 py-3 rounded-lg font-bold transition flex items-center justify-center gap-2 shadow-lg">
                        <i class="fa-solid fa-copy"></i> Copiar Documentaci√≥n
                    </button>
                </div>
            </div>
        </div>

        <!-- INSPECTOR MODAL (Human-in-the-Loop) -->
        <div id="inspector-modal" class="hidden absolute inset-0 bg-slate-950/95 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-cyan-500/30 rounded-xl w-full max-w-3xl shadow-2xl flex flex-col max-h-[90vh]">
                <!-- Header -->
                <div class="p-5 border-b border-slate-800 bg-gradient-to-r from-cyan-500/10 to-transparent">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-cyan-500/20 rounded-lg flex items-center justify-center">
                                <i class="fa-solid fa-magnifying-glass text-cyan-400"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-white text-xl">Inspector de Flujo</h3>
                                <span class="text-xs text-cyan-400">Human-in-the-Loop</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="inspector-step" class="text-xs px-2 py-1 rounded bg-slate-800 text-slate-400">Paso 1/3</span>
                        </div>
                    </div>
                </div>

                <!-- Body -->
                <div class="p-6 overflow-y-auto flex-1 space-y-4">
                    <!-- ORIGEN -->
                    <div class="bg-green-500/5 border border-green-500/20 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-green-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-arrow-right-to-bracket"></i> Origen (De donde viene)
                        </h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-slate-500">Nodo anterior:</span>
                                <span id="inspector-origin-node" class="text-white ml-2 font-semibold">-</span>
                            </div>
                            <div>
                                <span class="text-slate-500">Fuente:</span>
                                <span id="inspector-origin-source" class="text-white ml-2 font-mono text-xs">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- PROCESO -->
                    <div class="bg-blue-500/5 border border-blue-500/20 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-gears"></i> Proceso (Quien lo hizo)
                        </h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-slate-500">Herramienta:</span>
                                <span id="inspector-process-tool" class="text-white ml-2 font-semibold">-</span>
                            </div>
                            <div>
                                <span class="text-slate-500">Accion:</span>
                                <span id="inspector-process-action" class="text-white ml-2">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- DATOS -->
                    <div class="bg-amber-500/5 border border-amber-500/20 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-amber-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-database"></i> Datos (Que se extrajo)
                        </h4>
                        <div class="bg-slate-950 rounded-lg p-3 max-h-48 overflow-y-auto">
                            <pre id="inspector-data" class="text-sm text-slate-300 whitespace-pre-wrap font-mono">-</pre>
                        </div>
                        <div class="mt-2 text-xs text-slate-500">
                            <span id="inspector-data-size">0 caracteres</span>
                        </div>
                    </div>

                    <!-- DESTINO -->
                    <div class="bg-purple-500/5 border border-purple-500/20 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-purple-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-arrow-right-from-bracket"></i> Destino (A donde va)
                        </h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-slate-500">Siguiente nodo:</span>
                                <span id="inspector-dest-node" class="text-white ml-2 font-semibold">-</span>
                            </div>
                            <div>
                                <span class="text-slate-500">Accion:</span>
                                <span id="inspector-dest-action" class="text-white ml-2">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- TIP DIDACTICO -->
                    <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-lightbulb text-yellow-400"></i> Aprendizaje
                        </h4>
                        <p id="inspector-tip" class="text-sm text-slate-300 leading-relaxed">-</p>
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-4 border-t border-slate-800 bg-slate-900 flex gap-3">
                    <button onclick="inspectorStop()" class="px-4 py-3 rounded-lg bg-red-500/20 hover:bg-red-500/30 text-red-400 font-semibold transition flex items-center gap-2">
                        <i class="fa-solid fa-stop"></i> Parar
                    </button>
                    <button onclick="inspectorEdit()" class="px-4 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-semibold transition flex items-center gap-2">
                        <i class="fa-solid fa-edit"></i> Editar datos
                    </button>
                    <button onclick="inspectorContinue()" class="flex-1 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white px-4 py-3 rounded-lg font-bold transition flex items-center justify-center gap-2 shadow-lg">
                        <i class="fa-solid fa-play"></i> Continuar
                    </button>
                </div>
            </div>
        </div>

        <!-- DRY RUN MODAL (Simulaci√≥n) -->
        <div id="dry-run-modal" class="hidden absolute inset-0 bg-slate-950/95 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-amber-500/30 rounded-xl w-full max-w-3xl shadow-2xl flex flex-col max-h-[90vh]">
                <!-- Header -->
                <div class="p-5 border-b border-slate-800 bg-gradient-to-r from-amber-500/10 to-transparent">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-amber-500/20 rounded-lg flex items-center justify-center">
                                <i class="fa-solid fa-flask text-amber-400"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-white text-xl">Simulacion del Pipeline</h3>
                                <span class="text-xs text-amber-400">Dry Run - Sin ejecutar realmente</span>
                            </div>
                        </div>
                        <button onclick="closeDryRunModal()" class="text-slate-500 hover:text-white p-1">
                            <i class="fa-solid fa-times text-xl"></i>
                        </button>
                    </div>
                </div>

                <!-- Body -->
                <div class="p-6 overflow-y-auto flex-1 space-y-4">
                    <!-- Resumen -->
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="bg-slate-800/50 rounded-lg p-4 text-center">
                            <div id="dry-run-nodes" class="text-2xl font-bold text-white">0</div>
                            <div class="text-xs text-slate-400">Nodos</div>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-4 text-center">
                            <div id="dry-run-time" class="text-2xl font-bold text-amber-400">~0s</div>
                            <div class="text-xs text-slate-400">Tiempo estimado</div>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-4 text-center">
                            <div id="dry-run-pauses" class="text-2xl font-bold text-cyan-400">0</div>
                            <div class="text-xs text-slate-400">Pausas HITL</div>
                        </div>
                    </div>

                    <!-- Lista de pasos -->
                    <div class="bg-slate-950 rounded-lg p-4 max-h-80 overflow-y-auto">
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">
                            <i class="fa-solid fa-list-check mr-2"></i> Pasos de ejecucion
                        </h4>
                        <div id="dry-run-steps" class="space-y-2">
                            <!-- Steps will be inserted here -->
                        </div>
                    </div>

                    <!-- Warnings -->
                    <div id="dry-run-warnings" class="hidden bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-yellow-400 uppercase tracking-widest mb-2">
                            <i class="fa-solid fa-triangle-exclamation mr-2"></i> Advertencias
                        </h4>
                        <ul id="dry-run-warnings-list" class="text-sm text-yellow-300 space-y-1">
                        </ul>
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-4 border-t border-slate-800 bg-slate-900 flex gap-3">
                    <button onclick="closeDryRunModal()" class="px-4 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-semibold transition flex items-center gap-2">
                        <i class="fa-solid fa-times"></i> Cerrar
                    </button>
                    <button onclick="closeDryRunModal(); runPipelineFromBuilder();" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white px-4 py-3 rounded-lg font-bold transition flex items-center justify-center gap-2 shadow-lg">
                        <i class="fa-solid fa-play"></i> Ejecutar Pipeline Real
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ============================================
        // 0. OFFLINE-FIRST MODULES
        // ============================================

        const API_URL = '';  // Mismo origen

        // TOAST NOTIFICATIONS
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', info: 'fa-info-circle' };
            toast.innerHTML = `<i class="fa-solid ${icons[type] || icons.info}"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // OFFLINE STORE - Maneja localStorage con timestamps
        const OfflineStore = {
            KEYS: {
                tools: 'directos_tools',
                toolStates: 'directos_tool_states',
                projects: 'directos_projects',
                architectures: 'directos_architectures',
                queue: 'directos_sync_queue',
                lastSync: 'directos_last_sync'
            },

            get(key) {
                try {
                    return JSON.parse(localStorage.getItem(this.KEYS[key]) || '{}');
                } catch {
                    return {};
                }
            },

            getArray(key) {
                try {
                    return JSON.parse(localStorage.getItem(this.KEYS[key]) || '[]');
                } catch {
                    return [];
                }
            },

            set(key, data) {
                localStorage.setItem(this.KEYS[key], JSON.stringify(data));
            },

            // Guardar entidad con timestamp
            save(entity, id, data) {
                const store = this.get(entity);
                store[id] = { ...data, id, updatedAt: Date.now(), synced: false };
                this.set(entity, store);
                SyncQueue.add(entity, 'update', id, data);
                SyncManager.updateUI();
                return store[id];
            },

            // Crear nueva entidad
            create(entity, data) {
                const store = this.get(entity);
                const id = 'local_' + Date.now().toString(36);
                store[id] = { ...data, id, createdAt: Date.now(), updatedAt: Date.now(), synced: false };
                this.set(entity, store);
                SyncQueue.add(entity, 'create', id, store[id]);
                SyncManager.updateUI();
                return store[id];
            },

            // Eliminar entidad
            remove(entity, id) {
                const store = this.get(entity);
                if (store[id]) {
                    const deleted = store[id];
                    delete store[id];
                    this.set(entity, store);
                    SyncQueue.add(entity, 'delete', id, deleted);
                    SyncManager.updateUI();
                    return deleted;
                }
                return null;
            },

            // Marcar como sincronizado
            markSynced(entity, id, serverId = null) {
                const store = this.get(entity);
                if (store[id]) {
                    store[id].synced = true;
                    store[id].syncedAt = Date.now();
                    if (serverId && serverId !== id) {
                        // Reemplazar ID local con ID del servidor
                        store[serverId] = { ...store[id], id: serverId };
                        delete store[id];
                    }
                    this.set(entity, store);
                }
            },

            // Obtener todos como array
            getAll(entity) {
                const store = this.get(entity);
                return Object.values(store);
            }
        };

        // SYNC QUEUE - Cola de operaciones pendientes
        const SyncQueue = {
            add(entity, action, id, data) {
                const queue = OfflineStore.getArray('queue');
                // Evitar duplicados: si ya hay una operaci√≥n pendiente para este id, actualizarla
                const existingIdx = queue.findIndex(q => q.entity === entity && q.id === id);
                const item = {
                    entity,
                    action,  // 'create' | 'update' | 'delete'
                    id,
                    data,
                    timestamp: Date.now(),
                    retries: 0
                };
                if (existingIdx >= 0) {
                    // Si era create y ahora es delete, eliminar de la cola
                    if (queue[existingIdx].action === 'create' && action === 'delete') {
                        queue.splice(existingIdx, 1);
                    } else {
                        queue[existingIdx] = item;
                    }
                } else {
                    queue.push(item);
                }
                OfflineStore.set('queue', queue);
                SyncManager.attemptSync();
            },

            getAll() {
                return OfflineStore.getArray('queue');
            },

            clear() {
                OfflineStore.set('queue', []);
            },

            removeFirst() {
                const queue = this.getAll();
                queue.shift();
                OfflineStore.set('queue', queue);
            },

            size() {
                return this.getAll().length;
            }
        };

        // SYNC MANAGER - Orquesta la sincronizaci√≥n
        const SyncManager = {
            isOnline: navigator.onLine,
            isServerReachable: false,
            checkInterval: null,
            isSyncing: false,

            init() {
                // Listeners de conectividad
                window.addEventListener('online', () => this.checkConnection());
                window.addEventListener('offline', () => this.setOffline());

                // Check inicial
                this.checkConnection();

                // Ping cada 30s
                this.checkInterval = setInterval(() => this.checkConnection(), 30000);

                console.log('[SyncManager] Initialized');
            },

            async checkConnection() {
                this.isOnline = navigator.onLine;
                if (!this.isOnline) {
                    this.setOffline();
                    return;
                }

                try {
                    const res = await fetch(`${API_URL}/api/health`, {
                        method: 'GET',
                        cache: 'no-cache'
                    });
                    this.isServerReachable = res.ok;
                    this.updateUI();

                    if (this.isServerReachable) {
                        this.attemptSync();
                    }
                } catch {
                    this.isServerReachable = false;
                    this.updateUI();
                }
            },

            setOffline() {
                this.isOnline = false;
                this.isServerReachable = false;
                this.updateUI();
            },

            async attemptSync() {
                if (!this.isServerReachable || this.isSyncing) return;

                const queue = SyncQueue.getAll();
                if (queue.length === 0) {
                    // Solo pull si no hay nada pendiente
                    await this.pullFromServer();
                    return;
                }

                this.isSyncing = true;
                this.updateUI('syncing');

                for (let i = 0; i < queue.length; i++) {
                    const item = queue[0]; // Siempre el primero (FIFO)
                    try {
                        const serverId = await this.pushToServer(item);
                        OfflineStore.markSynced(item.entity, item.id, serverId);
                        SyncQueue.removeFirst();
                        console.log(`[Sync] ‚úì ${item.action} ${item.entity}/${item.id}`);
                    } catch (e) {
                        console.error(`[Sync] ‚úó ${item.action} ${item.entity}/${item.id}:`, e);
                        // Incrementar retries en la cola
                        const q = SyncQueue.getAll();
                        if (q[0]) {
                            q[0].retries++;
                            if (q[0].retries > 3) {
                                console.error('[Sync] Max retries reached, skipping');
                                SyncQueue.removeFirst();
                            } else {
                                OfflineStore.set('queue', q);
                            }
                        }
                        break; // Parar en el primer error
                    }
                }

                // Pull datos frescos despu√©s de push
                await this.pullFromServer();

                this.isSyncing = false;
                this.updateUI();
            },

            async pushToServer(item) {
                let endpoint, method, body;

                switch (item.entity) {
                    case 'toolStates':
                        endpoint = `${API_URL}/api/tools/${item.id}/status`;
                        method = 'PUT';
                        body = { status: item.data.status || item.data };
                        break;
                    case 'projects':
                        if (item.action === 'create') {
                            endpoint = `${API_URL}/api/projects`;
                            method = 'POST';
                        } else if (item.action === 'delete') {
                            endpoint = `${API_URL}/api/projects/${item.id}`;
                            method = 'DELETE';
                        } else {
                            endpoint = `${API_URL}/api/projects/${item.id}`;
                            method = 'PUT';
                        }
                        body = item.data;
                        break;
                    case 'architectures':
                        if (item.action === 'create') {
                            endpoint = `${API_URL}/api/architectures`;
                            method = 'POST';
                        } else if (item.action === 'delete') {
                            endpoint = `${API_URL}/api/architectures/${item.id}`;
                            method = 'DELETE';
                        } else {
                            endpoint = `${API_URL}/api/architectures/${item.id}`;
                            method = 'PUT';
                        }
                        body = item.data;
                        break;
                    default:
                        throw new Error(`Unknown entity: ${item.entity}`);
                }

                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (method !== 'DELETE' && body) {
                    options.body = JSON.stringify(body);
                }

                const res = await fetch(endpoint, options);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();
                return data.id || item.id; // Devolver ID del servidor si existe
            },

            async pullFromServer() {
                const lastSync = localStorage.getItem(OfflineStore.KEYS.lastSync) || 0;

                try {
                    // Pull tool states
                    const statesRes = await fetch(`${API_URL}/api/tools/states`);
                    if (statesRes.ok) {
                        const { states } = await statesRes.json();
                        this.mergeToolStates(states);
                    }

                    // Pull architectures
                    const archRes = await fetch(`${API_URL}/api/architectures`);
                    if (archRes.ok) {
                        const { architectures } = await archRes.json();
                        this.mergeData('architectures', architectures);
                    }

                    // Pull projects sync
                    const projRes = await fetch(`${API_URL}/api/projects/sync`);
                    if (projRes.ok) {
                        const { projects } = await projRes.json();
                        this.mergeData('projects', projects);
                    }

                    localStorage.setItem(OfflineStore.KEYS.lastSync, Date.now());
                    console.log('[Sync] Pull complete');
                } catch (e) {
                    console.warn('[Sync] Pull failed:', e);
                }
            },

            mergeToolStates(serverStates) {
                const local = OfflineStore.get('toolStates');

                Object.entries(serverStates).forEach(([id, serverItem]) => {
                    const localItem = local[id];
                    // Si no existe local o est√° sincronizado, aceptar server
                    if (!localItem || localItem.synced !== false) {
                        local[id] = { ...serverItem, synced: true };
                    }
                });

                OfflineStore.set('toolStates', local);
            },

            mergeData(entity, serverData) {
                const local = OfflineStore.get(entity);

                serverData.forEach(item => {
                    const localItem = local[item.id];
                    // Si no existe local o est√° sincronizado, aceptar server
                    if (!localItem || localItem.synced !== false) {
                        local[item.id] = { ...item, synced: true, syncedAt: Date.now() };
                    }
                });

                OfflineStore.set(entity, local);
            },

            updateUI(status) {
                const badge = document.getElementById('sync-status');
                if (!badge) return;

                const pending = SyncQueue.size();

                if (status === 'syncing') {
                    badge.innerHTML = '<i class="fa-solid fa-sync fa-spin mr-1"></i> Syncing...';
                    badge.className = 'text-xs font-medium px-2 py-1 rounded bg-yellow-500/20 text-yellow-400 border border-yellow-500/30';
                } else if (!this.isOnline || !this.isServerReachable) {
                    badge.innerHTML = `<i class="fa-solid fa-cloud-slash mr-1"></i> Offline${pending > 0 ? ` (${pending})` : ''}`;
                    badge.className = 'text-xs font-medium px-2 py-1 rounded bg-slate-700 text-slate-400 border border-slate-600';
                } else if (pending > 0) {
                    badge.innerHTML = `<i class="fa-solid fa-clock mr-1"></i> ${pending} pending`;
                    badge.className = 'text-xs font-medium px-2 py-1 rounded bg-yellow-500/20 text-yellow-400 border border-yellow-500/30';
                } else {
                    badge.innerHTML = '<i class="fa-solid fa-check mr-1"></i> Synced';
                    badge.className = 'text-xs font-medium px-2 py-1 rounded bg-green-500/20 text-green-400 border border-green-500/30';
                }
            }
        };

        // ============================================
        // 1. DATA TOOLS & DETAILS (TAGS CON ICONOS A√ëADIDOS)
        // ============================================

        // Variable global para tools (se carga desde API o fallback)
        let toolsData = null;

        // FALLBACK: Tools hardcodeados (se usan si API falla)
        const FALLBACK_TOOLS = [
            // ==========================================
            // üüß FRONTEND (La Cara Visible)
            // ==========================================
            {
                id: "html", name: "HTML5 Sem√°ntico", cat: "Frontend",
                icon: "fa-html5", color: "text-orange-500", tag: "Estructura", status: "used",
                desc: "El esqueleto fundamental de la web moderna.",
                why: "Porque minerOS es 'Local First' y web. Un buen HTML sem√°ntico (<article>, <section>) hace que tus datos sean portables y accesibles sin depender de frameworks.",
                cases: ["Estructura de dashboards", "Reportes generados por IA", "Interfaz de PhotoMine"],
                code: "<article class='card'>\n  <header>\n    <h2>Factura #102</h2>\n  </header>\n  <p>Contenido...</p>\n</article>"
            },
            {
                id: "css", name: "Tailwind CSS", cat: "Frontend",
                icon: "fa-css3", color: "text-blue-400", tag: "Estilos", status: "used",
                desc: "Framework de estilos 'utility-first' para dise√±o r√°pido.",
                why: "Te permite dise√±ar interfaces profesionales (modo oscuro, grids responsive) sin escribir hojas de estilo separadas. Ideal para prototipar r√°pido.",
                cases: ["Layouts de PhotoMine", "Tarjetas del Dashboard", "Botones interactivos"],
                code: "<div class='bg-slate-900 text-white p-4 rounded-xl hover:bg-slate-800 transition shadow-lg'>\n  Panel de Control\n</div>"
            },
            {
                id: "htmx", name: "HTMX", cat: "Frontend",
                icon: "fa-bolt", color: "text-yellow-400", tag: "Interactividad", status: "learning",
                desc: "Superpoderes para HTML. AJAX sin JavaScript complejo.",
                why: "Convierte tus botones y formularios en din√°micos (sin recargar p√°gina) conectando directo con Python. Es la alternativa KISS a React.",
                cases: ["B√∫squeda en vivo", "Carga infinita de fotos", "Edici√≥n inline de datos"],
                code: "<button hx-post='/api/procesar' hx-target='#resultado' hx-swap='innerHTML'>\n  Analizar Imagen\n</button>"
            },
            {
                id: "alpine", name: "Alpine.js", cat: "Frontend",
                icon: "fa-code", color: "text-teal-400", tag: "Reactividad", status: "new",
                desc: "JavaScript minimalista para interacciones en el navegador.",
                why: "Para cuando necesitas abrir un modal, un men√∫ desplegable o pesta√±as sin llamar al servidor. Pesa poqu√≠simo.",
                cases: ["Modales de confirmaci√≥n", "Tabs del Dashboard", "Toggles de visibilidad"],
                code: "<div x-data='{ open: false }'>\n  <button @click='open = true'>Abrir</button>\n  <span x-show='open'>Hola!</span>\n</div>"
            },

            // ==========================================
            // üü© BACKEND (El Cerebro L√≥gico)
            // ==========================================
            {
                id: "python", name: "Python 3.11+", cat: "Backend",
                icon: "fa-brands fa-python", color: "text-blue-500", tag: "Lenguaje Core", status: "used",
                desc: "El lenguaje de programaci√≥n para IA y Datos.",
                why: "Es el pegamento de todo el ecosistema minerOS. Orquesta la IA, mueve archivos y sirve la web.",
                cases: ["Scripts de automatizaci√≥n", "L√≥gica de negocio", "Pegamento entre herramientas"],
                code: "def procesar_archivo(ruta: str) -> dict:\n    datos = extraer_texto(ruta)\n    return {'status': 'ok', 'data': datos}"
            },
            {
                id: "fastapi", name: "FastAPI", cat: "Backend",
                icon: "fa-server", color: "text-green-400", tag: "API Server", status: "learning",
                desc: "El servidor web m√°s r√°pido y moderno para Python.",
                why: "Es as√≠ncrono (no se bloquea mientras la IA piensa). Genera documentaci√≥n autom√°tica (/docs) para que pruebes tus funciones.",
                cases: ["Backend de DirectOS", "API de b√∫squeda", "Endpoint de ingesta de archivos"],
                code: "from fastapi import FastAPI\napp = FastAPI()\n\n@app.get('/items/{id}')\nasync def read_item(id: int):\n    return {'item_id': id}"
            },
            {
                id: "pydantic", name: "Pydantic", cat: "Backend",
                icon: "fa-shield-halved", color: "text-red-400", tag: "Validaci√≥n", status: "new",
                desc: "Control de calidad para tus datos.",
                why: "Define c√≥mo deben ser tus datos (ej: 'La edad debe ser un n√∫mero'). Si algo falla, te avisa antes de romper la base de datos.",
                cases: ["Validar JSON de entrada", "Configuraci√≥n (.env)", "Esquemas de DB"],
                code: "from pydantic import BaseModel\n\nclass Usuario(BaseModel):\n    id: int\n    email: str\n    es_admin: bool = False"
            },
            {
                id: "loguru", name: "Loguru", cat: "Backend",
                icon: "fa-list-ul", color: "text-slate-400", tag: "Logging", status: "learning",
                desc: "Logging simplificado y bonito para humanos.",
                why: "Deja de usar print(). Loguru te dice d√≥nde, cu√°ndo y por qu√© fall√≥ algo, con colores y guardado autom√°tico en archivo.",
                cases: ["Depuraci√≥n de errores", "Historial de operaciones", "Alertas del sistema"],
                code: "from loguru import logger\n\nlogger.add('app.log', rotation='1 day')\nlogger.info('Iniciando proceso...')\nlogger.error('Error cr√≠tico en DB')"
            },
            {
                id: "bs4", name: "BeautifulSoup", cat: "Backend",
                icon: "fa-code", color: "text-green-300", tag: "Scraper", status: "learning",
                desc: "Parser HTML para extraer datos de webs.",
                why: "Cuando necesitas sacar informaci√≥n de p√°ginas web (precios, art√≠culos, datos p√∫blicos) de forma estructurada.",
                cases: ["Scraping de precios", "Extracci√≥n de art√≠culos", "Monitoreo de cambios web"],
                code: "from bs4 import BeautifulSoup\nsoup = BeautifulSoup(html, 'html.parser')\ntitulo = soup.find('h1').text"
            },
            {
                id: "watchdog", name: "Watchdog", cat: "Backend",
                icon: "fa-eye", color: "text-amber-400", tag: "File Watcher", status: "learning",
                desc: "Detecta cambios en carpetas autom√°ticamente.",
                why: "Para pipelines autom√°ticos: cuando guardas un archivo, se procesa solo. Ideal para ingesta continua.",
                cases: ["Auto-indexar Descargas", "Procesar fotos nuevas", "Backup autom√°tico"],
                code: "from watchdog.observers import Observer\nobserver = Observer()\nobserver.schedule(handler, path='./inbox')"
            },

            // ==========================================
            // üü™ IA & MODELOS (La Magia)
            // ==========================================
            {
                id: "clip", name: "OpenAI CLIP", cat: "IA Model",
                icon: "fa-brain", color: "text-purple-400", tag: "Visi√≥n", status: "used",
                desc: "Modelo multimodal que entiende im√°genes y texto.",
                why: "Es el coraz√≥n de PhotoMine. Permite buscar 'perro en la playa' y encontrar la foto sin que nadie la haya etiquetado.",
                cases: ["B√∫squeda sem√°ntica visual", "Clasificaci√≥n autom√°tica", "Detecci√≥n de duplicados"],
                code: "inputs = processor(text=['gato', 'perro'], images=image, return_tensors='pt')\nprobs = model(**inputs).logits_per_image.softmax(dim=1)"
            },
            {
                id: "whisper", name: "Whisper", cat: "IA Model",
                icon: "fa-ear-listen", color: "text-indigo-400", tag: "Audio", status: "learning",
                desc: "Reconocimiento de voz a texto de alta precisi√≥n.",
                why: "Convierte el audio (v√≠deos, notas de voz) en texto que luego puedes buscar, resumir o procesar.",
                cases: ["Transcribir reuniones", "Subt√≠tulos autom√°ticos", "Notas de voz a Obsidian"],
                code: "import whisper\nmodel = whisper.load_model('base')\nresult = model.transcribe('audio.mp3')\nprint(result['text'])"
            },
            {
                id: "sbert", name: "Sentence-BERT", cat: "IA Model",
                icon: "fa-brain", color: "text-teal-400", tag: "Embeddings", status: "used",
                desc: "Vectoriza texto para b√∫squeda sem√°ntica.",
                why: "Convierte p√°rrafos en vectores matem√°ticos. Permite buscar 'documentos similares a este' sin keywords exactas.",
                cases: ["Knowledge Base RAG", "B√∫squeda en notas", "Clustering de documentos"],
                code: "from sentence_transformers import SentenceTransformer\nmodel = SentenceTransformer('all-MiniLM-L6-v2')\nvector = model.encode('Tu texto aqu√≠')"
            },
            {
                id: "claude", name: "Claude API", cat: "IA Model",
                icon: "fa-comments", color: "text-orange-400", tag: "LLM Cloud", status: "used",
                desc: "Razonamiento y generaci√≥n de texto avanzado.",
                why: "Para tareas complejas: resumir, analizar errores, generar c√≥digo. Scout usa Claude para diagnosticar problemas.",
                cases: ["An√°lisis de errores (Scout)", "Res√∫menes inteligentes", "Generaci√≥n de c√≥digo"],
                code: "from anthropic import Anthropic\nclient = Anthropic()\nresponse = client.messages.create(\n  model='claude-sonnet-4-20250514',\n  messages=[{'role': 'user', 'content': prompt}]\n)"
            },
            {
                id: "ollama", name: "Ollama", cat: "IA Model",
                icon: "fa-robot", color: "text-pink-400", tag: "Local LLM", status: "new",
                desc: "Ejecuta modelos tipo ChatGPT (Llama 3, Mistral) en tu Mac.",
                why: "Privacidad total. Te permite tener un asistente inteligente que lee tus documentos privados sin subirlos a la nube.",
                cases: ["Resumir documentos sensibles", "Chatbot offline", "Extracci√≥n de datos privados"],
                code: "# En terminal:\nollama run llama3\n# O desde Python:\nimport ollama\nollama.chat(model='llama3', messages=[...])"
            },

            // ==========================================
            // üü® DATOS & ALMACENAMIENTO (La Memoria)
            // ==========================================
            {
                id: "chroma", name: "ChromaDB", cat: "Storage",
                icon: "fa-database", color: "text-emerald-400", tag: "Vector DB", status: "used",
                desc: "Base de datos para guardar vectores (embeddings).",
                why: "Es donde vive la 'memoria sem√°ntica' de minerOS. Permite buscar por significado ('algo parecido a esto') en lugar de palabras exactas.",
                cases: ["Motor de b√∫squeda RAG", "Recomendaciones", "Memoria de chatbot"],
                code: "collection = client.get_collection('fotos')\nresults = collection.query(query_texts=['atardecer'], n_results=5)"
            },
            {
                id: "sqlite", name: "SQLite", cat: "Storage",
                icon: "fa-table", color: "text-blue-300", tag: "Relacional", status: "used",
                desc: "Base de datos SQL en un archivo √∫nico.",
                why: "Perfecta para metadatos estructurados (fechas, nombres, rutas). Es robusta, r√°pida y no necesita servidor.",
                cases: ["√çndice de archivos", "Registro de usuarios", "Logs estructurados"],
                code: "import sqlite3\ncon = sqlite3.connect('mineros.db')\ncon.execute('SELECT * FROM docs WHERE fecha > ?', ('2024-01-01',))"
            },
            {
                id: "markdown", name: "Markdown", cat: "Storage",
                icon: "fa-file-lines", color: "text-slate-300", tag: "Archivos", status: "used",
                desc: "Formato de texto plano para notas y documentaci√≥n.",
                why: "Es el formato universal de conocimiento. Compatible con Obsidian, GitHub, y f√°cil de procesar con IA.",
                cases: ["Notas de aprendizaje", "Documentaci√≥n de proyectos", "Knowledge Base"],
                code: "# T√≠tulo\n## Subt√≠tulo\n- Lista de items\n- **Negrita** y *cursiva*\n```python\ncodigo()\n```"
            },

            // ==========================================
            // üü• PROCESAMIENTO (Los Obreros)
            // ==========================================
            {
                id: "opencv", name: "OpenCV / Pillow", cat: "Process",
                icon: "fa-eye", color: "text-red-400", tag: "Visi√≥n", status: "used",
                desc: "Librer√≠as para manipular im√°genes p√≠xel a p√≠xel.",
                why: "Necesarias para preparar las im√°genes antes de pasarlas a la IA (redimensionar, recortar, convertir formato).",
                cases: ["Generar miniaturas", "Detectar caras", "Normalizar para CLIP"],
                code: "from PIL import Image\nimg = Image.open('foto.jpg').resize((224, 224))\nimg.save('thumb.jpg')"
            },
            {
                id: "ffmpeg", name: "FFmpeg", cat: "Process",
                icon: "fa-film", color: "text-pink-400", tag: "Multimedia", status: "learning",
                desc: "La navaja suiza del v√≠deo y audio.",
                why: "Permite extraer el audio de un v√≠deo para Whisper, o sacar fotogramas cada 5 segundos para CLIP.",
                cases: ["Extraer audio de v√≠deo", "Comprimir v√≠deos", "Generar GIFs"],
                code: "import subprocess\nsubprocess.run(['ffmpeg', '-i', 'video.mp4', '-vn', 'audio.mp3'])"
            },
            {
                id: "ocr", name: "Tesseract OCR", cat: "Process",
                icon: "fa-font", color: "text-cyan-400", tag: "OCR", status: "learning",
                desc: "Extrae texto de im√°genes y PDFs escaneados.",
                why: "Para digitalizar documentos f√≠sicos (facturas, recibos) y hacerlos buscables.",
                cases: ["Escanear facturas", "Digitalizar notas a mano", "Extraer texto de capturas"],
                code: "import pytesseract\nfrom PIL import Image\ntexto = pytesseract.image_to_string(Image.open('scan.png'))"
            },

            // ==========================================
            // ‚¨õ DEVOPS & CALIDAD (El Taller)
            // ==========================================
            {
                id: "git", name: "Git", cat: "DevOps",
                icon: "fa-code-branch", color: "text-orange-400", tag: "Versiones", status: "learning",
                desc: "Sistema de control de versiones.",
                why: "Tu red de seguridad. Te permite experimentar sin miedo a romper nada, pudiendo volver atr√°s en el tiempo.",
                cases: ["Guardar progreso", "Probar features nuevas (ramas)", "Backup en GitHub"],
                code: "git init\ngit add .\ngit commit -m 'A√±adido nuevo parser'"
            },
            {
                id: "ruff", name: "Ruff / Black", cat: "DevOps",
                icon: "fa-check-double", color: "text-yellow-200", tag: "Calidad", status: "new",
                desc: "Herramientas de limpieza y formateo de c√≥digo.",
                why: "Hacen que tu c√≥digo se vea profesional autom√°ticamente. Black formatea y Ruff busca errores.",
                cases: ["Formatear al guardar", "Detectar imports no usados", "Estilo consistente"],
                code: "# En terminal\nruff check .\nblack ."
            },
            {
                id: "docker", name: "Docker", cat: "DevOps",
                icon: "fa-brands fa-docker", color: "text-blue-400", tag: "Contenedores", status: "new",
                desc: "Empaqueta tu aplicaci√≥n para que funcione en cualquier servidor.",
                why: "Tu app funciona en tu Mac pero falla en producci√≥n? Docker asegura que el entorno sea id√©ntico en todas partes.",
                cases: ["Desplegar minerOS en servidor", "Entornos reproducibles", "CI/CD"],
                code: "# Dockerfile\nFROM python:3.11-slim\nWORKDIR /app\nCOPY . .\nRUN pip install -r requirements.txt\nCMD [\"uvicorn\", \"main:app\"]"
            },
            {
                id: "pytest", name: "Pytest", cat: "DevOps",
                icon: "fa-vial", color: "text-green-400", tag: "Testing", status: "new",
                desc: "Framework de testing para Python. Simple pero potente.",
                why: "Escribe tests una vez, ejec√∫talos mil veces. Detecta bugs antes de que lleguen a producci√≥n.",
                cases: ["Tests unitarios", "Tests de integraci√≥n", "Mocks y fixtures"],
                code: "def test_suma():\n    assert suma(2, 2) == 4\n\ndef test_api(client):\n    response = client.get('/health')\n    assert response.status_code == 200"
            },
            {
                id: "httpx", name: "HTTPX", cat: "Backend",
                icon: "fa-globe", color: "text-cyan-400", tag: "HTTP Client", status: "new",
                desc: "Cliente HTTP moderno y as√≠ncrono para Python.",
                why: "requests es s√≠ncrono y lento. HTTPX es async, soporta HTTP/2 y tiene API id√©ntica a requests.",
                cases: ["Llamadas a APIs externas", "Web scraping async", "Testing de endpoints"],
                code: "import httpx\n\nasync with httpx.AsyncClient() as client:\n    response = await client.get('https://api.example.com/data')\n    data = response.json()"
            },
            {
                id: "jq", name: "jq", cat: "Process",
                icon: "fa-filter", color: "text-amber-400", tag: "JSON Parser", status: "new",
                desc: "El grep/sed/awk para JSON. Filtra y transforma JSON desde terminal.",
                why: "Tienes un JSON gigante y solo necesitas un campo? jq lo extrae en una l√≠nea.",
                cases: ["Filtrar respuestas de API", "Transformar datos", "Pipelines de shell"],
                code: "# Extraer nombres de un JSON\ncat data.json | jq '.users[].name'\n\n# Filtrar por condici√≥n\njq '.items | map(select(.price < 100))'"
            },
            {
                id: "typer", name: "Typer", cat: "Backend",
                icon: "fa-terminal", color: "text-emerald-400", tag: "CLI", status: "new",
                desc: "Crea CLIs profesionales con Python usando type hints.",
                why: "Convierte tus scripts en herramientas de l√≠nea de comandos con ayuda autom√°tica y autocompletado.",
                cases: ["CLI para minerOS", "Scripts con argumentos", "Herramientas internas"],
                code: "import typer\n\napp = typer.Typer()\n\n@app.command()\ndef process(path: str, verbose: bool = False):\n    '''Procesa archivos en PATH'''\n    typer.echo(f'Procesando {path}')"
            },
            {
                id: "rich", name: "Rich", cat: "Backend",
                icon: "fa-palette", color: "text-purple-400", tag: "Terminal UI", status: "new",
                desc: "Salida bonita en terminal: colores, tablas, barras de progreso.",
                why: "Deja de usar print(). Rich hace que tus scripts se vean profesionales.",
                cases: ["Logs con colores", "Tablas de datos", "Barras de progreso"],
                code: "from rich import print\nfrom rich.table import Table\n\ntable = Table(title='Resultados')\ntable.add_column('Archivo')\ntable.add_row('foto.jpg')\nprint(table)"
            },

            // ==========================================
            // ‚ö° TRIGGERS (Activadores de Pipeline) v10.0
            // ==========================================
            {
                id: "trigger-manual", name: "Trigger Manual", cat: "Trigger",
                icon: "fa-play-circle", color: "text-emerald-400", tag: "Ejecutar Ahora", status: "used",
                desc: "Ejecuta el pipeline manualmente con un clic.",
                why: "El punto de entrada m√°s simple. Arrastra al inicio del canvas y presiona el bot√≥n para ejecutar todo el flujo.",
                cases: ["Testing de pipelines", "Ejecuci√≥n bajo demanda", "Demos"],
                code: "# Click en el bot√≥n para ejecutar\n# El pipeline procesa de izquierda a derecha",
                isTrigger: true
            },
            {
                id: "trigger-file", name: "Trigger File", cat: "Trigger",
                icon: "fa-folder-open", color: "text-blue-400", tag: "Watch Carpeta", status: "new",
                desc: "Detecta archivos nuevos en una carpeta y ejecuta el pipeline.",
                why: "Automatiza el procesamiento. Deja PDFs en ~/Downloads y se procesan solos.",
                cases: ["Auto-ingest de documentos", "Procesamiento de fotos", "Watchdog de datos"],
                code: "# Configurar:\n# - Directorio: ~/Downloads\n# - Patr√≥n: *.pdf, *.jpg\n# Se ejecuta cuando detecta archivo nuevo",
                isTrigger: true
            },
            {
                id: "trigger-cron", name: "Trigger Cron", cat: "Trigger",
                icon: "fa-clock", color: "text-yellow-400", tag: "Programado", status: "new",
                desc: "Ejecuta el pipeline en horarios programados.",
                why: "Ideal para tareas recurrentes: backups diarios, reportes semanales, sincronizaciones.",
                cases: ["Backup nocturno", "Reporte semanal", "Sync cada hora"],
                code: "# Configurar frecuencia:\n# - Cada hora\n# - Diario a las 9:00\n# - Semanal los lunes",
                isTrigger: true
            },
            {
                id: "trigger-webhook", name: "Trigger Webhook", cat: "Trigger",
                icon: "fa-link", color: "text-purple-400", tag: "HTTP POST", status: "new",
                desc: "Ejecuta el pipeline cuando recibe una petici√≥n HTTP.",
                why: "Integra con servicios externos: GitHub, Zapier, IFTTT, o tu propia app.",
                cases: ["CI/CD trigger", "Integraci√≥n Zapier", "API callback"],
                code: "# Endpoint generado:\n# POST /api/trigger/{pipeline_id}\n# Body: { data: ... }",
                isTrigger: true
            },
            // ==========================================
            // OUTPUT NODES
            // ==========================================
            {
                id: "output-file", name: "Output File", cat: "Output",
                icon: "fa-file-export", color: "text-orange-400", tag: "Guardar", status: "new",
                desc: "Guarda el resultado del pipeline en un archivo.",
                why: "El paso final de muchos pipelines: guardar resultado en disco.",
                cases: ["Guardar JSON", "Exportar CSV", "Generar reporte"],
                code: "Path('./output/result.json').write_text(json.dumps(data))",
                isOutput: true
            },
            {
                id: "output-notify", name: "Output Notify", cat: "Output",
                icon: "fa-bell", color: "text-orange-400", tag: "Notificar", status: "new",
                desc: "Env√≠a una notificaci√≥n del sistema.",
                why: "Feedback inmediato cuando un pipeline termina.",
                cases: ["Notificar fin", "Alertar errores", "Confirmar backup"],
                code: "osascript -e 'display notification \"Done\" with title \"Pipeline\"'",
                isOutput: true
            },
            {
                id: "output-email", name: "Output Email", cat: "Output",
                icon: "fa-envelope", color: "text-orange-400", tag: "Email", status: "new",
                desc: "Env√≠a el resultado por email.",
                why: "Distribuir resultados autom√°ticamente a equipos o clientes.",
                cases: ["Reporte diario", "Alertas cr√≠ticas", "Compartir resultados"],
                code: "smtplib.SMTP('smtp.gmail.com').send_message(msg)",
                isOutput: true
            },
            {
                id: "output-slack", name: "Output Slack", cat: "Output",
                icon: "fa-hashtag", color: "text-orange-400", tag: "Slack", status: "new",
                desc: "Env√≠a mensaje a un canal de Slack.",
                why: "Notificaciones a equipos en tiempo real.",
                cases: ["Notificar deploys", "Alertar #ops", "M√©tricas diarias"],
                code: "requests.post(SLACK_WEBHOOK, json={'text': message})",
                isOutput: true
            },
            // ==========================================
            // FLOW CONTROL NODES
            // ==========================================
            {
                id: "flow-if", name: "Flow If", cat: "Flow",
                icon: "fa-code-branch", color: "text-purple-400", tag: "Condicional", status: "new",
                desc: "Bifurca el pipeline seg√∫n una condici√≥n.",
                why: "Control de flujo inteligente seg√∫n contenido o tipo.",
                cases: ["PDF vs Imagen", "Tama√±o > 10MB", "Contiene error"],
                code: "if condition:\n    execute(true_branch)\nelse:\n    execute(false_branch)",
                isFlow: true
            },
            {
                id: "flow-loop", name: "Flow Loop", cat: "Flow",
                icon: "fa-repeat", color: "text-purple-400", tag: "Repetir", status: "new",
                desc: "Repite una secci√≥n del pipeline N veces.",
                why: "Procesamiento por lotes, reintentos, iteraciones.",
                cases: ["Procesar lista", "Reintentar 3x", "Polling"],
                code: "for item in items:\n    execute_pipeline(item)",
                isFlow: true
            },
            {
                id: "flow-delay", name: "Flow Delay", cat: "Flow",
                icon: "fa-clock", color: "text-purple-400", tag: "Esperar", status: "new",
                desc: "Pausa el pipeline durante un tiempo.",
                why: "Rate limiting, sincronizaci√≥n, debounce.",
                cases: ["Rate limit API", "Esperar escritura", "Backoff"],
                code: "time.sleep(seconds)",
                isFlow: true
            },
            {
                id: "flow-inspector", name: "Inspector", cat: "Flow",
                icon: "fa-magnifying-glass", color: "text-cyan-400", tag: "HITL", status: "new",
                desc: "Pausa y muestra panel didactico del flujo.",
                why: "Entender automatizaciones: origen, proceso, datos, destino.",
                cases: ["Debug pipeline", "Validar datos", "Aprender herramientas"],
                code: "# Pausa y muestra: origen ‚Üí proceso ‚Üí datos ‚Üí destino",
                isFlow: true
            },
            // ==========================================
            // CLAUDE NODE (usa suscripci√≥n Pro/Max)
            // ==========================================
            {
                id: "claude-node", name: "Claude (CLI)", cat: "IA Model",
                icon: "fa-brain", color: "text-amber-400", tag: "LLM Pro/Max", status: "used",
                desc: "Ejecuta Claude usando tu suscripci√≥n Pro/Max.",
                why: "Acceso a Claude sin API de pago. Usa tu suscripci√≥n existente.",
                cases: ["An√°lisis c√≥digo", "Documentaci√≥n", "Debugging", "Refactoring"],
                code: 'claude -p "tu prompt" --output-format json'
            }
        ];

        // ============================================
        // DUAL-LOAD: API + FALLBACK
        // ============================================

        /**
         * Carga herramientas desde /api/tools
         * Si falla, usa FALLBACK_TOOLS
         */
        async function loadToolsFromAPI() {
            try {
                console.log('[DUAL-LOAD] Intentando cargar desde /api/tools...');
                const response = await fetch('/api/tools');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.tools && Array.isArray(data.tools)) {
                    console.log(`[DUAL-LOAD] ‚úÖ Cargadas ${data.count} herramientas desde API`);

                    // Transformar formato API ‚Üí formato frontend
                    const toolsFromAPI = data.tools.map(t => ({
                        id: t.id,
                        name: t.name,
                        cat: t.category,
                        icon: t.icon,
                        color: t.color,
                        tag: t.tag,
                        status: t.status,
                        isTrigger: t.isTrigger || false,
                        desc: t.content?.split('\n\n')[0]?.replace(/^# .*\n/, '') || t.desc || '',
                        why: extractSection(t.content, 'Por qu√© en minerOS') || '',
                        cases: extractListItems(t.content, 'Casos de uso') || [],
                        code: extractCodeBlock(t.content) || ''
                    }));

                    // MERGE: Combinar tools de API con las que faltan de FALLBACK
                    const apiIds = new Set(toolsFromAPI.map(t => t.id));
                    const remainingFallback = FALLBACK_TOOLS.filter(t => !apiIds.has(t.id));

                    toolsData = [...toolsFromAPI, ...remainingFallback];
                    console.log(`[DUAL-LOAD] üì¶ Total: ${toolsData.length} herramientas (${toolsFromAPI.length} desde API + ${remainingFallback.length} fallback)`);

                    // Actualizar toolbox del Pipeline Builder con los nuevos datos
                    if (typeof renderToolbox === 'function') {
                        renderToolbox();
                    }

                    return true;
                }
                throw new Error('Formato de respuesta inv√°lido');

            } catch (error) {
                console.warn('[DUAL-LOAD] ‚ö†Ô∏è API fall√≥, usando fallback completo:', error.message);
                toolsData = FALLBACK_TOOLS;
                return false;
            }
        }

        // Helpers para parsear markdown
        function extractSection(content, heading) {
            if (!content) return '';
            const regex = new RegExp(`## ${heading}\\s*\\n([^#]+)`, 'i');
            const match = content.match(regex);
            return match ? match[1].trim() : '';
        }

        function extractListItems(content, heading) {
            if (!content) return [];
            const section = extractSection(content, heading);
            const items = section.match(/^- (.+)$/gm);
            return items ? items.map(i => i.replace(/^- /, '')) : [];
        }

        function extractCodeBlock(content) {
            if (!content) return '';
            const match = content.match(/```(?:python|javascript)?\n([\s\S]+?)\n```/);
            return match ? match[1] : '';
        }

        // Getter para usar en vez de acceder directamente a tools
        function getTools() {
            return toolsData || FALLBACK_TOOLS;
        }

        // ============================================
        // PATRONES DE ARQUITECTURA (PRESETS)
        // ============================================
        const presets = [
            {
                id: "rag-chatbot",
                name: "üß† Cerebro de Segunda Memoria",
                desc: "RAG Chatbot - Chatea con tus PDFs/Apuntes",
                useCase: "farmaIA, DocMine",
                tools: ["fastapi", "sbert", "chroma", "claude", "htmx"],
                flow: "Pregunta ‚Üí Vector ‚Üí Busca contexto ‚Üí LLM responde"
            },
            {
                id: "video-search",
                name: "ü¶Ö Ojo de Halc√≥n",
                desc: "Video Search - Encuentra momentos por texto o imagen",
                useCase: "VideoMine, PhotoMine++",
                tools: ["ffmpeg", "whisper", "clip", "sqlite", "fastapi"],
                flow: "Video ‚Üí Escenas + Audio ‚Üí Indexa ‚Üí Busca"
            },
            {
                id: "smart-scraper",
                name: "üïµÔ∏è Agente Curador",
                desc: "Smart Scraper - Extrae datos limpios de webs",
                useCase: "Investigaci√≥n, precios",
                tools: ["python", "bs4", "claude", "sqlite", "loguru"],
                flow: "URL ‚Üí HTML ‚Üí LLM extrae JSON ‚Üí Guarda"
            },
            {
                id: "voice-notes",
                name: "üé§ Escriba Silencioso",
                desc: "Voice-to-Knowledge - Notas de voz a texto estructurado",
                useCase: "Diario, ideas, reuniones",
                tools: ["whisper", "python", "claude", "markdown"],
                flow: "Audio ‚Üí Transcribe ‚Üí LLM resume ‚Üí Guarda .md"
            },
            {
                id: "auto-tagger",
                name: "üëª Clasificador Fantasma",
                desc: "Auto-Tagging - Organiza archivos por contenido",
                useCase: "Descargas, Escritorio",
                tools: ["watchdog", "clip", "ocr", "chroma", "python"],
                flow: "Detecta archivo ‚Üí Analiza ‚Üí Clasifica ‚Üí Mueve"
            },
            {
                id: "text-to-sql",
                name: "üîÆ Or√°culo de Datos",
                desc: "Text-to-SQL - Pregunta a tu BD en lenguaje natural",
                useCase: "Farmacia, Fiscalidad",
                tools: ["fastapi", "claude", "python", "sqlite", "htmx"],
                flow: "Pregunta ‚Üí LLM genera SQL ‚Üí Ejecuta ‚Üí Muestra"
            }
        ];
        
        const catStyles = { "Frontend": "cat-frontend", "Backend": "cat-backend", "IA Model": "cat-ai", "Storage": "cat-storage", "Process": "cat-process", "DevOps": "cat-devops", "Trigger": "cat-trigger", "Output": "cat-output", "Flow": "cat-flow" };
        const statusLabels = { "used": "‚úÖ Dominada", "learning": "üöß En progreso", "new": "üÜï Por descubrir" };

        // ============================================
        // BIBLIOTECA DE PATRONES DE PROMPTS
        // ============================================
        const promptPatterns = {
            "refactoring": {
                name: "üîß Refactoring",
                icon: "fa-wrench",
                patterns: [
                    {
                        id: "refactorizador-modular",
                        name: "Refactorizador Modular",
                        emoji: "üèóÔ∏è",
                        problem: "Tienes un script prueba.py de 300 l√≠neas que funciona, pero es un caos.",
                        prompt: `Act√∫a como Arquitecto de Software. Toma este c√≥digo monol√≠tico y refactor√≠zalo siguiendo la arquitectura limpia de minerOS. Sep√°ralo en: routers/ (endpoints), services/ (l√≥gica pura), y core/ (configuraci√≥n). Usa inyecci√≥n de dependencias y Pydantic para validaci√≥n. Entr√©game la estructura de archivos final.`,
                        flow: ["python", "fastapi", "loguru"],
                        flowDesc: "Script ‚Üí Analiza ‚Üí Separa m√≥dulos ‚Üí Estructura limpia"
                    },
                    {
                        id: "guardian-calidad",
                        name: "Guardi√°n de Calidad",
                        emoji: "üõ°Ô∏è",
                        problem: "Tienes miedo de tocar el c√≥digo porque se puede romper.",
                        prompt: `Act√∫a como Ingeniero de QA experto en Pytest. Genera una suite de tests completa para este m√≥dulo. Incluye conftest.py con fixtures para mockear la base de datos y las llamadas a APIs externas (como OpenAI). Cubre casos de √©xito, casos de error y casos borde.`,
                        flow: ["python", "sqlite", "loguru"],
                        flowDesc: "C√≥digo ‚Üí Analiza ‚Üí Genera tests ‚Üí conftest.py + tests/"
                    },
                    {
                        id: "constructor-interfaz",
                        name: "Constructor de Interfaz",
                        emoji: "üé®",
                        problem: "Tienes la API hecha pero te da pereza hacer el HTML.",
                        prompt: `Act√∫a como Desarrollador Frontend Minimalista. Teniendo en cuenta este esquema de datos Pydantic del backend, genera un componente HTML5 + TailwindCSS aut√≥nomo. Usa HTMX para conectar con el endpoint sin escribir JavaScript. El dise√±o debe ser limpio, oscuro (Slate-900) y mobile-first.`,
                        flow: ["html", "css", "htmx", "fastapi"],
                        flowDesc: "Pydantic Schema ‚Üí HTML5 + Tailwind ‚Üí HTMX bindings"
                    }
                ]
            },
            "contenido": {
                name: "üìù Contenido",
                icon: "fa-pen-fancy",
                patterns: [
                    {
                        id: "alquimista-contenido",
                        name: "Alquimista de Contenido",
                        emoji: "‚ú®",
                        problem: "Tienes un archivo Markdown t√©cnico y quieres convertirlo en contenido publicable.",
                        prompt: `Act√∫a como Content Strategist t√©cnico. Toma este archivo Markdown y genera: 1) Un hilo de Twitter de 5 tweets con hooks y emojis, 2) Un post de LinkedIn profesional con bullet points, 3) Una Newsletter HTML maquetada. Mant√©n el tono t√©cnico pero accesible.`,
                        flow: ["python", "claude", "clip", "html", "sqlite"],
                        flowDesc: "Markdown ‚Üí IA extrae ideas ‚Üí Genera formatos ‚Üí HTML Newsletter"
                    }
                ]
            },
            "seguridad": {
                name: "üõ°Ô∏è Seguridad",
                icon: "fa-shield-halved",
                patterns: [
                    {
                        id: "escudo-privacidad",
                        name: "Escudo de Privacidad",
                        emoji: "üîí",
                        problem: "Necesitas compartir logs o documentos pero contienen datos sensibles.",
                        prompt: `Act√∫a como Ingeniero de Seguridad. Crea un script Python que escanee archivos recursivamente, detecte datos sensibles (DNI, Email, Tel√©fono, API Keys, IBANs) usando regex y opcionalmente Spacy NER, y genere una copia censurada con [REDACTED]. Usa Loguru para alertar cada hallazgo. Sin APIs externas - todo local.`,
                        flow: ["python", "ocr", "loguru"],
                        flowDesc: "Archivos ‚Üí OCR si es imagen ‚Üí Regex/Spacy detecta ‚Üí Copia censurada"
                    }
                ]
            },
            "knowledge": {
                name: "üß† Knowledge",
                icon: "fa-brain",
                patterns: [
                    {
                        id: "sintetizador-conocimiento",
                        name: "Sintetizador de Conocimiento",
                        emoji: "üìö",
                        problem: "Tienes 50 PDFs sobre un tema y necesitas un resumen coherente.",
                        prompt: `Act√∫a como Investigador Senior. Genera un "Estado del Arte" sobre el tema especificado bas√°ndote √∫nicamente en los fragmentos recuperados de mi Knowledge Base local. Estructura el ensayo con: Introducci√≥n, Conceptos clave, Evoluci√≥n hist√≥rica, Estado actual, y Conclusiones. Cita las fuentes originales.`,
                        flow: ["fastapi", "chroma", "python", "claude", "html"],
                        flowDesc: "Tema ‚Üí ChromaDB busca ‚Üí Reranking ‚Üí LLM sintetiza ‚Üí Informe HTML"
                    }
                ]
            },
            "aprendizaje": {
                name: "üìñ Aprendizaje",
                icon: "fa-graduation-cap",
                patterns: [
                    {
                        id: "mentor-socratico",
                        name: "Mentor Socr√°tico",
                        emoji: "üéì",
                        problem: "Quieres comprobar si realmente entendiste un documento t√©cnico.",
                        prompt: `Act√∫a como profesor universitario experto en evaluaci√≥n. Lee este documento t√©cnico y genera un test de 10 preguntas tipo test (4 opciones, solo 1 correcta). Incluye preguntas de comprensi√≥n, aplicaci√≥n y an√°lisis. Devuelve un JSON con: pregunta, opciones[], respuesta_correcta, explicacion.`,
                        flow: ["python", "claude", "htmx", "markdown"],
                        flowDesc: "PDF/MD ‚Üí LLM genera quiz ‚Üí JSON ‚Üí Interfaz Flashcards"
                    },
                    {
                        id: "resumen-ejecutivo",
                        name: "Resumen Ejecutivo",
                        emoji: "üìã",
                        problem: "Al final del d√≠a no recuerdas qu√© guardaste en tus carpetas.",
                        prompt: `Act√∫a como Asistente Personal. Escanea los archivos creados/modificados en las √∫ltimas 24 horas en la carpeta especificada. Para cada archivo, extrae su "esencia" (t√≠tulo, tipo, tema principal). Genera un resumen narrativo de 1 p√°rrafo: "Hoy guardaste 3 facturas, 2 notas de voz sobre X, y 1 snippet de c√≥digo para Y".`,
                        flow: ["python", "watchdog", "ocr", "clip", "claude", "markdown"],
                        flowDesc: "Watchdog ‚Üí Clasifica archivos ‚Üí IA resume ‚Üí DIARIO.md"
                    },
                    {
                        id: "torre-babel",
                        name: "Torre de Babel",
                        emoji: "üåç",
                        problem: "Necesitas leer documentaci√≥n t√©cnica en otro idioma.",
                        prompt: `Act√∫a como Traductor T√©cnico especializado. Traduce este documento manteniendo: 1) Bloques de c√≥digo intactos, 2) Nombres de variables/funciones sin traducir, 3) Terminolog√≠a t√©cnica est√°ndar (API, endpoint, etc). Genera una versi√≥n biling√ºe lado a lado si es posible.`,
                        flow: ["python", "claude", "html", "markdown"],
                        flowDesc: "Markdown ‚Üí Separa c√≥digo/texto ‚Üí Traduce texto ‚Üí Re-ensambla"
                    }
                ]
            },
            "devops": {
                name: "üîß DevOps",
                icon: "fa-code",
                patterns: [
                    {
                        id: "code-reviewer",
                        name: "Code Reviewer",
                        emoji: "üëÄ",
                        problem: "Quieres un segundo par de ojos antes de hacer commit.",
                        prompt: `Act√∫a como Senior Python Developer con 10 a√±os de experiencia. Revisa este c√≥digo buscando: 1) Vulnerabilidades de seguridad (inyecci√≥n, exposici√≥n de secrets), 2) Problemas de rendimiento (N+1, memory leaks), 3) Falta de type hints, 4) Code smells (funciones largas, acoplamiento). Prioriza los hallazgos por severidad.`,
                        flow: ["python", "loguru"],
                        flowDesc: "C√≥digo ‚Üí An√°lisis est√°tico ‚Üí IA review ‚Üí Reporte priorizado"
                    },
                    {
                        id: "semilla-datos",
                        name: "Semilla de Datos",
                        emoji: "üå±",
                        problem: "Necesitas datos de prueba realistas sin usar datos reales de producci√≥n.",
                        prompt: `Act√∫a como Ingeniero de Datos. Genera un dataset de prueba con el esquema especificado. Los datos deben ser: 1) Coherentes entre s√≠ (edades realistas, nombres plausibles), 2) Diversos (cubrir casos borde), 3) En formato JSON/CSV. Incluye al menos 100 registros.`,
                        flow: ["fastapi", "claude", "python", "sqlite"],
                        flowDesc: "Esquema ‚Üí LLM genera JSON ‚Üí Valida Pydantic ‚Üí Inserta SQLite"
                    },
                    {
                        id: "documentador-fantasma",
                        name: "Documentador Fantasma",
                        emoji: "üëª",
                        problem: "Tu c√≥digo funciona pero no tiene documentaci√≥n.",
                        prompt: `Act√∫a como Technical Writer. Lee este m√≥dulo Python usando AST y genera: 1) Docstrings en formato Google Style para cada funci√≥n, 2) Un README.md con: descripci√≥n, instalaci√≥n, uso b√°sico, y ejemplos. 3) Un diagrama ASCII del flujo principal. No inventes funcionalidad - documenta solo lo que existe.`,
                        flow: ["python", "claude", "markdown"],
                        flowDesc: "C√≥digo ‚Üí AST extrae estructura ‚Üí LLM documenta ‚Üí docs/"
                    }
                ]
            },
            "debug": {
                name: "üîç Debug & Performance",
                icon: "fa-bug",
                patterns: [
                    {
                        id: "debugger-sherlock",
                        name: "Debugger Sherlock",
                        emoji: "üîç",
                        problem: "Tienes un error cr√≠ptico y no sabes por d√≥nde empezar.",
                        prompt: `Act√∫a como Detective de Bugs Senior. Analiza este traceback como Sherlock Holmes. Identifica: 1) La l√≠nea exacta del fallo y tipo de excepci√≥n, 2) El contexto (qu√© datos entraron), 3) 3 hip√≥tesis ordenadas por probabilidad, 4) Plan de debugging paso a paso con prints/breakpoints estrat√©gicos. No asumas - deduce desde la evidencia.`,
                        flow: ["python", "loguru", "claude"],
                        flowDesc: "Traceback ‚Üí Analiza contexto ‚Üí Hip√≥tesis ‚Üí Plan de acci√≥n"
                    },
                    {
                        id: "performance-hunter",
                        name: "Performance Hunter",
                        emoji: "‚ö°",
                        problem: "Tu script funciona pero tarda demasiado.",
                        prompt: `Act√∫a como Performance Engineer. Analiza este c√≥digo Python buscando: 1) Loops O(n¬≤) convertibles a O(n) con sets/dicts, 2) Operaciones I/O bloqueantes que podr√≠an ser async, 3) Memory allocations innecesarias en loops, 4) Candidatos para caching (@lru_cache). Prioriza por impacto/esfuerzo. Dame el c√≥digo optimizado.`,
                        flow: ["python", "loguru"],
                        flowDesc: "C√≥digo lento ‚Üí Profiling mental ‚Üí Identificar hotspots ‚Üí Optimizar"
                    }
                ]
            },
            "data-api": {
                name: "üóÇÔ∏è Data & API",
                icon: "fa-database",
                patterns: [
                    {
                        id: "schema-detective",
                        name: "Schema Detective",
                        emoji: "üóÇÔ∏è",
                        problem: "Recibes un JSON/CSV gigante y necesitas entender su estructura.",
                        prompt: `Act√∫a como Data Analyst. Analiza este dataset (JSON/CSV) y genera: 1) Modelo Pydantic con tipos inferidos autom√°ticamente, 2) Campos opcionales (Optional[]) vs requeridos detectados, 3) Valores √∫nicos que deber√≠an ser Enums, 4) Relaciones entre entidades si existen. Formato listo para copiar a models.py.`,
                        flow: ["python", "fastapi", "sqlite"],
                        flowDesc: "JSON/CSV ‚Üí Inferir tipos ‚Üí Generar Pydantic ‚Üí models.py"
                    },
                    {
                        id: "api-architect",
                        name: "API Architect",
                        emoji: "üèõÔ∏è",
                        problem: "Sabes qu√© necesitas pero no c√≥mo dise√±ar los endpoints.",
                        prompt: `Act√∫a como API Designer experto en REST. Dado este dominio de negocio, dise√±a una API RESTful completa: 1) Recursos y rutas (GET/POST/PUT/DELETE), 2) Esquemas Pydantic de request/response, 3) C√≥digos HTTP espec√≠ficos (201, 204, 404, 422), 4) Ejemplo curl de cada endpoint. Estilo FastAPI, listo para implementar.`,
                        flow: ["fastapi", "python", "sqlite"],
                        flowDesc: "Dominio ‚Üí Identificar recursos ‚Üí Dise√±ar rutas ‚Üí Schemas"
                    }
                ]
            },
            "meta": {
                name: "üéØ Meta & Automation",
                icon: "fa-wand-magic-sparkles",
                patterns: [
                    {
                        id: "prompt-optimizer",
                        name: "Prompt Optimizer",
                        emoji: "üéØ",
                        problem: "Tu prompt funciona a medias, a veces da respuestas inconsistentes.",
                        prompt: `Act√∫a como Prompt Engineer Senior. Analiza este prompt y mej√≥ralo aplicando: 1) Rol espec√≠fico con expertise, 2) Formato de salida estructurado (JSON, Markdown), 3) Ejemplos few-shot si el patr√≥n es complejo, 4) Restricciones expl√≠citas (qu√© NO hacer), 5) Pensamiento paso a paso si requiere razonamiento. Devuelve: versi√≥n original vs mejorada.`,
                        flow: ["claude", "markdown"],
                        flowDesc: "Prompt d√©bil ‚Üí An√°lisis ‚Üí Aplicar t√©cnicas ‚Üí Prompt robusto"
                    },
                    {
                        id: "workflow-automator",
                        name: "Workflow Automator",
                        emoji: "ü§ñ",
                        problem: "Haces lo mismo manualmente cada d√≠a (renombrar, mover, procesar).",
                        prompt: `Act√∫a como Automation Engineer. Dado este flujo manual, genera un script Python con Watchdog que: 1) Detecte archivos nuevos por patr√≥n (*.pdf, *.jpg), 2) Ejecute la acci√≥n autom√°ticamente, 3) Loguee cada operaci√≥n con Loguru, 4) Tenga modo --dry-run para probar. Sin dependencias innecesarias. Local-first.`,
                        flow: ["python", "watchdog", "loguru"],
                        flowDesc: "Describir flujo ‚Üí Watchdog detecta ‚Üí Acci√≥n ‚Üí Log"
                    }
                ]
            },
            "ui-creative": {
                name: "üé® Creatividad & UI",
                icon: "fa-palette",
                patterns: [
                    {
                        id: "pincel-digital",
                        name: "Pincel Digital",
                        emoji: "üñåÔ∏è",
                        problem: "Tienes un HTML funcional pero feo. Quieres que parezca SaaS profesional.",
                        prompt: `Act√∫a como Dise√±ador UI/UX Senior experto en Tailwind CSS. Toma este HTML crudo y redis√©√±alo para que sea moderno, oscuro y minimalista. Requisitos: Gradientes sutiles (slate-900‚Üíslate-950), tipograf√≠a Inter, micro-interacciones (hover, transiciones 200ms), sombras para profundidad. Mant√©n la estructura funcional intacta.`,
                        flow: ["html", "css", "htmx"],
                        flowDesc: "HTML feo ‚Üí An√°lisis UX ‚Üí Tailwind magic ‚Üí HTML profesional"
                    },
                    {
                        id: "narrador-datos",
                        name: "Narrador de Datos",
                        emoji: "üìä",
                        problem: "Tienes datos en SQLite/Python pero verlos en tablas es aburrido.",
                        prompt: `Act√∫a como Experto en Visualizaci√≥n de Datos. Tengo este dataset JSON. Genera c√≥digo HTML + JS usando Chart.js para un dashboard interactivo: gr√°fico de l√≠nea temporal, donut para distribuci√≥n por categor√≠as, tarjetas KPI con totales. Paleta ne√≥n (cyan, magenta, amarillo) sobre fondo slate-900.`,
                        flow: ["html", "python", "sqlite"],
                        flowDesc: "Datos ‚Üí Elegir visualizaci√≥n ‚Üí Chart.js ‚Üí Dashboard"
                    },
                    {
                        id: "arquitecto-componentes",
                        name: "Arquitecto de Componentes",
                        emoji: "üß±",
                        problem: "Repites mucho c√≥digo HTML (tarjetas, botones, men√∫s).",
                        prompt: `Act√∫a como Frontend Developer experto en DRY. Extrae este bloque de HTML repetitivo y convi√©rtelo en: A) Macro de Jinja2, B) Template con slots, o C) Componente Alpine.js. Que acepte par√°metros: t√≠tulo, imagen, estado, onClick. Incluye ejemplo instanci√°ndolo 3 veces con datos diferentes.`,
                        flow: ["html", "htmx", "python"],
                        flowDesc: "HTML repetido ‚Üí Identificar variaciones ‚Üí Parametrizar ‚Üí Componente"
                    }
                ]
            },
            "robustez": {
                name: "üõ†Ô∏è Ingenier√≠a & Robustez",
                icon: "fa-hammer",
                patterns: [
                    {
                        id: "comandante-terminal",
                        name: "Comandante de Terminal",
                        emoji: "‚å®Ô∏è",
                        problem: "Ejecutar scripts editando variables en el c√≥digo es cutre.",
                        prompt: `Act√∫a como Python Tooling Expert. Convierte este script en una CLI profesional con Typer. Requisitos: Comandos claros (scan, process, clean), opciones con defaults, barras de progreso con rich/tqdm, ayuda autom√°tica (--help), colores para √©xito/error, manejo de Ctrl+C graceful.`,
                        flow: ["python", "loguru"],
                        flowDesc: "Script ‚Üí Identificar inputs ‚Üí Typer CLI ‚Üí Instalable con pip"
                    },
                    {
                        id: "cirujano-datos",
                        name: "Cirujano de Datos",
                        emoji: "üî¨",
                        problem: "Tus consultas a SQLite empiezan a ir lentas.",
                        prompt: `Act√∫a como DBA experto en SQLite. Analiza este esquema y consulta SQL lenta. Tareas: 1) Identificar cuellos de botella (table scans, joins sin √≠ndice), 2) Sugerir √≠ndices (CREATE INDEX), 3) Normalizar si hay redundancia, 4) Reescribir query optimizada, 5) Explicar con EXPLAIN QUERY PLAN.`,
                        flow: ["sqlite", "python"],
                        flowDesc: "Schema + Query ‚Üí EXPLAIN ‚Üí √çndices ‚Üí Query optimizada"
                    },
                    {
                        id: "centinela-errores",
                        name: "Centinela de Errores",
                        emoji: "üõ°Ô∏è",
                        problem: "Tu script se rompe si falta internet o un archivo.",
                        prompt: `Act√∫a como SRE (Site Reliability Engineer). Envuelve este c√≥digo en estructura robusta de errores: Excepciones espec√≠ficas (NetworkError, FileNotFoundError), retry con backoff exponencial (3 intentos: 1s‚Üí2s‚Üí4s), fallback graceful, Loguru para registrar timestamp/intento/error/contexto.`,
                        flow: ["python", "loguru"],
                        flowDesc: "C√≥digo fr√°gil ‚Üí Identificar fallos ‚Üí try/except ‚Üí Retry ‚Üí Log"
                    }
                ]
            },
            "data-eng": {
                name: "üßπ Data Engineering",
                icon: "fa-broom",
                patterns: [
                    {
                        id: "conserje-datos",
                        name: "Conserje de Datos",
                        emoji: "üßπ",
                        problem: "Tienes un CSV/JSON sucio con fechas mixtas, nulos y duplicados.",
                        prompt: `Act√∫a como Data Engineer. Genera script de limpieza con Pandas: 1) Estandarizar fechas a ISO 8601, 2) Manejar nulos (media para num√©ricos, "UNKNOWN" para strings), 3) Eliminar duplicados por columnas clave, 4) Detectar outliers (>3 std), 5) Exportar CSV limpio + quality_report.json.`,
                        flow: ["python", "sqlite"],
                        flowDesc: "CSV sucio ‚Üí Pandas ‚Üí Limpieza ‚Üí CSV limpio + reporte"
                    },
                    {
                        id: "susurrador-regex",
                        name: "Susurrador de Regex",
                        emoji: "üîÆ",
                        problem: "Necesitas extraer informaci√≥n de texto no estructurado (logs, emails).",
                        prompt: `Act√∫a como experto en Expresiones Regulares de Python. Necesito extraer [PATR√ìN: IBANs, referencias catastrales, fechas, etc] de este texto. Para cada patr√≥n: 1) Regex comentada paso a paso, 2) C√≥digo Python con re.findall(), 3) Tests con casos borde (qu√© matchea y qu√© no).`,
                        flow: ["python", "loguru"],
                        flowDesc: "Texto ‚Üí Identificar patr√≥n ‚Üí Regex ‚Üí Extraer ‚Üí Lista limpia"
                    },
                    {
                        id: "traductor-formatos",
                        name: "Traductor de Formatos",
                        emoji: "üîÑ",
                        problem: "Necesitas mover datos entre sistemas incompatibles (XML‚ÜíSQLite).",
                        prompt: `Act√∫a como Integration Engineer. Genera script de migraci√≥n en Python: 1) Parsear origen (lxml para XML, openpyxl para Excel), 2) Transformar al esquema destino, 3) Validar con Pydantic antes de insertar, 4) Manejar errores por registro (no fallar todo por uno), 5) Log de migraci√≥n: exitosos/fallidos/warnings.`,
                        flow: ["python", "sqlite", "fastapi"],
                        flowDesc: "Origen ‚Üí Parse ‚Üí Transform ‚Üí Validate ‚Üí Load ‚Üí Log"
                    }
                ]
            },
            "docs-visual": {
                name: "üìê Documentaci√≥n Visual",
                icon: "fa-diagram-project",
                patterns: [
                    {
                        id: "diagramador-auto",
                        name: "Diagramador Autom√°tico",
                        emoji: "üìê",
                        problem: "Necesitas explicar un flujo visualmente pero dibujar es tedioso.",
                        prompt: `Act√∫a como Technical Illustrator. Analiza este c√≥digo/flujo y genera c√≥digo Mermaid.js. Tipos: Secuencia (Frontend‚ÜíAPI‚ÜíDB), Flowchart (if/else), ER (relaciones tablas), State (estados proceso). Output: c√≥digo Mermaid listo para GitHub/Notion + preview ASCII si es posible.`,
                        flow: ["markdown", "python"],
                        flowDesc: "C√≥digo/descripci√≥n ‚Üí Elegir tipo ‚Üí Mermaid.js ‚Üí Diagrama"
                    },
                    {
                        id: "bibliotecario-api",
                        name: "Bibliotecario de API",
                        emoji: "üìö",
                        problem: "Tu API funciona pero no tiene documentaci√≥n para otros devs.",
                        prompt: `Act√∫a como API Documentation Specialist. Genera documentaci√≥n OpenAPI 3.0 (Swagger) en YAML: Paths con m√©todos HTTP, Request/Response schemas, C√≥digos de error (400, 404, 500), Ejemplos realistas, Tags por recurso. Bonus: docstring para que FastAPI auto-genere /docs.`,
                        flow: ["fastapi", "python", "markdown"],
                        flowDesc: "C√≥digo ‚Üí Extraer endpoints ‚Üí OpenAPI YAML ‚Üí /docs autom√°tico"
                    },
                    {
                        id: "gestor-entorno",
                        name: "Gestor de Entorno",
                        emoji: "‚öôÔ∏è",
                        problem: "Tienes API keys y rutas hardcodeadas en el c√≥digo.",
                        prompt: `Act√∫a como DevOps Engineer. Analiza este script e identifica variables de configuraci√≥n: API Keys, rutas, URLs, puertos, feature flags. Refactoriza usando python-dotenv + Pydantic Settings. Genera .env.example con placeholders. A√±ade validaci√≥n (app no arranca si falta ANTHROPIC_API_KEY).`,
                        flow: ["python", "fastapi", "loguru"],
                        flowDesc: "C√≥digo ‚Üí Identificar config ‚Üí .env + Settings ‚Üí Validaci√≥n"
                    }
                ]
            },
            "comodin": {
                name: "üÉè Comod√≠n",
                icon: "fa-hat-wizard",
                patterns: [
                    {
                        id: "meta-patron",
                        name: "Meta-Patr√≥n",
                        emoji: "üÉè",
                        problem: "Necesitas un patr√≥n que no existe en esta lista.",
                        prompt: `Act√∫a como Prompt Architect de minerOS. Necesito un nuevo patr√≥n de prompt para [DESCRIBIR PROBLEMA]. Genera siguiendo esta estructura: Nombre creativo + emoji, El Problema (1 frase), El Prompt completo, Flujo T√°ctico (herramientas), Ejemplo de uso real.`,
                        flow: ["claude", "markdown"],
                        flowDesc: "Problema ‚Üí Dise√±ar patr√≥n ‚Üí Prompt + Flujo ‚Üí Ejemplo"
                    },
                    {
                        id: "auditor-proyecto",
                        name: "Auditor de Proyecto",
                        emoji: "üîé",
                        problem: "Heredas un proyecto y no sabes por d√≥nde empezar.",
                        prompt: `Act√∫a como Tech Lead haciendo due diligence. Escanea este proyecto y genera informe: 1) Stack detectado (lenguajes, frameworks, DBs), 2) Estructura de carpetas, 3) Puntos de entrada (main.py, index.html), 4) Dependencias cr√≠ticas, 5) Red flags: c√≥digo muerto, secrets expuestos, deuda t√©cnica, 6) Siguiente paso recomendado.`,
                        flow: ["python", "loguru", "markdown"],
                        flowDesc: "Proyecto ‚Üí Escanear ‚Üí Analizar ‚Üí Informe ejecutivo"
                    },
                    {
                        id: "simplificador-kiss",
                        name: "Simplificador KISS",
                        emoji: "‚úÇÔ∏è",
                        problem: "Sospechas que tu c√≥digo est√° sobre-engineered.",
                        prompt: `Act√∫a como Senior Developer minimalista. Revisa este c√≥digo con filosof√≠a KISS. Identifica: 1) Abstracciones prematuras (clases usadas una vez), 2) Patrones de dise√±o innecesarios, 3) Configuraci√≥n excesiva, 4) C√≥digo "por si acaso" que nunca se ejecuta. Para cada hallazgo: c√≥digo actual vs versi√≥n simplificada.`,
                        flow: ["python", "loguru"],
                        flowDesc: "C√≥digo complejo ‚Üí Identificar excesos ‚Üí Simplificar ‚Üí KISS"
                    }
                ]
            }
        };

        const nodeDetails = {
            fastapi: { title: "FastAPI", role: "Arquitecto Senior", desc: "Servidor as√≠ncrono. Maneja las peticiones de entrada.", code: "@app.post('/ingest')\nasync def ingest(file: UploadFile):\n    await process_file(file)\n    return {'status': 'ok'}", goal: "Crear endpoint no bloqueante para subida de archivos." },
            chroma: { title: "ChromaDB", role: "Arquitecto Datos", desc: "Base de datos vectorial para b√∫squeda sem√°ntica.", code: "client = chromadb.PersistentClient(path='./db')\ncollection.add(embeddings=[vector])", goal: "Configurar cliente persistente y esquema de colecci√≥n." },
            pillow: { title: "Pillow / OpenCV", role: "Ingeniero Datos", desc: "Pre-procesado de imagen: redimensi√≥n y normalizaci√≥n.", code: "img = Image.open(file).resize((224,224))\nimg_array = np.array(img)", goal: "Funci√≥n para limpiar EXIF y normalizar tama√±o para CLIP." },
            clip: { title: "OpenAI CLIP", role: "Ingeniero IA", desc: "Convierte im√°genes y texto en vectores matem√°ticos.", code: "inputs = processor(images=img, return_tensors='pt')\nembeds = model.get_image_features(**inputs)", goal: "Implementar extracci√≥n de embeddings usando HuggingFace Transformers." },
            whisper: { title: "OpenAI Whisper", role: "Ingeniero IA", desc: "Transcribe audio a texto con alta precisi√≥n.", code: "model = whisper.load_model('base')\nresult = model.transcribe('audio.mp3')", goal: "Script para transcribir audio optimizado para CPU." },
            ffmpeg: { title: "FFmpeg", role: "DevOps / Media", desc: "Herramienta de l√≠nea de comandos para manipular A/V.", code: "subprocess.run(['ffmpeg', '-i', input, output])", goal: "Wrapper de Python seguro para comandos FFmpeg." },
            python: { title: "Python 3.11", role: "Backend Dev", desc: "Lenguaje base del ecosistema.", code: "def main():\n    print('Hello minerOS')", goal: "Script base de Python con buenas pr√°cticas." },
            html: { title: "HTML5 Sem√°ntico", role: "Frontend Dev", desc: "Estructura de la interfaz.", code: "<article class='card'>\n  <h2>T√≠tulo</h2>\n</article>", goal: "Template HTML5 base con meta tags." },
            css: { title: "Tailwind CSS", role: "Frontend Dev", desc: "Estilos r√°pidos.", code: "<div class='p-4 bg-slate-900 text-white'>", goal: "Configurar CDN de Tailwind." },
            htmx: { title: "HTMX", role: "Frontend Dev", desc: "L√≥gica de interacci√≥n en HTML.", code: "<button hx-post='/api/action' hx-swap='outerHTML'>", goal: "Bot√≥n interactivo con HTMX." }
        };

        // ============================================
        // FLUJOS T√ÅCTICOS - APP STORE DE ARQUITECTURAS
        // ============================================
        const FLOWS_DATA = {
            // üìÇ Categor√≠a A: CONOCIMIENTO & RAG
            "docmine-classic": {
                title: "DocMine Classic",
                emoji: "üìÑ",
                desc: "Chat con tus PDFs y documentos. RAG simple pero efectivo.",
                category: "knowledge",
                stack: ["fastapi", "python", "chroma", "ollama"],
                complexity: "low",
                cost: "local",
                useCase: "Consultar manuales t√©cnicos, contratos, documentaci√≥n interna.",
                flowDesc: "Documento ‚Üí Chunking ‚Üí Embeddings ‚Üí ChromaDB ‚Üí Query ‚Üí LLM responde",
                prompt: `Act√∫a como Arquitecto RAG. Implementa un pipeline DocMine:
1. FastAPI endpoint para subir PDFs
2. PyMuPDF para extraer texto
3. Chunking con overlap (500 chars, 50 overlap)
4. Sentence-BERT para embeddings
5. ChromaDB para persistencia
6. Ollama (llama3) para respuestas
Entrega c√≥digo modular en services/, routers/.`
            },
            "research-synthesizer": {
                title: "Research Synthesizer",
                emoji: "üî¨",
                desc: "Genera informes a partir de m√∫ltiples fuentes. Deep research.",
                category: "knowledge",
                stack: ["python", "chroma", "claude", "markdown"],
                complexity: "high",
                cost: "api",
                useCase: "Estado del arte de una tecnolog√≠a, comparativas, investigaci√≥n.",
                flowDesc: "Tema ‚Üí Multi-query ChromaDB ‚Üí Reranking ‚Üí Claude sintetiza ‚Üí Markdown",
                prompt: `Act√∫a como Research Engineer. Crea un sintetizador que:
1. Reciba un tema de investigaci√≥n
2. Genere 5 queries diferentes (Multi-Query RAG)
3. Busque en ChromaDB con cada query
4. Reordene por relevancia (cross-encoder)
5. Pase contexto a Claude con prompt estructurado
6. Genere informe Markdown con citas
Output: Informe con secciones, bullet points y fuentes.`
            },
            "voice-to-knowledge": {
                title: "Voice-to-Knowledge",
                emoji: "üé§",
                desc: "Convierte audios en notas estructuradas para Obsidian.",
                category: "knowledge",
                stack: ["whisper", "python", "ollama", "markdown"],
                complexity: "mid",
                cost: "local",
                useCase: "Diario personal hablado, ideas al conducir, reuniones.",
                flowDesc: "Audio ‚Üí Whisper transcribe ‚Üí Ollama limpia/resume ‚Üí Obsidian .md",
                prompt: `Act√∫a como Knowledge Engineer. Pipeline de voz a notas:
1. Watchdog detecta .mp3/.m4a en carpeta inbox/
2. Whisper (base) transcribe a texto raw
3. Ollama (llama3) limpia muletillas y estructura
4. Genera YAML frontmatter (fecha, tags inferidos)
5. Guarda en vault/diario/ con nombre fecha-hora.md
Incluye manejo de errores y logs con Loguru.`
            },
            // üìÇ Categor√≠a B: MEDIA & CREATIVIDAD
            "videomine-search": {
                title: "VideoMine Search",
                emoji: "üé¨",
                desc: "Busca el momento exacto en cualquier video por texto.",
                category: "media",
                stack: ["ffmpeg", "clip", "whisper", "chroma", "fastapi"],
                complexity: "high",
                cost: "local",
                useCase: "Buscar en videos familiares, tutoriales, conferencias grabadas.",
                flowDesc: "Video ‚Üí FFmpeg (frames+audio) ‚Üí CLIP+Whisper ‚Üí ChromaDB ‚Üí API b√∫squeda",
                prompt: `Act√∫a como Media Search Engineer. Sistema VideoMine:
1. FFmpeg extrae frame cada 5 segundos + audio completo
2. CLIP genera embeddings de cada frame
3. Whisper transcribe audio con timestamps
4. ChromaDB indexa ambos (visual + texto)
5. FastAPI endpoint de b√∫squeda multimodal
6. Retorna timestamp exacto + thumbnail
Optimiza para Apple Silicon (MPS).`
            },
            "smart-gallery": {
                title: "Smart Gallery",
                emoji: "üñºÔ∏è",
                desc: "Organiza 10.000 fotos autom√°ticamente sin tocarlas.",
                category: "media",
                stack: ["python", "clip", "sqlite", "html", "watchdog"],
                complexity: "mid",
                cost: "local",
                useCase: "PhotoMine v2, organizar biblioteca familiar, portfolio.",
                flowDesc: "Watchdog detecta ‚Üí CLIP analiza ‚Üí SQLite metadata ‚Üí HTML5 galer√≠a",
                prompt: `Act√∫a como Photo Engineer. Sistema Smart Gallery:
1. Watchdog monitorea carpeta de fotos
2. CLIP genera tags autom√°ticos (top 10 conceptos)
3. SQLite guarda: path, hash, tags, fecha EXIF, GPS
4. HTML5 galer√≠a est√°tica con filtros por tag
5. B√∫squeda sem√°ntica por texto
6. No mueve archivos, solo indexa
Incluye detecci√≥n de duplicados por hash perceptual.`
            },
            "podcast-generator": {
                title: "Podcast Generator",
                emoji: "üéôÔ∏è",
                desc: "Convierte art√≠culos en audio para escuchar.",
                category: "media",
                stack: ["python", "ollama", "ffmpeg"],
                complexity: "mid",
                cost: "local",
                useCase: "Consumir noticias mientras cocinas, art√≠culos largos, newsletters.",
                flowDesc: "URL/Texto ‚Üí Scraper ‚Üí Ollama guioniza ‚Üí TTS local ‚Üí MP3",
                prompt: `Act√∫a como Audio Content Engineer. Pipeline podcast:
1. BeautifulSoup extrae texto limpio de URL
2. Ollama reescribe como gui√≥n de podcast (m√°s conversacional)
3. TTS local (piper/kokoro) genera audio
4. FFmpeg a√±ade intro/outro music
5. Guarda en podcast/ con metadata ID3
6. Genera feed RSS opcional
Target: 10 minutos de lectura ‚Üí 8 min audio.`
            },
            // üìÇ Categor√≠a C: AUTOMATIZACI√ìN & DATOS
            "smart-scraper": {
                title: "Smart Scraper",
                emoji: "üï∑Ô∏è",
                desc: "Extrae datos estructurados de cualquier web con IA.",
                category: "automation",
                stack: ["python", "bs4", "claude", "sqlite", "loguru"],
                complexity: "mid",
                cost: "api",
                useCase: "Comparador de precios, monitor de BOE, tracking de productos.",
                flowDesc: "URL ‚Üí HTTPX fetch ‚Üí Claude extrae JSON ‚Üí Valida ‚Üí SQLite",
                prompt: `Act√∫a como Scraping Engineer. Sistema inteligente:
1. HTTPX con retry y rate limiting
2. BeautifulSoup parsea HTML
3. Claude extrae datos seg√∫n schema Pydantic definido
4. Validaci√≥n estricta antes de guardar
5. SQLite con hist√≥rico (tracking de cambios)
6. Loguru registra cada operaci√≥n
Incluye modo --dry-run y ejemplos de schemas.`
            },
            "sql-oracle": {
                title: "SQL Oracle",
                emoji: "üîÆ",
                desc: "Pregunta a tu base de datos en lenguaje natural.",
                category: "automation",
                stack: ["fastapi", "claude", "pydantic", "sqlite"],
                complexity: "mid",
                cost: "api",
                useCase: "Dashboard de ventas sin saber SQL, reportes ad-hoc.",
                flowDesc: "Pregunta ‚Üí Claude genera SQL ‚Üí Valida ‚Üí Ejecuta ‚Üí Formatea respuesta",
                prompt: `Act√∫a como Data Engineer. Sistema Text-to-SQL:
1. FastAPI recibe pregunta en espa√±ol
2. Inyecta schema de tablas en prompt
3. Claude genera SQL (solo SELECT, no modificaciones)
4. Regex valida que no haya DROP/DELETE/UPDATE
5. Ejecuta query y formatea resultado
6. Cachea queries frecuentes
Incluye ejemplos few-shot en el prompt.`
            },
            "file-organizer": {
                title: "File Organizer",
                emoji: "üìÅ",
                desc: "Limpia la carpeta Descargas autom√°ticamente con IA.",
                category: "automation",
                stack: ["python", "ocr", "ollama", "loguru", "watchdog"],
                complexity: "low",
                cost: "local",
                useCase: "Ordenar facturas, organizar documentos recibidos.",
                flowDesc: "Watchdog detecta ‚Üí OCR si es imagen ‚Üí Ollama clasifica ‚Üí Mueve",
                prompt: `Act√∫a como Automation Engineer. Organizador inteligente:
1. Watchdog monitorea ~/Downloads
2. Por extensi√≥n: PDF/im√°genes ‚Üí OCR extrae texto
3. Ollama clasifica: factura, recibo, documento, imagen, otro
4. Mueve a carpetas: facturas/, recibos/, docs/, fotos/
5. Renombra con patr√≥n: YYYY-MM-DD_tipo_descripcion
6. Log de cada movimiento
Modo --dry-run para probar antes de activar.`
            },
            // üìÇ Categor√≠a D: DEVOPS & CALIDAD
            "code-reviewer": {
                title: "Code Reviewer",
                emoji: "üëÄ",
                desc: "Revisa tu c√≥digo antes de hacer commit.",
                category: "devops",
                stack: ["git", "python", "claude", "loguru"],
                complexity: "low",
                cost: "api",
                useCase: "CI/CD local, pre-commit hook, code quality.",
                flowDesc: "git diff ‚Üí Claude analiza ‚Üí Reporte severidad ‚Üí Aprueba/Rechaza",
                prompt: `Act√∫a como Code Review Bot. Sistema de revisi√≥n:
1. git diff --staged captura cambios
2. Claude analiza buscando:
   - Vulnerabilidades de seguridad
   - Code smells
   - Falta de type hints
   - Complejidad ciclom√°tica
3. Genera reporte con severidad (critical/warning/info)
4. Exit code 1 si hay cr√≠ticos (bloquea commit)
Integrable como pre-commit hook.`
            },
            "privacy-shield": {
                title: "Privacy Shield",
                emoji: "üõ°Ô∏è",
                desc: "Censura datos sensibles en documentos autom√°ticamente.",
                category: "devops",
                stack: ["python", "ocr", "loguru"],
                complexity: "low",
                cost: "local",
                useCase: "Compartir logs sin exponer datos, anonimizar documentos.",
                flowDesc: "Documento ‚Üí OCR si necesario ‚Üí Regex/Spacy detecta ‚Üí Censura ‚Üí Copia limpia",
                prompt: `Act√∫a como Security Engineer. Redactor de PII:
1. Detecta tipo de archivo (texto, PDF, imagen)
2. OCR si es imagen/PDF escaneado
3. Regex detecta: DNI, tel√©fonos, emails, IBANs, IPs
4. Opcional: Spacy NER para nombres propios
5. Genera copia con [REDACTED]
6. Log de cada dato censurado (sin el dato)
100% local, sin APIs externas.`
            },
            "api-gateway": {
                title: "API Gateway",
                emoji: "üö™",
                desc: "Unifica todos tus microservicios locales en un solo punto.",
                category: "devops",
                stack: ["fastapi", "pydantic", "loguru"],
                complexity: "mid",
                cost: "local",
                useCase: "Exponer herramientas minerOS de forma segura, API unificada.",
                flowDesc: "Request ‚Üí Auth ‚Üí Route ‚Üí Proxy al servicio ‚Üí Log ‚Üí Response",
                prompt: `Act√∫a como API Architect. Gateway unificado:
1. FastAPI como punto de entrada √∫nico
2. Rutas: /photos/* ‚Üí PhotoMine, /docs/* ‚Üí DocMine, etc.
3. Middleware de autenticaci√≥n (API key simple)
4. Rate limiting por IP
5. Loguru registra cada request
6. Health checks a cada servicio
7. Swagger unificado en /docs
Incluye docker-compose para orquestar.`
            }
        };

        const FLOW_CATEGORIES = {
            "knowledge": { name: "Conocimiento & RAG", icon: "fa-brain", color: "text-purple-400", bg: "bg-purple-500/10", border: "border-purple-500/30" },
            "media": { name: "Media & Creatividad", icon: "fa-photo-film", color: "text-pink-400", bg: "bg-pink-500/10", border: "border-pink-500/30" },
            "automation": { name: "Automatizaci√≥n", icon: "fa-robot", color: "text-amber-400", bg: "bg-amber-500/10", border: "border-amber-500/30" },
            "devops": { name: "DevOps & Calidad", icon: "fa-shield-halved", color: "text-green-400", bg: "bg-green-500/10", border: "border-green-500/30" }
        };

        const COMPLEXITY_LABELS = {
            "low": { label: "F√°cil", icon: "üü¢", class: "bg-green-500/20 text-green-400 border-green-500/30" },
            "mid": { label: "Media", icon: "üü°", class: "bg-yellow-500/20 text-yellow-400 border-yellow-500/30" },
            "high": { label: "Alta", icon: "üî¥", class: "bg-red-500/20 text-red-400 border-red-500/30" }
        };

        const COST_LABELS = {
            "local": { label: "Local", icon: "üíª", desc: "Ollama/CPU", class: "bg-emerald-500/20 text-emerald-400 border-emerald-500/30" },
            "api": { label: "API", icon: "üí∏", desc: "Claude/OpenAI", class: "bg-orange-500/20 text-orange-400 border-orange-500/30" }
        };

        // ============================================
        // 2. ARQUITECTO PRO (CORE)
        // ============================================
        let canvasNodes = [];

        // ============================================
        // SISTEMA DE HISTORIAL (UNDO/REDO) v9.1
        // ============================================
        let canvasHistory = [[]];
        let historyIndex = 0;
        const MAX_HISTORY = 50;

        function saveToHistory() {
            // Truncar historial si estamos en medio
            if (historyIndex < canvasHistory.length - 1) {
                canvasHistory = canvasHistory.slice(0, historyIndex + 1);
            }
            // Guardar copia profunda del estado actual
            canvasHistory.push(JSON.parse(JSON.stringify(canvasNodes)));
            // Limitar tama√±o del historial
            if (canvasHistory.length > MAX_HISTORY) {
                canvasHistory.shift();
            } else {
                historyIndex++;
            }
            updateHistoryButtons();
        }

        function canvasUndo() {
            if (historyIndex > 0) {
                historyIndex--;
                canvasNodes = JSON.parse(JSON.stringify(canvasHistory[historyIndex]));
                renderCanvas();
                validateFlowRealtime();
                updateHistoryButtons();
                addLog("INFO", "Deshacer: estado restaurado");
            }
        }

        function canvasRedo() {
            if (historyIndex < canvasHistory.length - 1) {
                historyIndex++;
                canvasNodes = JSON.parse(JSON.stringify(canvasHistory[historyIndex]));
                renderCanvas();
                validateFlowRealtime();
                updateHistoryButtons();
                addLog("INFO", "Rehacer: estado restaurado");
            }
        }

        function updateHistoryButtons() {
            const undoBtn = document.getElementById('btn-undo');
            const redoBtn = document.getElementById('btn-redo');
            if (undoBtn) undoBtn.disabled = historyIndex <= 0;
            if (redoBtn) redoBtn.disabled = historyIndex >= canvasHistory.length - 1;
        }

        // ============================================
        // EXPORTAR PIPELINE COMO JSON v9.1
        // ============================================
        function exportPipelineJSON() {
            if (canvasNodes.length === 0) {
                showToast('A√±ade herramientas al canvas primero', 'error');
                return;
            }

            const pipeline = {
                version: "1.0",
                name: `Pipeline ${new Date().toLocaleDateString()}`,
                created: new Date().toISOString(),
                nodes: canvasNodes.map((n, i) => ({
                    id: n.id,
                    name: n.name,
                    category: n.cat,
                    position: i
                })),
                connections: canvasNodes.slice(0, -1).map((n, i) => ({
                    from: n.id,
                    to: canvasNodes[i + 1].id
                })),
                metadata: {
                    tool_count: canvasNodes.length,
                    categories: [...new Set(canvasNodes.map(n => n.cat))]
                }
            };

            const blob = new Blob([JSON.stringify(pipeline, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `directos-pipeline-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            addLog("SUCCESS", `Pipeline exportado como JSON (${canvasNodes.length} nodos)`);
            showToast('Pipeline exportado', 'success');
        }

        const toolbox = document.getElementById('architect-toolbox');
        const canvas = document.getElementById('architect-canvas');

        // Funci√≥n para renderizar la toolbox (llamada despu√©s de cargar API)
        function renderToolbox() {
            if (!toolbox) return;
            toolbox.innerHTML = ''; // Limpiar antes de renderizar
            getTools().forEach(t => {
                const el = document.createElement('div');
                const bc = catStyles[t.cat] || "border-slate-700";
                el.className = `draggable-tool bg-slate-800 border-l-4 ${bc} border-y border-r border-slate-700 p-2.5 rounded-r-lg flex items-center justify-between gap-2 hover:bg-slate-700 cursor-grab active:cursor-grabbing mb-1.5 transition`;
                el.draggable = true;
                el.innerHTML = `<div class="flex items-center gap-2"><i class="fa-solid ${t.icon} ${t.color} text-sm"></i><div><span class="text-xs font-bold block">${t.name}</span></div></div><i class="fa-solid fa-plus text-slate-600 text-[10px]"></i>`;
                el.ondragstart = (ev) => { ev.dataTransfer.setData("toolId", t.id); ev.dataTransfer.effectAllowed = "copy"; };
                el.onclick = () => addNodeToCanvas(t.id);
                toolbox.appendChild(el);
            });
            console.log(`[TOOLBOX] Renderizadas ${getTools().length} herramientas (${getTools().filter(t => t.isTrigger).length} triggers)`);
        }

        // Init Toolbox inicial (con FALLBACK mientras carga API)
        renderToolbox();

        // ============================================
        // PIPELINE BUILDER PRO - v10.0
        // Canvas interactivo con zoom, pan, conexiones draggables
        // ============================================
        const nodesContainer = document.getElementById('nodes-container');
        const connectionsSvg = document.getElementById('connections-svg');
        const pipelineCanvas = document.getElementById('pipeline-canvas');
        const canvasTransform = document.getElementById('canvas-transform');
        const canvasGrid = document.getElementById('canvas-grid');

        // Estado del canvas
        let canvasState = {
            zoom: 1,
            panX: 0,
            panY: 0,
            isPanning: false,
            panStartX: 0,
            panStartY: 0,
            selectedNodeId: null,
            // Estado para conexiones
            isConnecting: false,
            connectingFrom: null,
            // Estado para drag de nodos
            isDraggingNode: false,
            dragNodeId: null,
            dragOffsetX: 0,
            dragOffsetY: 0
        };

        // Conexiones entre nodos: [{from: nodeId, to: nodeId}]
        let nodeConnections = [];

        // Posiciones de nodos: {nodeId: {x, y}}
        let nodePositions = {};

        // ============================================
        // ZOOM FUNCTIONS
        // ============================================
        function canvasZoomIn() {
            canvasState.zoom = Math.min(2, canvasState.zoom + 0.1);
            updateCanvasTransform();
        }

        function canvasZoomOut() {
            canvasState.zoom = Math.max(0.3, canvasState.zoom - 0.1);
            updateCanvasTransform();
        }

        function canvasZoomReset() {
            canvasState.zoom = 1;
            canvasState.panX = 0;
            canvasState.panY = 0;
            updateCanvasTransform();
        }

        function updateCanvasTransform() {
            if (!canvasTransform || !canvasGrid) return;
            const transform = `translate(${canvasState.panX}px, ${canvasState.panY}px) scale(${canvasState.zoom})`;
            canvasTransform.style.transform = transform;
            canvasGrid.style.transform = transform;
            canvasGrid.style.backgroundSize = `${20 * canvasState.zoom}px ${20 * canvasState.zoom}px`;
            document.getElementById('zoom-level').textContent = `${Math.round(canvasState.zoom * 100)}%`;
            drawConnections();
        }

        // Zoom con scroll
        if (pipelineCanvas) {
            pipelineCanvas.addEventListener('wheel', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? -0.1 : 0.1;
                    canvasState.zoom = Math.max(0.3, Math.min(2, canvasState.zoom + delta));
                    updateCanvasTransform();
                }
            }, { passive: false });

            // Pan con click derecho o click medio
            pipelineCanvas.addEventListener('mousedown', (e) => {
                // Solo si es click en el fondo (no en un nodo)
                if (e.target === pipelineCanvas || e.target === canvasTransform || e.target === canvasGrid || e.target.id === 'nodes-container') {
                    if (e.button === 1 || (e.button === 0 && e.target !== nodesContainer)) { // Middle click o click en grid
                        canvasState.isPanning = true;
                        canvasState.panStartX = e.clientX - canvasState.panX;
                        canvasState.panStartY = e.clientY - canvasState.panY;
                        pipelineCanvas.style.cursor = 'grabbing';
                    }
                }
            });

            pipelineCanvas.addEventListener('mousemove', (e) => {
                if (canvasState.isPanning) {
                    canvasState.panX = e.clientX - canvasState.panStartX;
                    canvasState.panY = e.clientY - canvasState.panStartY;
                    updateCanvasTransform();
                }
                // Actualizar l√≠nea temporal de conexi√≥n
                if (canvasState.isConnecting) {
                    updateTempConnection(e.clientX, e.clientY);
                }
                // Drag de nodo
                if (canvasState.isDraggingNode && canvasState.dragNodeId) {
                    const rect = pipelineCanvas.getBoundingClientRect();
                    let x = (e.clientX - rect.left - canvasState.panX) / canvasState.zoom - canvasState.dragOffsetX;
                    let y = (e.clientY - rect.top - canvasState.panY) / canvasState.zoom - canvasState.dragOffsetY;
                    // Snap to Grid (20px)
                    const gridSize = 20;
                    x = Math.round(x / gridSize) * gridSize;
                    y = Math.round(y / gridSize) * gridSize;
                    nodePositions[canvasState.dragNodeId] = { x: Math.max(0, x), y: Math.max(0, y) };
                    renderCanvas();
                }
            });

            pipelineCanvas.addEventListener('mouseup', (e) => {
                if (canvasState.isPanning) {
                    canvasState.isPanning = false;
                    pipelineCanvas.style.cursor = 'default';
                }
                if (canvasState.isDraggingNode) {
                    canvasState.isDraggingNode = false;
                    canvasState.dragNodeId = null;
                    document.querySelectorAll('.pipeline-node-pro.dragging').forEach(n => n.classList.remove('dragging'));
                    saveToHistory();
                }
                if (canvasState.isConnecting) {
                    // Verificar si solt√≥ sobre un puerto de entrada
                    const port = e.target.closest('.port-in');
                    if (port) {
                        const toNodeId = port.dataset.nodeId;
                        if (toNodeId !== canvasState.connectingFrom) {
                            // Validar conexi√≥n
                            const validation = validateConnection(canvasState.connectingFrom, toNodeId);
                            if (validation.valid) {
                                // Crear conexi√≥n si no existe
                                const exists = nodeConnections.some(c => c.from === canvasState.connectingFrom && c.to === toNodeId);
                                if (!exists) {
                                    nodeConnections.push({ from: canvasState.connectingFrom, to: toNodeId });
                                    drawConnections();
                                    saveToHistory();
                                }
                            } else {
                                showToast(validation.reason, 'error');
                            }
                        }
                    }
                    endConnecting();
                }
            });

            pipelineCanvas.addEventListener('mouseleave', () => {
                if (canvasState.isPanning) {
                    canvasState.isPanning = false;
                    pipelineCanvas.style.cursor = 'default';
                }
            });
        }

        // ============================================
        // VALIDACI√ìN DE CONEXIONES
        // ============================================
        function validateConnection(fromId, toId) {
            const fromNode = canvasNodes.find(n => n.id === fromId);
            const toNode = canvasNodes.find(n => n.id === toId);

            if (!fromNode || !toNode) {
                return { valid: false, reason: 'Nodo no encontrado' };
            }

            // Regla 1: No conectar trigger a trigger
            const fromIsTrigger = fromNode.isTrigger || fromNode.cat === 'Trigger' || fromId.startsWith('trigger-');
            const toIsTrigger = toNode.isTrigger || toNode.cat === 'Trigger' || toId.startsWith('trigger-');
            if (fromIsTrigger && toIsTrigger) {
                return { valid: false, reason: 'No se pueden conectar dos triggers' };
            }

            // Regla 2: No conectar output a output
            const fromIsOutput = fromNode.isOutput || fromNode.cat === 'Output' || fromId.startsWith('output-');
            const toIsOutput = toNode.isOutput || toNode.cat === 'Output' || toId.startsWith('output-');
            if (fromIsOutput && toIsOutput) {
                return { valid: false, reason: 'No se pueden conectar dos outputs' };
            }

            // Regla 3: No crear ciclos (conexi√≥n que va hacia atr√°s)
            const wouldCreateCycle = checkCycle(fromId, toId);
            if (wouldCreateCycle) {
                return { valid: false, reason: 'Esta conexi√≥n crear√≠a un ciclo' };
            }

            // Regla 4: El nodo destino ya tiene una entrada (excepto flow-if)
            const existingInput = nodeConnections.find(c => c.to === toId);
            if (existingInput && toId !== 'flow-if') {
                return { valid: false, reason: 'Este nodo ya tiene una entrada' };
            }

            return { valid: true };
        }

        function checkCycle(fromId, toId) {
            // BFS para detectar si toId puede llegar a fromId (lo que crear√≠a ciclo)
            const visited = new Set();
            const queue = [toId];

            while (queue.length > 0) {
                const current = queue.shift();
                if (current === fromId) return true;
                if (visited.has(current)) continue;
                visited.add(current);

                // Encontrar conexiones salientes desde current
                nodeConnections
                    .filter(c => c.from === current)
                    .forEach(c => queue.push(c.to));
            }
            return false;
        }

        // ============================================
        // CONEXIONES
        // ============================================
        function startConnecting(nodeId, e) {
            e.stopPropagation();
            canvasState.isConnecting = true;
            canvasState.connectingFrom = nodeId;
            document.querySelectorAll('.port-out').forEach(p => p.classList.add('connecting'));
            const tempLine = document.getElementById('temp-connection');
            if (tempLine) tempLine.style.display = 'block';
        }

        function endConnecting() {
            canvasState.isConnecting = false;
            canvasState.connectingFrom = null;
            document.querySelectorAll('.node-port').forEach(p => p.classList.remove('connecting'));
            const tempLine = document.getElementById('temp-connection');
            if (tempLine) {
                tempLine.style.display = 'none';
                tempLine.setAttribute('d', '');
            }
        }

        function updateTempConnection(mouseX, mouseY) {
            if (!canvasState.connectingFrom) return;

            const fromPos = nodePositions[canvasState.connectingFrom];
            if (!fromPos) return;

            const nodeWidth = 260;
            const nodeHeight = 70;

            // Punto de inicio: puerto de salida del nodo
            const x1 = fromPos.x + nodeWidth + 6;
            const y1 = fromPos.y + nodeHeight / 2;

            // Punto final: posici√≥n del mouse en coordenadas del canvas
            const rect = pipelineCanvas.getBoundingClientRect();
            const x2 = (mouseX - rect.left - canvasState.panX) / canvasState.zoom;
            const y2 = (mouseY - rect.top - canvasState.panY) / canvasState.zoom;

            const tempLine = document.getElementById('temp-connection');
            if (tempLine) {
                const dx = Math.abs(x2 - x1);
                const controlOffset = Math.max(30, dx * 0.3);
                tempLine.setAttribute('d', `M ${x1} ${y1} C ${x1 + controlOffset} ${y1}, ${x2 - controlOffset} ${y2}, ${x2} ${y2}`);
                tempLine.style.display = 'block';
            }
        }

        function removeConnection(fromId, toId) {
            nodeConnections = nodeConnections.filter(c => !(c.from === fromId && c.to === toId));
            drawConnections();
            saveToHistory();
        }

        // ============================================
        // DRAG & DROP NODOS
        // ============================================
        if (nodesContainer) {
            nodesContainer.ondragover = (ev) => { ev.preventDefault(); ev.dataTransfer.dropEffect = "copy"; };
            nodesContainer.ondrop = (ev) => {
                ev.preventDefault();
                const toolId = ev.dataTransfer.getData("toolId");
                if (toolId) {
                    const rect = pipelineCanvas.getBoundingClientRect();
                    const x = (ev.clientX - rect.left - canvasState.panX) / canvasState.zoom;
                    const y = (ev.clientY - rect.top - canvasState.panY) / canvasState.zoom;
                    addNodeToCanvas(toolId, x, y);
                }
            };
        }

        function addNodeToCanvas(toolId, x = null, y = null) {
            const tool = getTools().find(t => t.id === toolId);
            if(tool && !canvasNodes.find(n => n.id === toolId)) {
                console.log(`[ADD NODE] ${tool.name} - isTrigger: ${tool.isTrigger}`);
                canvasNodes.push({...tool});
                // Posici√≥n: si no se especifica, calcular basado en nodos existentes
                if (x === null || y === null) {
                    const count = Object.keys(nodePositions).length;
                    x = 100 + (count % 3) * 320;
                    y = 100 + Math.floor(count / 3) * 160;
                }
                nodePositions[toolId] = { x, y };
                saveToHistory();
                renderCanvas();
                validateFlowRealtime();
            }
        }

        function removeNode(nodeId) {
            const index = canvasNodes.findIndex(n => n.id === nodeId);
            if (index > -1) {
                canvasNodes.splice(index, 1);
                delete nodePositions[nodeId];
                // Eliminar conexiones relacionadas
                nodeConnections = nodeConnections.filter(c => c.from !== nodeId && c.to !== nodeId);
                saveToHistory();
                renderCanvas();
                validateFlowRealtime();
            }
        }

        function selectNode(nodeId) {
            canvasState.selectedNodeId = nodeId;
            document.querySelectorAll('.pipeline-node-pro').forEach(n => n.classList.remove('selected'));
            const node = document.querySelector(`[data-node-id="${nodeId}"]`);
            if (node) node.classList.add('selected');
            // Mostrar panel de configuraci√≥n
            showNodeConfig(nodeId);
        }

        function startDraggingNode(nodeId, e) {
            if (e.target.closest('.node-port')) return; // No drag si es un puerto
            e.stopPropagation();
            canvasState.isDraggingNode = true;
            canvasState.dragNodeId = nodeId;
            const node = document.querySelector(`[data-node-id="${nodeId}"]`);
            if (node) {
                node.classList.add('dragging');
                const rect = node.getBoundingClientRect();
                const canvasRect = pipelineCanvas.getBoundingClientRect();
                canvasState.dragOffsetX = (e.clientX - rect.left) / canvasState.zoom;
                canvasState.dragOffsetY = (e.clientY - rect.top) / canvasState.zoom;
            }
        }

        function clearCanvas() {
            if (canvasNodes.length === 0) return;
            if (confirm('¬øLimpiar todo el canvas?')) {
                canvasNodes = [];
                nodePositions = {};
                nodeConnections = [];
                canvasState.selectedNodeId = null;
                saveToHistory();
                renderCanvas();
                hideNodeConfig();
                addLog("INFO", "Canvas limpiado");
            }
        }

        // Nodo seleccionado para eliminar con tecla
        let selectedNodeIndex = null;

        // ============================================
        // ARQUITECTURAS - SAVE/LOAD (Offline-First)
        // ============================================

        function saveArchitecture() {
            if (canvasNodes.length === 0) {
                showToast('A√±ade herramientas al canvas primero', 'error');
                return;
            }

            const name = prompt('Nombre de la arquitectura:', `Arquitectura ${new Date().toLocaleDateString()}`);
            if (!name) return;

            const description = prompt('Descripci√≥n (opcional):', '');

            const archData = {
                name,
                description: description || '',
                nodes: canvasNodes.map(n => ({ id: n.id, name: n.name, cat: n.cat })),
                stack: canvasNodes.map(n => n.name).join(' ‚Üí ')
            };

            const saved = OfflineStore.create('architectures', archData);
            showToast(`Arquitectura "${name}" guardada (${canvasNodes.length} nodos)`, 'success');
            addLog("SUCCESS", `Arquitectura "${name}" guardada (${canvasNodes.length} nodos)`);

            // Refrescar selector de presets
            initPresets();

            // Mostrar estado de sync
            if (!SyncManager.isServerReachable) {
                showToast("Se sincronizar√° cuando haya conexi√≥n", 'info');
            }
        }

        function loadArchitectureModal() {
            const architectures = OfflineStore.getAll('architectures');
            const loadList = document.getElementById('load-list');

            if (architectures.length === 0) {
                showToast('No hay arquitecturas guardadas', 'info');
                return;
            }

            // Renderizar lista en el modal
            loadList.innerHTML = architectures.map(arch => `
                <div class="flex items-center justify-between p-3 bg-slate-800 hover:bg-slate-700 rounded-lg cursor-pointer group" onclick="loadArchitectureById('${arch.id}')">
                    <div class="flex-1">
                        <p class="font-medium text-white">${arch.name}</p>
                        <p class="text-xs text-slate-400">${arch.nodes?.length || 0} nodos ${arch.synced === false ? '‚Ä¢ <span class="text-yellow-400">pendiente sync</span>' : ''}</p>
                    </div>
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                        <button onclick="event.stopPropagation(); deleteArchitecture('${arch.id}', '${arch.name}')" class="text-red-400 hover:text-red-300 p-1" title="Eliminar">
                            <i class="fa-solid fa-trash text-sm"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            // Mostrar modal
            document.getElementById('load-modal').classList.remove('hidden');
        }

        function loadArchitectureById(archId) {
            const arch = OfflineStore.getAll('architectures').find(a => a.id === archId);
            if (!arch) return;

            canvasNodes = [];

            // Reconstruir nodos desde IDs guardados
            (arch.nodes || []).forEach(savedNode => {
                const tool = getTools().find(t => t.id === savedNode.id);
                if (tool) {
                    canvasNodes.push({...tool});
                }
            });

            renderCanvas();
            validateFlowRealtime();
            closeModal('load-modal');
            showToast(`Arquitectura "${arch.name}" cargada`, 'success');
            addLog("SUCCESS", `Arquitectura "${arch.name}" cargada`);
        }

        function deleteArchitecture(archId, archName) {
            if (confirm(`¬øEliminar "${archName}"?`)) {
                OfflineStore.remove('architectures', archId);
                showToast(`Arquitectura "${archName}" eliminada`, 'info');
                addLog("INFO", `Arquitectura "${archName}" eliminada`);
                loadArchitectureModal(); // Refrescar lista
                initPresets(); // Refrescar selector
            }
        }

        function exportDiagram() {
            if (canvasNodes.length === 0) {
                showToast('A√±ade herramientas al canvas primero', 'error');
                return;
            }

            const canvas = document.getElementById('pipeline-canvas');
            if (!canvas) return;

            // Mostrar feedback
            addLog("INFO", "Generando imagen PNG...");

            html2canvas(canvas, {
                backgroundColor: '#0f172a',
                scale: 2,
                logging: false,
                useCORS: true
            }).then(canvasImg => {
                // Crear link de descarga
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().slice(0, 10);
                link.download = `directos-pipeline-${timestamp}.png`;
                link.href = canvasImg.toDataURL('image/png');
                link.click();

                addLog("SUCCESS", `Pipeline exportado como PNG`);
            }).catch(err => {
                console.error('Error exportando:', err);
                addLog("ERROR", "Error al exportar PNG");
            });
        }

        // ============================================
        // RENDER CANVAS PRO
        // ============================================
        function renderCanvas() {
            if (!nodesContainer) return;

            if (canvasNodes.length === 0) {
                nodesContainer.innerHTML = `<div id="canvas-placeholder" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 border-2 border-dashed border-slate-800 rounded-2xl flex flex-col items-center justify-center text-slate-600 p-12">
                    <i class="fa-solid fa-diagram-project text-4xl mb-3 text-slate-700"></i>
                    <p class="text-sm font-medium">Arrastra herramientas aqu√≠</p>
                    <p class="text-xs mt-1 text-slate-700">Ctrl+Scroll para zoom ‚Ä¢ Arrastra fondo para mover</p>
                </div>`;
                document.getElementById('node-count').textContent = '0';
                document.getElementById('connection-count').textContent = '0';
                return;
            }

            nodesContainer.innerHTML = '';
            const nodeWidth = 260;

            canvasNodes.forEach((node, index) => {
                // Usar posici√≥n guardada o calcular nueva
                if (!nodePositions[node.id]) {
                    const count = Object.keys(nodePositions).length;
                    nodePositions[node.id] = {
                        x: 100 + (count % 3) * 320,
                        y: 100 + Math.floor(count / 3) * 160
                    };
                }
                const pos = nodePositions[node.id];

                const bc = catStyles[node.cat] || "border-slate-600";
                // Detectar trigger por propiedad O por categor√≠a O por ID
                const isTrigger = node.isTrigger === true || node.cat === 'Trigger' || (node.id && node.id.startsWith('trigger-'));
                if (isTrigger) console.log(`[RENDER] ‚úÖ Trigger detectado: ${node.name}`);
                const nodeStatus = node.runStatus || 'idle';
                const isSelected = canvasState.selectedNodeId === node.id;

                const el = document.createElement('div');
                el.className = `pipeline-node-pro ${isTrigger ? 'is-trigger' : ''} ${isSelected ? 'selected' : ''}`;
                el.style.left = `${pos.x}px`;
                el.style.top = `${pos.y}px`;
                el.style.width = `${nodeWidth}px`;
                el.style.zIndex = isSelected ? 100 : 10;
                el.dataset.nodeId = node.id;

                // Bot√≥n de ejecuci√≥n para triggers
                const triggerButton = isTrigger ? `
                    <button onclick="event.stopPropagation(); executePipelineFromTrigger('${node.id}')"
                            class="mt-2 w-full py-1.5 px-2 rounded-lg bg-emerald-500/20 hover:bg-emerald-500/30 border border-emerald-500/50 text-emerald-400 text-xs font-medium transition flex items-center justify-center gap-2"
                            id="trigger-btn-${node.id}">
                        <i class="fa-solid fa-play text-[10px]"></i>
                        <span>Ejecutar</span>
                    </button>` : '';

                // Indicador de estado
                const statusColor = nodeStatus === 'running' ? '#eab308' : nodeStatus === 'success' ? '#22c55e' : nodeStatus === 'error' ? '#ef4444' : '#475569';

                el.innerHTML = `
                    <div class="bg-slate-800/95 backdrop-blur border border-slate-600 border-l-4 ${bc} p-3 rounded-xl shadow-xl hover:shadow-2xl hover:border-slate-500 transition-all relative">
                        <!-- Status indicator -->
                        <div class="absolute -top-1.5 -right-1.5 w-3 h-3 rounded-full border-2 border-slate-900" style="background: ${statusColor};"></div>

                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-lg ${isTrigger ? 'bg-emerald-900/50 border-emerald-700' : 'bg-slate-900 border-slate-700'} flex items-center justify-center border flex-shrink-0">
                                <i class="fa-solid ${node.icon} ${node.color} ${isTrigger ? 'animate-pulse' : ''}"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-white text-sm leading-tight truncate">${node.name}</h4>
                                <span class="text-[10px] text-slate-500 uppercase tracking-wider">${node.tag}</span>
                            </div>
                            <button onclick="event.stopPropagation(); removeNode('${node.id}')" class="text-slate-600 hover:text-red-400 transition p-1 hover:bg-red-500/10 rounded opacity-0 group-hover:opacity-100">
                                <i class="fa-solid fa-times text-xs"></i>
                            </button>
                        </div>
                        ${triggerButton}

                        <!-- Puertos de conexi√≥n -->
                        ${!isTrigger ? `<div class="node-port port-in" data-node-id="${node.id}" title="Entrada"></div>` : ''}
                        <div class="node-port port-out" data-node-id="${node.id}" title="Conectar" onmousedown="startConnecting('${node.id}', event)"></div>
                    </div>`;

                // Event listeners para drag y select
                el.addEventListener('mousedown', (e) => {
                    if (!e.target.closest('.node-port') && !e.target.closest('button')) {
                        selectNode(node.id);
                        startDraggingNode(node.id, e);
                    }
                });

                nodesContainer.appendChild(el);
            });

            // Dibujar conexiones
            drawConnections();
            document.getElementById('node-count').textContent = canvasNodes.length;
            document.getElementById('connection-count').textContent = nodeConnections.length;
        }

        // ============================================
        // DRAW CONNECTIONS PRO - FIXED
        // ============================================
        function drawConnections() {
            if (!connectionsSvg) return;

            // Mantener defs y temp-connection
            let paths = `
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
                    </marker>
                    <marker id="arrowhead-hover" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#ef4444"/>
                    </marker>
                </defs>
                <path id="temp-connection" class="connection-line-temp" d="" style="display: none;"/>
            `;

            const nodeWidth = 260;
            const nodeHeight = 70;

            // Dibujar cada conexi√≥n
            nodeConnections.forEach((conn, idx) => {
                const fromPos = nodePositions[conn.from];
                const toPos = nodePositions[conn.to];
                if (!fromPos || !toPos) return;

                // Puerto de salida (derecha del nodo FROM)
                const x1 = fromPos.x + nodeWidth + 6;
                const y1 = fromPos.y + nodeHeight / 2;

                // Puerto de entrada (izquierda del nodo TO)
                const x2 = toPos.x - 6;
                const y2 = toPos.y + nodeHeight / 2;

                // Curva bezier suave
                const dx = Math.abs(x2 - x1);
                const controlOffset = Math.max(50, dx * 0.4);

                paths += `
                    <path d="M ${x1} ${y1} C ${x1 + controlOffset} ${y1}, ${x2 - controlOffset} ${y2}, ${x2} ${y2}"
                        class="connection-line"
                        marker-end="url(#arrowhead)"
                        style="filter: drop-shadow(0 0 4px rgba(59, 130, 246, 0.3)); pointer-events: stroke; cursor: pointer;"
                        onclick="removeConnection('${conn.from}', '${conn.to}')"
                        data-from="${conn.from}" data-to="${conn.to}"/>
                `;
            });

            connectionsSvg.innerHTML = paths;
            document.getElementById('connection-count').textContent = nodeConnections.length;
        }

        function autoLayoutNodes() {
            if (canvasNodes.length === 0) return;

            // Reorganizar nodos en l√≠nea horizontal con conexiones secuenciales
            const nodeWidth = 260;
            const gapX = 120;
            const startX = 100;
            const startY = 150;

            // Limpiar conexiones anteriores
            nodeConnections = [];

            canvasNodes.forEach((node, index) => {
                // Posicionar en l√≠nea horizontal
                nodePositions[node.id] = {
                    x: startX + index * (nodeWidth + gapX),
                    y: startY
                };

                // Crear conexi√≥n secuencial con el siguiente nodo
                if (index < canvasNodes.length - 1) {
                    const nextNode = canvasNodes[index + 1];
                    nodeConnections.push({
                        from: node.id,
                        to: nextNode.id
                    });
                }
            });

            renderCanvas();
            saveToHistory();
            addLog("SUCCESS", `Nodos organizados con ${nodeConnections.length} conexiones`);
            showToast(`${canvasNodes.length} nodos conectados`, 'success');
        }

        // ============================================
        // NODE CONFIG PANEL
        // ============================================
        function showNodeConfig(nodeId) {
            const node = canvasNodes.find(n => n.id === nodeId);
            if (!node) return;

            const panel = document.getElementById('node-config-panel');
            if (!panel) return;

            // Ocultar panel de validaci√≥n si est√° visible
            document.getElementById('validation-panel')?.classList.add('hidden');

            // Llenar informaci√≥n del nodo
            const iconContainer = document.getElementById('config-node-icon');
            iconContainer.innerHTML = `<i class="fa-solid ${node.icon} ${node.color}"></i>`;

            document.getElementById('config-node-name').textContent = node.name;
            document.getElementById('config-node-tag').textContent = node.tag || node.cat;
            document.getElementById('config-node-desc').textContent = node.desc || node.why || 'Sin descripci√≥n';
            document.getElementById('config-node-code').textContent = node.code || '# Sin c√≥digo de ejemplo';

            // Contar conexiones
            const inputs = nodeConnections.filter(c => c.to === nodeId).length;
            const outputs = nodeConnections.filter(c => c.from === nodeId).length;
            document.getElementById('config-node-inputs').textContent = inputs;
            document.getElementById('config-node-outputs').textContent = outputs;

            // Generar par√°metros din√°micos seg√∫n el tipo de nodo
            const paramsContainer = document.getElementById('config-node-params');
            paramsContainer.innerHTML = generateNodeParams(node);

            // Mostrar panel
            panel.classList.remove('hidden');
        }

        function generateNodeParams(node) {
            // Par√°metros base seg√∫n categor√≠a
            const params = [];

            if (node.isTrigger) {
                // Par√°metros para triggers
                if (node.id === 'trigger-file') {
                    params.push({ name: 'watch_path', label: 'Carpeta', type: 'text', value: '/path/to/watch', placeholder: '/ruta/a/vigilar' });
                    params.push({ name: 'pattern', label: 'Patr√≥n', type: 'text', value: '*.pdf', placeholder: '*.pdf, *.jpg' });
                } else if (node.id === 'trigger-cron') {
                    params.push({ name: 'schedule', label: 'Programaci√≥n', type: 'select', value: 'daily', options: [
                        { value: 'hourly', label: 'Cada hora' },
                        { value: 'daily', label: 'Diario (9:00)' },
                        { value: 'weekly', label: 'Semanal (Lunes)' }
                    ]});
                } else if (node.id === 'trigger-webhook') {
                    params.push({ name: 'endpoint', label: 'Endpoint', type: 'text', value: `/api/trigger/${node.id}`, readonly: true });
                }
            } else if (node.cat === 'Storage') {
                params.push({ name: 'collection', label: 'Colecci√≥n', type: 'text', value: 'default', placeholder: 'nombre_colecci√≥n' });
            } else if (node.cat === 'IA Model') {
                params.push({ name: 'model', label: 'Modelo', type: 'text', value: 'default', placeholder: 'nombre_modelo' });
                params.push({ name: 'temperature', label: 'Temperatura', type: 'number', value: '0.7', min: 0, max: 2, step: 0.1 });
            } else if (node.cat === 'Process') {
                params.push({ name: 'timeout', label: 'Timeout (s)', type: 'number', value: '30', min: 1, max: 300 });
            }

            // Par√°metro gen√©rico de nombre personalizado
            params.push({ name: 'custom_name', label: 'Nombre Custom', type: 'text', value: '', placeholder: 'Nombre opcional' });

            // Generar HTML para par√°metros normales
            let html = params.map(p => {
                if (p.type === 'select') {
                    const options = p.options.map(o => `<option value="${o.value}" ${o.value === p.value ? 'selected' : ''}>${o.label}</option>`).join('');
                    return `
                        <div>
                            <label class="text-[10px] text-slate-500 block mb-1">${p.label}</label>
                            <select data-param="${p.name}" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-xs text-white focus:border-blue-500 focus:outline-none">
                                ${options}
                            </select>
                        </div>`;
                } else {
                    return `
                        <div>
                            <label class="text-[10px] text-slate-500 block mb-1">${p.label}</label>
                            <input type="${p.type}" data-param="${p.name}" value="${p.value}" placeholder="${p.placeholder || ''}"
                                   ${p.readonly ? 'readonly' : ''} ${p.min !== undefined ? `min="${p.min}"` : ''} ${p.max !== undefined ? `max="${p.max}"` : ''} ${p.step !== undefined ? `step="${p.step}"` : ''}
                                   class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-xs text-white focus:border-blue-500 focus:outline-none ${p.readonly ? 'opacity-60' : ''}">
                        </div>`;
                }
            }).join('');

            // A√±adir secci√≥n HITL (checkboxes de pausa)
            html += `
                <div class="mt-4 pt-4 border-t border-slate-800">
                    <label class="text-[10px] text-cyan-400 block mb-2 font-bold uppercase tracking-wider">
                        <i class="fa-solid fa-hand mr-1"></i> Human-in-the-Loop
                    </label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="checkbox" id="pause-before-${node.id}" ${node.pauseBefore ? 'checked' : ''}
                                   onchange="toggleNodePause('${node.id}', 'before', this.checked)"
                                   class="w-4 h-4 rounded border-slate-600 bg-slate-800 text-cyan-500 focus:ring-cyan-500 focus:ring-offset-0">
                            <span class="text-xs text-slate-400 group-hover:text-white transition">Pausar antes de ejecutar</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="checkbox" id="pause-after-${node.id}" ${node.pauseAfter ? 'checked' : ''}
                                   onchange="toggleNodePause('${node.id}', 'after', this.checked)"
                                   class="w-4 h-4 rounded border-slate-600 bg-slate-800 text-cyan-500 focus:ring-cyan-500 focus:ring-offset-0">
                            <span class="text-xs text-slate-400 group-hover:text-white transition">Pausar despues de ejecutar</span>
                        </label>
                    </div>
                    <p class="text-[10px] text-slate-600 mt-2">Activa pausas para inspeccionar datos durante la ejecucion.</p>
                </div>
            `;

            return html;
        }

        // Toggle pause configuration for a node
        function toggleNodePause(nodeId, when, checked) {
            const node = canvasNodes.find(n => n.id === nodeId);
            if (!node) return;

            if (when === 'before') {
                node.pauseBefore = checked;
            } else if (when === 'after') {
                node.pauseAfter = checked;
            }

            // Visual feedback
            const nodeEl = document.querySelector(`[data-node-id="${nodeId}"]`);
            if (nodeEl) {
                if (node.pauseBefore || node.pauseAfter) {
                    nodeEl.classList.add('has-hitl');
                } else {
                    nodeEl.classList.remove('has-hitl');
                }
            }

            showToast(`Pausa ${when === 'before' ? 'antes' : 'despues'} ${checked ? 'activada' : 'desactivada'}`, 'info');
        }

        function hideNodeConfig() {
            const panel = document.getElementById('node-config-panel');
            if (panel) panel.classList.add('hidden');
            canvasState.selectedNodeId = null;
            document.querySelectorAll('.pipeline-node-pro').forEach(n => n.classList.remove('selected'));
        }

        function copyNodeCode() {
            const code = document.getElementById('config-node-code')?.textContent;
            if (code) {
                navigator.clipboard.writeText(code).then(() => {
                    showToast('C√≥digo copiado', 'success');
                });
            }
        }

        function duplicateSelectedNode() {
            if (!canvasState.selectedNodeId) return;

            const node = canvasNodes.find(n => n.id === canvasState.selectedNodeId);
            if (!node) return;

            // Crear copia con nuevo ID
            const newId = `${node.id}-copy-${Date.now()}`;
            const newNode = { ...node, id: newId, name: `${node.name} (copia)` };

            canvasNodes.push(newNode);

            // Posicionar cerca del original
            const origPos = nodePositions[node.id];
            nodePositions[newId] = {
                x: origPos.x + 40,
                y: origPos.y + 40
            };

            saveToHistory();
            renderCanvas();
            selectNode(newId);
            showToast(`${node.name} duplicado`, 'success');
        }

        function deleteSelectedNode() {
            if (!canvasState.selectedNodeId) return;
            removeNode(canvasState.selectedNodeId);
            hideNodeConfig();
            showToast('Nodo eliminado', 'info');
        }

        // Validaci√≥n en tiempo real
        function validateFlowRealtime() {
            const panel = document.getElementById('validation-panel');
            const messages = document.getElementById('validation-messages');
            const statusEl = document.getElementById('flow-status');
            if (!panel || !messages) return;

            const ids = canvasNodes.map(n => n.id);
            const errors = [];
            const warnings = [];
            const tips = [];

            // Detecci√≥n de duplicados (ciclos potenciales) v9.1
            const duplicates = ids.filter((id, i) => ids.indexOf(id) !== i);
            if (duplicates.length > 0) {
                errors.push({ icon: 'fa-circle-exclamation', color: 'red', msg: `Nodos duplicados detectados: ${[...new Set(duplicates)].join(', ')}` });
            }

            // Validaciones de compatibilidad entre nodos consecutivos v9.1
            const nodeCompatibility = {
                'whisper': { requires: ['ffmpeg'], produces: 'text' },
                'clip': { requires: ['pillow'], produces: 'embeddings' },
                'chroma': { accepts: ['embeddings', 'text'], produces: 'vectors' },
                'langchain': { requires: ['chroma'], produces: 'rag' }
            };

            for (let i = 0; i < canvasNodes.length - 1; i++) {
                const current = canvasNodes[i];
                const next = canvasNodes[i + 1];
                const compat = nodeCompatibility[next.id];
                if (compat?.requires && !compat.requires.some(r => ids.includes(r))) {
                    // Ya cubierto abajo
                }
            }

            // Validaciones existentes
            if (ids.includes('whisper') && !ids.includes('ffmpeg'))
                warnings.push({ icon: 'fa-triangle-exclamation', color: 'yellow', msg: 'Whisper necesita FFmpeg para procesar audio' });
            if (ids.includes('clip') && !ids.includes('pillow'))
                warnings.push({ icon: 'fa-triangle-exclamation', color: 'yellow', msg: 'CLIP necesita Pillow para pre-procesar im√°genes' });
            if (ids.length > 0 && !ids.some(id => ['chroma', 'sqlite'].includes(id)))
                tips.push({ icon: 'fa-lightbulb', color: 'blue', msg: 'Considera a√±adir persistencia (ChromaDB o SQLite)' });
            if (ids.includes('fastapi') && !ids.includes('pydantic'))
                tips.push({ icon: 'fa-lightbulb', color: 'blue', msg: 'FastAPI funciona mejor con Pydantic para validaci√≥n' });
            if (ids.includes('langchain') && !ids.includes('chroma'))
                warnings.push({ icon: 'fa-triangle-exclamation', color: 'yellow', msg: 'LangChain RAG funciona mejor con ChromaDB' });
            if (ids.length > 5)
                tips.push({ icon: 'fa-info-circle', color: 'slate', msg: `Pipeline complejo: ${ids.length} componentes` });

            const allMessages = [...errors, ...warnings, ...tips];

            if (allMessages.length > 0) {
                messages.innerHTML = allMessages.map(m => `
                    <div class="flex items-start gap-2 p-2 bg-${m.color}-500/10 border border-${m.color}-500/30 rounded-lg">
                        <i class="fa-solid ${m.icon} text-${m.color}-400 text-xs mt-0.5"></i>
                        <span class="text-xs text-slate-300">${m.msg}</span>
                    </div>
                `).join('');
                panel.classList.remove('hidden');

                statusEl.innerHTML = errors.length > 0
                    ? '<span class="px-3 py-1 rounded-full text-xs font-medium bg-red-500/20 text-red-400 border border-red-500/30"><i class="fa-solid fa-times-circle mr-1"></i> Errores</span>'
                    : warnings.length > 0
                    ? '<span class="px-3 py-1 rounded-full text-xs font-medium bg-yellow-500/20 text-yellow-400 border border-yellow-500/30"><i class="fa-solid fa-exclamation-circle mr-1"></i> Avisos</span>'
                    : '<span class="px-3 py-1 rounded-full text-xs font-medium bg-green-500/20 text-green-400 border border-green-500/30"><i class="fa-solid fa-check-circle mr-1"></i> OK</span>';
                statusEl.classList.remove('hidden');
            } else if (ids.length > 0) {
                messages.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-check-circle text-green-400 text-2xl mb-2"></i><p class="text-xs text-slate-400">Pipeline v√°lido</p></div>';
                panel.classList.remove('hidden');
                statusEl.innerHTML = '<span class="px-3 py-1 rounded-full text-xs font-medium bg-green-500/20 text-green-400 border border-green-500/30"><i class="fa-solid fa-check-circle mr-1"></i> V√°lido</span>';
                statusEl.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
                statusEl.classList.add('hidden');
            }
        }

        // Redibujar conexiones al hacer scroll
        if (pipelineCanvas) {
            pipelineCanvas.addEventListener('scroll', () => setTimeout(drawConnections, 10));
            window.addEventListener('resize', () => setTimeout(drawConnections, 100));
        }

        // --- SCAFFOLD / CREAR PROYECTO ---
        function generateScaffold() {
            if (canvasNodes.length === 0) return alert("A√±ade herramientas al canvas primero");

            // Generar nombre sugerido
            const mainTool = canvasNodes[0]?.name.toLowerCase().replace(/\s+/g, '_') || 'proyecto';
            document.getElementById('project-name').value = `${mainTool}_pipeline`;

            // Generar preview de estructura
            updateScaffoldPreview();
            document.getElementById('scaffold-modal').classList.remove('hidden');
        }

        function updateScaffoldPreview() {
            const name = document.getElementById('project-name').value || 'mi_proyecto';
            const hasApi = canvasNodes.some(n => n.id === 'fastapi');
            const hasDb = canvasNodes.some(n => ['sqlite', 'chroma'].includes(n.id));
            const hasAi = canvasNodes.some(n => ['clip', 'whisper', 'ollama', 'claude'].includes(n.id));

            let structure = `${name}/
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ .gitignore`;

            if (hasApi) structure += `
‚îú‚îÄ‚îÄ routers/
‚îÇ   ‚îî‚îÄ‚îÄ api.py`;

            structure += `
‚îú‚îÄ‚îÄ services/`;

            canvasNodes.forEach(n => {
                if (!['fastapi', 'python', 'html', 'css'].includes(n.id)) {
                    structure += `
‚îÇ   ‚îî‚îÄ‚îÄ ${n.id}_service.py`;
                }
            });

            if (hasDb) structure += `
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îî‚îÄ‚îÄ connection.py`;

            if (hasAi) structure += `
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ schemas.py`;

            structure += `
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ logger.py
‚îî‚îÄ‚îÄ tests/
    ‚îî‚îÄ‚îÄ test_main.py`;

            document.getElementById('scaffold-preview').textContent = structure;
        }

        // Escuchar cambios en el nombre
        document.getElementById('project-name')?.addEventListener('input', updateScaffoldPreview);

        function copyScaffoldCommand() {
            const name = document.getElementById('project-name').value || 'mi_proyecto';
            const path = document.getElementById('project-path').value || '~/Desktop';
            const withGit = document.getElementById('opt-git').checked;
            const withVenv = document.getElementById('opt-venv').checked;

            let cmd = `cd ${path} && mkdir -p ${name}/{routers,services,db,models,utils,tests} && cd ${name}`;
            cmd += ` && touch main.py requirements.txt .env.example .gitignore`;
            if (withVenv) cmd += ` && python3 -m venv venv`;
            if (withGit) cmd += ` && git init`;
            cmd += ` && echo "Proyecto creado!"`;

            navigator.clipboard.writeText(cmd);
            addLog("SUCCESS", "Comando copiado al portapapeles");
            closeModal('scaffold-modal');
        }

        function downloadScaffoldScript() {
            const name = document.getElementById('project-name').value || 'mi_proyecto';
            const path = document.getElementById('project-path').value || '~/Desktop';
            const withGit = document.getElementById('opt-git').checked;
            const withVenv = document.getElementById('opt-venv').checked;
            const withReadme = document.getElementById('opt-readme').checked;

            // Generar requirements.txt basado en el stack
            const deps = [];
            canvasNodes.forEach(n => {
                if (n.id === 'fastapi') deps.push('fastapi', 'uvicorn[standard]');
                if (n.id === 'chroma') deps.push('chromadb');
                if (n.id === 'sqlite') deps.push('aiosqlite');
                if (n.id === 'clip') deps.push('transformers', 'torch', 'pillow');
                if (n.id === 'whisper') deps.push('openai-whisper');
                if (n.id === 'ollama') deps.push('ollama');
                if (n.id === 'pydantic') deps.push('pydantic');
                if (n.id === 'loguru') deps.push('loguru');
                if (n.id === 'httpx') deps.push('httpx');
                if (n.id === 'bs4') deps.push('beautifulsoup4', 'lxml');
            });

            let script = `#!/bin/bash
# DirectOS Pipeline Scaffold - ${name}
# Generado autom√°ticamente

set -e

PROJECT_NAME="${name}"
BASE_PATH="${path}"

echo "üöÄ Creando proyecto $PROJECT_NAME..."

cd "$BASE_PATH"
mkdir -p "$PROJECT_NAME"/{routers,services,db,models,utils,tests}
cd "$PROJECT_NAME"

# Archivos base
touch main.py .env.example

# requirements.txt
cat > requirements.txt << 'EOF'
${[...new Set(deps)].join('\n')}
python-dotenv
EOF

# .gitignore
cat > .gitignore << 'EOF'
venv/
__pycache__/
*.pyc
.env
*.db
.DS_Store
EOF

# main.py base
cat > main.py << 'EOF'
"""
${name} - Pipeline generado con DirectOS
Stack: ${canvasNodes.map(n => n.name).join(' ‚Üí ')}
"""
from loguru import logger

def main():
    logger.info("Pipeline iniciado")
    # TODO: Implementar l√≥gica

if __name__ == "__main__":
    main()
EOF
`;

            if (withReadme) {
                script += `
# README.md
cat > README.md << 'EOF'
# ${name}

Pipeline generado con DirectOS v9.0

## Stack
${canvasNodes.map(n => `- **${n.name}**: ${n.tag}`).join('\n')}

## Instalaci√≥n
\`\`\`bash
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
\`\`\`

## Uso
\`\`\`bash
python main.py
\`\`\`
EOF
`;
            }

            if (withVenv) script += `\n# Crear entorno virtual\npython3 -m venv venv\necho "‚úÖ venv creado"`;
            if (withGit) script += `\n# Inicializar git\ngit init\ngit add .\ngit commit -m "Initial commit - ${name} scaffold"\necho "‚úÖ Git inicializado"`;

            script += `\n\necho ""\necho "‚úÖ Proyecto $PROJECT_NAME creado en $BASE_PATH"\necho "üìÅ cd $BASE_PATH/$PROJECT_NAME"\necho "üêç source venv/bin/activate && pip install -r requirements.txt"`;

            // Descargar como archivo .sh
            const blob = new Blob([script], { type: 'text/x-shellscript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `create_${name}.sh`;
            a.click();
            URL.revokeObjectURL(url);

            addLog("SUCCESS", `Script create_${name}.sh descargado`);
            closeModal('scaffold-modal');
        }

        // --- PRESETS ---
        async function initPresets() {
            const selector = document.getElementById('preset-selector');

            // Limpiar selector (excepto la primera opci√≥n vac√≠a)
            while (selector.options.length > 1) {
                selector.remove(1);
            }
            // Remover optgroups existentes
            selector.querySelectorAll('optgroup').forEach(g => g.remove());

            // Grupo: Patrones (hardcoded)
            const patternsGroup = document.createElement('optgroup');
            patternsGroup.label = 'üìê Patrones';
            presets.forEach(p => {
                const opt = document.createElement('option');
                opt.value = `preset:${p.id}`;
                opt.textContent = p.name;
                patternsGroup.appendChild(opt);
            });
            selector.appendChild(patternsGroup);

            // Grupo: Proyectos (desde API)
            try {
                const res = await fetch('/api/projects');
                const data = await res.json();
                if (data.projects && data.projects.length > 0) {
                    const projectsGroup = document.createElement('optgroup');
                    projectsGroup.label = 'üìÅ Proyectos';
                    data.projects.forEach(p => {
                        if (p.stack && p.stack.length > 0) {
                            const opt = document.createElement('option');
                            opt.value = `project:${p.id}`;
                            opt.textContent = `${p.name} (${p.stack.length} tools)`;
                            projectsGroup.appendChild(opt);
                        }
                    });
                    if (projectsGroup.children.length > 0) {
                        selector.appendChild(projectsGroup);
                    }
                }
            } catch (e) {
                console.warn('No se pudieron cargar proyectos para selector');
            }

            // Grupo: Arquitecturas guardadas (offline)
            const savedArchs = OfflineStore.getAll('architectures');
            if (savedArchs.length > 0) {
                const archGroup = document.createElement('optgroup');
                archGroup.label = 'üíæ Guardadas';
                savedArchs.forEach(a => {
                    const opt = document.createElement('option');
                    opt.value = `arch:${a.id}`;
                    opt.textContent = `${a.name} (${a.nodes?.length || 0} nodos)`;
                    archGroup.appendChild(opt);
                });
                selector.appendChild(archGroup);
            }
        }

        function loadPreset(value) {
            if (!value) {
                document.getElementById('preset-info').classList.add('hidden');
                return;
            }

            const [type, id] = value.split(':');

            if (type === 'preset') {
                // Cargar preset predefinido
                const preset = presets.find(p => p.id === id);
                if (!preset) return;

                document.getElementById('preset-info').classList.remove('hidden');
                document.getElementById('preset-desc').textContent = preset.desc;
                document.getElementById('preset-flow').textContent = preset.flow;
                document.getElementById('preset-usecase').textContent = `Casos: ${preset.useCase}`;

                canvasNodes = [];
                preset.tools.forEach(toolId => {
                    const tool = getTools().find(t => t.id === toolId);
                    if (tool) canvasNodes.push(tool);
                });
                renderCanvas();

            } else if (type === 'project') {
                // Cargar stack de proyecto
                loadProjectToCanvas(id);

            } else if (type === 'arch') {
                // Cargar arquitectura guardada
                const arch = OfflineStore.getAll('architectures').find(a => a.id === id);
                if (!arch) return;

                document.getElementById('preset-info').classList.remove('hidden');
                document.getElementById('preset-desc').textContent = arch.description || 'Arquitectura guardada';
                document.getElementById('preset-flow').textContent = arch.stack || '';
                document.getElementById('preset-usecase').textContent = '';

                canvasNodes = [];
                (arch.nodes || []).forEach(n => {
                    const tool = getTools().find(t => t.id === n.id);
                    if (tool) canvasNodes.push({...tool});
                });
                renderCanvas();
                addLog("SUCCESS", `Arquitectura "${arch.name}" cargada`);
            }
        }

        async function loadProjectToCanvas(projectId) {
            try {
                const res = await fetch(`/api/projects/${projectId}`);
                const project = await res.json();

                if (project && project.stack) {
                    document.getElementById('preset-info').classList.remove('hidden');
                    document.getElementById('preset-desc').textContent = project.description || project.name;
                    document.getElementById('preset-flow').textContent = project.stack.join(' ‚Üí ');
                    document.getElementById('preset-usecase').textContent = `v${project.version || '1.0'} - ${project.status || 'active'}`;

                    canvasNodes = [];
                    // Mapear nombres de stack a IDs de tools
                    project.stack.forEach(techName => {
                        const tool = getTools().find(t =>
                            t.name.toLowerCase() === techName.toLowerCase() ||
                            t.id.toLowerCase() === techName.toLowerCase()
                        );
                        if (tool) canvasNodes.push({...tool});
                    });
                    renderCanvas();
                    addLog("SUCCESS", `Proyecto "${project.name}" cargado (${canvasNodes.length} tools)`);
                }
            } catch (e) {
                console.error('Error loading project:', e);
            }
        }

        // --- CORE UI ---
        function compileArchitecture() {
            if(canvasNodes.length===0) return alert("A√±ade herramientas al canvas primero");

            // Generar c√≥digo Python real basado en el stack
            const ids = canvasNodes.map(n => n.id);
            const stack = [...new Set(canvasNodes.map(n => n.name))].join(", ");

            let imports = `"""
Pipeline generado con DirectOS v9.0
Stack: ${stack}
"""
import os
from pathlib import Path
from dotenv import load_dotenv
`;
            let code = '';

            // A√±adir imports seg√∫n el stack
            if (ids.includes('loguru')) imports += `from loguru import logger\n`;
            if (ids.includes('fastapi')) imports += `from fastapi import FastAPI, HTTPException, Depends\nfrom fastapi.middleware.cors import CORSMiddleware\n`;
            if (ids.includes('pydantic')) imports += `from pydantic import BaseModel, Field\n`;
            if (ids.includes('chroma')) imports += `import chromadb\nfrom chromadb.config import Settings\n`;
            if (ids.includes('sqlite')) imports += `import sqlite3\nfrom contextlib import contextmanager\n`;
            if (ids.includes('httpx')) imports += `import httpx\n`;
            if (ids.includes('clip')) imports += `from transformers import CLIPProcessor, CLIPModel\nfrom PIL import Image\nimport torch\n`;
            if (ids.includes('whisper')) imports += `import whisper\n`;
            if (ids.includes('ollama')) imports += `import ollama\n`;

            imports += `\nload_dotenv()\n\n`;

            // Generar c√≥digo seg√∫n componentes
            if (ids.includes('fastapi')) {
                code += `# ============================================
# FastAPI App
# ============================================
app = FastAPI(
    title="Pipeline API",
    description="Generado con DirectOS",
    version="1.0.0"
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

`;
            }

            if (ids.includes('chroma')) {
                code += `# ============================================
# ChromaDB Client
# ============================================
def get_chroma_client():
    return chromadb.PersistentClient(path="./db/chroma")

def get_collection(name: str = "default"):
    client = get_chroma_client()
    return client.get_or_create_collection(name)

`;
            }

            if (ids.includes('sqlite')) {
                code += `# ============================================
# SQLite Connection
# ============================================
DB_PATH = Path("./db/data.db")

@contextmanager
def get_db():
    DB_PATH.parent.mkdir(exist_ok=True)
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    try:
        yield conn
    finally:
        conn.close()

`;
            }

            if (ids.includes('clip')) {
                code += `# ============================================
# CLIP Model
# ============================================
DEVICE = "mps" if torch.backends.mps.is_available() else "cpu"
clip_model = CLIPModel.from_pretrained("openai/clip-vit-base-patch32").to(DEVICE)
clip_processor = CLIPProcessor.from_pretrained("openai/clip-vit-base-patch32")

def get_image_embedding(image_path: str):
    image = Image.open(image_path).convert("RGB")
    inputs = clip_processor(images=image, return_tensors="pt").to(DEVICE)
    with torch.no_grad():
        embedding = clip_model.get_image_features(**inputs)
    return embedding.cpu().numpy().flatten().tolist()

`;
            }

            if (ids.includes('whisper')) {
                code += `# ============================================
# Whisper Model
# ============================================
whisper_model = whisper.load_model("base")

def transcribe_audio(audio_path: str) -> str:
    result = whisper_model.transcribe(audio_path)
    return result["text"]

`;
            }

            if (ids.includes('ollama')) {
                code += `# ============================================
# Ollama LLM
# ============================================
def query_llm(prompt: str, model: str = "llama3") -> str:
    response = ollama.chat(model=model, messages=[
        {"role": "user", "content": prompt}
    ])
    return response["message"]["content"]

`;
            }

            // A√±adir endpoints si hay FastAPI
            if (ids.includes('fastapi')) {
                code += `# ============================================
# API Endpoints
# ============================================
@app.get("/health")
async def health_check():
    return {"status": "ok", "stack": "${stack}"}

@app.get("/")
async def root():
    return {"message": "Pipeline API - DirectOS v9.0"}

`;
                if (ids.includes('chroma')) {
                    code += `@app.post("/search")
async def semantic_search(query: str, limit: int = 5):
    collection = get_collection()
    results = collection.query(query_texts=[query], n_results=limit)
    return {"results": results}

`;
                }
            }

            // Main
            code += `# ============================================
# Main
# ============================================
if __name__ == "__main__":
`;
            if (ids.includes('fastapi')) {
                code += `    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
`;
            } else {
                code += `    ${ids.includes('loguru') ? 'logger.info("Pipeline iniciado")' : 'print("Pipeline iniciado")'}
    # TODO: Implementar l√≥gica del pipeline
    pass
`;
            }

            const fullCode = imports + code;
            document.getElementById('architect-prompt-output').textContent = fullCode;
            document.getElementById('architect-output-modal').classList.remove('hidden');
            addLog("SUCCESS", "C√≥digo Python generado");
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function copyArchitectPrompt() { navigator.clipboard.writeText(document.getElementById('architect-prompt-output').textContent); }

        function switchView(view) {
            ['architect', 'generator', 'grid', 'flow', 'monitor', 'projects', 'agent', 'prompt-builder'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                const b = document.getElementById(`btn-${v}`);
                if(b) { b.classList.replace('bg-blue-600', 'text-slate-400'); b.classList.replace('text-white', 'hover:bg-slate-800'); b.classList.remove('shadow-lg'); }
            });
            document.getElementById(`view-${view}`).classList.remove('hidden');
            const btn = document.getElementById(`btn-${view}`);
            if(btn) { btn.classList.replace('text-slate-400', 'bg-blue-600'); btn.classList.replace('hover:bg-slate-800', 'text-white'); btn.classList.add('shadow-lg'); }

            const headerTools = document.getElementById('header-tools');
            if(view === 'architect') headerTools.classList.remove('hidden'); else headerTools.classList.add('hidden');

            document.getElementById('page-title').textContent = { 'architect': 'Pipeline Builder', 'generator': 'Patrones', 'grid': 'Glosario', 'flow': 'Recetas', 'monitor': 'Monitor', 'projects': 'Proyectos', 'agent': 'Automatizaciones', 'prompt-builder': 'Prompt Builder Pro' }[view];

            // Refresh Agent Mode data when switching to it
            if(view === 'agent') refreshAgentStatus();
        }

        // ============================================
        // PROMPT BUILDER PRO
        // ============================================

        const promptTemplates = {
            'code-review': {
                name: 'code-review',
                description: 'Code review de calidad, seguridad y mantenibilidad. Usa despu√©s de escribir c√≥digo o antes de commit/PR.',
                argHint: '[archivo o directorio]',
                tools: ['Read', 'Grep', 'Glob'],
                variables: [
                    { name: '$ARGUMENTS', type: 'din√°mico', desc: 'Target a revisar' },
                    { name: 'TARGET', type: 'est√°tico', desc: 'Si vac√≠o ‚Üí git diff' },
                    { name: 'MAX_ISSUES', type: 'est√°tico', desc: '10 por archivo' }
                ],
                workflow: ['Determinar scope', 'Leer c√≥digo', 'Analizar por categor√≠a', 'Clasificar hallazgos', 'Generar reporte'],
                instructions: ['M√°ximo 10 issues por archivo', 'Siempre incluir l√≠nea exacta', 'Sugerencia concreta de fix'],
                report: `üìã CODE REVIEW: {target}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìç archivo:l√≠nea
üè∑Ô∏è [SEVERIDAD] Categor√≠a
‚ùå Problema
‚úÖ Sugerencia

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üìä RESUMEN
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Archivos: X | Hallazgos: Y

üéØ Top 3 prioridades:
1. ...`
            },
            'doc': {
                name: 'doc',
                description: 'Genera documentaci√≥n t√©cnica desde c√≥digo. Usa cuando necesites README, docs de API, o documentar archivos.',
                argHint: '[archivo, directorio o "readme"]',
                tools: ['Read', 'Write', 'Glob', 'Grep'],
                variables: [
                    { name: '$ARGUMENTS', type: 'din√°mico', desc: 'Target: archivo, directorio, o "readme"' },
                    { name: 'MODE', type: 'est√°tico', desc: 'readme | file | directory' }
                ],
                workflow: ['Detectar modo seg√∫n $ARGUMENTS', 'Recopilar contexto', 'Analizar patrones', 'Generar documentaci√≥n', 'Presentar resultado'],
                instructions: ['NO inventar funcionalidad', 'Ejemplos reales del proyecto', 'Mantener estilo existente'],
                report: `# {Proyecto}

## Descripci√≥n
{1-2 l√≠neas}

## Instalaci√≥n
{Pasos detectados}

## Uso
{Ejemplo funcional}`
            },
            'test': {
                name: 'test',
                description: 'Ejecuta tests, analiza fallos y sugiere correcciones.',
                argHint: '[archivo, patr√≥n o vac√≠o]',
                tools: ['Read', 'Bash', 'Grep', 'Glob'],
                variables: [
                    { name: '$ARGUMENTS', type: 'din√°mico', desc: 'Archivo/patr√≥n espec√≠fico' },
                    { name: 'FRAMEWORK', type: 'est√°tico', desc: 'Detectado: jest, pytest, go test' }
                ],
                workflow: ['Detectar framework', 'Ejecutar tests', 'Analizar fallos', 'Sugerir correcci√≥n', 'Reportar cobertura'],
                instructions: ['Ejecutar con verbose (-v)', 'Para cada fallo: leer test + c√≥digo', 'Comparar expected vs actual'],
                report: `‚úÖ TODOS PASAN | ‚ùå X FALLOS

Para fallos:
- Test: nombre
- Causa probable
- Sugerencia de fix

‚ö†Ô∏è C√≥digo sin tests detectado`
            },
            'security': {
                name: 'security',
                description: 'Auditor√≠a de seguridad OWASP Top 10 + secrets.',
                argHint: '[directorio o vac√≠o para todo]',
                tools: ['Read', 'Grep', 'Glob'],
                variables: [
                    { name: '$ARGUMENTS', type: 'din√°mico', desc: 'Scope del escaneo' },
                    { name: 'SEVERITY', type: 'est√°tico', desc: 'üî¥ CR√çTICO ‚Üí üîµ BAJO' }
                ],
                workflow: ['Escanear secrets', 'Buscar SQL injection', 'Detectar XSS', 'Validar inputs', 'Auditar dependencias', 'Generar reporte'],
                instructions: ['Ignorar: .env.example, *.test.*', 'Incluir referencia OWASP', 'Priorizar por explotabilidad'],
                report: `üõ°Ô∏è AUDITOR√çA DE SEGURIDAD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üî¥ [CR√çTICO] Tipo - ubicaci√≥n
‚ùå C√≥digo vulnerable
‚úÖ C√≥digo seguro
üîó Referencia OWASP

üìä RESUMEN por severidad`
            },
            'refactor': {
                name: 'refactor',
                description: 'Analiza c√≥digo y sugiere refactorizaciones. Usa cuando el c√≥digo funciona pero quieres mejorarlo.',
                argHint: '[archivo o directorio]',
                tools: ['Read', 'Grep', 'Glob'],
                variables: [
                    { name: '$ARGUMENTS', type: 'din√°mico', desc: 'Target a analizar' },
                    { name: 'PRIORITY', type: 'est√°tico', desc: 'impacto √ó (1/esfuerzo)' }
                ],
                workflow: ['Leer c√≥digo target', 'Detectar code smells', 'Identificar dead code', 'Evaluar naming', 'Priorizar sugerencias', 'Generar reporte'],
                instructions: ['NO romper funcionalidad', 'C√≥digo ANTES y DESPU√âS', 'Explicar POR QU√â es mejor'],
                report: `üîß REFACTORING ANALYSIS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üí° QUICK WINS (alto impacto, f√°cil)
üìç ubicaci√≥n
ANTES: ...
DESPU√âS: ...
üí° Beneficio: ...

üìã REFACTORS MAYORES
üìä Deuda t√©cnica: BAJA|MEDIA|ALTA`
            },
            'vault': {
                name: 'vault',
                description: 'Actualiza el Vault personal con aprendizajes de la sesi√≥n (knowledge-base, dashboard, tools, projects, patterns)',
                argHint: '',
                tools: ['Read', 'Write', 'Edit', 'Bash'],
                variables: [
                    { name: 'VAULT_PATH', type: 'est√°tico', desc: '~/learning-journey/' },
                    { name: 'DIRECTOS_PATH', type: 'est√°tico', desc: '~/Desktop/DirectOS/data/content/' },
                    { name: 'KB_FILE', type: 'est√°tico', desc: '{VAULT_PATH}knowledge-base.md' }
                ],
                workflow: ['Preguntar al usuario qu√© trabaj√≥', 'Leer estado actual del Vault', 'Decidir qu√© actualizar', 'Aplicar cambios en archivos', 'Sincronizar dashboard.html', 'Refrescar cache y confirmar'],
                instructions: ['KISS: Solo cambios necesarios', 'Incremental: Peque√±as actualizaciones', 'DRY: No duplicar datos', 'Git-friendly: Cambios f√°ciles de revisar'],
                report: `üì¶ VAULT ACTUALIZADO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚úÖ knowledge-base.md actualizado
‚úÖ dashboard.html sincronizado
‚úÖ tools/python.md ‚Üí level: expert
üÜï projects/nuevo.md creado

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üìä RESUMEN
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Archivos modificados: X
Archivos creados: Y

¬øCrear commit? [S/n]`
            },
            'scan-projects': {
                name: 'scan-projects',
                description: 'Escanea el Desktop buscando proyectos no documentados en el Vault',
                argHint: '',
                tools: ['Read', 'Bash', 'Glob', 'Grep'],
                variables: [
                    { name: 'SCAN_PATH', type: 'est√°tico', desc: '~/Desktop/' },
                    { name: 'VAULT_FILE', type: 'est√°tico', desc: '~/learning-journey/knowledge-base.md' },
                    { name: 'IGNORE', type: 'est√°tico', desc: 'venv, node_modules, .git, __pycache__' }
                ],
                workflow: ['Leer Vault actual', 'Escanear Desktop buscando indicadores', 'Detectar stack por archivo', 'Comparar documentados vs encontrados', 'Generar reporte con hallazgos'],
                instructions: ['Ignorar: venv, node_modules, .git, backups', 'Solo carpetas primer nivel Desktop', 'No entrar en subdirectorios profundos'],
                report: `üìä ESCANEO COMPLETO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚úÖ DOCUMENTADOS (X):
- Proyecto1
- Proyecto2

üÜï SIN DOCUMENTAR (Y):
| Proyecto | Stack | √öltima mod |
|----------|-------|------------|
| nombre   | Python| 2 dic 2025 |

‚Üí Usar /vault para a√±adir`
            },
            'update-context': {
                name: 'update-context',
                description: 'Actualiza CLAUDE.md del proyecto actual con cambios recientes',
                argHint: '',
                tools: ['Read', 'Write', 'Edit', 'Bash'],
                variables: [
                    { name: 'PROJECT_ROOT', type: 'est√°tico', desc: 'Directorio actual' },
                    { name: 'CLAUDE_FILE', type: 'est√°tico', desc: '{PROJECT_ROOT}/CLAUDE.md' },
                    { name: 'LOOKBACK', type: 'est√°tico', desc: '√öltimos 5 commits' }
                ],
                workflow: ['Analizar cambios recientes (git log, diff)', 'Leer CLAUDE.md actual', 'Identificar actualizaciones necesarias', 'Preguntar al usuario', 'Generar diff de cambios', 'Confirmar y guardar'],
                instructions: ['NO borrar informaci√≥n √∫til', 'Mantener formato existente', 'Fechas: DD mmm YYYY', 'Si no hay cambios ‚Üí decirlo'],
                report: `üìù ACTUALIZACI√ìN DE CLAUDE.md
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìä Cambios detectados:
- X commits desde √∫ltima actualizaci√≥n
- Y archivos modificados

üìã Actualizaciones propuestas:
+ Secci√≥n nueva...
~ Secci√≥n modificada...

¬øGuardar cambios? [S/n]`
            },
            'blank': {
                name: '',
                description: '',
                argHint: '',
                tools: ['Read', 'Glob', 'Grep'],
                variables: [{ name: '$ARGUMENTS', type: 'din√°mico', desc: 'Target del comando' }],
                workflow: [''],
                instructions: [''],
                report: ''
            }
        };

        function loadPromptTemplate(templateId) {
            if (!templateId) return;
            const t = promptTemplates[templateId];
            if (!t) return;

            document.getElementById('pb-name').value = t.name;
            document.getElementById('pb-description').value = t.description;
            document.getElementById('pb-arg-hint').value = t.argHint;

            // Tools
            document.querySelectorAll('.pb-tool').forEach(cb => {
                cb.checked = t.tools.includes(cb.value);
            });

            // Variables
            const varsContainer = document.getElementById('pb-variables');
            varsContainer.innerHTML = '';
            t.variables.forEach((v, i) => {
                addVariableRow(v.name, v.type, v.desc, i === 0);
            });

            // Workflow
            const wfContainer = document.getElementById('pb-workflow');
            wfContainer.innerHTML = '';
            t.workflow.forEach((step, i) => {
                addWorkflowStepRow(step, i + 1);
            });

            // Instructions
            const insContainer = document.getElementById('pb-instructions');
            insContainer.innerHTML = '';
            t.instructions.forEach(ins => {
                addInstructionRow(ins);
            });

            // Report
            document.getElementById('pb-report').value = t.report;

            generatePromptPreview();
            validatePromptBuilder();
        }

        function addVariableRow(name = '', type = 'est√°tico', desc = '', isReadonly = false) {
            const container = document.getElementById('pb-variables');
            const row = document.createElement('div');
            row.className = 'grid grid-cols-12 gap-2 items-center pb-variable-row';
            row.innerHTML = `
                <input type="text" class="col-span-3 bg-slate-950 border border-slate-700 rounded p-1.5 text-xs text-slate-300 font-mono" value="${name}" ${isReadonly ? 'readonly' : ''} placeholder="VARIABLE">
                <select class="col-span-3 bg-slate-950 border border-slate-700 rounded p-1.5 text-xs text-slate-300">
                    <option value="din√°mico" ${type === 'din√°mico' ? 'selected' : ''}>din√°mico</option>
                    <option value="est√°tico" ${type === 'est√°tico' ? 'selected' : ''}>est√°tico</option>
                </select>
                <input type="text" class="col-span-5 bg-slate-950 border border-slate-700 rounded p-1.5 text-xs text-slate-300" placeholder="Descripci√≥n..." value="${desc}">
                <button onclick="this.closest('.pb-variable-row').remove(); validatePromptBuilder();" class="col-span-1 text-slate-500 hover:text-red-400 transition ${isReadonly ? 'opacity-50 cursor-not-allowed' : ''}" ${isReadonly ? 'disabled' : ''}><i class="fa-solid fa-times"></i></button>
            `;
            container.appendChild(row);
        }

        function addVariable() {
            addVariableRow();
            validatePromptBuilder();
        }

        function addWorkflowStepRow(value = '', num = null) {
            const container = document.getElementById('pb-workflow');
            const stepNum = num || container.querySelectorAll('.pb-workflow-step').length + 1;
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2 pb-workflow-step';
            row.draggable = true;
            row.innerHTML = `
                <span class="drag-handle text-slate-600 hover:text-slate-400 cursor-grab active:cursor-grabbing mr-1" title="Arrastrar para reordenar"><i class="fa-solid fa-grip-vertical"></i></span>
                <span class="step-number text-xs text-slate-500 font-mono w-4">${stepNum}.</span>
                <input type="text" class="flex-1 bg-slate-950 border border-slate-700 rounded p-1.5 text-xs text-slate-300 focus:border-green-500 focus:outline-none transition" placeholder="Verbo + descripci√≥n del paso..." value="${value}">
                <button onclick="removeStep(this)" class="text-slate-500 hover:text-red-400 transition text-xs"><i class="fa-solid fa-times"></i></button>
            `;

            // Drag & Drop events
            row.addEventListener('dragstart', handleDragStart);
            row.addEventListener('dragend', handleDragEnd);
            row.addEventListener('dragover', handleDragOver);
            row.addEventListener('drop', handleDrop);
            row.addEventListener('dragenter', handleDragEnter);
            row.addEventListener('dragleave', handleDragLeave);

            container.appendChild(row);
        }

        // Drag & Drop para Workflow
        let draggedStep = null;

        function handleDragStart(e) {
            draggedStep = this;
            this.style.opacity = '0.4';
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
            document.querySelectorAll('.pb-workflow-step').forEach(step => {
                step.classList.remove('border-t-2', 'border-green-500');
            });
            renumberSteps();
            generatePromptPreview();
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            this.classList.add('border-t-2', 'border-green-500');
        }

        function handleDragLeave(e) {
            this.classList.remove('border-t-2', 'border-green-500');
        }

        function handleDrop(e) {
            e.stopPropagation();
            if (draggedStep !== this) {
                const container = document.getElementById('pb-workflow');
                const allSteps = Array.from(container.querySelectorAll('.pb-workflow-step'));
                const draggedIdx = allSteps.indexOf(draggedStep);
                const targetIdx = allSteps.indexOf(this);

                if (draggedIdx < targetIdx) {
                    this.parentNode.insertBefore(draggedStep, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedStep, this);
                }
            }
            this.classList.remove('border-t-2', 'border-green-500');
            return false;
        }

        function addWorkflowStep() {
            addWorkflowStepRow();
            renumberSteps();
            validatePromptBuilder();
        }

        function removeStep(btn) {
            btn.closest('.pb-workflow-step').remove();
            renumberSteps();
            validatePromptBuilder();
        }

        function moveStepUp(btn) {
            const row = btn.closest('.pb-workflow-step');
            const prev = row.previousElementSibling;
            if (prev) row.parentNode.insertBefore(row, prev);
            renumberSteps();
        }

        function moveStepDown(btn) {
            const row = btn.closest('.pb-workflow-step');
            const next = row.nextElementSibling;
            if (next) row.parentNode.insertBefore(next, row);
            renumberSteps();
        }

        function renumberSteps() {
            document.querySelectorAll('.pb-workflow-step').forEach((step, i) => {
                const numSpan = step.querySelector('.step-number');
                if (numSpan) numSpan.textContent = `${i + 1}.`;
            });
        }

        function addInstructionRow(value = '') {
            const container = document.getElementById('pb-instructions');
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2 pb-instruction-row';
            row.innerHTML = `
                <span class="text-cyan-400">‚Ä¢</span>
                <input type="text" class="flex-1 bg-slate-950 border border-slate-700 rounded p-1.5 text-xs text-slate-300" placeholder="Regla o gu√≠a..." value="${value}">
                <button onclick="removeInstruction(this)" class="text-slate-500 hover:text-red-400 transition text-xs"><i class="fa-solid fa-times"></i></button>
            `;
            container.appendChild(row);
        }

        function addInstruction() {
            addInstructionRow();
            validatePromptBuilder();
        }

        function removeInstruction(btn) {
            btn.closest('.pb-instruction-row').remove();
            validatePromptBuilder();
        }

        function validatePromptBuilder() {
            const checks = [
                {
                    test: () => document.getElementById('pb-name').value && document.getElementById('pb-description').value,
                    label: 'Metadata completo'
                },
                {
                    test: () => document.querySelectorAll('.pb-variable-row').length >= 1,
                    label: 'Variables definidas'
                },
                {
                    test: () => {
                        const steps = document.querySelectorAll('.pb-workflow-step input');
                        return steps.length >= 4 && Array.from(steps).every(s => s.value.trim());
                    },
                    label: 'Workflow tiene 4+ pasos'
                },
                {
                    test: () => {
                        const ins = document.querySelectorAll('.pb-instruction-row input');
                        return ins.length >= 1 && Array.from(ins).some(i => i.value.trim());
                    },
                    label: 'Instructions definidas'
                },
                {
                    test: () => document.getElementById('pb-report').value.trim().length > 10,
                    label: 'Report definido'
                }
            ];

            const container = document.getElementById('pb-validation');
            container.innerHTML = checks.map(c => {
                const passed = c.test();
                const icon = passed ? 'fa-check-circle text-green-400' : 'fa-circle text-slate-500';
                const textColor = passed ? 'text-green-400' : 'text-slate-500';
                return `<div class="flex items-center gap-2 ${textColor}"><i class="fa-solid ${icon} w-3"></i> ${c.label}</div>`;
            }).join('');
        }

        function generatePromptPreview() {
            const name = document.getElementById('pb-name').value || 'mi-comando';
            const desc = document.getElementById('pb-description').value || 'Descripci√≥n del comando';
            const argHint = document.getElementById('pb-arg-hint').value;
            const tools = Array.from(document.querySelectorAll('.pb-tool:checked')).map(cb => cb.value).join(', ');

            const variables = Array.from(document.querySelectorAll('.pb-variable-row')).map(row => {
                const inputs = row.querySelectorAll('input');
                const select = row.querySelector('select');
                return { name: inputs[0].value, type: select.value, desc: inputs[1].value };
            }).filter(v => v.name);

            const workflow = Array.from(document.querySelectorAll('.pb-workflow-step input'))
                .map(i => i.value).filter(v => v.trim());

            const instructions = Array.from(document.querySelectorAll('.pb-instruction-row input'))
                .map(i => i.value).filter(v => v.trim());

            const report = document.getElementById('pb-report').value;

            let md = `---
description: ${desc}
allowed-tools: ${tools}${argHint ? `\nargument-hint: ${argHint}` : ''}
---

# ${name.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}

## Variables

| Variable | Tipo | Descripci√≥n |
|----------|------|-------------|
${variables.map(v => `| \`${v.name}\` | ${v.type} | ${v.desc} |`).join('\n')}

## Workflow

${workflow.map((step, i) => `${i + 1}. **${step}**`).join('\n')}

## Instructions

${instructions.map(ins => `- ${ins}`).join('\n')}

## Report

\`\`\`
${report}
\`\`\``;

            document.getElementById('pb-preview').textContent = md;
            validatePromptBuilder();
        }

        function copyPromptBuilder() {
            const content = document.getElementById('pb-preview').textContent;
            navigator.clipboard.writeText(content);
            showToast('Prompt copiado al portapapeles', 'success');
        }

        function exportPromptCommand() {
            const name = document.getElementById('pb-name').value || 'mi-comando';
            const content = document.getElementById('pb-preview').textContent;

            if (!content) {
                showToast('Primero genera el preview', 'error');
                return;
            }

            // Crear blob y descargar
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name}.md`;
            a.click();
            URL.revokeObjectURL(url);

            showToast(`${name}.md descargado. Mueve a ~/.claude/commands/`, 'success');
        }

        async function installPromptCommand() {
            const name = document.getElementById('pb-name').value;
            const content = document.getElementById('pb-preview').textContent;
            const description = document.getElementById('pb-description').value;
            const argHint = document.getElementById('pb-arg-hint').value;

            if (!name) {
                showToast('El nombre del comando es requerido', 'error');
                return;
            }

            if (!content) {
                showToast('Primero genera el preview', 'error');
                return;
            }

            // Obtener tools seleccionados
            const tools = [];
            document.querySelectorAll('.pb-tool:checked').forEach(cb => tools.push(cb.value));

            try {
                const response = await fetch('/api/commands', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        allowed_tools: tools,
                        argument_hint: argHint,
                        content: content
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                showToast(`/${name} instalado correctamente`, 'success');

                // Refrescar lista de comandos instalados
                loadInstalledCommands();

            } catch (error) {
                console.error('Error installing command:', error);
                showToast(`Error: ${error.message}. ¬øBackend activo?`, 'error');
            }
        }

        async function loadInstalledCommands() {
            try {
                const response = await fetch('/api/commands');
                if (!response.ok) return;

                const data = await response.json();
                const container = document.getElementById('installed-commands-list');
                if (!container) return;

                if (data.commands.length === 0) {
                    container.innerHTML = '<p class="text-slate-500 text-xs">No hay comandos instalados</p>';
                    return;
                }

                container.innerHTML = data.commands.map(cmd => `
                    <div class="flex items-center justify-between bg-slate-900 rounded-lg p-2 border border-slate-700">
                        <div class="flex-1 min-w-0">
                            <span class="text-blue-400 font-mono text-xs">/${cmd.name}</span>
                            <p class="text-[10px] text-slate-500 truncate">${cmd.description || 'Sin descripci√≥n'}</p>
                        </div>
                        <div class="flex gap-1 ml-2">
                            <button onclick="loadCommandToEditor('${cmd.name}')" class="text-slate-400 hover:text-blue-400 p-1" title="Editar">
                                <i class="fa-solid fa-pen-to-square text-xs"></i>
                            </button>
                            <button onclick="deleteInstalledCommand('${cmd.name}')" class="text-slate-400 hover:text-red-400 p-1" title="Eliminar">
                                <i class="fa-solid fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading commands:', error);
            }
        }

        async function loadCommandToEditor(name) {
            try {
                const response = await fetch(`/api/commands/${name}`);
                if (!response.ok) throw new Error('Comando no encontrado');

                const cmd = await response.json();
                const content = cmd.content;

                // Parsear el contenido markdown
                document.getElementById('pb-name').value = cmd.name;
                document.getElementById('pb-description').value = cmd.description;
                document.getElementById('pb-arg-hint').value = cmd.argument_hint;

                // Cargar tools
                document.querySelectorAll('.pb-tool').forEach(cb => {
                    cb.checked = cmd.allowed_tools.includes(cb.value);
                });

                // Parsear secciones del markdown
                const sections = parseMarkdownSections(content);

                // Variables
                const varsContainer = document.getElementById('pb-variables');
                varsContainer.innerHTML = '';
                if (sections.variables && sections.variables.length > 0) {
                    sections.variables.forEach((v, i) => {
                        addVariableRow(v.name, v.type, v.desc, i === 0 && v.name.includes('$'));
                    });
                } else {
                    addVariableRow('$ARGUMENTS', 'din√°mico', 'Input del usuario', true);
                }

                // Workflow
                const wfContainer = document.getElementById('pb-workflow');
                wfContainer.innerHTML = '';
                if (sections.workflow && sections.workflow.length > 0) {
                    sections.workflow.forEach((step, i) => {
                        addWorkflowStepRow(step, i + 1);
                    });
                } else {
                    addWorkflowStepRow('Determinar scope');
                }

                // Instructions
                const insContainer = document.getElementById('pb-instructions');
                insContainer.innerHTML = '';
                if (sections.instructions && sections.instructions.length > 0) {
                    sections.instructions.forEach(ins => {
                        addInstructionRow(ins);
                    });
                } else {
                    addInstructionRow('');
                }

                // Report
                document.getElementById('pb-report').value = sections.report || '';

                // Poner contenido en preview
                document.getElementById('pb-preview').textContent = content;

                showToast(`/${name} cargado para editar`, 'info');
                validatePromptBuilder();

            } catch (error) {
                console.error('Error loading command:', error);
                showToast(`Error cargando /${name}`, 'error');
            }
        }

        function parseMarkdownSections(content) {
            const result = { variables: [], workflow: [], instructions: [], report: '' };

            // Extraer Variables (tabla markdown)
            const varsMatch = content.match(/## Variables[\s\S]*?\|[\s\S]*?(?=\n## |\n---|\n```|$)/);
            if (varsMatch) {
                const tableLines = varsMatch[0].split('\n').filter(l => l.startsWith('|') && !l.includes('---'));
                tableLines.slice(1).forEach(line => { // Skip header
                    const cells = line.split('|').map(c => c.trim()).filter(c => c);
                    if (cells.length >= 3) {
                        result.variables.push({
                            name: cells[0].replace(/`/g, ''),
                            type: cells[1],
                            desc: cells[2]
                        });
                    }
                });
            }

            // Extraer Workflow (lista numerada)
            const workflowMatch = content.match(/## Workflow[\s\S]*?(?=\n## |\n---|\n```|$)/);
            if (workflowMatch) {
                const lines = workflowMatch[0].split('\n');
                lines.forEach(line => {
                    const stepMatch = line.match(/^\d+\.\s+\*\*([^*]+)\*\*/);
                    if (stepMatch) {
                        result.workflow.push(stepMatch[1].trim());
                    } else {
                        const simpleMatch = line.match(/^\d+\.\s+(.+)/);
                        if (simpleMatch && !simpleMatch[1].includes('|')) {
                            result.workflow.push(simpleMatch[1].replace(/\*\*/g, '').trim());
                        }
                    }
                });
            }

            // Extraer Instructions (lista con -)
            const instructionsMatch = content.match(/## Instructions[\s\S]*?(?=\n## |\n---|\n```|$)/);
            if (instructionsMatch) {
                const lines = instructionsMatch[0].split('\n');
                lines.forEach(line => {
                    const insMatch = line.match(/^-\s+(.+)/);
                    if (insMatch) {
                        result.instructions.push(insMatch[1].replace(/\*\*/g, '').trim());
                    }
                });
            }

            // Extraer Report (bloque de c√≥digo)
            const reportMatch = content.match(/## Report[\s\S]*?```([\s\S]*?)```/);
            if (reportMatch) {
                result.report = reportMatch[1].trim();
            }

            return result;
        }

        async function deleteInstalledCommand(name) {
            if (!confirm(`¬øEliminar el comando /${name}?`)) return;

            try {
                const response = await fetch(`/api/commands/${name}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Error eliminando');

                showToast(`/${name} eliminado`, 'success');
                loadInstalledCommands();

            } catch (error) {
                showToast(`Error eliminando /${name}`, 'error');
            }
        }

        // Cargar comandos al iniciar si estamos en Prompt Builder
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadInstalledCommands, 1000);
            // Inicializar workflow con un paso por defecto si est√° vac√≠o
            initializePromptBuilder();
        });

        // ============================================
        // ATAJOS DE TECLADO GLOBALES v9.1
        // ============================================
        document.addEventListener('keydown', (e) => {
            // Solo en vista architect
            const isArchitectView = document.getElementById('view-architect')?.classList.contains('hidden') === false;
            if (!isArchitectView) return;

            // Ignorar si estamos en un input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            // Ctrl+Z / Cmd+Z = Undo
            if ((e.ctrlKey || e.metaKey) && !e.shiftKey && e.key === 'z') {
                e.preventDefault();
                canvasUndo();
            }

            // Ctrl+Shift+Z / Cmd+Shift+Z = Redo
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z') {
                e.preventDefault();
                canvasRedo();
            }

            // Ctrl+S / Cmd+S = Guardar arquitectura
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveArchitecture();
            }

            // Ctrl+E / Cmd+E = Exportar JSON
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                exportPipelineJSON();
            }

            // Delete / Backspace = Eliminar √∫ltimo nodo
            if ((e.key === 'Delete' || e.key === 'Backspace') && canvasNodes.length > 0) {
                e.preventDefault();
                if (selectedNodeIndex !== null && selectedNodeIndex < canvasNodes.length) {
                    removeNode(selectedNodeIndex);
                    selectedNodeIndex = null;
                } else {
                    // Si no hay nodo seleccionado, eliminar el √∫ltimo
                    removeNode(canvasNodes.length - 1);
                }
            }
        });

        function initializePromptBuilder() {
            const wfContainer = document.getElementById('pb-workflow');
            if (wfContainer && wfContainer.children.length === 0) {
                addWorkflowStepRow('Determinar scope');
            }
        }

        function clearPromptBuilder() {
            // Limpiar metadata
            document.getElementById('pb-name').value = '';
            document.getElementById('pb-description').value = '';
            document.getElementById('pb-arg-hint').value = '';

            // Desmarcar tools
            document.querySelectorAll('.pb-tool').forEach(cb => cb.checked = false);
            // Marcar los b√°sicos
            ['Read', 'Glob', 'Grep'].forEach(t => {
                const cb = document.querySelector(`.pb-tool[value="${t}"]`);
                if (cb) cb.checked = true;
            });

            // Limpiar variables
            const varsContainer = document.getElementById('pb-variables');
            varsContainer.innerHTML = '';
            addVariableRow('$ARGUMENTS', 'din√°mico', 'Input del usuario', true);

            // Limpiar workflow
            const wfContainer = document.getElementById('pb-workflow');
            wfContainer.innerHTML = '';
            addWorkflowStepRow('');

            // Limpiar instructions
            const insContainer = document.getElementById('pb-instructions');
            insContainer.innerHTML = '';
            addInstructionRow('');

            // Limpiar report
            document.getElementById('pb-report').value = '';

            // Limpiar preview
            document.getElementById('pb-preview').textContent = '';

            // Reset selector
            document.getElementById('pb-template').value = '';

            validatePromptBuilder();
            showToast('Formulario limpiado', 'info');
        }

        // Lista de herramientas comunes para autocompletado
        const commonTools = [
            { name: 'Read', desc: 'Leer archivos' },
            { name: 'Write', desc: 'Escribir archivos' },
            { name: 'Edit', desc: 'Editar archivos' },
            { name: 'Glob', desc: 'Buscar por patr√≥n' },
            { name: 'Grep', desc: 'Buscar contenido' },
            { name: 'Bash', desc: 'Ejecutar comandos' },
            { name: 'Bash(npm:*)', desc: 'Comandos npm' },
            { name: 'Bash(pytest:*)', desc: 'Comandos pytest' },
            { name: 'Bash(git:*)', desc: 'Comandos git' },
            { name: 'Bash(python:*)', desc: 'Ejecutar Python' },
            { name: 'Bash(curl:*)', desc: 'Comandos curl' },
            { name: 'Bash(ls:*)', desc: 'Listar archivos' },
            { name: 'WebFetch', desc: 'Obtener URLs' },
            { name: 'WebSearch', desc: 'Buscar en web' },
            { name: 'Task', desc: 'Lanzar subagentes' }
        ];

        // Verbos comunes para workflow
        const workflowVerbs = [
            'Detectar', 'Leer', 'Analizar', 'Validar', 'Buscar', 'Comparar',
            'Generar', 'Ejecutar', 'Reportar', 'Clasificar', 'Identificar',
            'Preguntar', 'Confirmar', 'Guardar', 'Refrescar', 'Parsear'
        ];

        // Monitor & Generator
        let isOnline = false; const term = document.getElementById('terminal-window');
        function addLog(t,m){const time=new Date().toLocaleTimeString('es-ES',{hour12:false});let c="text-slate-300";if(t==="SUCCESS")c="text-green-400";if(t==="ERROR")c="text-red-400";term.innerHTML+=`<div class="terminal-line"><span class="text-slate-600">[${time}]</span> <span class="${c} font-bold w-16 inline-block">${t}</span> ${m}</div>`;term.scrollTop=term.scrollHeight;}
        setTimeout(()=>{addLog("INFO","Conectado a DirectOS v10.1 - Pipeline Builder Pro")},1000);
        
        // ============================================
        // GLOSARIO - FILTROS, B√öSQUEDA Y PERSISTENCIA
        // ============================================

        // Cargar estados desde localStorage (compatible con OfflineStore)
        function loadToolStates() {
            const allTools = getTools();
            // Primero intentar cargar del nuevo formato (OfflineStore)
            const offlineStates = OfflineStore.get('toolStates');
            if (Object.keys(offlineStates).length > 0) {
                allTools.forEach(t => {
                    if (offlineStates[t.id]) {
                        t.status = offlineStates[t.id].status || offlineStates[t.id];
                    }
                });
                return;
            }
            // Fallback: formato antiguo
            const saved = localStorage.getItem('directos_tool_states');
            if (saved) {
                const states = JSON.parse(saved);
                allTools.forEach(t => {
                    if (states[t.id]) t.status = states[t.id];
                });
                // Migrar al nuevo formato
                Object.entries(states).forEach(([id, status]) => {
                    OfflineStore.save('toolStates', id, { status, synced: true });
                });
            }
        }

        // Guardar estados en localStorage (usa OfflineStore + sync)
        function saveToolStates() {
            const states = {};
            const allTools = getTools();
            allTools.forEach(t => {
                states[t.id] = t.status;
                // Guardar en OfflineStore con sync
                OfflineStore.save('toolStates', t.id, { status: t.status });
            });
            // Mantener compatibilidad con formato antiguo
            localStorage.setItem('directos_tool_states', JSON.stringify(states));
        }

        // Cambiar estado de herramienta (con sync offline-first)
        function changeToolStatus(toolId, newStatus) {
            const allTools = getTools();
            const tool = allTools.find(t => t.id === toolId);
            if (tool) {
                tool.status = newStatus;
                // Guardar solo este tool en OfflineStore (m√°s eficiente)
                OfflineStore.save('toolStates', toolId, { status: newStatus });
                // Mantener compatibilidad
                const states = {};
                allTools.forEach(t => states[t.id] = t.status);
                localStorage.setItem('directos_tool_states', JSON.stringify(states));

                renderToolsGrid();
                updateProgress();
                // Actualizar modal si est√° abierto
                if (currentTool && currentTool.id === toolId) {
                    currentTool.status = newStatus;
                    const statusEl = document.getElementById('tool-modal-status');
                    statusEl.textContent = statusLabels[newStatus];
                    statusEl.className = `status-badge status-${newStatus}`;
                }
                addLog("SUCCESS", `"${tool.name}" marcada como ${statusLabels[newStatus]}`);
            }
        }

        // Filtrar herramientas
        function filterTools() {
            renderToolsGrid();
        }

        // Filtro r√°pido por estado
        function setStatusFilter(status) {
            document.getElementById('filter-status').value = status;
            // Actualizar botones activos
            document.querySelectorAll('.status-filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-500');
                btn.classList.add('bg-slate-800', 'text-slate-300', 'border-slate-700');
            });
            const activeBtn = document.querySelector(`.status-filter-btn[data-status="${status}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-slate-800', 'text-slate-300', 'border-slate-700');
                activeBtn.classList.add('bg-blue-600', 'text-white', 'border-blue-500');
            }
            filterTools();
        }

        // Renderizar grid con filtros
        function renderToolsGrid() {
            const grid = document.getElementById('tools-grid');
            const noResults = document.getElementById('no-results');
            if (!grid) return;

            const searchTerm = (document.getElementById('tools-search')?.value || '').toLowerCase();
            const categoryFilter = document.getElementById('filter-category')?.value || 'all';
            const statusFilter = document.getElementById('filter-status')?.value || 'all';

            grid.innerHTML = '';

            const filteredTools = getTools().filter(t => {
                const matchSearch = t.name.toLowerCase().includes(searchTerm) ||
                                   t.desc.toLowerCase().includes(searchTerm) ||
                                   t.tag.toLowerCase().includes(searchTerm);
                const matchCategory = categoryFilter === 'all' || t.cat === categoryFilter;
                const matchStatus = statusFilter === 'all' || t.status === statusFilter;
                return matchSearch && matchCategory && matchStatus;
            });

            if (filteredTools.length === 0) {
                noResults?.classList.remove('hidden');
            } else {
                noResults?.classList.add('hidden');
            }

            filteredTools.forEach(t => {
                const card = document.createElement('div');
                card.className = `bg-slate-900 border border-slate-800 border-l-4 ${catStyles[t.cat]} p-5 rounded-xl flex flex-col justify-between hover:border-slate-600 transition card-hover cursor-pointer`;
                card.onclick = () => openToolModal(t.id);
                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-3">
                            <i class="fa-solid ${t.icon} ${t.color} text-xl"></i>
                            <span class="status-badge status-${t.status}">${statusLabels[t.status]}</span>
                        </div>
                        <h3 class="text-lg font-bold text-white mb-1">${t.name}</h3>
                        <span class="text-[10px] bg-slate-950 px-2 py-0.5 rounded text-slate-500 uppercase tracking-wider">${t.tag}</span>
                        <p class="text-sm text-slate-400 mt-3 leading-relaxed">${t.desc}</p>
                    </div>
                    <div class="mt-4 pt-3 border-t border-slate-800 flex flex-wrap gap-1">
                        ${t.cases.slice(0, 2).map(c => `<span class="text-[10px] bg-slate-800 text-slate-400 px-2 py-1 rounded">${c}</span>`).join('')}
                        ${t.cases.length > 2 ? `<span class="text-[10px] text-slate-600">+${t.cases.length - 2}</span>` : ''}
                    </div>`;
                grid.appendChild(card);
            });

            updateCounts();
        }

        // Actualizar contadores
        function updateCounts() {
            const counts = { all: getTools().length, used: 0, learning: 0, new: 0 };
            getTools().forEach(t => counts[t.status]++);

            document.getElementById('count-all').textContent = counts.all;
            document.getElementById('count-used').textContent = counts.used;
            document.getElementById('count-learning').textContent = counts.learning;
            document.getElementById('count-new').textContent = counts.new;
        }

        // Actualizar progreso
        function updateProgress() {
            const total = getTools().length;
            const dominated = getTools().filter(t => t.status === 'used').length;
            const percent = Math.round((dominated / total) * 100);

            document.getElementById('progress-count').textContent = dominated;
            document.getElementById('progress-total').textContent = total;
            document.getElementById('progress-percent').textContent = `${percent}%`;

            // Actualizar c√≠rculo SVG (circunferencia = 2 * PI * 24 = 150.8)
            const circle = document.getElementById('progress-circle');
            if (circle) {
                const offset = 150.8 - (150.8 * percent / 100);
                circle.style.strokeDashoffset = offset;
            }
        }

        // Inicializar Glosario (async para cargar desde API)
        async function initGlosario() {
            // Primero cargar tools desde API (o fallback)
            await loadToolsFromAPI();

            // Luego renderizar
            loadToolStates();
            renderToolsGrid();
            updateProgress();
            setStatusFilter('all');
        }

        // Render inicial (se llamar√° desde init)
        initGlosario();

        // Render Stack Selector
        const stackContainer = document.getElementById('stack-selector');
        const categories = {}; getTools().forEach(t => { if(!categories[t.cat]) categories[t.cat] = []; categories[t.cat].push(t); });
        for (const [cat, items] of Object.entries(categories)) {
            const g = document.createElement('div'); g.className="mb-4"; g.innerHTML=`<h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 sticky top-0 bg-slate-900 py-1">${cat}</h4>`;
            items.forEach(t=>{ const l=document.createElement('label'); l.className="flex items-center gap-3 p-2 rounded-lg cursor-pointer hover:bg-slate-800/50 transition group"; l.innerHTML=`<input type="checkbox" value="${t.name}" class="peer sr-only tool-checkbox"><div class="w-4 h-4 rounded border border-slate-600 bg-slate-900 peer-checked:bg-blue-500 flex items-center justify-center"><i class="fa-solid fa-check text-[10px] text-white opacity-0 check-icon"></i></div><span class="text-sm text-slate-300 peer-checked:text-white">${t.name}</span>`; g.appendChild(l); });
            stackContainer.appendChild(g);
        }

        // INTERACTIVIDAD COMPLETA
        function openNodeDetails(nodeId) {
            const data = nodeDetails[nodeId];
            if(!data) return;
            const modal = document.getElementById('node-modal');
            modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('translate-x-full'), 10);
            
            document.getElementById('modal-content').innerHTML = `
                <div class="mb-6"><span class="text-xs font-mono text-blue-400 border border-blue-500/30 px-2 py-1 rounded bg-blue-500/10 mb-2 inline-block">INSPECTOR</span><h2 class="text-2xl font-bold text-white">${data.title}</h2><p class="text-slate-400 mt-2 text-sm leading-relaxed">${data.desc}</p></div>
                <div class="mb-6"><h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">C√≥digo T√°ctico</h3><div class="bg-slate-950 border border-slate-800 rounded-lg p-3 font-mono text-xs text-green-400 overflow-x-auto"><pre>${data.code}</pre></div></div>
                <div class="mt-8 pt-6 border-t border-slate-800"><h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Generar Prompt para...</h3><div class="grid grid-cols-1 gap-2">
                     <button onclick="jumpToGenerator('${nodeId}', 'scaffold')" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 p-2 rounded-lg text-xs font-bold border border-slate-700 flex items-center gap-2">üèóÔ∏è Scaffold</button>
                     <button onclick="jumpToGenerator('${nodeId}', 'explain')" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 p-2 rounded-lg text-xs font-bold border border-slate-700 flex items-center gap-2">üìñ Explicar</button>
                     <button onclick="jumpToGenerator('${nodeId}', 'optimize')" class="w-full bg-slate-800 hover:bg-blue-600 hover:text-white text-slate-300 p-2 rounded-lg text-xs font-bold border border-slate-700">üöÄ Optimizar</button>
                </div></div>`;
        }
        function closeNodeDetails() { const m = document.getElementById('node-modal'); m.classList.add('translate-x-full'); setTimeout(() => m.classList.add('hidden'), 300); }
        
        function jumpToGenerator(nodeId, mode) {
            const data = nodeDetails[nodeId]; closeNodeDetails(); switchView('generator');
            document.getElementById('prompt-role').value = data.role;
            let g = data.goal;
            if (mode === 'scaffold') g = `Generar el c√≥digo base (scaffold) para implementar ${data.title}.`;
            if (mode === 'explain') g = `Explicar l√≠nea por l√≠nea c√≥mo funciona ${data.title}.`;
            if (mode === 'optimize') g = `Analizar y optimizar el c√≥digo de ${data.title}.`;
            document.getElementById('prompt-goal').value = g;
        }

        // Helpers
        function setGoal(t) { document.getElementById('prompt-goal').value = t; }
        function clearSelection() { document.querySelectorAll('.tool-checkbox').forEach(c => c.checked = false); }
        function copyToClipboard() { navigator.clipboard.writeText(document.getElementById('prompt-output').textContent); }
        function generatePrompt() {
            const r = document.getElementById('prompt-role').value; const g = document.getElementById('prompt-goal').value || "[Objetivo]"; const s = Array.from(document.querySelectorAll('.tool-checkbox:checked')).map(cb => cb.value).join(", ") || "stack";
            document.getElementById('prompt-output').textContent = `**ROL:** ${r}\n**STACK:** ${s}\n**OBJETIVO:** ${g}\n**ESTILO:** Local-first.`;
        }
        function loadProjectPreset() { const v=document.getElementById('project-select').value; canvasNodes=[]; if(v==='videomine')['fastapi','ffmpeg','whisper','clip','chroma'].forEach(id=>addNodeToCanvas(id)); else if(v==='docmine')['fastapi','python','clip','chroma','sqlite'].forEach(id=>addNodeToCanvas(id)); renderCanvas(); }

        setInterval(() => { document.getElementById('clock').textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }, 1000);

        // ============================================
        // FLUJOS T√ÅCTICOS - FUNCIONES
        // ============================================
        let currentFlow = null;
        let currentFlowFilter = 'all';

        function initFlowsGallery() {
            renderFlowsGrid('all');
        }

        function renderFlowsGrid(filter) {
            currentFlowFilter = filter;
            const grid = document.getElementById('flows-grid');
            if (!grid) return;

            grid.innerHTML = '';

            // Filtrar flujos
            const flowEntries = Object.entries(FLOWS_DATA).filter(([key, flow]) => {
                return filter === 'all' || flow.category === filter;
            });

            // Renderizar tarjetas
            flowEntries.forEach(([flowId, flow]) => {
                const cat = FLOW_CATEGORIES[flow.category];
                const complexity = COMPLEXITY_LABELS[flow.complexity];
                const cost = COST_LABELS[flow.cost];

                const card = document.createElement('div');
                card.className = `flow-card bg-slate-900 border border-slate-800 rounded-xl overflow-hidden hover:border-slate-600 transition-all duration-300 cursor-pointer group hover:shadow-xl hover:shadow-blue-500/5 hover:-translate-y-1`;
                card.setAttribute('data-category', flow.category);
                card.onclick = () => openFlowModal(flowId);

                card.innerHTML = `
                    <!-- Header con emoji y badges -->
                    <div class="p-4 border-b border-slate-800 ${cat.bg}">
                        <div class="flex items-start justify-between">
                            <span class="text-3xl">${flow.emoji}</span>
                            <div class="flex flex-col gap-1 items-end">
                                <span class="text-[10px] px-2 py-0.5 rounded border ${complexity.class}">${complexity.icon} ${complexity.label}</span>
                                <span class="text-[10px] px-2 py-0.5 rounded border ${cost.class}">${cost.icon} ${cost.label}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Body -->
                    <div class="p-4">
                        <h3 class="text-lg font-bold text-white mb-2 group-hover:text-blue-400 transition">${flow.title}</h3>
                        <p class="text-sm text-slate-400 mb-4 line-clamp-2">${flow.desc}</p>

                        <!-- Stack visual -->
                        <div class="flex flex-wrap gap-1 mb-4">
                            ${flow.stack.slice(0, 4).map(toolId => {
                                const tool = getTools().find(t => t.id === toolId);
                                if (!tool) return '';
                                return `<span class="inline-flex items-center gap-1 bg-slate-800 border border-slate-700 px-1.5 py-0.5 rounded text-[10px]">
                                    <i class="fa-solid ${tool.icon} ${tool.color}"></i>
                                </span>`;
                            }).join('')}
                            ${flow.stack.length > 4 ? `<span class="text-[10px] text-slate-500 px-1">+${flow.stack.length - 4}</span>` : ''}
                        </div>

                        <!-- Categor√≠a -->
                        <div class="flex items-center gap-2">
                            <i class="fa-solid ${cat.icon} ${cat.color} text-xs"></i>
                            <span class="text-[10px] text-slate-500 uppercase tracking-wider">${cat.name}</span>
                        </div>
                    </div>

                    <!-- Footer con acci√≥n r√°pida -->
                    <div class="px-4 pb-4">
                        <button onclick="event.stopPropagation(); quickCloneFlow('${flowId}')" class="w-full bg-slate-800 hover:bg-blue-600 text-slate-300 hover:text-white text-xs py-2 rounded-lg font-medium transition flex items-center justify-center gap-2 border border-slate-700 hover:border-blue-500">
                            <i class="fa-solid fa-clone"></i> Clonar al Arquitecto
                        </button>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function filterFlows(category) {
            // Actualizar botones
            document.querySelectorAll('.flow-filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-slate-800', 'text-slate-300', 'border', 'border-slate-700');
            });

            const activeBtn = document.getElementById(`flow-filter-${category}`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-slate-800', 'text-slate-300', 'border', 'border-slate-700');
                activeBtn.classList.add('bg-blue-600', 'text-white');
            }

            renderFlowsGrid(category);
        }

        function openFlowModal(flowId) {
            const flow = FLOWS_DATA[flowId];
            if (!flow) return;

            currentFlow = { id: flowId, ...flow };

            const cat = FLOW_CATEGORIES[flow.category];
            const complexity = COMPLEXITY_LABELS[flow.complexity];
            const cost = COST_LABELS[flow.cost];

            // Rellenar datos
            document.getElementById('flow-modal-emoji').textContent = flow.emoji;
            document.getElementById('flow-modal-title').textContent = flow.title;
            document.getElementById('flow-modal-desc').textContent = flow.desc;
            document.getElementById('flow-modal-usecase').textContent = flow.useCase;
            document.getElementById('flow-modal-flowdesc').textContent = flow.flowDesc;
            document.getElementById('flow-modal-prompt').textContent = flow.prompt;

            // Badges
            const catEl = document.getElementById('flow-modal-category');
            catEl.textContent = cat.name;
            catEl.className = `text-xs px-2 py-0.5 rounded border ${cat.bg} ${cat.border} ${cat.color}`;

            const complexEl = document.getElementById('flow-modal-complexity');
            complexEl.textContent = `${complexity.icon} ${complexity.label}`;
            complexEl.className = `text-xs px-2 py-0.5 rounded border ${complexity.class}`;

            const costEl = document.getElementById('flow-modal-cost');
            costEl.textContent = `${cost.icon} ${cost.label}`;
            costEl.className = `text-xs px-2 py-0.5 rounded border ${cost.class}`;

            // Stack visual
            const stackContainer = document.getElementById('flow-modal-stack');
            stackContainer.innerHTML = flow.stack.map(toolId => {
                const tool = getTools().find(t => t.id === toolId);
                if (!tool) return '';
                return `<span class="inline-flex items-center gap-1.5 bg-slate-800 border border-slate-700 px-2 py-1 rounded text-xs">
                    <i class="fa-solid ${tool.icon} ${tool.color}"></i>
                    <span class="text-slate-300">${tool.name}</span>
                </span>`;
            }).join('<span class="text-slate-600 mx-1">‚Üí</span>');

            document.getElementById('flow-detail-modal').classList.remove('hidden');
        }

        function cloneFlowToArchitect() {
            if (!currentFlow) return;

            // Limpiar canvas y cargar herramientas del flujo
            canvasNodes = [];
            currentFlow.stack.forEach(toolId => {
                const tool = getTools().find(t => t.id === toolId);
                if (tool) canvasNodes.push(tool);
            });
            renderCanvas();

            closeModal('flow-detail-modal');
            switchView('architect');

            // Notificaci√≥n
            addLog("SUCCESS", `Flujo "${currentFlow.title}" clonado al Arquitecto`);
        }

        function quickCloneFlow(flowId) {
            const flow = FLOWS_DATA[flowId];
            if (!flow) return;

            // Limpiar canvas y cargar herramientas
            canvasNodes = [];
            flow.stack.forEach(toolId => {
                const tool = getTools().find(t => t.id === toolId);
                if (tool) canvasNodes.push(tool);
            });
            renderCanvas();

            switchView('architect');
            addLog("SUCCESS", `Flujo "${flow.title}" clonado al Arquitecto`);
        }

        function copyFlowPrompt() {
            if (!currentFlow) return;
            navigator.clipboard.writeText(currentFlow.prompt);
            addLog("SUCCESS", `Prompt de "${currentFlow.title}" copiado al portapapeles`);
        }

        // ============================================
        // BIBLIOTECA DE PATRONES - FUNCIONES
        // ============================================
        let currentPattern = null;

        function initPatternsAccordion() {
            const container = document.getElementById('patterns-accordion');
            if (!container) return;

            container.innerHTML = '';

            for (const [catId, category] of Object.entries(promptPatterns)) {
                const catDiv = document.createElement('div');
                catDiv.className = 'border border-slate-800 rounded-lg overflow-hidden';

                // Header del acorde√≥n
                const header = document.createElement('button');
                header.className = 'w-full flex items-center justify-between p-3 bg-slate-950 hover:bg-slate-800 transition text-left';
                header.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fa-solid ${category.icon} text-slate-500 text-xs"></i>
                        <span class="text-sm font-medium text-slate-300">${category.name}</span>
                        <span class="text-[10px] bg-slate-800 text-slate-500 px-1.5 py-0.5 rounded">${category.patterns.length}</span>
                    </div>
                    <i class="fa-solid fa-chevron-down text-slate-600 text-xs transition-transform accordion-icon"></i>
                `;

                // Contenido del acorde√≥n
                const content = document.createElement('div');
                content.className = 'hidden bg-slate-900/50 border-t border-slate-800';

                category.patterns.forEach(pattern => {
                    const patternBtn = document.createElement('button');
                    patternBtn.className = 'w-full text-left p-2.5 hover:bg-slate-800 transition flex items-center gap-2 border-b border-slate-800/50 last:border-0';
                    patternBtn.innerHTML = `
                        <span class="text-base">${pattern.emoji}</span>
                        <span class="text-xs text-slate-400">${pattern.name}</span>
                    `;
                    patternBtn.onclick = () => openPatternModal(pattern);
                    content.appendChild(patternBtn);
                });

                // Toggle acorde√≥n
                header.onclick = () => {
                    const isOpen = !content.classList.contains('hidden');
                    // Cerrar todos
                    container.querySelectorAll('.accordion-content').forEach(c => c.classList.add('hidden'));
                    container.querySelectorAll('.accordion-icon').forEach(i => i.style.transform = 'rotate(0deg)');
                    // Abrir actual si estaba cerrado
                    if (!isOpen) {
                        content.classList.remove('hidden');
                        header.querySelector('.accordion-icon').style.transform = 'rotate(180deg)';
                    }
                };

                content.classList.add('accordion-content');
                catDiv.appendChild(header);
                catDiv.appendChild(content);
                container.appendChild(catDiv);
            }
        }

        function openPatternModal(pattern) {
            currentPattern = pattern;

            document.getElementById('pattern-modal-emoji').textContent = pattern.emoji;
            document.getElementById('pattern-modal-title').textContent = pattern.name;
            document.getElementById('pattern-modal-problem').textContent = pattern.problem;
            document.getElementById('pattern-modal-prompt').textContent = pattern.prompt;
            document.getElementById('pattern-modal-flowdesc').textContent = pattern.flowDesc;

            // Renderizar herramientas del flujo
            const flowContainer = document.getElementById('pattern-modal-flow');
            flowContainer.innerHTML = pattern.flow.map(toolId => {
                const tool = getTools().find(t => t.id === toolId);
                if (!tool) return '';
                return `<span class="inline-flex items-center gap-1.5 bg-slate-800 border border-slate-700 px-2 py-1 rounded text-xs">
                    <i class="fa-solid ${tool.icon} ${tool.color}"></i>
                    <span class="text-slate-300">${tool.name}</span>
                </span>`;
            }).join('<span class="text-slate-600">‚Üí</span>');

            document.getElementById('pattern-modal').classList.remove('hidden');
        }

        function loadPatternToPrompt() {
            if (!currentPattern) return;

            // Copiar prompt al output
            document.getElementById('prompt-output').textContent = currentPattern.prompt;

            // Seleccionar herramientas del stack
            document.querySelectorAll('.tool-checkbox').forEach(cb => {
                const toolName = cb.value;
                const tool = getTools().find(t => t.name === toolName);
                cb.checked = tool && currentPattern.flow.includes(tool.id);
            });

            closeModal('pattern-modal');

            // Notificaci√≥n
            addLog("SUCCESS", `Patr√≥n "${currentPattern.name}" cargado en Generador`);
        }

        function loadPatternToArchitect() {
            if (!currentPattern) return;

            // Limpiar canvas y cargar herramientas del patr√≥n
            canvasNodes = [];
            currentPattern.flow.forEach(toolId => {
                const tool = getTools().find(t => t.id === toolId);
                if (tool) canvasNodes.push(tool);
            });
            renderCanvas();

            closeModal('pattern-modal');
            switchView('architect');

            // Notificaci√≥n
            addLog("SUCCESS", `Patr√≥n "${currentPattern.name}" cargado en Arquitecto Pro`);
        }

        // ============================================
        // FICHA T√âCNICA - FUNCIONES
        // ============================================
        let currentTool = null;

        function openToolModal(toolId) {
            const tool = getTools().find(t => t.id === toolId);
            if (!tool) return;
            currentTool = tool;

            // Rellenar datos
            const iconEl = document.getElementById('tool-modal-icon');
            iconEl.className = `fa-solid ${tool.icon} ${tool.color} text-2xl`;
            document.getElementById('tool-modal-title').textContent = tool.name;
            document.getElementById('tool-modal-tag').textContent = `${tool.cat} ‚Ä¢ ${tool.tag}`;

            const statusEl = document.getElementById('tool-modal-status');
            statusEl.textContent = statusLabels[tool.status];
            statusEl.className = `status-badge status-${tool.status}`;

            document.getElementById('tool-modal-desc').textContent = tool.desc;
            document.getElementById('tool-modal-why').textContent = tool.why;
            document.getElementById('tool-modal-code').textContent = tool.code;

            // Renderizar casos de uso
            const casesContainer = document.getElementById('tool-modal-cases');
            casesContainer.innerHTML = tool.cases.map(c =>
                `<span class="bg-slate-800 border border-slate-700 text-slate-300 text-xs px-3 py-1.5 rounded-lg">${c}</span>`
            ).join('');

            document.getElementById('tool-modal').classList.remove('hidden');
        }

        function addToolToArchitect() {
            if (!currentTool) return;
            addNodeToCanvas(currentTool.id);
            closeModal('tool-modal');
            switchView('architect');
            addLog("SUCCESS", `"${currentTool.name}" a√±adido al Arquitecto`);
        }

        function copyToolCode() {
            if (!currentTool) return;
            navigator.clipboard.writeText(currentTool.code);
            addLog("SUCCESS", `C√≥digo de "${currentTool.name}" copiado`);
        }

        // ============================================
        // 6. BACKEND API CONNECTION
        // ============================================
        // API_URL ya definido arriba en m√≥dulos offline-first

        // Health Check
        async function checkHealth() {
            try {
                const start = Date.now();
                const res = await fetch(`${API_URL}/api/health`);
                const latency = Date.now() - start;
                const data = await res.json();

                document.getElementById('health-metric').textContent = latency;
                document.getElementById('health-msg').textContent = `Online - v${data.version}`;
                document.getElementById('health-bar').style.width = Math.min(100, 100 - latency/5) + '%';
                document.getElementById('term-dot').classList.add('bg-green-500');
                document.getElementById('term-dot').classList.remove('bg-red-500/20');
                addLog("SUCCESS", `Backend conectado (${latency}ms)`);

                // Mostrar estado de m√≥dulos
                if (data.modules) {
                    addLog("INFO", `Knowledge: ${data.modules.knowledge ? '‚úì' : '‚úó'} | Scout: ${data.modules.scout ? '‚úì' : '‚úó'}`);
                }
            } catch (e) {
                document.getElementById('health-metric').textContent = '--';
                document.getElementById('health-msg').textContent = 'Backend offline';
                document.getElementById('health-bar').style.width = '0%';
                addLog("ERROR", "No se pudo conectar al backend. Ejecuta: ./start.sh");
            }
        }

        // Knowledge Base - B√∫squeda Sem√°ntica
        async function searchKnowledgeBase() {
            const query = document.getElementById('kb-search').value.trim();
            if (!query) return;

            const resultsDiv = document.getElementById('kb-results');
            resultsDiv.innerHTML = '<p class="text-slate-500 text-sm">Buscando...</p>';
            resultsDiv.classList.remove('hidden');

            try {
                const res = await fetch(`${API_URL}/api/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, limit: 5 })
                });
                const results = await res.json();

                if (results.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-slate-500 text-sm">No se encontraron resultados. ¬øHas indexado tus archivos?</p>';
                    return;
                }

                resultsDiv.innerHTML = results.map(r => `
                    <div class="bg-slate-950 border border-slate-800 rounded-lg p-3">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] text-slate-500 font-mono">${r.source.split('/').pop()}</span>
                            <span class="text-[10px] bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded">${Math.round(r.score * 100)}% match</span>
                        </div>
                        <p class="text-sm text-slate-300 leading-relaxed">${r.text.substring(0, 300)}${r.text.length > 300 ? '...' : ''}</p>
                    </div>
                `).join('');
                addLog("SUCCESS", `B√∫squeda: "${query}" ‚Üí ${results.length} resultados`);
            } catch (e) {
                resultsDiv.innerHTML = '<p class="text-red-400 text-sm">Error: Backend no disponible</p>';
                addLog("ERROR", "Knowledge Base no disponible");
            }
        }

        // Knowledge Base - Indexar
        async function indexKnowledgeBase() {
            addLog("INFO", "Indexando archivos markdown del Desktop...");
            try {
                const res = await fetch(`${API_URL}/api/index`, { method: 'POST' });
                const data = await res.json();
                addLog("SUCCESS", `Indexados ${data.indexed} chunks de ${data.path}`);
                alert(`Indexaci√≥n completada: ${data.indexed} fragmentos`);
            } catch (e) {
                addLog("ERROR", "Error al indexar");
            }
        }

        // Scout - Analizar Error
        async function analyzeWithScout() {
            const errorText = document.getElementById('scout-input').value.trim();
            if (!errorText) return alert("Pega un error para analizar");

            const btn = document.getElementById('scout-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analizando...';
            addLog("INFO", "Scout analizando error...");

            try {
                const res = await fetch(`${API_URL}/api/scout/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ error_text: errorText, context: "DirectOS / minerOS stack" })
                });
                const data = await res.json();

                // Mostrar resultado en terminal
                addLog("SUCCESS", "Scout encontr√≥ una soluci√≥n:");
                term.innerHTML += `<div class="terminal-line mt-2 p-3 bg-purple-500/10 border border-purple-500/30 rounded-lg"><pre class="text-purple-300 whitespace-pre-wrap">${data.analysis}</pre></div>`;
                term.scrollTop = term.scrollHeight;

            } catch (e) {
                addLog("ERROR", "Scout no disponible. ¬øConfiguraste ANTHROPIC_API_KEY?");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-magnifying-glass-chart"></i> Analizar Error';
            }
        }

        // Enter para buscar
        document.getElementById('kb-search')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchKnowledgeBase();
        });

        // Check health on load
        setTimeout(checkHealth, 1500);
        setInterval(checkHealth, 30000); // cada 30s

        // ============================================
        // PROYECTOS - FUNCIONES (Offline-First)
        // ============================================
        let projectsData = [];
        let currentProject = null;

        async function loadProjectsFromAPI() {
            // 1. Cargar proyectos locales (OfflineStore) primero
            const localProjects = OfflineStore.getAll('projects');

            // 2. Intentar cargar del servidor
            try {
                const response = await fetch('/api/projects');
                const data = await response.json();
                if (data.projects && Array.isArray(data.projects)) {
                    // Combinar: server projects + local projects (sin duplicados)
                    const serverProjects = data.projects;
                    const localIds = new Set(localProjects.map(p => p.id));
                    const serverIds = new Set(serverProjects.map(p => p.id));

                    // Proyectos del servidor que no est√°n en local
                    projectsData = serverProjects.filter(p => !localIds.has(p.id));
                    // A√±adir proyectos locales (tienen prioridad si hay ediciones pendientes)
                    projectsData = [...projectsData, ...localProjects];

                    return true;
                }
            } catch (error) {
                console.error('Error loading projects:', error);
            }

            // Fallback: solo proyectos locales
            projectsData = localProjects;
            return localProjects.length > 0;
        }

        // Crear proyecto local (offline-first)
        function createLocalProject() {
            const name = prompt('Nombre del proyecto:');
            if (!name) return;

            const description = prompt('Descripci√≥n:', '');
            const stackStr = prompt('Stack (separado por comas):', 'FastAPI, Python');
            const stack = stackStr ? stackStr.split(',').map(s => s.trim()) : [];

            const projectData = {
                name,
                description: description || '',
                status: 'active',
                stack,
                version: 'v1.0',
                repo: ''
            };

            const saved = OfflineStore.create('projects', projectData);
            addLog("SUCCESS", `Proyecto "${name}" creado`);

            // Recargar grid
            loadProjectsFromAPI().then(() => renderProjectsGrid());
        }

        // Eliminar proyecto local
        function deleteLocalProject(projectId) {
            const project = projectsData.find(p => p.id === projectId);
            if (!project) return;

            if (!confirm(`¬øEliminar proyecto "${project.name}"?`)) return;

            OfflineStore.remove('projects', projectId);
            addLog("INFO", `Proyecto "${project.name}" eliminado`);

            document.getElementById('project-detail-modal').classList.add('hidden');
            loadProjectsFromAPI().then(() => renderProjectsGrid());
        }

        function renderProjectsGrid() {
            const grid = document.getElementById('projects-grid');
            grid.innerHTML = '';

            if (!projectsData.length) {
                grid.innerHTML = '<div class="col-span-full text-center text-slate-500 py-12"><i class="fa-solid fa-folder-open text-4xl mb-4 block"></i><p>No hay proyectos disponibles</p></div>';
                return;
            }

            projectsData.forEach(project => {
                const statusColors = {
                    'production': 'bg-green-500/20 text-green-400 border-green-500/30',
                    'active': 'bg-blue-500/20 text-blue-400 border-blue-500/30',
                    'archived': 'bg-slate-500/20 text-slate-400 border-slate-500/30',
                    'learning': 'bg-amber-500/20 text-amber-400 border-amber-500/30'
                };

                const statusClass = statusColors[project.status] || statusColors['active'];
                const isLocal = project.id?.startsWith('local_') || project.synced === false;
                const syncIndicator = isLocal ?
                    `<span class="text-[10px] px-1.5 py-0.5 rounded bg-yellow-500/20 text-yellow-400 border border-yellow-500/30" title="Pendiente de sync"><i class="fa-solid fa-clock"></i></span>` :
                    '';

                const card = document.createElement('div');
                card.className = 'bg-slate-900 border border-slate-800 rounded-xl overflow-hidden hover:border-slate-600 transition-all duration-300 cursor-pointer group hover:shadow-xl hover:shadow-blue-500/5 hover:-translate-y-1';
                card.onclick = () => openProjectModal(project.id);

                card.innerHTML = `
                    <div class="p-5">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h3 class="text-lg font-bold text-white mb-1 group-hover:text-blue-400 transition">${project.name}</h3>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs px-2 py-0.5 rounded ${statusClass} border">${project.status}</span>
                                    ${syncIndicator}
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-500 font-mono">${project.version || 'v1.0'}</span>
                                ${isLocal ? `<button onclick="event.stopPropagation(); deleteLocalProject('${project.id}')" class="text-slate-500 hover:text-red-400 transition" title="Eliminar"><i class="fa-solid fa-trash text-xs"></i></button>` : ''}
                            </div>
                        </div>
                        <p class="text-sm text-slate-400 mb-4 line-clamp-2">${project.description || 'Sin descripci√≥n'}</p>
                        <div class="flex flex-wrap gap-1.5">
                            ${(project.stack || []).slice(0, 4).map(tech => `
                                <span class="text-[10px] bg-slate-800 text-slate-400 px-2 py-0.5 rounded border border-slate-700">${tech}</span>
                            `).join('')}
                            ${(project.stack || []).length > 4 ? `<span class="text-[10px] text-slate-500 px-1">+${project.stack.length - 4}</span>` : ''}
                        </div>
                    </div>
                    <div class="border-t border-slate-800 p-3 bg-slate-950/50">
                        <button onclick="event.stopPropagation(); openProjectModal('${project.id}')" class="w-full bg-slate-800 hover:bg-blue-600 text-slate-300 hover:text-white text-xs py-2 rounded-lg font-medium transition flex items-center justify-center gap-2 border border-slate-700 hover:border-blue-500">
                            <i class="fa-solid fa-book-open"></i> Ver Documentaci√≥n
                        </button>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function openProjectModal(projectId) {
            const project = projectsData.find(p => p.id === projectId);
            if (!project) return;

            currentProject = project;

            const statusColors = {
                'production': 'bg-green-500/20 text-green-400 border-green-500/30',
                'active': 'bg-blue-500/20 text-blue-400 border-blue-500/30',
                'archived': 'bg-slate-500/20 text-slate-400 border-slate-500/30',
                'learning': 'bg-amber-500/20 text-amber-400 border-amber-500/30'
            };

            document.getElementById('project-modal-name').textContent = project.name;
            document.getElementById('project-modal-version').textContent = project.version || 'v1.0';
            document.getElementById('project-modal-status').textContent = project.status;
            document.getElementById('project-modal-status').className = `text-xs px-2 py-1 rounded ${statusColors[project.status] || statusColors['active']} border`;
            document.getElementById('project-modal-desc').textContent = project.description || 'Sin descripci√≥n';
            document.getElementById('project-modal-repo').textContent = project.repo || 'N/A';

            // Stack t√©cnico
            const stackContainer = document.getElementById('project-modal-stack');
            stackContainer.innerHTML = (project.stack || []).map(tech => `
                <span class="inline-flex items-center gap-1.5 bg-slate-800 border border-slate-700 px-2 py-1 rounded text-xs text-slate-300">
                    <i class="fa-solid fa-cube text-purple-400"></i> ${tech}
                </span>
            `).join('');

            // Contenido markdown
            document.getElementById('project-modal-content').textContent = project.content || 'Sin contenido disponible';

            document.getElementById('project-detail-modal').classList.remove('hidden');
        }

        function copyProjectContent() {
            if (!currentProject) return;

            const text = `# ${currentProject.name} ${currentProject.version}\n\n${currentProject.description}\n\n## Stack\n${(currentProject.stack || []).join(', ')}\n\n${currentProject.content || ''}`;

            navigator.clipboard.writeText(text).then(() => {
                addLog("SUCCESS", `Documentaci√≥n de "${currentProject.name}" copiada al portapapeles`);
            });
        }

        async function initProjects() {
            await loadProjectsFromAPI();
            renderProjectsGrid();
        }

        // ============================================
        // IMPORTAR DESDE C√ìDIGO
        // ============================================

        // Mapeo de imports Python a tool IDs
        const IMPORT_TO_TOOL = {
            // Backend
            'fastapi': 'fastapi',
            'uvicorn': 'uvicorn',
            'flask': 'flask',
            'pydantic': 'pydantic',
            'httpx': 'httpx',

            // AI/ML
            'anthropic': 'claude',
            'openai': 'clip',
            'ollama': 'ollama',
            'sentence_transformers': 'sbert',
            'transformers': 'huggingface',
            'huggingface_hub': 'huggingface',
            'whisper': 'whisper',
            'faster_whisper': 'whisper',

            // Data/Storage
            'sqlite3': 'sqlite',
            'chromadb': 'chroma',

            // Scraping/Web
            'bs4': 'bs4',
            'BeautifulSoup': 'bs4',
            'beautifulsoup4': 'bs4',

            // Media/Files
            'cv2': 'opencv',
            'opencv': 'opencv',
            'ffmpeg': 'ffmpeg',
            'pymupdf': 'pymupdf',
            'fitz': 'pymupdf',
            'pypdf': 'pypdf',
            'PyPDF2': 'pypdf',
            'pytesseract': 'ocr',

            // CLI/Utils
            'loguru': 'loguru',
            'rich': 'rich',
            'typer': 'typer',
            'watchdog': 'watchdog',
            'pytest': 'pytest',
            'frontmatter': 'markdown',

            // GUI
            'tkinter': 'tkinter',

            // DevOps
            'docker': 'docker',
            'git': 'git',

            // Frontend (para c√≥digo mixto)
            'htmx': 'htmx'
        };

        let detectedTools = [];

        function importFromCodeModal() {
            document.getElementById('import-modal').classList.remove('hidden');
            document.getElementById('import-code').value = '';
            document.getElementById('import-preview').classList.add('hidden');
            document.getElementById('import-preview').innerHTML = '';
            detectedTools = [];
        }

        function analyzeImports() {
            const code = document.getElementById('import-code').value;
            if (!code.trim()) {
                showToast('Pega c√≥digo Python primero', 'error');
                return;
            }

            // Regex para detectar imports
            const importRegex = /^(?:from\s+(\w+)|import\s+(\w+))/gm;
            const detected = new Set();
            let match;

            while ((match = importRegex.exec(code)) !== null) {
                const moduleName = match[1] || match[2];
                if (moduleName) {
                    detected.add(moduleName.toLowerCase());
                }
            }

            // Mapear a herramientas
            detectedTools = [];
            const previewContainer = document.getElementById('import-preview');

            detected.forEach(moduleName => {
                // Buscar en mapeo (case insensitive)
                const toolId = Object.entries(IMPORT_TO_TOOL).find(([key, _]) =>
                    key.toLowerCase() === moduleName
                )?.[1];

                if (toolId && !detectedTools.includes(toolId)) {
                    detectedTools.push(toolId);
                }
            });

            // Mostrar preview
            previewContainer.classList.remove('hidden');

            if (detectedTools.length === 0) {
                previewContainer.innerHTML = `
                    <div class="text-center py-2">
                        <i class="fa-solid fa-circle-info text-xl text-slate-600 mb-2"></i>
                        <p class="text-slate-500 text-sm">No se detectaron herramientas conocidas</p>
                        <p class="text-xs text-slate-600 mt-1">Imports encontrados: ${[...detected].join(', ') || 'ninguno'}</p>
                    </div>
                `;
                return;
            }

            // Mostrar preview de herramientas detectadas
            previewContainer.innerHTML = `
                <p class="text-sm text-green-400 font-medium mb-2"><i class="fa-solid fa-check-circle mr-2"></i>${detectedTools.length} herramientas detectadas:</p>
                <div class="flex flex-wrap gap-2">
                    ${detectedTools.map(id => `
                        <span class="bg-slate-700 text-slate-300 px-2 py-1 rounded-full text-xs flex items-center gap-1">
                            <i class="fa-solid fa-cube text-blue-400"></i>
                            ${id}
                        </span>
                    `).join('')}
                </div>
            `;

            showToast(`${detectedTools.length} herramientas detectadas`, 'success');
        }

        async function applyImportedArchitecture() {
            if (detectedTools.length === 0) {
                showToast('Primero analiza el c√≥digo', 'error');
                return;
            }

            // Cargar herramientas desde API
            try {
                const response = await fetch('/api/tools');
                if (!response.ok) throw new Error('No se pudieron cargar las herramientas');

                const apiTools = await response.json();
                let added = 0;

                detectedTools.forEach(toolId => {
                    const tool = apiTools.find(t => t.id === toolId);
                    if (tool) {
                        // Verificar que no est√© ya en el canvas
                        if (!canvasNodes.find(n => n.id === toolId)) {
                            canvasNodes.push({
                                id: tool.id,
                                name: tool.name,
                                cat: (tool.category || 'Other').toLowerCase(),
                                icon: tool.icon || 'fa-cube',
                                tag: tool.tag || tool.category
                            });
                            added++;
                        }
                    }
                });

                renderCanvas();
                closeModal('import-modal');

                if (added > 0) {
                    showToast(`${added} herramientas a√±adidas al canvas`, 'success');
                    addLog("SUCCESS", `Importadas ${added} herramientas desde c√≥digo`);
                } else {
                    showToast('Las herramientas ya estaban en el canvas', 'info');
                }

            } catch (error) {
                console.error('Error aplicando arquitectura:', error);
                showToast('Error cargando herramientas', 'error');
            }
        }

        // ============================================
        // AGENT MODE v9.0
        // ============================================
        let agentState = {
            watchdogRunning: false,
            schedulerRunning: false,
            watches: [],
            schedules: [],
            runs: [],
            notifications: []
        };

        async function refreshAgentStatus() {
            try {
                const res = await fetch('/api/agent/status');
                const data = await res.json();

                // Update status cards
                document.getElementById('agent-executor-runs').textContent = data.executor?.active_runs || 0;
                document.getElementById('agent-watchdog-count').textContent = data.watchdog?.watches_count || 0;
                document.getElementById('agent-scheduler-count').textContent = data.scheduler?.tasks_count || 0;
                document.getElementById('agent-notif-count').textContent = data.notifier?.unread_count || 0;

                // Update status indicators
                agentState.watchdogRunning = data.watchdog?.running || false;
                agentState.schedulerRunning = data.scheduler?.running || false;

                const watchdogStatus = document.getElementById('agent-watchdog-status');
                const schedulerStatus = document.getElementById('agent-scheduler-status');
                const statusDot = document.getElementById('agent-status-dot');

                watchdogStatus.className = 'w-2 h-2 rounded-full ' + (agentState.watchdogRunning ? 'bg-green-400' : 'bg-slate-600');
                schedulerStatus.className = 'w-2 h-2 rounded-full ' + (agentState.schedulerRunning ? 'bg-green-400' : 'bg-slate-600');
                statusDot.className = 'w-2 h-2 rounded-full ' + ((agentState.watchdogRunning || agentState.schedulerRunning) ? 'bg-green-400' : 'bg-slate-600');

                // Update toggle buttons
                updateToggleButtons();

                // Refresh lists
                await Promise.all([refreshAgentWatches(), refreshAgentSchedules(), refreshAgentRuns(), refreshAgentNotifications()]);
            } catch(e) {
                console.error('Error refreshing agent status:', e);
            }
        }

        function updateToggleButtons() {
            const btnWatchdog = document.getElementById('btn-toggle-watchdog');
            const btnScheduler = document.getElementById('btn-toggle-scheduler');

            if(btnWatchdog) {
                const isRunning = agentState.watchdogRunning;
                btnWatchdog.innerHTML = `<i class="fa-solid fa-eye"></i> <span>${isRunning ? 'Detener Watchdog' : 'Iniciar Watchdog'}</span>`;
                btnWatchdog.className = isRunning
                    ? 'bg-cyan-600 hover:bg-cyan-500 text-white text-sm px-4 py-2 rounded-lg transition flex items-center gap-2'
                    : 'bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm px-4 py-2 rounded-lg transition flex items-center gap-2';
            }
            if(btnScheduler) {
                const isRunning = agentState.schedulerRunning;
                btnScheduler.innerHTML = `<i class="fa-solid fa-clock"></i> <span>${isRunning ? 'Detener Scheduler' : 'Iniciar Scheduler'}</span>`;
                btnScheduler.className = isRunning
                    ? 'bg-orange-600 hover:bg-orange-500 text-white text-sm px-4 py-2 rounded-lg transition flex items-center gap-2'
                    : 'bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm px-4 py-2 rounded-lg transition flex items-center gap-2';
            }
        }

        async function refreshAgentWatches() {
            try {
                const res = await fetch('/api/agent/watches');
                const data = await res.json();
                const watches = data.watches || [];
                agentState.watches = watches;

                const container = document.getElementById('agent-watches-list');
                if(!watches || watches.length === 0) {
                    container.innerHTML = '<p class="text-slate-500 text-sm text-center py-4">No hay watches configurados</p>';
                    return;
                }

                container.innerHTML = watches.map(w => `
                    <div class="bg-slate-950 border border-slate-800 rounded-lg p-3 flex justify-between items-center">
                        <div>
                            <p class="text-white font-medium text-sm">${w.name}</p>
                            <p class="text-slate-500 text-xs">${w.directory} ‚Üí ${w.patterns?.join(', ') || '*'}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full ${w.active ? 'bg-green-400' : 'bg-slate-600'}"></span>
                            <button onclick="deleteWatch('${w.id}')" class="text-red-400 hover:text-red-300 text-xs"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            } catch(e) {
                console.error('Error loading watches:', e);
            }
        }

        async function refreshAgentSchedules() {
            try {
                const res = await fetch('/api/agent/schedules');
                const data = await res.json();
                const schedules = data.tasks || [];
                agentState.schedules = schedules;

                const container = document.getElementById('agent-schedules-list');
                if(!schedules || schedules.length === 0) {
                    container.innerHTML = '<p class="text-slate-500 text-sm text-center py-4">No hay tareas programadas</p>';
                    return;
                }

                container.innerHTML = schedules.map(s => `
                    <div class="bg-slate-950 border border-slate-800 rounded-lg p-3 flex justify-between items-center">
                        <div>
                            <p class="text-white font-medium text-sm">${s.name}</p>
                            <p class="text-slate-500 text-xs">${s.schedule_type}: ${s.schedule}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full ${s.enabled ? 'bg-green-400' : 'bg-slate-600'}"></span>
                            <button onclick="deleteSchedule('${s.id}')" class="text-red-400 hover:text-red-300 text-xs"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            } catch(e) {
                console.error('Error loading schedules:', e);
            }
        }

        async function refreshAgentRuns() {
            try {
                const res = await fetch('/api/agent/runs?limit=10');
                const data = await res.json();
                const runs = data.runs || [];
                agentState.runs = runs;

                const container = document.getElementById('agent-runs-list');
                if(!runs || runs.length === 0) {
                    container.innerHTML = '<p class="text-slate-500 text-sm text-center py-4">No hay ejecuciones recientes</p>';
                    return;
                }

                container.innerHTML = runs.map(r => {
                    const statusColor = r.status === 'success' ? 'text-green-400' : r.status === 'error' ? 'text-red-400' : 'text-yellow-400';
                    const statusIcon = r.status === 'success' ? 'fa-check-circle' : r.status === 'error' ? 'fa-times-circle' : 'fa-spinner fa-spin';
                    const time = new Date(r.started_at * 1000).toLocaleTimeString('es-ES', {hour12: false});
                    return `
                        <div class="bg-slate-950 border border-slate-800 rounded-lg p-3 flex justify-between items-center">
                            <div>
                                <p class="text-white font-medium text-sm">${r.pipeline_name || 'Pipeline'}</p>
                                <p class="text-slate-500 text-xs">${time} ‚Ä¢ ${r.duration ? r.duration.toFixed(1) + 's' : 'En progreso...'}</p>
                            </div>
                            <i class="fa-solid ${statusIcon} ${statusColor}"></i>
                        </div>
                    `;
                }).join('');
            } catch(e) {
                console.error('Error loading runs:', e);
            }
        }

        async function refreshAgentNotifications() {
            try {
                const res = await fetch('/api/agent/notifications?limit=10');
                const data = await res.json();
                const notifs = data.notifications || [];
                agentState.notifications = notifs;

                const container = document.getElementById('agent-notifications-list');
                if(!notifs || notifs.length === 0) {
                    container.innerHTML = '<p class="text-slate-500 text-sm text-center py-4">No hay notificaciones</p>';
                    return;
                }

                container.innerHTML = notifs.map(n => {
                    const typeColor = {success: 'text-green-400', error: 'text-red-400', warning: 'text-yellow-400', info: 'text-blue-400'}[n.type] || 'text-slate-400';
                    const time = new Date(n.timestamp * 1000).toLocaleTimeString('es-ES', {hour12: false});
                    return `
                        <div class="bg-slate-950 border border-slate-800 rounded-lg p-3 ${n.read ? 'opacity-60' : ''}">
                            <div class="flex justify-between items-start">
                                <p class="${typeColor} font-medium text-sm">${n.title}</p>
                                <span class="text-slate-600 text-xs">${time}</span>
                            </div>
                            <p class="text-slate-400 text-xs mt-1">${n.message}</p>
                        </div>
                    `;
                }).join('');
            } catch(e) {
                console.error('Error loading notifications:', e);
            }
        }

        async function startAllAgents() {
            try {
                const res = await fetch('/api/agent/start-all', {method: 'POST'});
                const data = await res.json();
                showToast('Automatizaciones iniciadas', 'success');
                await refreshAgentStatus();
            } catch(e) {
                showToast('Error iniciando automatizaciones', 'error');
            }
        }

        async function stopAllAgents() {
            try {
                const res = await fetch('/api/agent/stop-all', {method: 'POST'});
                showToast('Automatizaciones detenidas', 'info');
                await refreshAgentStatus();
            } catch(e) {
                showToast('Error deteniendo automatizaciones', 'error');
            }
        }

        async function toggleWatchdogService() {
            try {
                const endpoint = agentState.watchdogRunning ? '/api/agent/watchdog/stop' : '/api/agent/watchdog/start';
                await fetch(endpoint, {method: 'POST'});
                showToast(agentState.watchdogRunning ? 'Watchdog detenido' : 'Watchdog iniciado', 'info');
                await refreshAgentStatus();
            } catch(e) {
                showToast('Error con Watchdog', 'error');
            }
        }

        async function toggleSchedulerService() {
            try {
                const endpoint = agentState.schedulerRunning ? '/api/agent/scheduler/stop' : '/api/agent/scheduler/start';
                await fetch(endpoint, {method: 'POST'});
                showToast(agentState.schedulerRunning ? 'Scheduler detenido' : 'Scheduler iniciado', 'info');
                await refreshAgentStatus();
            } catch(e) {
                showToast('Error con Scheduler', 'error');
            }
        }

        function showCreateWatchModal() {
            document.getElementById('watch-name').value = '';
            document.getElementById('watch-directory').value = '~/Downloads';
            document.getElementById('watch-patterns').value = '*.pdf';
            document.getElementById('create-watch-modal').classList.remove('hidden');
        }

        async function createWatch() {
            const name = document.getElementById('watch-name').value;
            const directory = document.getElementById('watch-directory').value;
            const patterns = document.getElementById('watch-patterns').value.split(',').map(p => p.trim()).filter(p => p);

            if(!name || !directory) {
                showToast('Nombre y directorio requeridos', 'error');
                return;
            }

            try {
                const res = await fetch('/api/agent/watches', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, directory, patterns})
                });
                if(res.ok) {
                    showToast('Watch creado', 'success');
                    closeModal('create-watch-modal');
                    await refreshAgentWatches();
                    await refreshAgentStatus();
                } else {
                    const err = await res.json();
                    showToast(err.detail || 'Error creando watch', 'error');
                }
            } catch(e) {
                showToast('Error creando watch', 'error');
            }
        }

        async function deleteWatch(watchId) {
            if(!confirm('¬øEliminar este watch?')) return;
            try {
                await fetch(`/api/agent/watches/${watchId}`, {method: 'DELETE'});
                showToast('Watch eliminado', 'info');
                await refreshAgentWatches();
                await refreshAgentStatus();
            } catch(e) {
                showToast('Error eliminando watch', 'error');
            }
        }

        function showCreateScheduleModal() {
            document.getElementById('schedule-name').value = '';
            document.getElementById('schedule-type').value = 'cron';
            document.getElementById('schedule-schedule').value = '0 9 * * *';
            document.getElementById('create-schedule-modal').classList.remove('hidden');
        }

        async function createSchedule() {
            const name = document.getElementById('schedule-name').value;
            const schedule_type = document.getElementById('schedule-type').value;
            const schedule = document.getElementById('schedule-schedule').value;

            if(!name || !schedule) {
                showToast('Nombre y horario requeridos', 'error');
                return;
            }

            try {
                const res = await fetch('/api/agent/schedules', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, schedule_type, schedule})
                });
                if(res.ok) {
                    showToast('Tarea programada creada', 'success');
                    closeModal('create-schedule-modal');
                    await refreshAgentSchedules();
                    await refreshAgentStatus();
                } else {
                    const err = await res.json();
                    showToast(err.detail || 'Error creando tarea', 'error');
                }
            } catch(e) {
                showToast('Error creando tarea', 'error');
            }
        }

        async function deleteSchedule(scheduleId) {
            if(!confirm('¬øEliminar esta tarea programada?')) return;
            try {
                await fetch(`/api/agent/schedules/${scheduleId}`, {method: 'DELETE'});
                showToast('Tarea eliminada', 'info');
                await refreshAgentSchedules();
                await refreshAgentStatus();
            } catch(e) {
                showToast('Error eliminando tarea', 'error');
            }
        }

        async function testNotification() {
            try {
                await fetch('/api/agent/notifications/test', {method: 'POST'});
                showToast('Notificaci√≥n enviada', 'info');
                setTimeout(() => refreshAgentNotifications(), 500);
            } catch(e) {
                showToast('Error enviando notificaci√≥n', 'error');
            }
        }

        async function markAllNotificationsRead() {
            try {
                await fetch('/api/agent/notifications/read-all', {method: 'POST'});
                await refreshAgentNotifications();
                await refreshAgentStatus();
            } catch(e) {
                console.error('Error marking notifications read:', e);
            }
        }

        async function executeCurrentPipeline() {
            // Get current pipeline from canvas
            if(!canvasNodes || canvasNodes.length === 0) {
                showToast('No hay pipeline en el canvas', 'error');
                return;
            }

            const pipelineDef = {
                name: 'Pipeline desde Canvas',
                nodes: canvasNodes.map(n => ({
                    id: n.id,
                    tool: n.id,  // El nodo ES el tool
                    name: n.name,
                    config: {}
                })),
                connections: (typeof connections !== 'undefined' ? connections : []).map(c => ({
                    from: c.from,
                    to: c.to
                }))
            };

            try {
                const res = await fetch('/api/agent/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(pipelineDef)
                });
                const data = await res.json();
                showToast(`Pipeline iniciado (${data.run_id})`, 'success');
                switchView('agent');
                setTimeout(() => refreshAgentRuns(), 1000);
            } catch(e) {
                showToast('Error ejecutando pipeline', 'error');
            }
        }

        // ============================================
        // EJECUCI√ìN DE PIPELINE v10.1 PRO
        // ============================================

        // Ejecutar pipeline desde el bot√≥n principal del Pipeline Builder
        // EJECUCI√ìN REAL - Conecta con Claude y otros servicios
        async function runPipelineFromBuilder() {
            if (!canvasNodes || canvasNodes.length === 0) {
                showToast('A√±ade herramientas al canvas primero', 'error');
                return;
            }

            const btn = document.getElementById('run-pipeline-btn');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ejecutando...';

            // Actualizar estados visuales
            updateNodeStatus('all', 'idle');

            // Ordenar nodos seg√∫n conexiones (topol√≥gico simple)
            const orderedNodes = getExecutionOrder();

            // Estado del pipeline (datos que pasan entre nodos)
            let pipelineData = {
                input: "Inicio del pipeline",
                results: {},
                // Contexto para Inspector HITL
                previousNode: null,
                previousNodeId: null,
                source: 'Pipeline input',
                lastTool: null,
                lastAction: null,
                nextNode: null,
                nextAction: null,
                currentStep: 0,
                totalSteps: orderedNodes.length
            };

            addLog('INFO', `‚ñ∂ Ejecutando pipeline con ${orderedNodes.length} nodos...`);

            try {
                for (let i = 0; i < orderedNodes.length; i++) {
                    const node = orderedNodes[i];
                    updateNodeStatus(node.id, 'running');
                    addLog('INFO', `[${i+1}/${orderedNodes.length}] Ejecutando: ${node.name}`);

                    // Actualizar contexto para Inspector
                    pipelineData.currentStep = i + 1;

                    // Info del nodo anterior
                    if (i > 0) {
                        const prevNode = orderedNodes[i - 1];
                        pipelineData.previousNode = prevNode.name;
                        pipelineData.previousNodeId = prevNode.id;
                        pipelineData.lastTool = prevNode.name;
                        pipelineData.lastAction = getNodeAction(prevNode.id);
                    } else {
                        pipelineData.previousNode = 'Inicio';
                        pipelineData.previousNodeId = null;
                        pipelineData.lastTool = 'Pipeline';
                        pipelineData.lastAction = 'Inicializar datos';
                    }

                    // Info del nodo siguiente
                    if (i < orderedNodes.length - 1) {
                        const nextNode = orderedNodes[i + 1];
                        pipelineData.nextNode = nextNode.name;
                        pipelineData.nextAction = getNodeAction(nextNode.id);
                    } else {
                        pipelineData.nextNode = 'Fin';
                        pipelineData.nextAction = 'Mostrar resultado';
                    }

                    try {
                        // Check pauseBefore (HITL antes de ejecutar)
                        if (node.pauseBefore) {
                            addLog('INFO', `  ‚Üí HITL: Pausa antes de ${node.name}...`);
                            const beforeContext = {
                                previousNode: pipelineData.previousNode,
                                previousNodeId: pipelineData.previousNodeId,
                                source: pipelineData.source,
                                tool: node.name,
                                action: `Ejecutar ${node.name}`,
                                data: pipelineData.lastOutput || pipelineData.input || 'Sin datos previos',
                                nextNode: node.name,
                                nextAction: getNodeAction(node.id),
                                currentStep: pipelineData.currentStep,
                                totalSteps: pipelineData.totalSteps
                            };
                            const beforeResult = await showInspectorModal(beforeContext);
                            if (beforeResult.action === 'stop') {
                                throw new Error('Pipeline detenido por el usuario (pauseBefore)');
                            }
                            if (beforeResult.action === 'edit') {
                                pipelineData.lastOutput = beforeResult.editedData;
                            }
                        }

                        // Ejecutar nodo seg√∫n su tipo
                        const result = await executeNode(node, pipelineData);

                        // Guardar resultado
                        pipelineData.results[node.id] = result;
                        pipelineData.lastOutput = result;

                        // Check pauseAfter (HITL despues de ejecutar)
                        if (node.pauseAfter) {
                            addLog('INFO', `  ‚Üí HITL: Pausa despues de ${node.name}...`);
                            const afterContext = {
                                previousNode: node.name,
                                previousNodeId: node.id,
                                source: pipelineData.source,
                                tool: node.name,
                                action: getNodeAction(node.id),
                                data: result || 'Sin resultado',
                                nextNode: pipelineData.nextNode,
                                nextAction: pipelineData.nextAction,
                                currentStep: pipelineData.currentStep,
                                totalSteps: pipelineData.totalSteps
                            };
                            const afterResult = await showInspectorModal(afterContext);
                            if (afterResult.action === 'stop') {
                                throw new Error('Pipeline detenido por el usuario (pauseAfter)');
                            }
                            if (afterResult.action === 'edit') {
                                pipelineData.lastOutput = afterResult.editedData;
                                pipelineData.results[node.id] = afterResult.editedData;
                            }
                        }

                        updateNodeStatus(node.id, 'success');

                        if (result && result.length > 100) {
                            addLog('SUCCESS', `‚úì ${node.name}: ${result.substring(0, 100)}...`);
                        } else if (result) {
                            addLog('SUCCESS', `‚úì ${node.name}: ${result}`);
                        } else {
                            addLog('SUCCESS', `‚úì ${node.name}: OK`);
                        }

                    } catch (nodeError) {
                        updateNodeStatus(node.id, 'error');
                        addLog('ERROR', `‚úó ${node.name}: ${nodeError.message}`);
                        throw nodeError;
                    }
                }

                addLog('SUCCESS', '‚ñ∂ Pipeline completado exitosamente');
                showToast('Pipeline completado', 'success');

                // Mostrar resultado final si hay
                if (pipelineData.lastOutput) {
                    showPipelineResult(pipelineData.lastOutput);
                }

            } catch (error) {
                console.error('Pipeline error:', error);
                addLog('ERROR', `Pipeline fall√≥: ${error.message}`);
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        // Obtener orden de ejecuci√≥n (siguiendo conexiones)
        function getExecutionOrder() {
            if (nodeConnections.length === 0) {
                // Sin conexiones: ejecutar en orden de posici√≥n X
                return [...canvasNodes].sort((a, b) => {
                    const posA = nodePositions[a.id] || { x: 0 };
                    const posB = nodePositions[b.id] || { x: 0 };
                    return posA.x - posB.x;
                });
            }

            // Con conexiones: orden topol√≥gico
            const inDegree = {};
            const adjList = {};

            canvasNodes.forEach(n => {
                inDegree[n.id] = 0;
                adjList[n.id] = [];
            });

            nodeConnections.forEach(c => {
                adjList[c.from].push(c.to);
                inDegree[c.to]++;
            });

            // Empezar con nodos sin entradas
            const queue = canvasNodes.filter(n => inDegree[n.id] === 0);
            const result = [];

            while (queue.length > 0) {
                const node = queue.shift();
                result.push(node);

                adjList[node.id].forEach(toId => {
                    inDegree[toId]--;
                    if (inDegree[toId] === 0) {
                        const toNode = canvasNodes.find(n => n.id === toId);
                        if (toNode) queue.push(toNode);
                    }
                });
            }

            return result;
        }

        // Ejecutar un nodo individual
        async function executeNode(node, pipelineData) {
            const nodeId = node.id;

            // ===== CLAUDE NODE =====
            if (nodeId === 'claude-node' || nodeId.includes('claude')) {
                const prompt = pipelineData.lastOutput || pipelineData.input || "Hola";

                addLog('INFO', `  ‚Üí Llamando a Claude CLI...`);

                const response = await fetch('/api/claude/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        system_prompt: "Eres un asistente √∫til. Responde de forma concisa."
                    })
                });

                const data = await response.json();

                if (data.success) {
                    return data.content;
                } else {
                    throw new Error(data.error || 'Error de Claude');
                }
            }

            // ===== OUTPUT NOTIFY =====
            if (nodeId === 'output-notify') {
                const message = pipelineData.lastOutput || 'Pipeline completado';
                // Intentar notificaci√≥n del navegador
                if (Notification.permission === 'granted') {
                    new Notification('DirectOS Pipeline', { body: message.substring(0, 100) });
                } else if (Notification.permission !== 'denied') {
                    await Notification.requestPermission();
                }
                return `Notificaci√≥n enviada: ${message.substring(0, 50)}...`;
            }

            // ===== OUTPUT FILE =====
            if (nodeId === 'output-file') {
                const content = pipelineData.lastOutput || JSON.stringify(pipelineData.results);
                // Descargar como archivo
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pipeline-output-${Date.now()}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                return `Archivo descargado (${content.length} bytes)`;
            }

            // ===== FLOW DELAY =====
            if (nodeId === 'flow-delay') {
                const seconds = 2; // Default 2 segundos
                addLog('INFO', `  ‚Üí Esperando ${seconds}s...`);
                await new Promise(r => setTimeout(r, seconds * 1000));
                return pipelineData.lastOutput || 'Delay completado';
            }

            // ===== FLOW INSPECTOR (Human-in-the-Loop) =====
            if (nodeId === 'flow-inspector') {
                addLog('INFO', `  ‚Üí Inspector: esperando revision humana...`);

                // Obtener contexto del pipeline
                const inspectorContext = {
                    previousNode: pipelineData.previousNode || 'Inicio',
                    previousNodeId: pipelineData.previousNodeId || null,
                    source: pipelineData.source || 'Pipeline input',
                    tool: pipelineData.lastTool || 'N/A',
                    action: pipelineData.lastAction || 'Procesar datos',
                    data: pipelineData.lastOutput || pipelineData.input || 'Sin datos',
                    nextNode: pipelineData.nextNode || 'Fin',
                    nextAction: pipelineData.nextAction || 'Finalizar pipeline',
                    currentStep: pipelineData.currentStep || 1,
                    totalSteps: pipelineData.totalSteps || 1
                };

                // Mostrar modal y esperar decision del usuario
                const result = await showInspectorModal(inspectorContext);

                if (result.action === 'stop') {
                    throw new Error('Pipeline detenido por el usuario');
                }

                if (result.action === 'edit') {
                    return result.editedData;
                }

                // Continuar con los datos originales
                return pipelineData.lastOutput || pipelineData.input;
            }

            // ===== TRIGGERS (pass-through) =====
            if (nodeId.startsWith('trigger-')) {
                return pipelineData.input || 'Trigger activado';
            }

            // ===== OTROS NODOS (simulados por ahora) =====
            addLog('INFO', `  ‚Üí Simulando ${node.name}...`);
            await new Promise(r => setTimeout(r, 500));
            return pipelineData.lastOutput || `${node.name} procesado`;
        }

        // Mostrar resultado del pipeline en un modal
        function showPipelineResult(result) {
            const resultPreview = result.length > 500 ? result.substring(0, 500) + '...' : result;

            // Mostrar en el panel de log con formato especial
            addLog('INFO', '‚îÄ'.repeat(40));
            addLog('INFO', 'üìã RESULTADO DEL PIPELINE:');
            addLog('INFO', resultPreview);
            addLog('INFO', '‚îÄ'.repeat(40));

            // Copiar al portapapeles
            navigator.clipboard.writeText(result).then(() => {
                showToast('Resultado copiado al portapapeles', 'success');
            });
        }

        // ============================================
        // INSPECTOR (Human-in-the-Loop)
        // ============================================

        let inspectorResolve = null;
        let inspectorData = null;

        // Tips didacticos por herramienta
        const INSPECTOR_TIPS = {
            'trigger-manual': 'El Trigger Manual inicia el pipeline cuando haces click. Util para pruebas y ejecuciones bajo demanda.',
            'trigger-file': 'El Trigger File vigila una carpeta y detecta archivos nuevos. Usa patrones como *.pdf para filtrar.',
            'trigger-cron': 'El Trigger Cron ejecuta el pipeline en horarios programados. Usa expresiones cron o presets como "cada hora".',
            'trigger-webhook': 'El Trigger Webhook recibe peticiones HTTP POST de sistemas externos para iniciar el pipeline.',
            'claude-node': 'Claude CLI usa tu suscripcion Pro/Max para analizar texto. No consume creditos de API. Ideal para tareas complejas de razonamiento.',
            'pdf-parser': 'PyPDF2 extrae texto de PDFs digitales. Para PDFs escaneados (imagenes), necesitarias Tesseract OCR.',
            'whisper': 'Whisper de OpenAI transcribe audio a texto. Soporta multiples idiomas y es muy preciso con audio claro.',
            'tesseract': 'Tesseract es OCR gratuito. Funciona bien con imagenes claras. Para mejor precision, preprocesa las imagenes.',
            'chromadb': 'ChromaDB almacena embeddings para busqueda semantica. Util para encontrar documentos similares.',
            'sqlite': 'SQLite guarda datos estructurados localmente. Perfecto para persistir resultados sin servidor.',
            'output-file': 'Output File guarda el resultado en un archivo. Soporta JSON, CSV y TXT.',
            'output-notify': 'Output Notify envia una notificacion del navegador. Util para alertas cuando termina el pipeline.',
            'output-email': 'Output Email envia el resultado por correo. Necesita configurar SMTP.',
            'output-slack': 'Output Slack envia mensajes a un canal via webhook. Ideal para notificaciones de equipo.',
            'flow-if': 'Flow If bifurca el pipeline segun una condicion. Permite logica condicional.',
            'flow-loop': 'Flow Loop repite una seccion del pipeline. Util para procesar listas o reintentos.',
            'flow-delay': 'Flow Delay pausa el pipeline. Usalo para rate limiting o esperar procesos externos.',
            'default': 'Este nodo procesa los datos y los pasa al siguiente paso del pipeline.'
        };

        function getInspectorTip(nodeId) {
            return INSPECTOR_TIPS[nodeId] || INSPECTOR_TIPS['default'];
        }

        // Acciones por tipo de nodo (para el Inspector)
        const NODE_ACTIONS = {
            'trigger-manual': 'Iniciar pipeline manualmente',
            'trigger-file': 'Detectar archivos nuevos',
            'trigger-cron': 'Ejecutar en horario programado',
            'trigger-webhook': 'Recibir peticion HTTP',
            'claude-node': 'Analizar con IA (Claude)',
            'pdf-parser': 'Extraer texto del PDF',
            'whisper': 'Transcribir audio a texto',
            'tesseract': 'Extraer texto de imagen (OCR)',
            'chromadb': 'Buscar en base de vectores',
            'sqlite': 'Guardar en base de datos',
            'output-file': 'Guardar en archivo',
            'output-notify': 'Enviar notificacion',
            'output-email': 'Enviar por email',
            'output-slack': 'Enviar a Slack',
            'flow-if': 'Evaluar condicion',
            'flow-loop': 'Repetir secuencia',
            'flow-delay': 'Esperar antes de continuar',
            'flow-inspector': 'Revisar datos (HITL)',
            'default': 'Procesar datos'
        };

        function getNodeAction(nodeId) {
            return NODE_ACTIONS[nodeId] || NODE_ACTIONS['default'];
        }

        function showInspectorModal(context) {
            return new Promise((resolve) => {
                inspectorResolve = resolve;
                inspectorData = context.data;

                // Rellenar el modal
                document.getElementById('inspector-step').textContent = `Paso ${context.currentStep}/${context.totalSteps}`;
                document.getElementById('inspector-origin-node').textContent = context.previousNode;
                document.getElementById('inspector-origin-source').textContent = context.source;
                document.getElementById('inspector-process-tool').textContent = context.tool;
                document.getElementById('inspector-process-action').textContent = context.action;

                // Datos - mostrar preview
                const dataStr = typeof context.data === 'string' ? context.data : JSON.stringify(context.data, null, 2);
                const dataPreview = dataStr.length > 1000 ? dataStr.substring(0, 1000) + '\n\n... (truncado)' : dataStr;
                document.getElementById('inspector-data').textContent = dataPreview;
                document.getElementById('inspector-data-size').textContent = `${dataStr.length} caracteres`;

                document.getElementById('inspector-dest-node').textContent = context.nextNode;
                document.getElementById('inspector-dest-action').textContent = context.nextAction;

                // Tip didactico basado en la herramienta anterior
                document.getElementById('inspector-tip').textContent = getInspectorTip(context.previousNodeId);

                // Mostrar modal
                document.getElementById('inspector-modal').classList.remove('hidden');
            });
        }

        function inspectorContinue() {
            document.getElementById('inspector-modal').classList.add('hidden');
            if (inspectorResolve) {
                inspectorResolve({ action: 'continue' });
                inspectorResolve = null;
            }
        }

        function inspectorStop() {
            document.getElementById('inspector-modal').classList.add('hidden');
            if (inspectorResolve) {
                inspectorResolve({ action: 'stop' });
                inspectorResolve = null;
            }
        }

        function inspectorEdit() {
            // Mostrar textarea para editar
            const dataEl = document.getElementById('inspector-data');
            const currentText = dataEl.textContent;

            // Convertir pre a textarea
            const container = dataEl.parentElement;
            container.innerHTML = `
                <textarea id="inspector-data-edit" class="w-full h-48 bg-slate-950 text-slate-300 text-sm font-mono p-3 rounded border border-amber-500/30 focus:outline-none focus:border-amber-500">${currentText}</textarea>
                <div class="mt-2 flex gap-2">
                    <button onclick="inspectorSaveEdit()" class="px-3 py-1 bg-amber-500 text-black text-xs font-bold rounded hover:bg-amber-400">
                        <i class="fa-solid fa-check mr-1"></i> Guardar cambios
                    </button>
                    <button onclick="inspectorCancelEdit()" class="px-3 py-1 bg-slate-700 text-white text-xs rounded hover:bg-slate-600">
                        Cancelar
                    </button>
                </div>
            `;
        }

        function inspectorSaveEdit() {
            const editedData = document.getElementById('inspector-data-edit').value;
            document.getElementById('inspector-modal').classList.add('hidden');

            // Restaurar el pre
            const container = document.getElementById('inspector-data').parentElement;
            container.innerHTML = `<pre id="inspector-data" class="text-sm text-slate-300 whitespace-pre-wrap font-mono">-</pre>`;

            if (inspectorResolve) {
                inspectorResolve({ action: 'edit', editedData: editedData });
                inspectorResolve = null;
            }
        }

        function inspectorCancelEdit() {
            // Restaurar el pre con los datos originales
            const container = document.querySelector('#inspector-modal .bg-amber-500\\/5 .bg-slate-950');
            const dataStr = typeof inspectorData === 'string' ? inspectorData : JSON.stringify(inspectorData, null, 2);
            const dataPreview = dataStr.length > 1000 ? dataStr.substring(0, 1000) + '\n\n... (truncado)' : dataStr;

            container.innerHTML = `
                <pre id="inspector-data" class="text-sm text-slate-300 whitespace-pre-wrap font-mono">${dataPreview}</pre>
            `;
        }

        // ============================================
        // DRY RUN (Simulaci√≥n)
        // ============================================

        // Tiempos estimados por tipo de nodo (en segundos)
        const NODE_ESTIMATED_TIME = {
            'trigger-manual': 0,
            'trigger-file': 1,
            'trigger-cron': 0,
            'trigger-webhook': 0,
            'claude-node': 10,
            'pdf-parser': 3,
            'whisper': 30,
            'tesseract': 5,
            'chromadb': 2,
            'sqlite': 1,
            'output-file': 1,
            'output-notify': 0,
            'output-email': 2,
            'output-slack': 1,
            'flow-if': 0,
            'flow-loop': 0,
            'flow-delay': 2,
            'flow-inspector': 30,  // Tiempo humano
            'default': 1
        };

        function getNodeEstimatedTime(nodeId) {
            return NODE_ESTIMATED_TIME[nodeId] || NODE_ESTIMATED_TIME['default'];
        }

        function dryRunPipeline() {
            if (!canvasNodes || canvasNodes.length === 0) {
                showToast('A√±ade herramientas al canvas primero', 'error');
                return;
            }

            const orderedNodes = getExecutionOrder();
            let totalTime = 0;
            let pauseCount = 0;
            let warnings = [];
            let steps = [];

            // Analizar cada nodo
            orderedNodes.forEach((node, index) => {
                const time = getNodeEstimatedTime(node.id);
                totalTime += time;

                // Contar pausas (Inspector o nodos con pauseBefore/pauseAfter)
                if (node.id === 'flow-inspector') {
                    pauseCount++;
                }
                if (node.pauseBefore) pauseCount++;
                if (node.pauseAfter) pauseCount++;

                // Detectar warnings
                if (node.id === 'claude-node') {
                    warnings.push('Claude CLI necesita autenticaci√≥n activa');
                }
                if (node.id === 'whisper') {
                    warnings.push('Whisper puede tardar varios minutos en archivos largos');
                }
                if (node.id === 'output-email') {
                    warnings.push('Output Email requiere configuraci√≥n SMTP');
                }

                // Construir paso
                const pauseIndicator = (node.id === 'flow-inspector' || node.pauseBefore || node.pauseAfter)
                    ? '<span class="text-cyan-400 ml-2"><i class="fa-solid fa-pause"></i> HITL</span>'
                    : '';

                steps.push({
                    index: index + 1,
                    name: node.name,
                    action: getNodeAction(node.id),
                    time: time,
                    pauseIndicator: pauseIndicator,
                    icon: node.icon || 'fa-cube',
                    color: node.color || 'text-slate-400'
                });
            });

            // Actualizar modal
            document.getElementById('dry-run-nodes').textContent = orderedNodes.length;
            document.getElementById('dry-run-time').textContent = totalTime > 60
                ? `~${Math.ceil(totalTime / 60)}min`
                : `~${totalTime}s`;
            document.getElementById('dry-run-pauses').textContent = pauseCount;

            // Renderizar pasos
            const stepsContainer = document.getElementById('dry-run-steps');
            stepsContainer.innerHTML = steps.map(step => `
                <div class="flex items-center gap-3 p-2 bg-slate-900/50 rounded-lg">
                    <div class="w-6 h-6 bg-slate-800 rounded-full flex items-center justify-center text-xs font-bold text-slate-400">
                        ${step.index}
                    </div>
                    <i class="fa-solid ${step.icon} ${step.color}"></i>
                    <div class="flex-1">
                        <span class="font-semibold text-white">${step.name}</span>
                        <span class="text-slate-500 text-sm ml-2">${step.action}</span>
                        ${step.pauseIndicator}
                    </div>
                    <div class="text-xs text-slate-500">
                        ${step.time > 0 ? `~${step.time}s` : '-'}
                    </div>
                </div>
            `).join('');

            // Mostrar warnings si hay
            const warningsContainer = document.getElementById('dry-run-warnings');
            const warningsList = document.getElementById('dry-run-warnings-list');
            if (warnings.length > 0) {
                warningsContainer.classList.remove('hidden');
                warningsList.innerHTML = [...new Set(warnings)].map(w => `<li>‚Ä¢ ${w}</li>`).join('');
            } else {
                warningsContainer.classList.add('hidden');
            }

            // Mostrar modal
            document.getElementById('dry-run-modal').classList.remove('hidden');
        }

        function closeDryRunModal() {
            document.getElementById('dry-run-modal').classList.add('hidden');
        }

        async function executePipelineFromTrigger(triggerId) {
            if (!canvasNodes || canvasNodes.length === 0) {
                showToast('No hay pipeline en el canvas', 'error');
                return;
            }

            // Verificar que el trigger est√° en el canvas
            const triggerNode = canvasNodes.find(n => n.id === triggerId);
            if (!triggerNode) {
                showToast('Trigger no encontrado', 'error');
                return;
            }

            // Cambiar bot√≥n a estado "ejecutando"
            const btn = document.getElementById(`trigger-btn-${triggerId}`);
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-[10px]"></i><span>Ejecutando...</span>';
            }

            // Actualizar estados visuales de todos los nodos
            updateNodeStatus('all', 'idle');

            try {
                // Filtrar nodos que no son triggers para la ejecuci√≥n
                const pipelineNodes = canvasNodes.filter(n => !n.isTrigger);

                if (pipelineNodes.length === 0) {
                    showToast('A√±ade herramientas despu√©s del trigger', 'error');
                    resetTriggerButton(triggerId);
                    return;
                }

                // Obtener par√°metros configurados del panel
                const getNodeParams = (nodeId) => {
                    const params = {};
                    document.querySelectorAll(`[data-param]`).forEach(input => {
                        if (canvasState.selectedNodeId === nodeId) {
                            params[input.dataset.param] = input.value;
                        }
                    });
                    return params;
                };

                const pipelineDef = {
                    name: `Pipeline desde ${triggerNode.name}`,
                    trigger: triggerId,
                    nodes: pipelineNodes.map(n => ({
                        id: n.id,
                        tool: n.id,
                        name: n.name,
                        category: n.cat,
                        config: getNodeParams(n.id),
                        position: nodePositions[n.id] || { x: 0, y: 0 }
                    })),
                    connections: nodeConnections.map(c => ({
                        from: c.from,
                        to: c.to
                    }))
                };

                // Marcar trigger como "running"
                updateNodeStatus(triggerId, 'running');
                addLog("INFO", `Iniciando pipeline con ${pipelineNodes.length} nodos...`);

                const res = await fetch('/api/agent/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(pipelineDef)
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({ detail: 'Error desconocido' }));
                    throw new Error(err.detail || 'Error en API');
                }

                const data = await res.json();
                const runId = data.run_id;
                addLog("SUCCESS", `Pipeline iniciado: ${runId}`);

                // Polling del estado real
                await pollPipelineStatus(runId, triggerId, pipelineNodes);

            } catch (e) {
                console.error('Error ejecutando pipeline:', e);
                showToast('Error: ' + e.message, 'error');
                updateNodeStatus(triggerId, 'error');
                addLog("ERROR", `Pipeline fall√≥: ${e.message}`);
            } finally {
                resetTriggerButton(triggerId);
            }
        }

        // Polling del estado de ejecuci√≥n
        async function pollPipelineStatus(runId, triggerId, pipelineNodes) {
            const maxAttempts = 60; // 1 minuto m√°ximo
            let attempts = 0;
            let currentNodeIndex = 0;

            while (attempts < maxAttempts) {
                try {
                    const res = await fetch(`/api/agent/runs/${runId}`);
                    if (!res.ok) break;

                    const run = await res.json();

                    // Actualizar estado visual seg√∫n el progreso
                    if (run.current_node_index !== undefined) {
                        // Marcar nodos anteriores como success
                        for (let i = 0; i < run.current_node_index; i++) {
                            if (pipelineNodes[i]) {
                                updateNodeStatus(pipelineNodes[i].id, 'success');
                            }
                        }
                        // Marcar nodo actual como running
                        if (pipelineNodes[run.current_node_index]) {
                            updateNodeStatus(pipelineNodes[run.current_node_index].id, 'running');
                        }
                    }

                    // Verificar si termin√≥
                    if (run.status === 'completed') {
                        pipelineNodes.forEach(n => updateNodeStatus(n.id, 'success'));
                        updateNodeStatus(triggerId, 'success');
                        showToast('Pipeline completado', 'success');
                        addLog("SUCCESS", `Pipeline completado en ${run.duration || 'N/A'}s`);
                        return;
                    } else if (run.status === 'failed' || run.status === 'error') {
                        const failedNode = run.failed_node || pipelineNodes[run.current_node_index];
                        if (failedNode) updateNodeStatus(failedNode.id || failedNode, 'error');
                        updateNodeStatus(triggerId, 'error');
                        showToast('Pipeline fall√≥', 'error');
                        addLog("ERROR", run.error || 'Error desconocido');
                        return;
                    }

                    // Esperar antes de siguiente poll
                    await new Promise(r => setTimeout(r, 1000));
                    attempts++;

                } catch (e) {
                    console.error('Error polling:', e);
                    break;
                }
            }

            // Si llegamos aqu√≠, simular progreso visual
            await animatePipelineExecution(pipelineNodes, runId);
            updateNodeStatus(triggerId, 'success');
            showToast('Pipeline completado', 'success');
        }

        function resetTriggerButton(triggerId) {
            const btn = document.getElementById(`trigger-btn-${triggerId}`);
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-play text-[10px]"></i><span>Ejecutar Pipeline</span>';
            }
        }

        function updateNodeStatus(nodeId, status) {
            if (nodeId === 'all') {
                document.querySelectorAll('.node-status').forEach(el => {
                    el.dataset.status = status;
                    el.style.background = '#475569';
                });
                return;
            }

            const nodeEl = document.querySelector(`[data-node-id="${nodeId}"] .node-status`);
            if (nodeEl) {
                nodeEl.dataset.status = status;
                const colors = { running: '#eab308', success: '#22c55e', error: '#ef4444', idle: '#475569' };
                nodeEl.style.background = colors[status] || colors.idle;

                // Animaci√≥n de pulso para running
                if (status === 'running') {
                    nodeEl.classList.add('animate-pulse');
                } else {
                    nodeEl.classList.remove('animate-pulse');
                }
            }
        }

        async function animatePipelineExecution(nodes, runId) {
            for (let i = 0; i < nodes.length; i++) {
                const node = nodes[i];
                updateNodeStatus(node.id, 'running');

                // Esperar un tiempo simulado (en futuro: polling real al backend)
                await new Promise(resolve => setTimeout(resolve, 800));

                updateNodeStatus(node.id, 'success');
            }
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        SyncManager.init();  // Offline-first sync
        initPresets();
        initPatternsAccordion();
        initFlowsGallery();
        initProjects();
        switchView('architect');
        renderCanvas();
    </script>
</body>
</html>