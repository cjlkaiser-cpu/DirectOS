<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ†Ô∏è DirectOS v7.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* UI Utilities */
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .flow-line { background: linear-gradient(90deg, #334155 0%, #3b82f6 50%, #334155 100%); background-size: 200% 100%; animation: flowAnimation 2s infinite linear; }
        @keyframes flowAnimation { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .tool-checkbox:checked + div { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); }
        .tool-checkbox:checked + div .check-icon { opacity: 1; }

        /* ARQUITECTO VISUAL STYLES */
        .draggable-tool { cursor: grab; user-select: none; transition: all 0.2s; }
        .draggable-tool:active { cursor: grabbing; transform: scale(0.98); }
        
        /* Colores de Categor√≠a */
        .cat-frontend { border-left-color: #f97316; } 
        .cat-backend { border-left-color: #22c55e; }  
        .cat-ai { border-left-color: #a855f7; }       
        .cat-storage { border-left-color: #eab308; }  
        .cat-process { border-left-color: #ec4899; }  

        .flow-arrow::after { content: '‚¨á'; display: block; text-align: center; color: #64748b; font-size: 1.2rem; margin: 0.5rem 0; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-5px);} 60% {transform: translateY(-3px);} }
        .flow-node:last-child .flow-arrow::after { display: none; }

        .interactive-node { cursor: pointer; transition: all 0.3s ease; }
        .interactive-node:hover { transform: scale(1.03); box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); border-color: #60a5fa; }

        /* MONITOR STYLES */
        .terminal-line { font-family: 'Courier New', monospace; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; }
        .status-online { background-color: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .status-offline { background-color: #ef4444; box-shadow: 0 0 10px #ef4444; }

        /* ESTADOS DE MAESTR√çA */
        .status-badge { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 9999px; text-transform: uppercase; letter-spacing: 0.05em; }
        .status-used { background-color: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
        .status-learning { background-color: rgba(234, 179, 8, 0.2); color: #eab308; border: 1px solid rgba(234, 179, 8, 0.3); }
        .status-new { background-color: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }

        /* Categor√≠a DevOps */
        .cat-devops { border-left-color: #f97316; }

        /* Line clamp para tarjetas de flujo */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Flow cards hover effects */
        .flow-card {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 h-screen flex overflow-hidden selection:bg-blue-500 selection:text-white">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-slate-900 border-r border-slate-800 flex-shrink-0 flex flex-col transition-all duration-300">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-xl font-bold text-white tracking-tight flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-blue-500"></i>
                Director<span class="text-slate-500">OS</span>
            </h1>
            <p class="text-xs text-slate-500 mt-1">v8.0 - Pipeline Builder</p>
        </div>
        
        <nav class="flex-1 overflow-y-auto p-4 space-y-2">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 pl-2">Dise√±o</p>
            <button onclick="switchView('architect')" id="btn-architect" class="w-full text-left px-3 py-2.5 rounded-lg text-sm transition font-medium flex items-center gap-3 bg-blue-600 text-white shadow-lg shadow-blue-900/20"><i class="fa-solid fa-diagram-project"></i> Pipeline Builder</button>
            <button onclick="switchView('flow')" id="btn-flow" class="w-full text-left px-3 py-2.5 rounded-lg hover:bg-slate-800 text-slate-400 text-sm transition font-medium flex items-center gap-3"><i class="fa-solid fa-store"></i> Recetas</button>
            <button onclick="switchView('generator')" id="btn-generator" class="w-full text-left px-3 py-2.5 rounded-lg hover:bg-slate-800 text-slate-400 text-sm transition font-medium flex items-center gap-3"><i class="fa-solid fa-wand-magic-sparkles"></i> Generador Prompts</button>
            
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 pl-2 mt-6">Operaciones</p>
            <button onclick="switchView('monitor')" id="btn-monitor" class="w-full text-left px-3 py-2.5 rounded-lg hover:bg-slate-800 text-slate-400 text-sm transition font-medium flex items-center gap-3"><i class="fa-solid fa-heart-pulse"></i> Monitor Sistema</button>
            <button onclick="switchView('grid')" id="btn-grid" class="w-full text-left px-3 py-2.5 rounded-lg hover:bg-slate-800 text-slate-400 text-sm transition font-medium flex items-center gap-3"><i class="fa-solid fa-boxes-stacked"></i> Glosario</button>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col min-w-0 relative bg-slate-950">
        
        <!-- Header -->
        <header class="bg-slate-900/50 backdrop-blur border-b border-slate-800 p-4 h-16 flex justify-between items-center sticky top-0 z-20">
            <div class="flex items-center gap-4">
                <h2 id="page-title" class="text-lg font-semibold text-white">Arquitecto Pro</h2>
                <!-- Dynamic Header Content -->
                <div id="header-tools" class="hidden flex gap-2">
                    <button onclick="saveArchitecture()" class="bg-slate-800 hover:bg-slate-700 text-xs px-3 py-1.5 rounded border border-slate-700 transition flex items-center gap-2" title="Guardar"><i class="fa-solid fa-floppy-disk"></i> Guardar</button>
                    <button onclick="loadArchitectureModal()" class="bg-slate-800 hover:bg-slate-700 text-xs px-3 py-1.5 rounded border border-slate-700 transition flex items-center gap-2" title="Cargar"><i class="fa-solid fa-folder-open"></i> Cargar</button>
                    <button onclick="exportDiagram()" class="bg-slate-800 hover:bg-slate-700 text-xs px-3 py-1.5 rounded border border-slate-700 transition flex items-center gap-2" title="Exportar"><i class="fa-solid fa-camera"></i> PNG</button>
                </div>
            </div>
            <div class="flex gap-3 items-center">
                <span class="text-xs font-mono text-slate-500 bg-slate-900 px-2 py-1 rounded border border-slate-800" id="clock">00:00</span>
            </div>
        </header>

        <!-- VISTA 0: PIPELINE BUILDER PRO -->
        <div id="view-architect" class="flex-1 overflow-hidden flex relative">
            <!-- Sidebar Herramientas -->
            <div class="w-64 bg-slate-900 border-r border-slate-800 p-4 overflow-y-auto flex-shrink-0">
                <div class="mb-6">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Patrones</h3>
                    <select id="preset-selector" onchange="loadPreset(this.value)" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-sm text-slate-300 mb-2">
                        <option value="">-- Seleccionar patr√≥n --</option>
                    </select>
                    <div id="preset-info" class="hidden bg-slate-950/50 border border-slate-800 rounded-lg p-3 text-xs">
                        <p id="preset-desc" class="text-slate-400 mb-2"></p>
                        <p id="preset-flow" class="text-blue-400 font-mono text-[10px]"></p>
                        <p id="preset-usecase" class="text-slate-500 mt-2 italic"></p>
                    </div>
                </div>
                <div class="border-t border-slate-800 pt-4">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Herramientas</h3>
                    <div id="architect-toolbox" class="space-y-3 max-h-[60vh] overflow-y-auto"></div>
                </div>
            </div>

            <!-- Canvas Principal -->
            <div class="flex-1 bg-slate-950 overflow-hidden relative bg-[radial-gradient(#1e293b_1px,transparent_1px)] [background-size:20px_20px]">
                <!-- Barra Superior -->
                <div class="absolute top-4 left-4 right-4 z-20 flex justify-between items-center bg-slate-900/95 backdrop-blur p-3 rounded-xl border border-slate-800 shadow-lg">
                    <div class="flex gap-4 text-[10px] uppercase font-bold tracking-wider text-slate-500">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-500"></span> Front</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> Back</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-purple-500"></span> IA</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> DB</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="autoLayoutNodes()" class="text-xs px-3 py-1.5 rounded-lg hover:bg-slate-700 text-slate-300 transition flex items-center gap-1.5 border border-slate-700" title="Organizar nodos"><i class="fa-solid fa-wand-magic-sparkles text-purple-400"></i> Auto</button>
                        <button onclick="validateFlowRealtime()" class="text-xs px-3 py-1.5 rounded-lg hover:bg-slate-700 text-slate-300 transition flex items-center gap-1.5 border border-slate-700"><i class="fa-solid fa-check-circle text-green-400"></i> Validar</button>
                        <button onclick="clearCanvas()" class="text-xs px-3 py-1.5 rounded-lg hover:bg-red-600/20 text-slate-300 hover:text-red-400 transition flex items-center gap-1.5 border border-slate-700 hover:border-red-500/50"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>

                <!-- Canvas SVG + Nodos -->
                <div id="pipeline-canvas" class="absolute inset-0 pt-20 pb-28 overflow-auto">
                    <svg id="connections-svg" class="absolute top-0 left-0 pointer-events-none" style="min-height: 100%; min-width: 100%; z-index: 5;">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
                            </marker>
                        </defs>
                    </svg>
                    <div id="nodes-container" class="relative p-8" style="min-height: 600px;">
                        <div id="canvas-placeholder" class="absolute inset-8 border-2 border-dashed border-slate-800 rounded-2xl flex flex-col items-center justify-center text-slate-600">
                            <i class="fa-solid fa-diagram-project text-4xl mb-3 text-slate-700"></i>
                            <p class="text-sm font-medium">Arrastra herramientas aqu√≠</p>
                            <p class="text-xs mt-1 text-slate-700">o selecciona un patr√≥n predefinido</p>
                        </div>
                    </div>
                </div>

                <!-- Panel de Validaci√≥n Flotante -->
                <div id="validation-panel" class="hidden absolute top-20 right-4 w-80 bg-slate-900/95 backdrop-blur border border-slate-700 rounded-xl shadow-2xl z-30 overflow-hidden">
                    <div class="p-3 border-b border-slate-800 flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                            <i class="fa-solid fa-clipboard-check text-blue-400"></i> Validaci√≥n
                        </span>
                        <button onclick="document.getElementById('validation-panel').classList.add('hidden')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
                    </div>
                    <div id="validation-messages" class="p-3 space-y-2 max-h-64 overflow-y-auto"></div>
                </div>

                <!-- Barra Inferior -->
                <div class="absolute bottom-4 left-4 right-4 z-20">
                    <div class="bg-slate-900/95 backdrop-blur border border-slate-700 p-4 rounded-xl shadow-2xl flex gap-4 items-center justify-between">
                        <div class="flex items-center gap-6">
                            <div class="text-sm">
                                <span id="node-count" class="font-bold text-white text-lg">0</span>
                                <span class="text-slate-500 text-xs ml-1">nodos</span>
                            </div>
                            <div class="text-sm">
                                <span id="connection-count" class="font-bold text-blue-400 text-lg">0</span>
                                <span class="text-slate-500 text-xs ml-1">conexiones</span>
                            </div>
                            <div id="flow-status" class="hidden"></div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="generateScaffold()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2.5 px-5 rounded-lg shadow-lg flex items-center gap-2 transition text-sm">
                                <i class="fa-solid fa-folder-plus"></i> Crear Proyecto
                            </button>
                            <button onclick="compileArchitecture()" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-2.5 px-5 rounded-lg shadow-lg flex items-center gap-2 transition text-sm">
                                <i class="fa-solid fa-code"></i> Generar C√≥digo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modales -->
        <div id="architect-output-modal" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-3xl shadow-2xl flex flex-col max-h-full">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center"><h3 class="font-bold text-white">Resultado</h3><button onclick="closeModal('architect-output-modal')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button></div>
                <div class="p-6 overflow-y-auto flex-1 bg-slate-950"><pre id="architect-prompt-output" class="font-mono text-xs text-slate-300 whitespace-pre-wrap leading-relaxed"></pre></div>
                <div class="p-4 border-t border-slate-800 bg-slate-900 flex justify-end"><button onclick="copyArchitectPrompt()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-4 py-2 rounded-lg font-medium transition">Copiar</button></div>
            </div>
        </div>

        <div id="load-modal" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-96 shadow-2xl">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center"><h3 class="font-bold text-white">Cargar Arquitectura</h3><button onclick="closeModal('load-modal')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button></div>
                <div id="load-list" class="p-2 max-h-64 overflow-y-auto space-y-1"></div>
            </div>
        </div>

        <!-- Modal Crear Proyecto -->
        <div id="scaffold-modal" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh]">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-folder-plus text-emerald-400 text-xl"></i>
                        <h3 class="font-bold text-white text-lg">Crear Proyecto</h3>
                    </div>
                    <button onclick="closeModal('scaffold-modal')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-6 overflow-y-auto flex-1 space-y-5">
                    <!-- Nombre del proyecto -->
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Nombre del Proyecto</label>
                        <input type="text" id="project-name" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-slate-200 placeholder-slate-600" placeholder="mi_proyecto_rag" value="">
                    </div>
                    <!-- Ruta -->
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Directorio Base</label>
                        <input type="text" id="project-path" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-slate-200 font-mono text-sm" value="~/Desktop">
                    </div>
                    <!-- Estructura Preview -->
                    <div class="bg-slate-950 border border-slate-800 rounded-xl p-4">
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-folder-tree text-amber-400"></i> Estructura a Crear
                        </h4>
                        <pre id="scaffold-preview" class="text-xs text-emerald-400 font-mono leading-relaxed"></pre>
                    </div>
                    <!-- Opciones -->
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="opt-git" checked class="w-4 h-4 rounded bg-slate-800 border-slate-600 text-blue-500">
                            <span class="text-sm text-slate-300">Inicializar Git</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="opt-venv" checked class="w-4 h-4 rounded bg-slate-800 border-slate-600 text-blue-500">
                            <span class="text-sm text-slate-300">Crear venv</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="opt-readme" checked class="w-4 h-4 rounded bg-slate-800 border-slate-600 text-blue-500">
                            <span class="text-sm text-slate-300">README.md</span>
                        </label>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-800 bg-slate-900 flex justify-between items-center">
                    <p class="text-xs text-slate-500"><i class="fa-solid fa-info-circle mr-1"></i> Se copiar√° el comando al portapapeles</p>
                    <div class="flex gap-2">
                        <button onclick="copyScaffoldCommand()" class="bg-slate-700 hover:bg-slate-600 text-white text-sm px-4 py-2 rounded-lg font-medium transition flex items-center gap-2">
                            <i class="fa-solid fa-copy"></i> Copiar Comando
                        </button>
                        <button onclick="downloadScaffoldScript()" class="bg-emerald-600 hover:bg-emerald-500 text-white text-sm px-4 py-2 rounded-lg font-medium transition flex items-center gap-2">
                            <i class="fa-solid fa-download"></i> Descargar Script
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Patr√≥n Detalle -->
        <div id="pattern-modal" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh]">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <span id="pattern-modal-emoji" class="text-2xl"></span>
                        <h3 id="pattern-modal-title" class="font-bold text-white text-lg"></h3>
                    </div>
                    <button onclick="closeModal('pattern-modal')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-6 overflow-y-auto flex-1 space-y-5">
                    <!-- Problema -->
                    <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-red-400 uppercase tracking-widest mb-2 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> Problema</h4>
                        <p id="pattern-modal-problem" class="text-sm text-slate-300"></p>
                    </div>
                    <!-- Prompt -->
                    <div class="bg-slate-950 border border-slate-800 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-2 flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> Prompt</h4>
                        <pre id="pattern-modal-prompt" class="text-sm text-slate-300 whitespace-pre-wrap font-mono leading-relaxed"></pre>
                    </div>
                    <!-- Flujo T√°ctico -->
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-purple-400 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-diagram-project"></i> Flujo T√°ctico</h4>
                        <p id="pattern-modal-flowdesc" class="text-xs text-slate-400 mb-3 font-mono"></p>
                        <div id="pattern-modal-flow" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-800 bg-slate-900 flex gap-3">
                    <button onclick="loadPatternToPrompt()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-sm px-4 py-2 rounded-lg font-medium transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-copy"></i> Usar Prompt
                    </button>
                    <button onclick="loadPatternToArchitect()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white text-sm px-4 py-2 rounded-lg font-medium transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-pen-ruler"></i> Abrir en Arquitecto
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Ficha T√©cnica (Tool Detail) -->
        <div id="tool-modal" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh]">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <i id="tool-modal-icon" class="fa-solid text-2xl"></i>
                        <div>
                            <h3 id="tool-modal-title" class="font-bold text-white text-lg"></h3>
                            <span id="tool-modal-tag" class="text-xs text-slate-500"></span>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="tool-modal-status" class="status-badge"></span>
                        <button onclick="closeModal('tool-modal')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
                    </div>
                </div>
                <div class="p-6 overflow-y-auto flex-1 space-y-5">
                    <!-- Qu√© es -->
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 flex items-center gap-2"><i class="fa-solid fa-circle-info text-blue-400"></i> Qu√© es</h4>
                        <p id="tool-modal-desc" class="text-sm text-slate-300 leading-relaxed"></p>
                    </div>
                    <!-- Por qu√© me importa -->
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-purple-400 uppercase tracking-widest mb-2 flex items-center gap-2"><i class="fa-solid fa-lightbulb"></i> Por qu√© me importa</h4>
                        <p id="tool-modal-why" class="text-sm text-slate-300 leading-relaxed"></p>
                    </div>
                    <!-- Casos de Uso -->
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 flex items-center gap-2"><i class="fa-solid fa-folder-open text-amber-400"></i> Casos de uso en minerOS</h4>
                        <div id="tool-modal-cases" class="flex flex-wrap gap-2"></div>
                    </div>
                    <!-- C√≥digo -->
                    <div class="bg-slate-950 border border-slate-800 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-green-400 uppercase tracking-widest mb-2 flex items-center gap-2"><i class="fa-solid fa-code"></i> Snippet de c√≥digo</h4>
                        <pre id="tool-modal-code" class="text-xs text-green-400 font-mono whitespace-pre-wrap overflow-x-auto"></pre>
                    </div>
                </div>
                <!-- Cambiar estado -->
                <div class="p-4 border-t border-slate-800 bg-slate-900/50">
                    <p class="text-xs text-slate-500 mb-2">Cambiar estado:</p>
                    <div class="flex gap-2">
                        <button onclick="changeToolStatus(currentTool.id, 'new')" class="flex-1 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 text-xs py-2 rounded-lg font-medium transition border border-blue-500/30">
                            üÜï Por descubrir
                        </button>
                        <button onclick="changeToolStatus(currentTool.id, 'learning')" class="flex-1 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 text-xs py-2 rounded-lg font-medium transition border border-yellow-500/30">
                            üöß En progreso
                        </button>
                        <button onclick="changeToolStatus(currentTool.id, 'used')" class="flex-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 text-xs py-2 rounded-lg font-medium transition border border-green-500/30">
                            ‚úÖ Dominada
                        </button>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-800 bg-slate-900 flex gap-3">
                    <button onclick="addToolToArchitect()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-sm px-4 py-2 rounded-lg font-medium transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> A√±adir al Arquitecto
                    </button>
                    <button onclick="copyToolCode()" class="bg-slate-700 hover:bg-slate-600 text-white text-sm px-4 py-2 rounded-lg font-medium transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-copy"></i> Copiar c√≥digo
                    </button>
                </div>
            </div>
        </div>

        <!-- VISTA 1: MONITOR -->
        <div id="view-monitor" class="hidden flex-1 overflow-y-auto p-8 bg-slate-950 relative">
            <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 space-y-6">
                    <!-- Health Check -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-heart-pulse text-6xl text-blue-500"></i></div>
                        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Salud Backend</h3>
                        <div class="flex items-end gap-3 mb-2"><span id="health-metric" class="text-4xl font-bold text-white">--</span><span class="text-sm text-slate-500 mb-1">ms</span></div>
                        <p id="health-msg" class="text-xs text-slate-500">Conectando...</p>
                        <div class="mt-4 h-1 w-full bg-slate-800 rounded-full overflow-hidden"><div id="health-bar" class="h-full bg-blue-500 w-0 transition-all duration-500"></div></div>
                    </div>
                    <!-- Scout Panel -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-6">
                        <div class="flex items-center gap-2 mb-4">
                            <i class="fa-solid fa-robot text-purple-400"></i>
                            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest">Scout</h3>
                            <span class="text-[10px] bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded-full">IA</span>
                        </div>
                        <p class="text-xs text-slate-500 mb-3">Pega un error y Scout te sugerir√° la soluci√≥n</p>
                        <textarea id="scout-input" rows="4" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-xs font-mono text-slate-300 placeholder-slate-600" placeholder="TypeError: 'NoneType' object..."></textarea>
                        <button onclick="analyzeWithScout()" id="scout-btn" class="mt-3 w-full bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold py-2 rounded-lg transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-magnifying-glass-chart"></i> Analizar Error
                        </button>
                    </div>
                </div>
                <div class="lg:col-span-2 flex flex-col h-[600px]">
                    <div class="bg-slate-950 border border-slate-800 rounded-t-xl p-3 flex justify-between items-center bg-slate-900/50">
                        <div class="flex gap-2"><div id="term-dot" class="w-3 h-3 rounded-full bg-red-500/20"></div><div class="w-3 h-3 rounded-full bg-yellow-500/20"></div><div class="w-3 h-3 rounded-full bg-green-500/20"></div></div><span class="text-xs font-mono text-slate-500">directos.log</span>
                    </div>
                    <div id="terminal-window" class="flex-1 bg-black/80 border-x border-b border-slate-800 rounded-b-xl p-4 font-mono text-xs overflow-y-auto space-y-1 shadow-inner"></div>
                </div>
            </div>
        </div>

        <!-- VISTA 2: FLUJOS T√ÅCTICOS - APP STORE -->
        <div id="view-flow" class="hidden flex-1 overflow-y-auto p-6 bg-slate-950 relative">
            <div class="max-w-7xl mx-auto">
                <!-- Header -->
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-white mb-2">Recetas de Arquitectura</h2>
                    <p class="text-slate-400">Selecciona un flujo y cl√≥nalo directamente al Arquitecto Pro.</p>
                </div>

                <!-- Filtros por Categor√≠a -->
                <div class="flex flex-wrap justify-center gap-2 mb-8">
                    <button onclick="filterFlows('all')" id="flow-filter-all" class="flow-filter-btn bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <i class="fa-solid fa-grid-2"></i> Todos
                        <span class="bg-white/20 px-1.5 py-0.5 rounded text-[10px]" id="flow-count-all">12</span>
                    </button>
                    <button onclick="filterFlows('knowledge')" id="flow-filter-knowledge" class="flow-filter-btn bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 border border-slate-700">
                        <i class="fa-solid fa-brain text-purple-400"></i> Conocimiento
                        <span class="bg-slate-700 px-1.5 py-0.5 rounded text-[10px]" id="flow-count-knowledge">3</span>
                    </button>
                    <button onclick="filterFlows('media')" id="flow-filter-media" class="flow-filter-btn bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 border border-slate-700">
                        <i class="fa-solid fa-photo-film text-pink-400"></i> Media
                        <span class="bg-slate-700 px-1.5 py-0.5 rounded text-[10px]" id="flow-count-media">3</span>
                    </button>
                    <button onclick="filterFlows('automation')" id="flow-filter-automation" class="flow-filter-btn bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 border border-slate-700">
                        <i class="fa-solid fa-robot text-amber-400"></i> Automatizaci√≥n
                        <span class="bg-slate-700 px-1.5 py-0.5 rounded text-[10px]" id="flow-count-automation">3</span>
                    </button>
                    <button onclick="filterFlows('devops')" id="flow-filter-devops" class="flow-filter-btn bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 border border-slate-700">
                        <i class="fa-solid fa-shield-halved text-green-400"></i> DevOps
                        <span class="bg-slate-700 px-1.5 py-0.5 rounded text-[10px]" id="flow-count-devops">3</span>
                    </button>
                </div>

                <!-- Grid de Flujos -->
                <div id="flows-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
                    <!-- Las tarjetas se generan din√°micamente -->
                </div>
            </div>
        </div>

        <!-- Modal Detalle de Flujo -->
        <div id="flow-detail-modal" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-3xl shadow-2xl flex flex-col max-h-[90vh]">
                <!-- Header -->
                <div class="p-5 border-b border-slate-800 flex justify-between items-start">
                    <div class="flex items-center gap-4">
                        <span id="flow-modal-emoji" class="text-4xl"></span>
                        <div>
                            <h3 id="flow-modal-title" class="font-bold text-white text-xl"></h3>
                            <div class="flex items-center gap-2 mt-1">
                                <span id="flow-modal-category" class="text-xs px-2 py-0.5 rounded border"></span>
                                <span id="flow-modal-complexity" class="text-xs px-2 py-0.5 rounded border"></span>
                                <span id="flow-modal-cost" class="text-xs px-2 py-0.5 rounded border"></span>
                            </div>
                        </div>
                    </div>
                    <button onclick="closeModal('flow-detail-modal')" class="text-slate-500 hover:text-white p-1">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Body -->
                <div class="p-6 overflow-y-auto flex-1 space-y-5">
                    <!-- Descripci√≥n -->
                    <div>
                        <p id="flow-modal-desc" class="text-slate-300 leading-relaxed"></p>
                    </div>

                    <!-- Caso de uso -->
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-lightbulb"></i> Caso de Uso
                        </h4>
                        <p id="flow-modal-usecase" class="text-sm text-slate-300"></p>
                    </div>

                    <!-- Flujo de Datos -->
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-purple-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-diagram-project"></i> Flujo de Datos
                        </h4>
                        <p id="flow-modal-flowdesc" class="text-sm text-slate-300 font-mono mb-4"></p>
                        <!-- Stack visual -->
                        <div id="flow-modal-stack" class="flex flex-wrap gap-2"></div>
                    </div>

                    <!-- Prompt T√°ctico -->
                    <div class="bg-slate-950 border border-slate-800 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-green-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-terminal"></i> Prompt T√°ctico
                        </h4>
                        <pre id="flow-modal-prompt" class="text-xs text-slate-300 whitespace-pre-wrap font-mono leading-relaxed max-h-48 overflow-y-auto"></pre>
                    </div>
                </div>

                <!-- Footer con acciones -->
                <div class="p-4 border-t border-slate-800 bg-slate-900 flex gap-3">
                    <button onclick="cloneFlowToArchitect()" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white text-sm px-4 py-3 rounded-lg font-bold transition flex items-center justify-center gap-2 shadow-lg">
                        <i class="fa-solid fa-clone"></i> Clonar al Arquitecto
                    </button>
                    <button onclick="copyFlowPrompt()" class="bg-slate-700 hover:bg-slate-600 text-white text-sm px-4 py-3 rounded-lg font-medium transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-copy"></i> Copiar Prompt
                    </button>
                </div>
            </div>
        </div>

        <!-- VISTA 3: GENERADOR -->
        <div id="view-generator" class="hidden flex-1 overflow-y-auto p-8 relative">
             <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4 space-y-6">
                    <!-- BIBLIOTECA DE PATRONES -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-5">
                        <div class="flex items-center gap-2 mb-4">
                            <i class="fa-solid fa-book text-amber-400"></i>
                            <h3 class="font-bold text-white text-sm">Biblioteca de Patrones</h3>
                            <span class="text-[10px] bg-amber-500/20 text-amber-400 px-2 py-0.5 rounded-full">15</span>
                        </div>
                        <div id="patterns-accordion" class="space-y-2"></div>
                    </div>

                    <!-- Modo Libre -->
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-5">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fa-solid fa-pen text-slate-400"></i>
                            <h3 class="font-bold text-white text-sm">Modo Libre</h3>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-slate-500 mb-1 block">Rol</label>
                                <select id="prompt-role" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-sm text-slate-300">
                                    <option>Arquitecto de Software Senior</option>
                                    <option>Ingeniero de Datos y RAG</option>
                                    <option>Experto en Debugging y Python</option>
                                    <option>Desarrollador Frontend Minimalista</option>
                                    <option>Ingeniero DevOps</option>
                                    <option>Ingeniero de QA</option>
                                    <option>Technical Writer</option>
                                    <option>Ingeniero de Seguridad</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 mb-1 block">Objetivo</label>
                                <textarea id="prompt-goal" rows="3" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2.5 text-sm text-slate-300" placeholder="Describe qu√© quieres lograr..."></textarea>
                            </div>
                            <div class="flex flex-wrap gap-1">
                                <button onclick="setGoal('Generar andamiaje (scaffold) inicial de proyecto')" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-slate-400 px-2 py-1 rounded border border-slate-700 transition">üèóÔ∏è Scaffold</button>
                                <button onclick="setGoal('Explicar este c√≥digo l√≠nea por l√≠nea')" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-slate-400 px-2 py-1 rounded border border-slate-700 transition">üìñ Explicar</button>
                                <button onclick="setGoal('Optimizar para rendimiento y concurrencia')" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-slate-400 px-2 py-1 rounded border border-slate-700 transition">üöÄ Optimizar</button>
                            </div>
                        </div>
                    </div>
                    <button onclick="generatePrompt()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition active:scale-95">Generar Orden</button>
                </div>
                <div class="lg:col-span-4 bg-slate-900 border border-slate-800 rounded-xl p-5 flex flex-col h-[calc(100vh-8rem)]"><div id="stack-selector" class="overflow-y-auto pr-2 space-y-2 flex-1"></div></div>
                <div class="lg:col-span-4 flex flex-col h-[calc(100vh-8rem)]">
                    <div class="bg-slate-800 border border-slate-700 rounded-xl p-1 flex-1 flex flex-col relative group">
                        <div class="absolute top-4 right-4 z-10 opacity-0 group-hover:opacity-100 transition"><button onclick="copyToClipboard()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1.5 rounded-md shadow-lg font-medium transition">Copiar</button></div>
                        <div class="bg-slate-950 rounded-lg p-4 flex-1 overflow-y-auto text-xs font-mono text-slate-300 whitespace-pre-wrap" id="prompt-output"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISTA 4: GLOSARIO + KNOWLEDGE BASE -->
        <div id="view-grid" class="hidden flex-1 overflow-y-auto p-6">
            <div class="max-w-7xl mx-auto">
                <!-- Header con progreso -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-white mb-1">Glosario de Herramientas</h2>
                        <p class="text-sm text-slate-400">Tu stack tecnol√≥gico personal</p>
                    </div>
                    <!-- Contador de progreso -->
                    <div id="progress-card" class="bg-slate-900 border border-slate-800 rounded-xl p-4 flex items-center gap-4">
                        <div class="relative w-14 h-14">
                            <svg class="w-14 h-14 transform -rotate-90">
                                <circle cx="28" cy="28" r="24" stroke="#1e293b" stroke-width="4" fill="none"/>
                                <circle id="progress-circle" cx="28" cy="28" r="24" stroke="#22c55e" stroke-width="4" fill="none" stroke-linecap="round" stroke-dasharray="150.8" stroke-dashoffset="150.8"/>
                            </svg>
                            <span id="progress-percent" class="absolute inset-0 flex items-center justify-center text-sm font-bold text-white">0%</span>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 uppercase tracking-wider">Progreso</p>
                            <p class="text-sm text-white font-medium"><span id="progress-count">0</span> / <span id="progress-total">0</span> dominadas</p>
                        </div>
                    </div>
                </div>

                <!-- Barra de b√∫squeda y filtros -->
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-4 mb-6">
                    <div class="flex flex-col lg:flex-row gap-4">
                        <!-- B√∫squeda -->
                        <div class="flex-1">
                            <div class="relative">
                                <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"></i>
                                <input type="text" id="tools-search" oninput="filterTools()" class="w-full bg-slate-950 border border-slate-700 rounded-lg pl-10 pr-4 py-2.5 text-sm text-slate-300 placeholder-slate-600" placeholder="Buscar herramienta...">
                            </div>
                        </div>
                        <!-- Filtros -->
                        <div class="flex flex-wrap gap-2">
                            <!-- Por categor√≠a -->
                            <select id="filter-category" onchange="filterTools()" class="bg-slate-950 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-slate-300">
                                <option value="all">Todas las categor√≠as</option>
                                <option value="Frontend">Frontend</option>
                                <option value="Backend">Backend</option>
                                <option value="IA Model">IA Model</option>
                                <option value="Storage">Storage</option>
                                <option value="Process">Process</option>
                                <option value="DevOps">DevOps</option>
                            </select>
                            <!-- Por estado -->
                            <select id="filter-status" onchange="filterTools()" class="bg-slate-950 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-slate-300">
                                <option value="all">Todos los estados</option>
                                <option value="used">‚úÖ Dominadas</option>
                                <option value="learning">üöß En progreso</option>
                                <option value="new">üÜï Por descubrir</option>
                            </select>
                        </div>
                    </div>
                    <!-- Filtros r√°pidos por estado -->
                    <div class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-slate-800">
                        <button onclick="setStatusFilter('all')" class="status-filter-btn bg-slate-800 text-slate-300 px-3 py-1.5 rounded-lg text-xs font-medium transition flex items-center gap-2 border border-slate-700" data-status="all">
                            Todos <span id="count-all" class="bg-slate-700 px-1.5 py-0.5 rounded">0</span>
                        </button>
                        <button onclick="setStatusFilter('used')" class="status-filter-btn bg-slate-800 text-slate-300 px-3 py-1.5 rounded-lg text-xs font-medium transition flex items-center gap-2 border border-slate-700" data-status="used">
                            <span class="w-2 h-2 rounded-full bg-green-500"></span> Dominadas <span id="count-used" class="bg-green-500/20 text-green-400 px-1.5 py-0.5 rounded">0</span>
                        </button>
                        <button onclick="setStatusFilter('learning')" class="status-filter-btn bg-slate-800 text-slate-300 px-3 py-1.5 rounded-lg text-xs font-medium transition flex items-center gap-2 border border-slate-700" data-status="learning">
                            <span class="w-2 h-2 rounded-full bg-yellow-500"></span> En progreso <span id="count-learning" class="bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">0</span>
                        </button>
                        <button onclick="setStatusFilter('new')" class="status-filter-btn bg-slate-800 text-slate-300 px-3 py-1.5 rounded-lg text-xs font-medium transition flex items-center gap-2 border border-slate-700" data-status="new">
                            <span class="w-2 h-2 rounded-full bg-blue-500"></span> Por descubrir <span id="count-new" class="bg-blue-500/20 text-blue-400 px-1.5 py-0.5 rounded">0</span>
                        </button>
                    </div>
                </div>

                <!-- Knowledge Base RAG (colapsado) -->
                <details class="bg-slate-900 border border-slate-800 rounded-xl mb-6 group">
                    <summary class="p-4 cursor-pointer flex items-center justify-between hover:bg-slate-800/50 transition rounded-xl">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-brain text-blue-400"></i>
                            <span class="text-sm font-bold text-white">Knowledge Base</span>
                            <span class="text-[10px] bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded-full">RAG</span>
                        </div>
                        <i class="fa-solid fa-chevron-down text-slate-500 group-open:rotate-180 transition-transform"></i>
                    </summary>
                    <div class="p-4 pt-0 border-t border-slate-800">
                        <div class="flex gap-2">
                            <input type="text" id="kb-search" class="flex-1 bg-slate-950 border border-slate-700 rounded-lg px-4 py-2 text-sm text-slate-300 placeholder-slate-600" placeholder="Buscar en tus notas... (ej: ¬øc√≥mo funciona RAG?)">
                            <button onclick="searchKnowledgeBase()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                                <i class="fa-solid fa-search"></i> Buscar
                            </button>
                            <button onclick="indexKnowledgeBase()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg text-sm transition" title="Indexar archivos">
                                <i class="fa-solid fa-rotate"></i>
                            </button>
                        </div>
                        <div id="kb-results" class="hidden mt-4 space-y-3"></div>
                    </div>
                </details>

                <!-- Grid de herramientas -->
                <div id="tools-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>

                <!-- Mensaje cuando no hay resultados -->
                <div id="no-results" class="hidden text-center py-12">
                    <i class="fa-solid fa-search text-4xl text-slate-700 mb-4"></i>
                    <p class="text-slate-500">No se encontraron herramientas con esos filtros</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ============================================
        // 1. DATA TOOLS & DETAILS (TAGS CON ICONOS A√ëADIDOS)
        // ============================================

        // Variable global para tools (se carga desde API o fallback)
        let toolsData = null;

        // FALLBACK: Tools hardcodeados (se usan si API falla)
        const FALLBACK_TOOLS = [
            // ==========================================
            // üüß FRONTEND (La Cara Visible)
            // ==========================================
            {
                id: "html", name: "HTML5 Sem√°ntico", cat: "Frontend",
                icon: "fa-html5", color: "text-orange-500", tag: "Estructura", status: "used",
                desc: "El esqueleto fundamental de la web moderna.",
                why: "Porque minerOS es 'Local First' y web. Un buen HTML sem√°ntico (<article>, <section>) hace que tus datos sean portables y accesibles sin depender de frameworks.",
                cases: ["Estructura de dashboards", "Reportes generados por IA", "Interfaz de PhotoMine"],
                code: "<article class='card'>\n  <header>\n    <h2>Factura #102</h2>\n  </header>\n  <p>Contenido...</p>\n</article>"
            },
            {
                id: "css", name: "Tailwind CSS", cat: "Frontend",
                icon: "fa-css3", color: "text-blue-400", tag: "Estilos", status: "used",
                desc: "Framework de estilos 'utility-first' para dise√±o r√°pido.",
                why: "Te permite dise√±ar interfaces profesionales (modo oscuro, grids responsive) sin escribir hojas de estilo separadas. Ideal para prototipar r√°pido.",
                cases: ["Layouts de PhotoMine", "Tarjetas del Dashboard", "Botones interactivos"],
                code: "<div class='bg-slate-900 text-white p-4 rounded-xl hover:bg-slate-800 transition shadow-lg'>\n  Panel de Control\n</div>"
            },
            {
                id: "htmx", name: "HTMX", cat: "Frontend",
                icon: "fa-bolt", color: "text-yellow-400", tag: "Interactividad", status: "learning",
                desc: "Superpoderes para HTML. AJAX sin JavaScript complejo.",
                why: "Convierte tus botones y formularios en din√°micos (sin recargar p√°gina) conectando directo con Python. Es la alternativa KISS a React.",
                cases: ["B√∫squeda en vivo", "Carga infinita de fotos", "Edici√≥n inline de datos"],
                code: "<button hx-post='/api/procesar' hx-target='#resultado' hx-swap='innerHTML'>\n  Analizar Imagen\n</button>"
            },
            {
                id: "alpine", name: "Alpine.js", cat: "Frontend",
                icon: "fa-code", color: "text-teal-400", tag: "Reactividad", status: "new",
                desc: "JavaScript minimalista para interacciones en el navegador.",
                why: "Para cuando necesitas abrir un modal, un men√∫ desplegable o pesta√±as sin llamar al servidor. Pesa poqu√≠simo.",
                cases: ["Modales de confirmaci√≥n", "Tabs del Dashboard", "Toggles de visibilidad"],
                code: "<div x-data='{ open: false }'>\n  <button @click='open = true'>Abrir</button>\n  <span x-show='open'>Hola!</span>\n</div>"
            },

            // ==========================================
            // üü© BACKEND (El Cerebro L√≥gico)
            // ==========================================
            {
                id: "python", name: "Python 3.11+", cat: "Backend",
                icon: "fa-brands fa-python", color: "text-blue-500", tag: "Lenguaje Core", status: "used",
                desc: "El lenguaje de programaci√≥n para IA y Datos.",
                why: "Es el pegamento de todo el ecosistema minerOS. Orquesta la IA, mueve archivos y sirve la web.",
                cases: ["Scripts de automatizaci√≥n", "L√≥gica de negocio", "Pegamento entre herramientas"],
                code: "def procesar_archivo(ruta: str) -> dict:\n    datos = extraer_texto(ruta)\n    return {'status': 'ok', 'data': datos}"
            },
            {
                id: "fastapi", name: "FastAPI", cat: "Backend",
                icon: "fa-server", color: "text-green-400", tag: "API Server", status: "learning",
                desc: "El servidor web m√°s r√°pido y moderno para Python.",
                why: "Es as√≠ncrono (no se bloquea mientras la IA piensa). Genera documentaci√≥n autom√°tica (/docs) para que pruebes tus funciones.",
                cases: ["Backend de DirectOS", "API de b√∫squeda", "Endpoint de ingesta de archivos"],
                code: "from fastapi import FastAPI\napp = FastAPI()\n\n@app.get('/items/{id}')\nasync def read_item(id: int):\n    return {'item_id': id}"
            },
            {
                id: "pydantic", name: "Pydantic", cat: "Backend",
                icon: "fa-shield-halved", color: "text-red-400", tag: "Validaci√≥n", status: "new",
                desc: "Control de calidad para tus datos.",
                why: "Define c√≥mo deben ser tus datos (ej: 'La edad debe ser un n√∫mero'). Si algo falla, te avisa antes de romper la base de datos.",
                cases: ["Validar JSON de entrada", "Configuraci√≥n (.env)", "Esquemas de DB"],
                code: "from pydantic import BaseModel\n\nclass Usuario(BaseModel):\n    id: int\n    email: str\n    es_admin: bool = False"
            },
            {
                id: "loguru", name: "Loguru", cat: "Backend",
                icon: "fa-list-ul", color: "text-slate-400", tag: "Logging", status: "learning",
                desc: "Logging simplificado y bonito para humanos.",
                why: "Deja de usar print(). Loguru te dice d√≥nde, cu√°ndo y por qu√© fall√≥ algo, con colores y guardado autom√°tico en archivo.",
                cases: ["Depuraci√≥n de errores", "Historial de operaciones", "Alertas del sistema"],
                code: "from loguru import logger\n\nlogger.add('app.log', rotation='1 day')\nlogger.info('Iniciando proceso...')\nlogger.error('Error cr√≠tico en DB')"
            },
            {
                id: "bs4", name: "BeautifulSoup", cat: "Backend",
                icon: "fa-code", color: "text-green-300", tag: "Scraper", status: "learning",
                desc: "Parser HTML para extraer datos de webs.",
                why: "Cuando necesitas sacar informaci√≥n de p√°ginas web (precios, art√≠culos, datos p√∫blicos) de forma estructurada.",
                cases: ["Scraping de precios", "Extracci√≥n de art√≠culos", "Monitoreo de cambios web"],
                code: "from bs4 import BeautifulSoup\nsoup = BeautifulSoup(html, 'html.parser')\ntitulo = soup.find('h1').text"
            },
            {
                id: "watchdog", name: "Watchdog", cat: "Backend",
                icon: "fa-eye", color: "text-amber-400", tag: "File Watcher", status: "learning",
                desc: "Detecta cambios en carpetas autom√°ticamente.",
                why: "Para pipelines autom√°ticos: cuando guardas un archivo, se procesa solo. Ideal para ingesta continua.",
                cases: ["Auto-indexar Descargas", "Procesar fotos nuevas", "Backup autom√°tico"],
                code: "from watchdog.observers import Observer\nobserver = Observer()\nobserver.schedule(handler, path='./inbox')"
            },

            // ==========================================
            // üü™ IA & MODELOS (La Magia)
            // ==========================================
            {
                id: "clip", name: "OpenAI CLIP", cat: "IA Model",
                icon: "fa-brain", color: "text-purple-400", tag: "Visi√≥n", status: "used",
                desc: "Modelo multimodal que entiende im√°genes y texto.",
                why: "Es el coraz√≥n de PhotoMine. Permite buscar 'perro en la playa' y encontrar la foto sin que nadie la haya etiquetado.",
                cases: ["B√∫squeda sem√°ntica visual", "Clasificaci√≥n autom√°tica", "Detecci√≥n de duplicados"],
                code: "inputs = processor(text=['gato', 'perro'], images=image, return_tensors='pt')\nprobs = model(**inputs).logits_per_image.softmax(dim=1)"
            },
            {
                id: "whisper", name: "Whisper", cat: "IA Model",
                icon: "fa-ear-listen", color: "text-indigo-400", tag: "Audio", status: "learning",
                desc: "Reconocimiento de voz a texto de alta precisi√≥n.",
                why: "Convierte el audio (v√≠deos, notas de voz) en texto que luego puedes buscar, resumir o procesar.",
                cases: ["Transcribir reuniones", "Subt√≠tulos autom√°ticos", "Notas de voz a Obsidian"],
                code: "import whisper\nmodel = whisper.load_model('base')\nresult = model.transcribe('audio.mp3')\nprint(result['text'])"
            },
            {
                id: "sbert", name: "Sentence-BERT", cat: "IA Model",
                icon: "fa-brain", color: "text-teal-400", tag: "Embeddings", status: "used",
                desc: "Vectoriza texto para b√∫squeda sem√°ntica.",
                why: "Convierte p√°rrafos en vectores matem√°ticos. Permite buscar 'documentos similares a este' sin keywords exactas.",
                cases: ["Knowledge Base RAG", "B√∫squeda en notas", "Clustering de documentos"],
                code: "from sentence_transformers import SentenceTransformer\nmodel = SentenceTransformer('all-MiniLM-L6-v2')\nvector = model.encode('Tu texto aqu√≠')"
            },
            {
                id: "claude", name: "Claude API", cat: "IA Model",
                icon: "fa-comments", color: "text-orange-400", tag: "LLM Cloud", status: "used",
                desc: "Razonamiento y generaci√≥n de texto avanzado.",
                why: "Para tareas complejas: resumir, analizar errores, generar c√≥digo. Scout usa Claude para diagnosticar problemas.",
                cases: ["An√°lisis de errores (Scout)", "Res√∫menes inteligentes", "Generaci√≥n de c√≥digo"],
                code: "from anthropic import Anthropic\nclient = Anthropic()\nresponse = client.messages.create(\n  model='claude-sonnet-4-20250514',\n  messages=[{'role': 'user', 'content': prompt}]\n)"
            },
            {
                id: "ollama", name: "Ollama", cat: "IA Model",
                icon: "fa-robot", color: "text-pink-400", tag: "Local LLM", status: "new",
                desc: "Ejecuta modelos tipo ChatGPT (Llama 3, Mistral) en tu Mac.",
                why: "Privacidad total. Te permite tener un asistente inteligente que lee tus documentos privados sin subirlos a la nube.",
                cases: ["Resumir documentos sensibles", "Chatbot offline", "Extracci√≥n de datos privados"],
                code: "# En terminal:\nollama run llama3\n# O desde Python:\nimport ollama\nollama.chat(model='llama3', messages=[...])"
            },

            // ==========================================
            // üü® DATOS & ALMACENAMIENTO (La Memoria)
            // ==========================================
            {
                id: "chroma", name: "ChromaDB", cat: "Storage",
                icon: "fa-database", color: "text-emerald-400", tag: "Vector DB", status: "used",
                desc: "Base de datos para guardar vectores (embeddings).",
                why: "Es donde vive la 'memoria sem√°ntica' de minerOS. Permite buscar por significado ('algo parecido a esto') en lugar de palabras exactas.",
                cases: ["Motor de b√∫squeda RAG", "Recomendaciones", "Memoria de chatbot"],
                code: "collection = client.get_collection('fotos')\nresults = collection.query(query_texts=['atardecer'], n_results=5)"
            },
            {
                id: "sqlite", name: "SQLite", cat: "Storage",
                icon: "fa-table", color: "text-blue-300", tag: "Relacional", status: "used",
                desc: "Base de datos SQL en un archivo √∫nico.",
                why: "Perfecta para metadatos estructurados (fechas, nombres, rutas). Es robusta, r√°pida y no necesita servidor.",
                cases: ["√çndice de archivos", "Registro de usuarios", "Logs estructurados"],
                code: "import sqlite3\ncon = sqlite3.connect('mineros.db')\ncon.execute('SELECT * FROM docs WHERE fecha > ?', ('2024-01-01',))"
            },
            {
                id: "markdown", name: "Markdown", cat: "Storage",
                icon: "fa-file-lines", color: "text-slate-300", tag: "Archivos", status: "used",
                desc: "Formato de texto plano para notas y documentaci√≥n.",
                why: "Es el formato universal de conocimiento. Compatible con Obsidian, GitHub, y f√°cil de procesar con IA.",
                cases: ["Notas de aprendizaje", "Documentaci√≥n de proyectos", "Knowledge Base"],
                code: "# T√≠tulo\n## Subt√≠tulo\n- Lista de items\n- **Negrita** y *cursiva*\n```python\ncodigo()\n```"
            },

            // ==========================================
            // üü• PROCESAMIENTO (Los Obreros)
            // ==========================================
            {
                id: "opencv", name: "OpenCV / Pillow", cat: "Process",
                icon: "fa-eye", color: "text-red-400", tag: "Visi√≥n", status: "used",
                desc: "Librer√≠as para manipular im√°genes p√≠xel a p√≠xel.",
                why: "Necesarias para preparar las im√°genes antes de pasarlas a la IA (redimensionar, recortar, convertir formato).",
                cases: ["Generar miniaturas", "Detectar caras", "Normalizar para CLIP"],
                code: "from PIL import Image\nimg = Image.open('foto.jpg').resize((224, 224))\nimg.save('thumb.jpg')"
            },
            {
                id: "ffmpeg", name: "FFmpeg", cat: "Process",
                icon: "fa-film", color: "text-pink-400", tag: "Multimedia", status: "learning",
                desc: "La navaja suiza del v√≠deo y audio.",
                why: "Permite extraer el audio de un v√≠deo para Whisper, o sacar fotogramas cada 5 segundos para CLIP.",
                cases: ["Extraer audio de v√≠deo", "Comprimir v√≠deos", "Generar GIFs"],
                code: "import subprocess\nsubprocess.run(['ffmpeg', '-i', 'video.mp4', '-vn', 'audio.mp3'])"
            },
            {
                id: "ocr", name: "Tesseract OCR", cat: "Process",
                icon: "fa-font", color: "text-cyan-400", tag: "OCR", status: "learning",
                desc: "Extrae texto de im√°genes y PDFs escaneados.",
                why: "Para digitalizar documentos f√≠sicos (facturas, recibos) y hacerlos buscables.",
                cases: ["Escanear facturas", "Digitalizar notas a mano", "Extraer texto de capturas"],
                code: "import pytesseract\nfrom PIL import Image\ntexto = pytesseract.image_to_string(Image.open('scan.png'))"
            },

            // ==========================================
            // ‚¨õ DEVOPS & CALIDAD (El Taller)
            // ==========================================
            {
                id: "git", name: "Git", cat: "DevOps",
                icon: "fa-code-branch", color: "text-orange-400", tag: "Versiones", status: "learning",
                desc: "Sistema de control de versiones.",
                why: "Tu red de seguridad. Te permite experimentar sin miedo a romper nada, pudiendo volver atr√°s en el tiempo.",
                cases: ["Guardar progreso", "Probar features nuevas (ramas)", "Backup en GitHub"],
                code: "git init\ngit add .\ngit commit -m 'A√±adido nuevo parser'"
            },
            {
                id: "ruff", name: "Ruff / Black", cat: "DevOps",
                icon: "fa-check-double", color: "text-yellow-200", tag: "Calidad", status: "new",
                desc: "Herramientas de limpieza y formateo de c√≥digo.",
                why: "Hacen que tu c√≥digo se vea profesional autom√°ticamente. Black formatea y Ruff busca errores.",
                cases: ["Formatear al guardar", "Detectar imports no usados", "Estilo consistente"],
                code: "# En terminal\nruff check .\nblack ."
            },
            {
                id: "docker", name: "Docker", cat: "DevOps",
                icon: "fa-brands fa-docker", color: "text-blue-400", tag: "Contenedores", status: "new",
                desc: "Empaqueta tu aplicaci√≥n para que funcione en cualquier servidor.",
                why: "Tu app funciona en tu Mac pero falla en producci√≥n? Docker asegura que el entorno sea id√©ntico en todas partes.",
                cases: ["Desplegar minerOS en servidor", "Entornos reproducibles", "CI/CD"],
                code: "# Dockerfile\nFROM python:3.11-slim\nWORKDIR /app\nCOPY . .\nRUN pip install -r requirements.txt\nCMD [\"uvicorn\", \"main:app\"]"
            },
            {
                id: "pytest", name: "Pytest", cat: "DevOps",
                icon: "fa-vial", color: "text-green-400", tag: "Testing", status: "new",
                desc: "Framework de testing para Python. Simple pero potente.",
                why: "Escribe tests una vez, ejec√∫talos mil veces. Detecta bugs antes de que lleguen a producci√≥n.",
                cases: ["Tests unitarios", "Tests de integraci√≥n", "Mocks y fixtures"],
                code: "def test_suma():\n    assert suma(2, 2) == 4\n\ndef test_api(client):\n    response = client.get('/health')\n    assert response.status_code == 200"
            },
            {
                id: "httpx", name: "HTTPX", cat: "Backend",
                icon: "fa-globe", color: "text-cyan-400", tag: "HTTP Client", status: "new",
                desc: "Cliente HTTP moderno y as√≠ncrono para Python.",
                why: "requests es s√≠ncrono y lento. HTTPX es async, soporta HTTP/2 y tiene API id√©ntica a requests.",
                cases: ["Llamadas a APIs externas", "Web scraping async", "Testing de endpoints"],
                code: "import httpx\n\nasync with httpx.AsyncClient() as client:\n    response = await client.get('https://api.example.com/data')\n    data = response.json()"
            },
            {
                id: "jq", name: "jq", cat: "Process",
                icon: "fa-filter", color: "text-amber-400", tag: "JSON Parser", status: "new",
                desc: "El grep/sed/awk para JSON. Filtra y transforma JSON desde terminal.",
                why: "Tienes un JSON gigante y solo necesitas un campo? jq lo extrae en una l√≠nea.",
                cases: ["Filtrar respuestas de API", "Transformar datos", "Pipelines de shell"],
                code: "# Extraer nombres de un JSON\ncat data.json | jq '.users[].name'\n\n# Filtrar por condici√≥n\njq '.items | map(select(.price < 100))'"
            },
            {
                id: "typer", name: "Typer", cat: "Backend",
                icon: "fa-terminal", color: "text-emerald-400", tag: "CLI", status: "new",
                desc: "Crea CLIs profesionales con Python usando type hints.",
                why: "Convierte tus scripts en herramientas de l√≠nea de comandos con ayuda autom√°tica y autocompletado.",
                cases: ["CLI para minerOS", "Scripts con argumentos", "Herramientas internas"],
                code: "import typer\n\napp = typer.Typer()\n\n@app.command()\ndef process(path: str, verbose: bool = False):\n    '''Procesa archivos en PATH'''\n    typer.echo(f'Procesando {path}')"
            },
            {
                id: "rich", name: "Rich", cat: "Backend",
                icon: "fa-palette", color: "text-purple-400", tag: "Terminal UI", status: "new",
                desc: "Salida bonita en terminal: colores, tablas, barras de progreso.",
                why: "Deja de usar print(). Rich hace que tus scripts se vean profesionales.",
                cases: ["Logs con colores", "Tablas de datos", "Barras de progreso"],
                code: "from rich import print\nfrom rich.table import Table\n\ntable = Table(title='Resultados')\ntable.add_column('Archivo')\ntable.add_row('foto.jpg')\nprint(table)"
            }
        ];

        // ============================================
        // DUAL-LOAD: API + FALLBACK
        // ============================================

        /**
         * Carga herramientas desde /api/tools
         * Si falla, usa FALLBACK_TOOLS
         */
        async function loadToolsFromAPI() {
            try {
                console.log('[DUAL-LOAD] Intentando cargar desde /api/tools...');
                const response = await fetch('/api/tools');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.tools && Array.isArray(data.tools)) {
                    console.log(`[DUAL-LOAD] ‚úÖ Cargadas ${data.count} herramientas desde API`);

                    // Transformar formato API ‚Üí formato frontend
                    const toolsFromAPI = data.tools.map(t => ({
                        id: t.id,
                        name: t.name,
                        cat: t.category,
                        icon: t.icon,
                        color: t.color,
                        tag: t.tag,
                        status: t.status,
                        desc: t.content?.split('\n\n')[0]?.replace(/^# .*\n/, '') || t.desc || '',
                        why: extractSection(t.content, 'Por qu√© en minerOS') || '',
                        cases: extractListItems(t.content, 'Casos de uso') || [],
                        code: extractCodeBlock(t.content) || ''
                    }));

                    // MERGE: Combinar tools de API con las que faltan de FALLBACK
                    const apiIds = new Set(toolsFromAPI.map(t => t.id));
                    const remainingFallback = FALLBACK_TOOLS.filter(t => !apiIds.has(t.id));

                    toolsData = [...toolsFromAPI, ...remainingFallback];
                    console.log(`[DUAL-LOAD] üì¶ Total: ${toolsData.length} herramientas (${toolsFromAPI.length} desde API + ${remainingFallback.length} fallback)`);

                    return true;
                }
                throw new Error('Formato de respuesta inv√°lido');

            } catch (error) {
                console.warn('[DUAL-LOAD] ‚ö†Ô∏è API fall√≥, usando fallback completo:', error.message);
                toolsData = FALLBACK_TOOLS;
                return false;
            }
        }

        // Helpers para parsear markdown
        function extractSection(content, heading) {
            if (!content) return '';
            const regex = new RegExp(`## ${heading}\\s*\\n([^#]+)`, 'i');
            const match = content.match(regex);
            return match ? match[1].trim() : '';
        }

        function extractListItems(content, heading) {
            if (!content) return [];
            const section = extractSection(content, heading);
            const items = section.match(/^- (.+)$/gm);
            return items ? items.map(i => i.replace(/^- /, '')) : [];
        }

        function extractCodeBlock(content) {
            if (!content) return '';
            const match = content.match(/```(?:python|javascript)?\n([\s\S]+?)\n```/);
            return match ? match[1] : '';
        }

        // Getter para usar en vez de acceder directamente a tools
        function getTools() {
            return toolsData || FALLBACK_TOOLS;
        }

        // ============================================
        // PATRONES DE ARQUITECTURA (PRESETS)
        // ============================================
        const presets = [
            {
                id: "rag-chatbot",
                name: "üß† Cerebro de Segunda Memoria",
                desc: "RAG Chatbot - Chatea con tus PDFs/Apuntes",
                useCase: "farmaIA, DocMine",
                tools: ["fastapi", "sbert", "chroma", "claude", "htmx"],
                flow: "Pregunta ‚Üí Vector ‚Üí Busca contexto ‚Üí LLM responde"
            },
            {
                id: "video-search",
                name: "ü¶Ö Ojo de Halc√≥n",
                desc: "Video Search - Encuentra momentos por texto o imagen",
                useCase: "VideoMine, PhotoMine++",
                tools: ["ffmpeg", "whisper", "clip", "sqlite", "fastapi"],
                flow: "Video ‚Üí Escenas + Audio ‚Üí Indexa ‚Üí Busca"
            },
            {
                id: "smart-scraper",
                name: "üïµÔ∏è Agente Curador",
                desc: "Smart Scraper - Extrae datos limpios de webs",
                useCase: "Investigaci√≥n, precios",
                tools: ["python", "bs4", "claude", "sqlite", "loguru"],
                flow: "URL ‚Üí HTML ‚Üí LLM extrae JSON ‚Üí Guarda"
            },
            {
                id: "voice-notes",
                name: "üé§ Escriba Silencioso",
                desc: "Voice-to-Knowledge - Notas de voz a texto estructurado",
                useCase: "Diario, ideas, reuniones",
                tools: ["whisper", "python", "claude", "markdown"],
                flow: "Audio ‚Üí Transcribe ‚Üí LLM resume ‚Üí Guarda .md"
            },
            {
                id: "auto-tagger",
                name: "üëª Clasificador Fantasma",
                desc: "Auto-Tagging - Organiza archivos por contenido",
                useCase: "Descargas, Escritorio",
                tools: ["watchdog", "clip", "ocr", "chroma", "python"],
                flow: "Detecta archivo ‚Üí Analiza ‚Üí Clasifica ‚Üí Mueve"
            },
            {
                id: "text-to-sql",
                name: "üîÆ Or√°culo de Datos",
                desc: "Text-to-SQL - Pregunta a tu BD en lenguaje natural",
                useCase: "Farmacia, Fiscalidad",
                tools: ["fastapi", "claude", "python", "sqlite", "htmx"],
                flow: "Pregunta ‚Üí LLM genera SQL ‚Üí Ejecuta ‚Üí Muestra"
            }
        ];
        
        const catStyles = { "Frontend": "cat-frontend", "Backend": "cat-backend", "IA Model": "cat-ai", "Storage": "cat-storage", "Process": "cat-process", "DevOps": "cat-devops" };
        const statusLabels = { "used": "‚úÖ Dominada", "learning": "üöß En progreso", "new": "üÜï Por descubrir" };

        // ============================================
        // BIBLIOTECA DE PATRONES DE PROMPTS
        // ============================================
        const promptPatterns = {
            "refactoring": {
                name: "üîß Refactoring",
                icon: "fa-wrench",
                patterns: [
                    {
                        id: "refactorizador-modular",
                        name: "Refactorizador Modular",
                        emoji: "üèóÔ∏è",
                        problem: "Tienes un script prueba.py de 300 l√≠neas que funciona, pero es un caos.",
                        prompt: `Act√∫a como Arquitecto de Software. Toma este c√≥digo monol√≠tico y refactor√≠zalo siguiendo la arquitectura limpia de minerOS. Sep√°ralo en: routers/ (endpoints), services/ (l√≥gica pura), y core/ (configuraci√≥n). Usa inyecci√≥n de dependencias y Pydantic para validaci√≥n. Entr√©game la estructura de archivos final.`,
                        flow: ["python", "fastapi", "loguru"],
                        flowDesc: "Script ‚Üí Analiza ‚Üí Separa m√≥dulos ‚Üí Estructura limpia"
                    },
                    {
                        id: "guardian-calidad",
                        name: "Guardi√°n de Calidad",
                        emoji: "üõ°Ô∏è",
                        problem: "Tienes miedo de tocar el c√≥digo porque se puede romper.",
                        prompt: `Act√∫a como Ingeniero de QA experto en Pytest. Genera una suite de tests completa para este m√≥dulo. Incluye conftest.py con fixtures para mockear la base de datos y las llamadas a APIs externas (como OpenAI). Cubre casos de √©xito, casos de error y casos borde.`,
                        flow: ["python", "sqlite", "loguru"],
                        flowDesc: "C√≥digo ‚Üí Analiza ‚Üí Genera tests ‚Üí conftest.py + tests/"
                    },
                    {
                        id: "constructor-interfaz",
                        name: "Constructor de Interfaz",
                        emoji: "üé®",
                        problem: "Tienes la API hecha pero te da pereza hacer el HTML.",
                        prompt: `Act√∫a como Desarrollador Frontend Minimalista. Teniendo en cuenta este esquema de datos Pydantic del backend, genera un componente HTML5 + TailwindCSS aut√≥nomo. Usa HTMX para conectar con el endpoint sin escribir JavaScript. El dise√±o debe ser limpio, oscuro (Slate-900) y mobile-first.`,
                        flow: ["html", "css", "htmx", "fastapi"],
                        flowDesc: "Pydantic Schema ‚Üí HTML5 + Tailwind ‚Üí HTMX bindings"
                    }
                ]
            },
            "contenido": {
                name: "üìù Contenido",
                icon: "fa-pen-fancy",
                patterns: [
                    {
                        id: "alquimista-contenido",
                        name: "Alquimista de Contenido",
                        emoji: "‚ú®",
                        problem: "Tienes un archivo Markdown t√©cnico y quieres convertirlo en contenido publicable.",
                        prompt: `Act√∫a como Content Strategist t√©cnico. Toma este archivo Markdown y genera: 1) Un hilo de Twitter de 5 tweets con hooks y emojis, 2) Un post de LinkedIn profesional con bullet points, 3) Una Newsletter HTML maquetada. Mant√©n el tono t√©cnico pero accesible.`,
                        flow: ["python", "claude", "clip", "html", "sqlite"],
                        flowDesc: "Markdown ‚Üí IA extrae ideas ‚Üí Genera formatos ‚Üí HTML Newsletter"
                    }
                ]
            },
            "seguridad": {
                name: "üõ°Ô∏è Seguridad",
                icon: "fa-shield-halved",
                patterns: [
                    {
                        id: "escudo-privacidad",
                        name: "Escudo de Privacidad",
                        emoji: "üîí",
                        problem: "Necesitas compartir logs o documentos pero contienen datos sensibles.",
                        prompt: `Act√∫a como Ingeniero de Seguridad. Crea un script Python que escanee archivos recursivamente, detecte datos sensibles (DNI, Email, Tel√©fono, API Keys, IBANs) usando regex y opcionalmente Spacy NER, y genere una copia censurada con [REDACTED]. Usa Loguru para alertar cada hallazgo. Sin APIs externas - todo local.`,
                        flow: ["python", "ocr", "loguru"],
                        flowDesc: "Archivos ‚Üí OCR si es imagen ‚Üí Regex/Spacy detecta ‚Üí Copia censurada"
                    }
                ]
            },
            "knowledge": {
                name: "üß† Knowledge",
                icon: "fa-brain",
                patterns: [
                    {
                        id: "sintetizador-conocimiento",
                        name: "Sintetizador de Conocimiento",
                        emoji: "üìö",
                        problem: "Tienes 50 PDFs sobre un tema y necesitas un resumen coherente.",
                        prompt: `Act√∫a como Investigador Senior. Genera un "Estado del Arte" sobre el tema especificado bas√°ndote √∫nicamente en los fragmentos recuperados de mi Knowledge Base local. Estructura el ensayo con: Introducci√≥n, Conceptos clave, Evoluci√≥n hist√≥rica, Estado actual, y Conclusiones. Cita las fuentes originales.`,
                        flow: ["fastapi", "chroma", "python", "claude", "html"],
                        flowDesc: "Tema ‚Üí ChromaDB busca ‚Üí Reranking ‚Üí LLM sintetiza ‚Üí Informe HTML"
                    }
                ]
            },
            "aprendizaje": {
                name: "üìñ Aprendizaje",
                icon: "fa-graduation-cap",
                patterns: [
                    {
                        id: "mentor-socratico",
                        name: "Mentor Socr√°tico",
                        emoji: "üéì",
                        problem: "Quieres comprobar si realmente entendiste un documento t√©cnico.",
                        prompt: `Act√∫a como profesor universitario experto en evaluaci√≥n. Lee este documento t√©cnico y genera un test de 10 preguntas tipo test (4 opciones, solo 1 correcta). Incluye preguntas de comprensi√≥n, aplicaci√≥n y an√°lisis. Devuelve un JSON con: pregunta, opciones[], respuesta_correcta, explicacion.`,
                        flow: ["python", "claude", "htmx", "markdown"],
                        flowDesc: "PDF/MD ‚Üí LLM genera quiz ‚Üí JSON ‚Üí Interfaz Flashcards"
                    },
                    {
                        id: "resumen-ejecutivo",
                        name: "Resumen Ejecutivo",
                        emoji: "üìã",
                        problem: "Al final del d√≠a no recuerdas qu√© guardaste en tus carpetas.",
                        prompt: `Act√∫a como Asistente Personal. Escanea los archivos creados/modificados en las √∫ltimas 24 horas en la carpeta especificada. Para cada archivo, extrae su "esencia" (t√≠tulo, tipo, tema principal). Genera un resumen narrativo de 1 p√°rrafo: "Hoy guardaste 3 facturas, 2 notas de voz sobre X, y 1 snippet de c√≥digo para Y".`,
                        flow: ["python", "watchdog", "ocr", "clip", "claude", "markdown"],
                        flowDesc: "Watchdog ‚Üí Clasifica archivos ‚Üí IA resume ‚Üí DIARIO.md"
                    },
                    {
                        id: "torre-babel",
                        name: "Torre de Babel",
                        emoji: "üåç",
                        problem: "Necesitas leer documentaci√≥n t√©cnica en otro idioma.",
                        prompt: `Act√∫a como Traductor T√©cnico especializado. Traduce este documento manteniendo: 1) Bloques de c√≥digo intactos, 2) Nombres de variables/funciones sin traducir, 3) Terminolog√≠a t√©cnica est√°ndar (API, endpoint, etc). Genera una versi√≥n biling√ºe lado a lado si es posible.`,
                        flow: ["python", "claude", "html", "markdown"],
                        flowDesc: "Markdown ‚Üí Separa c√≥digo/texto ‚Üí Traduce texto ‚Üí Re-ensambla"
                    }
                ]
            },
            "devops": {
                name: "üîß DevOps",
                icon: "fa-code",
                patterns: [
                    {
                        id: "code-reviewer",
                        name: "Code Reviewer",
                        emoji: "üëÄ",
                        problem: "Quieres un segundo par de ojos antes de hacer commit.",
                        prompt: `Act√∫a como Senior Python Developer con 10 a√±os de experiencia. Revisa este c√≥digo buscando: 1) Vulnerabilidades de seguridad (inyecci√≥n, exposici√≥n de secrets), 2) Problemas de rendimiento (N+1, memory leaks), 3) Falta de type hints, 4) Code smells (funciones largas, acoplamiento). Prioriza los hallazgos por severidad.`,
                        flow: ["python", "loguru"],
                        flowDesc: "C√≥digo ‚Üí An√°lisis est√°tico ‚Üí IA review ‚Üí Reporte priorizado"
                    },
                    {
                        id: "semilla-datos",
                        name: "Semilla de Datos",
                        emoji: "üå±",
                        problem: "Necesitas datos de prueba realistas sin usar datos reales de producci√≥n.",
                        prompt: `Act√∫a como Ingeniero de Datos. Genera un dataset de prueba con el esquema especificado. Los datos deben ser: 1) Coherentes entre s√≠ (edades realistas, nombres plausibles), 2) Diversos (cubrir casos borde), 3) En formato JSON/CSV. Incluye al menos 100 registros.`,
                        flow: ["fastapi", "claude", "python", "sqlite"],
                        flowDesc: "Esquema ‚Üí LLM genera JSON ‚Üí Valida Pydantic ‚Üí Inserta SQLite"
                    },
                    {
                        id: "documentador-fantasma",
                        name: "Documentador Fantasma",
                        emoji: "üëª",
                        problem: "Tu c√≥digo funciona pero no tiene documentaci√≥n.",
                        prompt: `Act√∫a como Technical Writer. Lee este m√≥dulo Python usando AST y genera: 1) Docstrings en formato Google Style para cada funci√≥n, 2) Un README.md con: descripci√≥n, instalaci√≥n, uso b√°sico, y ejemplos. 3) Un diagrama ASCII del flujo principal. No inventes funcionalidad - documenta solo lo que existe.`,
                        flow: ["python", "claude", "markdown"],
                        flowDesc: "C√≥digo ‚Üí AST extrae estructura ‚Üí LLM documenta ‚Üí docs/"
                    }
                ]
            },
            "debug": {
                name: "üîç Debug & Performance",
                icon: "fa-bug",
                patterns: [
                    {
                        id: "debugger-sherlock",
                        name: "Debugger Sherlock",
                        emoji: "üîç",
                        problem: "Tienes un error cr√≠ptico y no sabes por d√≥nde empezar.",
                        prompt: `Act√∫a como Detective de Bugs Senior. Analiza este traceback como Sherlock Holmes. Identifica: 1) La l√≠nea exacta del fallo y tipo de excepci√≥n, 2) El contexto (qu√© datos entraron), 3) 3 hip√≥tesis ordenadas por probabilidad, 4) Plan de debugging paso a paso con prints/breakpoints estrat√©gicos. No asumas - deduce desde la evidencia.`,
                        flow: ["python", "loguru", "claude"],
                        flowDesc: "Traceback ‚Üí Analiza contexto ‚Üí Hip√≥tesis ‚Üí Plan de acci√≥n"
                    },
                    {
                        id: "performance-hunter",
                        name: "Performance Hunter",
                        emoji: "‚ö°",
                        problem: "Tu script funciona pero tarda demasiado.",
                        prompt: `Act√∫a como Performance Engineer. Analiza este c√≥digo Python buscando: 1) Loops O(n¬≤) convertibles a O(n) con sets/dicts, 2) Operaciones I/O bloqueantes que podr√≠an ser async, 3) Memory allocations innecesarias en loops, 4) Candidatos para caching (@lru_cache). Prioriza por impacto/esfuerzo. Dame el c√≥digo optimizado.`,
                        flow: ["python", "loguru"],
                        flowDesc: "C√≥digo lento ‚Üí Profiling mental ‚Üí Identificar hotspots ‚Üí Optimizar"
                    }
                ]
            },
            "data-api": {
                name: "üóÇÔ∏è Data & API",
                icon: "fa-database",
                patterns: [
                    {
                        id: "schema-detective",
                        name: "Schema Detective",
                        emoji: "üóÇÔ∏è",
                        problem: "Recibes un JSON/CSV gigante y necesitas entender su estructura.",
                        prompt: `Act√∫a como Data Analyst. Analiza este dataset (JSON/CSV) y genera: 1) Modelo Pydantic con tipos inferidos autom√°ticamente, 2) Campos opcionales (Optional[]) vs requeridos detectados, 3) Valores √∫nicos que deber√≠an ser Enums, 4) Relaciones entre entidades si existen. Formato listo para copiar a models.py.`,
                        flow: ["python", "fastapi", "sqlite"],
                        flowDesc: "JSON/CSV ‚Üí Inferir tipos ‚Üí Generar Pydantic ‚Üí models.py"
                    },
                    {
                        id: "api-architect",
                        name: "API Architect",
                        emoji: "üèõÔ∏è",
                        problem: "Sabes qu√© necesitas pero no c√≥mo dise√±ar los endpoints.",
                        prompt: `Act√∫a como API Designer experto en REST. Dado este dominio de negocio, dise√±a una API RESTful completa: 1) Recursos y rutas (GET/POST/PUT/DELETE), 2) Esquemas Pydantic de request/response, 3) C√≥digos HTTP espec√≠ficos (201, 204, 404, 422), 4) Ejemplo curl de cada endpoint. Estilo FastAPI, listo para implementar.`,
                        flow: ["fastapi", "python", "sqlite"],
                        flowDesc: "Dominio ‚Üí Identificar recursos ‚Üí Dise√±ar rutas ‚Üí Schemas"
                    }
                ]
            },
            "meta": {
                name: "üéØ Meta & Automation",
                icon: "fa-wand-magic-sparkles",
                patterns: [
                    {
                        id: "prompt-optimizer",
                        name: "Prompt Optimizer",
                        emoji: "üéØ",
                        problem: "Tu prompt funciona a medias, a veces da respuestas inconsistentes.",
                        prompt: `Act√∫a como Prompt Engineer Senior. Analiza este prompt y mej√≥ralo aplicando: 1) Rol espec√≠fico con expertise, 2) Formato de salida estructurado (JSON, Markdown), 3) Ejemplos few-shot si el patr√≥n es complejo, 4) Restricciones expl√≠citas (qu√© NO hacer), 5) Pensamiento paso a paso si requiere razonamiento. Devuelve: versi√≥n original vs mejorada.`,
                        flow: ["claude", "markdown"],
                        flowDesc: "Prompt d√©bil ‚Üí An√°lisis ‚Üí Aplicar t√©cnicas ‚Üí Prompt robusto"
                    },
                    {
                        id: "workflow-automator",
                        name: "Workflow Automator",
                        emoji: "ü§ñ",
                        problem: "Haces lo mismo manualmente cada d√≠a (renombrar, mover, procesar).",
                        prompt: `Act√∫a como Automation Engineer. Dado este flujo manual, genera un script Python con Watchdog que: 1) Detecte archivos nuevos por patr√≥n (*.pdf, *.jpg), 2) Ejecute la acci√≥n autom√°ticamente, 3) Loguee cada operaci√≥n con Loguru, 4) Tenga modo --dry-run para probar. Sin dependencias innecesarias. Local-first.`,
                        flow: ["python", "watchdog", "loguru"],
                        flowDesc: "Describir flujo ‚Üí Watchdog detecta ‚Üí Acci√≥n ‚Üí Log"
                    }
                ]
            },
            "ui-creative": {
                name: "üé® Creatividad & UI",
                icon: "fa-palette",
                patterns: [
                    {
                        id: "pincel-digital",
                        name: "Pincel Digital",
                        emoji: "üñåÔ∏è",
                        problem: "Tienes un HTML funcional pero feo. Quieres que parezca SaaS profesional.",
                        prompt: `Act√∫a como Dise√±ador UI/UX Senior experto en Tailwind CSS. Toma este HTML crudo y redis√©√±alo para que sea moderno, oscuro y minimalista. Requisitos: Gradientes sutiles (slate-900‚Üíslate-950), tipograf√≠a Inter, micro-interacciones (hover, transiciones 200ms), sombras para profundidad. Mant√©n la estructura funcional intacta.`,
                        flow: ["html", "css", "htmx"],
                        flowDesc: "HTML feo ‚Üí An√°lisis UX ‚Üí Tailwind magic ‚Üí HTML profesional"
                    },
                    {
                        id: "narrador-datos",
                        name: "Narrador de Datos",
                        emoji: "üìä",
                        problem: "Tienes datos en SQLite/Python pero verlos en tablas es aburrido.",
                        prompt: `Act√∫a como Experto en Visualizaci√≥n de Datos. Tengo este dataset JSON. Genera c√≥digo HTML + JS usando Chart.js para un dashboard interactivo: gr√°fico de l√≠nea temporal, donut para distribuci√≥n por categor√≠as, tarjetas KPI con totales. Paleta ne√≥n (cyan, magenta, amarillo) sobre fondo slate-900.`,
                        flow: ["html", "python", "sqlite"],
                        flowDesc: "Datos ‚Üí Elegir visualizaci√≥n ‚Üí Chart.js ‚Üí Dashboard"
                    },
                    {
                        id: "arquitecto-componentes",
                        name: "Arquitecto de Componentes",
                        emoji: "üß±",
                        problem: "Repites mucho c√≥digo HTML (tarjetas, botones, men√∫s).",
                        prompt: `Act√∫a como Frontend Developer experto en DRY. Extrae este bloque de HTML repetitivo y convi√©rtelo en: A) Macro de Jinja2, B) Template con slots, o C) Componente Alpine.js. Que acepte par√°metros: t√≠tulo, imagen, estado, onClick. Incluye ejemplo instanci√°ndolo 3 veces con datos diferentes.`,
                        flow: ["html", "htmx", "python"],
                        flowDesc: "HTML repetido ‚Üí Identificar variaciones ‚Üí Parametrizar ‚Üí Componente"
                    }
                ]
            },
            "robustez": {
                name: "üõ†Ô∏è Ingenier√≠a & Robustez",
                icon: "fa-hammer",
                patterns: [
                    {
                        id: "comandante-terminal",
                        name: "Comandante de Terminal",
                        emoji: "‚å®Ô∏è",
                        problem: "Ejecutar scripts editando variables en el c√≥digo es cutre.",
                        prompt: `Act√∫a como Python Tooling Expert. Convierte este script en una CLI profesional con Typer. Requisitos: Comandos claros (scan, process, clean), opciones con defaults, barras de progreso con rich/tqdm, ayuda autom√°tica (--help), colores para √©xito/error, manejo de Ctrl+C graceful.`,
                        flow: ["python", "loguru"],
                        flowDesc: "Script ‚Üí Identificar inputs ‚Üí Typer CLI ‚Üí Instalable con pip"
                    },
                    {
                        id: "cirujano-datos",
                        name: "Cirujano de Datos",
                        emoji: "üî¨",
                        problem: "Tus consultas a SQLite empiezan a ir lentas.",
                        prompt: `Act√∫a como DBA experto en SQLite. Analiza este esquema y consulta SQL lenta. Tareas: 1) Identificar cuellos de botella (table scans, joins sin √≠ndice), 2) Sugerir √≠ndices (CREATE INDEX), 3) Normalizar si hay redundancia, 4) Reescribir query optimizada, 5) Explicar con EXPLAIN QUERY PLAN.`,
                        flow: ["sqlite", "python"],
                        flowDesc: "Schema + Query ‚Üí EXPLAIN ‚Üí √çndices ‚Üí Query optimizada"
                    },
                    {
                        id: "centinela-errores",
                        name: "Centinela de Errores",
                        emoji: "üõ°Ô∏è",
                        problem: "Tu script se rompe si falta internet o un archivo.",
                        prompt: `Act√∫a como SRE (Site Reliability Engineer). Envuelve este c√≥digo en estructura robusta de errores: Excepciones espec√≠ficas (NetworkError, FileNotFoundError), retry con backoff exponencial (3 intentos: 1s‚Üí2s‚Üí4s), fallback graceful, Loguru para registrar timestamp/intento/error/contexto.`,
                        flow: ["python", "loguru"],
                        flowDesc: "C√≥digo fr√°gil ‚Üí Identificar fallos ‚Üí try/except ‚Üí Retry ‚Üí Log"
                    }
                ]
            },
            "data-eng": {
                name: "üßπ Data Engineering",
                icon: "fa-broom",
                patterns: [
                    {
                        id: "conserje-datos",
                        name: "Conserje de Datos",
                        emoji: "üßπ",
                        problem: "Tienes un CSV/JSON sucio con fechas mixtas, nulos y duplicados.",
                        prompt: `Act√∫a como Data Engineer. Genera script de limpieza con Pandas: 1) Estandarizar fechas a ISO 8601, 2) Manejar nulos (media para num√©ricos, "UNKNOWN" para strings), 3) Eliminar duplicados por columnas clave, 4) Detectar outliers (>3 std), 5) Exportar CSV limpio + quality_report.json.`,
                        flow: ["python", "sqlite"],
                        flowDesc: "CSV sucio ‚Üí Pandas ‚Üí Limpieza ‚Üí CSV limpio + reporte"
                    },
                    {
                        id: "susurrador-regex",
                        name: "Susurrador de Regex",
                        emoji: "üîÆ",
                        problem: "Necesitas extraer informaci√≥n de texto no estructurado (logs, emails).",
                        prompt: `Act√∫a como experto en Expresiones Regulares de Python. Necesito extraer [PATR√ìN: IBANs, referencias catastrales, fechas, etc] de este texto. Para cada patr√≥n: 1) Regex comentada paso a paso, 2) C√≥digo Python con re.findall(), 3) Tests con casos borde (qu√© matchea y qu√© no).`,
                        flow: ["python", "loguru"],
                        flowDesc: "Texto ‚Üí Identificar patr√≥n ‚Üí Regex ‚Üí Extraer ‚Üí Lista limpia"
                    },
                    {
                        id: "traductor-formatos",
                        name: "Traductor de Formatos",
                        emoji: "üîÑ",
                        problem: "Necesitas mover datos entre sistemas incompatibles (XML‚ÜíSQLite).",
                        prompt: `Act√∫a como Integration Engineer. Genera script de migraci√≥n en Python: 1) Parsear origen (lxml para XML, openpyxl para Excel), 2) Transformar al esquema destino, 3) Validar con Pydantic antes de insertar, 4) Manejar errores por registro (no fallar todo por uno), 5) Log de migraci√≥n: exitosos/fallidos/warnings.`,
                        flow: ["python", "sqlite", "fastapi"],
                        flowDesc: "Origen ‚Üí Parse ‚Üí Transform ‚Üí Validate ‚Üí Load ‚Üí Log"
                    }
                ]
            },
            "docs-visual": {
                name: "üìê Documentaci√≥n Visual",
                icon: "fa-diagram-project",
                patterns: [
                    {
                        id: "diagramador-auto",
                        name: "Diagramador Autom√°tico",
                        emoji: "üìê",
                        problem: "Necesitas explicar un flujo visualmente pero dibujar es tedioso.",
                        prompt: `Act√∫a como Technical Illustrator. Analiza este c√≥digo/flujo y genera c√≥digo Mermaid.js. Tipos: Secuencia (Frontend‚ÜíAPI‚ÜíDB), Flowchart (if/else), ER (relaciones tablas), State (estados proceso). Output: c√≥digo Mermaid listo para GitHub/Notion + preview ASCII si es posible.`,
                        flow: ["markdown", "python"],
                        flowDesc: "C√≥digo/descripci√≥n ‚Üí Elegir tipo ‚Üí Mermaid.js ‚Üí Diagrama"
                    },
                    {
                        id: "bibliotecario-api",
                        name: "Bibliotecario de API",
                        emoji: "üìö",
                        problem: "Tu API funciona pero no tiene documentaci√≥n para otros devs.",
                        prompt: `Act√∫a como API Documentation Specialist. Genera documentaci√≥n OpenAPI 3.0 (Swagger) en YAML: Paths con m√©todos HTTP, Request/Response schemas, C√≥digos de error (400, 404, 500), Ejemplos realistas, Tags por recurso. Bonus: docstring para que FastAPI auto-genere /docs.`,
                        flow: ["fastapi", "python", "markdown"],
                        flowDesc: "C√≥digo ‚Üí Extraer endpoints ‚Üí OpenAPI YAML ‚Üí /docs autom√°tico"
                    },
                    {
                        id: "gestor-entorno",
                        name: "Gestor de Entorno",
                        emoji: "‚öôÔ∏è",
                        problem: "Tienes API keys y rutas hardcodeadas en el c√≥digo.",
                        prompt: `Act√∫a como DevOps Engineer. Analiza este script e identifica variables de configuraci√≥n: API Keys, rutas, URLs, puertos, feature flags. Refactoriza usando python-dotenv + Pydantic Settings. Genera .env.example con placeholders. A√±ade validaci√≥n (app no arranca si falta ANTHROPIC_API_KEY).`,
                        flow: ["python", "fastapi", "loguru"],
                        flowDesc: "C√≥digo ‚Üí Identificar config ‚Üí .env + Settings ‚Üí Validaci√≥n"
                    }
                ]
            },
            "comodin": {
                name: "üÉè Comod√≠n",
                icon: "fa-hat-wizard",
                patterns: [
                    {
                        id: "meta-patron",
                        name: "Meta-Patr√≥n",
                        emoji: "üÉè",
                        problem: "Necesitas un patr√≥n que no existe en esta lista.",
                        prompt: `Act√∫a como Prompt Architect de minerOS. Necesito un nuevo patr√≥n de prompt para [DESCRIBIR PROBLEMA]. Genera siguiendo esta estructura: Nombre creativo + emoji, El Problema (1 frase), El Prompt completo, Flujo T√°ctico (herramientas), Ejemplo de uso real.`,
                        flow: ["claude", "markdown"],
                        flowDesc: "Problema ‚Üí Dise√±ar patr√≥n ‚Üí Prompt + Flujo ‚Üí Ejemplo"
                    },
                    {
                        id: "auditor-proyecto",
                        name: "Auditor de Proyecto",
                        emoji: "üîé",
                        problem: "Heredas un proyecto y no sabes por d√≥nde empezar.",
                        prompt: `Act√∫a como Tech Lead haciendo due diligence. Escanea este proyecto y genera informe: 1) Stack detectado (lenguajes, frameworks, DBs), 2) Estructura de carpetas, 3) Puntos de entrada (main.py, index.html), 4) Dependencias cr√≠ticas, 5) Red flags: c√≥digo muerto, secrets expuestos, deuda t√©cnica, 6) Siguiente paso recomendado.`,
                        flow: ["python", "loguru", "markdown"],
                        flowDesc: "Proyecto ‚Üí Escanear ‚Üí Analizar ‚Üí Informe ejecutivo"
                    },
                    {
                        id: "simplificador-kiss",
                        name: "Simplificador KISS",
                        emoji: "‚úÇÔ∏è",
                        problem: "Sospechas que tu c√≥digo est√° sobre-engineered.",
                        prompt: `Act√∫a como Senior Developer minimalista. Revisa este c√≥digo con filosof√≠a KISS. Identifica: 1) Abstracciones prematuras (clases usadas una vez), 2) Patrones de dise√±o innecesarios, 3) Configuraci√≥n excesiva, 4) C√≥digo "por si acaso" que nunca se ejecuta. Para cada hallazgo: c√≥digo actual vs versi√≥n simplificada.`,
                        flow: ["python", "loguru"],
                        flowDesc: "C√≥digo complejo ‚Üí Identificar excesos ‚Üí Simplificar ‚Üí KISS"
                    }
                ]
            }
        };

        const nodeDetails = {
            fastapi: { title: "FastAPI", role: "Arquitecto Senior", desc: "Servidor as√≠ncrono. Maneja las peticiones de entrada.", code: "@app.post('/ingest')\nasync def ingest(file: UploadFile):\n    await process_file(file)\n    return {'status': 'ok'}", goal: "Crear endpoint no bloqueante para subida de archivos." },
            chroma: { title: "ChromaDB", role: "Arquitecto Datos", desc: "Base de datos vectorial para b√∫squeda sem√°ntica.", code: "client = chromadb.PersistentClient(path='./db')\ncollection.add(embeddings=[vector])", goal: "Configurar cliente persistente y esquema de colecci√≥n." },
            pillow: { title: "Pillow / OpenCV", role: "Ingeniero Datos", desc: "Pre-procesado de imagen: redimensi√≥n y normalizaci√≥n.", code: "img = Image.open(file).resize((224,224))\nimg_array = np.array(img)", goal: "Funci√≥n para limpiar EXIF y normalizar tama√±o para CLIP." },
            clip: { title: "OpenAI CLIP", role: "Ingeniero IA", desc: "Convierte im√°genes y texto en vectores matem√°ticos.", code: "inputs = processor(images=img, return_tensors='pt')\nembeds = model.get_image_features(**inputs)", goal: "Implementar extracci√≥n de embeddings usando HuggingFace Transformers." },
            whisper: { title: "OpenAI Whisper", role: "Ingeniero IA", desc: "Transcribe audio a texto con alta precisi√≥n.", code: "model = whisper.load_model('base')\nresult = model.transcribe('audio.mp3')", goal: "Script para transcribir audio optimizado para CPU." },
            ffmpeg: { title: "FFmpeg", role: "DevOps / Media", desc: "Herramienta de l√≠nea de comandos para manipular A/V.", code: "subprocess.run(['ffmpeg', '-i', input, output])", goal: "Wrapper de Python seguro para comandos FFmpeg." },
            python: { title: "Python 3.11", role: "Backend Dev", desc: "Lenguaje base del ecosistema.", code: "def main():\n    print('Hello minerOS')", goal: "Script base de Python con buenas pr√°cticas." },
            html: { title: "HTML5 Sem√°ntico", role: "Frontend Dev", desc: "Estructura de la interfaz.", code: "<article class='card'>\n  <h2>T√≠tulo</h2>\n</article>", goal: "Template HTML5 base con meta tags." },
            css: { title: "Tailwind CSS", role: "Frontend Dev", desc: "Estilos r√°pidos.", code: "<div class='p-4 bg-slate-900 text-white'>", goal: "Configurar CDN de Tailwind." },
            htmx: { title: "HTMX", role: "Frontend Dev", desc: "L√≥gica de interacci√≥n en HTML.", code: "<button hx-post='/api/action' hx-swap='outerHTML'>", goal: "Bot√≥n interactivo con HTMX." }
        };

        // ============================================
        // FLUJOS T√ÅCTICOS - APP STORE DE ARQUITECTURAS
        // ============================================
        const FLOWS_DATA = {
            // üìÇ Categor√≠a A: CONOCIMIENTO & RAG
            "docmine-classic": {
                title: "DocMine Classic",
                emoji: "üìÑ",
                desc: "Chat con tus PDFs y documentos. RAG simple pero efectivo.",
                category: "knowledge",
                stack: ["fastapi", "python", "chroma", "ollama"],
                complexity: "low",
                cost: "local",
                useCase: "Consultar manuales t√©cnicos, contratos, documentaci√≥n interna.",
                flowDesc: "Documento ‚Üí Chunking ‚Üí Embeddings ‚Üí ChromaDB ‚Üí Query ‚Üí LLM responde",
                prompt: `Act√∫a como Arquitecto RAG. Implementa un pipeline DocMine:
1. FastAPI endpoint para subir PDFs
2. PyMuPDF para extraer texto
3. Chunking con overlap (500 chars, 50 overlap)
4. Sentence-BERT para embeddings
5. ChromaDB para persistencia
6. Ollama (llama3) para respuestas
Entrega c√≥digo modular en services/, routers/.`
            },
            "research-synthesizer": {
                title: "Research Synthesizer",
                emoji: "üî¨",
                desc: "Genera informes a partir de m√∫ltiples fuentes. Deep research.",
                category: "knowledge",
                stack: ["python", "chroma", "claude", "markdown"],
                complexity: "high",
                cost: "api",
                useCase: "Estado del arte de una tecnolog√≠a, comparativas, investigaci√≥n.",
                flowDesc: "Tema ‚Üí Multi-query ChromaDB ‚Üí Reranking ‚Üí Claude sintetiza ‚Üí Markdown",
                prompt: `Act√∫a como Research Engineer. Crea un sintetizador que:
1. Reciba un tema de investigaci√≥n
2. Genere 5 queries diferentes (Multi-Query RAG)
3. Busque en ChromaDB con cada query
4. Reordene por relevancia (cross-encoder)
5. Pase contexto a Claude con prompt estructurado
6. Genere informe Markdown con citas
Output: Informe con secciones, bullet points y fuentes.`
            },
            "voice-to-knowledge": {
                title: "Voice-to-Knowledge",
                emoji: "üé§",
                desc: "Convierte audios en notas estructuradas para Obsidian.",
                category: "knowledge",
                stack: ["whisper", "python", "ollama", "markdown"],
                complexity: "mid",
                cost: "local",
                useCase: "Diario personal hablado, ideas al conducir, reuniones.",
                flowDesc: "Audio ‚Üí Whisper transcribe ‚Üí Ollama limpia/resume ‚Üí Obsidian .md",
                prompt: `Act√∫a como Knowledge Engineer. Pipeline de voz a notas:
1. Watchdog detecta .mp3/.m4a en carpeta inbox/
2. Whisper (base) transcribe a texto raw
3. Ollama (llama3) limpia muletillas y estructura
4. Genera YAML frontmatter (fecha, tags inferidos)
5. Guarda en vault/diario/ con nombre fecha-hora.md
Incluye manejo de errores y logs con Loguru.`
            },
            // üìÇ Categor√≠a B: MEDIA & CREATIVIDAD
            "videomine-search": {
                title: "VideoMine Search",
                emoji: "üé¨",
                desc: "Busca el momento exacto en cualquier video por texto.",
                category: "media",
                stack: ["ffmpeg", "clip", "whisper", "chroma", "fastapi"],
                complexity: "high",
                cost: "local",
                useCase: "Buscar en videos familiares, tutoriales, conferencias grabadas.",
                flowDesc: "Video ‚Üí FFmpeg (frames+audio) ‚Üí CLIP+Whisper ‚Üí ChromaDB ‚Üí API b√∫squeda",
                prompt: `Act√∫a como Media Search Engineer. Sistema VideoMine:
1. FFmpeg extrae frame cada 5 segundos + audio completo
2. CLIP genera embeddings de cada frame
3. Whisper transcribe audio con timestamps
4. ChromaDB indexa ambos (visual + texto)
5. FastAPI endpoint de b√∫squeda multimodal
6. Retorna timestamp exacto + thumbnail
Optimiza para Apple Silicon (MPS).`
            },
            "smart-gallery": {
                title: "Smart Gallery",
                emoji: "üñºÔ∏è",
                desc: "Organiza 10.000 fotos autom√°ticamente sin tocarlas.",
                category: "media",
                stack: ["python", "clip", "sqlite", "html", "watchdog"],
                complexity: "mid",
                cost: "local",
                useCase: "PhotoMine v2, organizar biblioteca familiar, portfolio.",
                flowDesc: "Watchdog detecta ‚Üí CLIP analiza ‚Üí SQLite metadata ‚Üí HTML5 galer√≠a",
                prompt: `Act√∫a como Photo Engineer. Sistema Smart Gallery:
1. Watchdog monitorea carpeta de fotos
2. CLIP genera tags autom√°ticos (top 10 conceptos)
3. SQLite guarda: path, hash, tags, fecha EXIF, GPS
4. HTML5 galer√≠a est√°tica con filtros por tag
5. B√∫squeda sem√°ntica por texto
6. No mueve archivos, solo indexa
Incluye detecci√≥n de duplicados por hash perceptual.`
            },
            "podcast-generator": {
                title: "Podcast Generator",
                emoji: "üéôÔ∏è",
                desc: "Convierte art√≠culos en audio para escuchar.",
                category: "media",
                stack: ["python", "ollama", "ffmpeg"],
                complexity: "mid",
                cost: "local",
                useCase: "Consumir noticias mientras cocinas, art√≠culos largos, newsletters.",
                flowDesc: "URL/Texto ‚Üí Scraper ‚Üí Ollama guioniza ‚Üí TTS local ‚Üí MP3",
                prompt: `Act√∫a como Audio Content Engineer. Pipeline podcast:
1. BeautifulSoup extrae texto limpio de URL
2. Ollama reescribe como gui√≥n de podcast (m√°s conversacional)
3. TTS local (piper/kokoro) genera audio
4. FFmpeg a√±ade intro/outro music
5. Guarda en podcast/ con metadata ID3
6. Genera feed RSS opcional
Target: 10 minutos de lectura ‚Üí 8 min audio.`
            },
            // üìÇ Categor√≠a C: AUTOMATIZACI√ìN & DATOS
            "smart-scraper": {
                title: "Smart Scraper",
                emoji: "üï∑Ô∏è",
                desc: "Extrae datos estructurados de cualquier web con IA.",
                category: "automation",
                stack: ["python", "bs4", "claude", "sqlite", "loguru"],
                complexity: "mid",
                cost: "api",
                useCase: "Comparador de precios, monitor de BOE, tracking de productos.",
                flowDesc: "URL ‚Üí HTTPX fetch ‚Üí Claude extrae JSON ‚Üí Valida ‚Üí SQLite",
                prompt: `Act√∫a como Scraping Engineer. Sistema inteligente:
1. HTTPX con retry y rate limiting
2. BeautifulSoup parsea HTML
3. Claude extrae datos seg√∫n schema Pydantic definido
4. Validaci√≥n estricta antes de guardar
5. SQLite con hist√≥rico (tracking de cambios)
6. Loguru registra cada operaci√≥n
Incluye modo --dry-run y ejemplos de schemas.`
            },
            "sql-oracle": {
                title: "SQL Oracle",
                emoji: "üîÆ",
                desc: "Pregunta a tu base de datos en lenguaje natural.",
                category: "automation",
                stack: ["fastapi", "claude", "pydantic", "sqlite"],
                complexity: "mid",
                cost: "api",
                useCase: "Dashboard de ventas sin saber SQL, reportes ad-hoc.",
                flowDesc: "Pregunta ‚Üí Claude genera SQL ‚Üí Valida ‚Üí Ejecuta ‚Üí Formatea respuesta",
                prompt: `Act√∫a como Data Engineer. Sistema Text-to-SQL:
1. FastAPI recibe pregunta en espa√±ol
2. Inyecta schema de tablas en prompt
3. Claude genera SQL (solo SELECT, no modificaciones)
4. Regex valida que no haya DROP/DELETE/UPDATE
5. Ejecuta query y formatea resultado
6. Cachea queries frecuentes
Incluye ejemplos few-shot en el prompt.`
            },
            "file-organizer": {
                title: "File Organizer",
                emoji: "üìÅ",
                desc: "Limpia la carpeta Descargas autom√°ticamente con IA.",
                category: "automation",
                stack: ["python", "ocr", "ollama", "loguru", "watchdog"],
                complexity: "low",
                cost: "local",
                useCase: "Ordenar facturas, organizar documentos recibidos.",
                flowDesc: "Watchdog detecta ‚Üí OCR si es imagen ‚Üí Ollama clasifica ‚Üí Mueve",
                prompt: `Act√∫a como Automation Engineer. Organizador inteligente:
1. Watchdog monitorea ~/Downloads
2. Por extensi√≥n: PDF/im√°genes ‚Üí OCR extrae texto
3. Ollama clasifica: factura, recibo, documento, imagen, otro
4. Mueve a carpetas: facturas/, recibos/, docs/, fotos/
5. Renombra con patr√≥n: YYYY-MM-DD_tipo_descripcion
6. Log de cada movimiento
Modo --dry-run para probar antes de activar.`
            },
            // üìÇ Categor√≠a D: DEVOPS & CALIDAD
            "code-reviewer": {
                title: "Code Reviewer",
                emoji: "üëÄ",
                desc: "Revisa tu c√≥digo antes de hacer commit.",
                category: "devops",
                stack: ["git", "python", "claude", "loguru"],
                complexity: "low",
                cost: "api",
                useCase: "CI/CD local, pre-commit hook, code quality.",
                flowDesc: "git diff ‚Üí Claude analiza ‚Üí Reporte severidad ‚Üí Aprueba/Rechaza",
                prompt: `Act√∫a como Code Review Bot. Sistema de revisi√≥n:
1. git diff --staged captura cambios
2. Claude analiza buscando:
   - Vulnerabilidades de seguridad
   - Code smells
   - Falta de type hints
   - Complejidad ciclom√°tica
3. Genera reporte con severidad (critical/warning/info)
4. Exit code 1 si hay cr√≠ticos (bloquea commit)
Integrable como pre-commit hook.`
            },
            "privacy-shield": {
                title: "Privacy Shield",
                emoji: "üõ°Ô∏è",
                desc: "Censura datos sensibles en documentos autom√°ticamente.",
                category: "devops",
                stack: ["python", "ocr", "loguru"],
                complexity: "low",
                cost: "local",
                useCase: "Compartir logs sin exponer datos, anonimizar documentos.",
                flowDesc: "Documento ‚Üí OCR si necesario ‚Üí Regex/Spacy detecta ‚Üí Censura ‚Üí Copia limpia",
                prompt: `Act√∫a como Security Engineer. Redactor de PII:
1. Detecta tipo de archivo (texto, PDF, imagen)
2. OCR si es imagen/PDF escaneado
3. Regex detecta: DNI, tel√©fonos, emails, IBANs, IPs
4. Opcional: Spacy NER para nombres propios
5. Genera copia con [REDACTED]
6. Log de cada dato censurado (sin el dato)
100% local, sin APIs externas.`
            },
            "api-gateway": {
                title: "API Gateway",
                emoji: "üö™",
                desc: "Unifica todos tus microservicios locales en un solo punto.",
                category: "devops",
                stack: ["fastapi", "pydantic", "loguru"],
                complexity: "mid",
                cost: "local",
                useCase: "Exponer herramientas minerOS de forma segura, API unificada.",
                flowDesc: "Request ‚Üí Auth ‚Üí Route ‚Üí Proxy al servicio ‚Üí Log ‚Üí Response",
                prompt: `Act√∫a como API Architect. Gateway unificado:
1. FastAPI como punto de entrada √∫nico
2. Rutas: /photos/* ‚Üí PhotoMine, /docs/* ‚Üí DocMine, etc.
3. Middleware de autenticaci√≥n (API key simple)
4. Rate limiting por IP
5. Loguru registra cada request
6. Health checks a cada servicio
7. Swagger unificado en /docs
Incluye docker-compose para orquestar.`
            }
        };

        const FLOW_CATEGORIES = {
            "knowledge": { name: "Conocimiento & RAG", icon: "fa-brain", color: "text-purple-400", bg: "bg-purple-500/10", border: "border-purple-500/30" },
            "media": { name: "Media & Creatividad", icon: "fa-photo-film", color: "text-pink-400", bg: "bg-pink-500/10", border: "border-pink-500/30" },
            "automation": { name: "Automatizaci√≥n", icon: "fa-robot", color: "text-amber-400", bg: "bg-amber-500/10", border: "border-amber-500/30" },
            "devops": { name: "DevOps & Calidad", icon: "fa-shield-halved", color: "text-green-400", bg: "bg-green-500/10", border: "border-green-500/30" }
        };

        const COMPLEXITY_LABELS = {
            "low": { label: "F√°cil", icon: "üü¢", class: "bg-green-500/20 text-green-400 border-green-500/30" },
            "mid": { label: "Media", icon: "üü°", class: "bg-yellow-500/20 text-yellow-400 border-yellow-500/30" },
            "high": { label: "Alta", icon: "üî¥", class: "bg-red-500/20 text-red-400 border-red-500/30" }
        };

        const COST_LABELS = {
            "local": { label: "Local", icon: "üíª", desc: "Ollama/CPU", class: "bg-emerald-500/20 text-emerald-400 border-emerald-500/30" },
            "api": { label: "API", icon: "üí∏", desc: "Claude/OpenAI", class: "bg-orange-500/20 text-orange-400 border-orange-500/30" }
        };

        // ============================================
        // 2. ARQUITECTO PRO (CORE)
        // ============================================
        let canvasNodes = [];
        const toolbox = document.getElementById('architect-toolbox');
        const canvas = document.getElementById('architect-canvas');

        // Init Toolbox
        tools.forEach(t => {
            const el = document.createElement('div');
            const bc = catStyles[t.cat] || "border-slate-700";
            el.className = `draggable-tool bg-slate-800 border-l-4 ${bc} border-y border-r border-slate-700 p-2.5 rounded-r-lg flex items-center justify-between gap-2 hover:bg-slate-700 cursor-grab active:cursor-grabbing mb-1.5 transition`;
            el.draggable = true;
            el.innerHTML = `<div class="flex items-center gap-2"><i class="fa-solid ${t.icon} ${t.color} text-sm"></i><div><span class="text-xs font-bold block">${t.name}</span></div></div><i class="fa-solid fa-plus text-slate-600 text-[10px]"></i>`;
            el.ondragstart = (ev) => { ev.dataTransfer.setData("toolId", t.id); ev.dataTransfer.effectAllowed = "copy"; };
            el.onclick = () => addNodeToCanvas(t.id);
            toolbox.appendChild(el);
        });

        // ============================================
        // PIPELINE BUILDER - SISTEMA DE NODOS v8.0
        // ============================================
        const nodesContainer = document.getElementById('nodes-container');
        const connectionsSvg = document.getElementById('connections-svg');
        const pipelineCanvas = document.getElementById('pipeline-canvas');

        // Configurar drag & drop en el canvas
        if (nodesContainer) {
            nodesContainer.ondragover = (ev) => { ev.preventDefault(); ev.dataTransfer.dropEffect = "copy"; };
            nodesContainer.ondrop = (ev) => {
                ev.preventDefault();
                const toolId = ev.dataTransfer.getData("toolId");
                if(toolId) addNodeToCanvas(toolId);
            };
        }

        function addNodeToCanvas(toolId) {
            const tool = tools.find(t => t.id === toolId);
            if(tool && !canvasNodes.find(n => n.id === toolId)) {
                canvasNodes.push({...tool});
                renderCanvas();
                validateFlowRealtime();
            }
        }

        function removeNode(index) {
            canvasNodes.splice(index, 1);
            renderCanvas();
            validateFlowRealtime();
        }

        function clearCanvas() {
            if (canvasNodes.length === 0) return;
            if (confirm('¬øLimpiar todo el canvas?')) {
                canvasNodes = [];
                renderCanvas();
                addLog("INFO", "Canvas limpiado");
            }
        }

        function renderCanvas() {
            if (!nodesContainer) return;
            const placeholder = document.getElementById('canvas-placeholder');

            if (canvasNodes.length === 0) {
                nodesContainer.innerHTML = `<div id="canvas-placeholder" class="absolute inset-8 border-2 border-dashed border-slate-800 rounded-2xl flex flex-col items-center justify-center text-slate-600">
                    <i class="fa-solid fa-diagram-project text-4xl mb-3 text-slate-700"></i>
                    <p class="text-sm font-medium">Arrastra herramientas aqu√≠</p>
                    <p class="text-xs mt-1 text-slate-700">o selecciona un patr√≥n predefinido</p>
                </div>`;
                connectionsSvg.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/></marker></defs>';
                document.getElementById('node-count').textContent = '0';
                document.getElementById('connection-count').textContent = '0';
                return;
            }

            nodesContainer.innerHTML = '';

            // Calcular posiciones en grid
            const cols = Math.min(3, canvasNodes.length);
            const nodeWidth = 280;
            const nodeHeight = 100;
            const gapX = 80;
            const gapY = 60;

            canvasNodes.forEach((node, index) => {
                const col = index % cols;
                const row = Math.floor(index / cols);
                const x = 40 + col * (nodeWidth + gapX);
                const y = 40 + row * (nodeHeight + gapY);

                const bc = catStyles[node.cat] || "border-slate-600";
                const el = document.createElement('div');
                el.className = "pipeline-node absolute transition-all duration-300";
                el.style.left = `${x}px`;
                el.style.top = `${y}px`;
                el.style.width = `${nodeWidth}px`;
                el.dataset.index = index;

                el.innerHTML = `
                    <div class="bg-slate-800/90 backdrop-blur border border-slate-600 border-l-4 ${bc} p-4 rounded-xl shadow-xl hover:shadow-2xl hover:border-slate-500 transition group">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-slate-900 flex items-center justify-center border border-slate-700">
                                    <i class="fa-solid ${node.icon} ${node.color} text-lg"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-white text-sm leading-tight">${node.name}</h4>
                                    <span class="text-[10px] text-slate-500 uppercase tracking-wider">${node.tag}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                                <span class="text-[10px] text-slate-600 mr-2">#${index + 1}</span>
                                <button onclick="removeNode(${index})" class="text-slate-600 hover:text-red-400 transition p-1.5 hover:bg-red-500/10 rounded">
                                    <i class="fa-solid fa-times text-xs"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Puntos de conexi√≥n -->
                        <div class="connection-point connection-out absolute -right-2 top-1/2 -translate-y-1/2 w-4 h-4 bg-blue-500 rounded-full border-2 border-slate-900 opacity-50 group-hover:opacity-100 transition cursor-crosshair" title="Arrastrar para conectar"></div>
                        <div class="connection-point connection-in absolute -left-2 top-1/2 -translate-y-1/2 w-4 h-4 bg-green-500 rounded-full border-2 border-slate-900 opacity-50 group-hover:opacity-100 transition" title="Entrada"></div>
                    </div>`;
                nodesContainer.appendChild(el);
            });

            // Dibujar conexiones (l√≠nea secuencial)
            drawConnections();
            document.getElementById('node-count').textContent = canvasNodes.length;
            document.getElementById('connection-count').textContent = Math.max(0, canvasNodes.length - 1);
        }

        function drawConnections() {
            if (!connectionsSvg || canvasNodes.length < 2) {
                connectionsSvg.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/></marker></defs>';
                return;
            }

            let paths = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/></marker></defs>';

            const nodes = nodesContainer.querySelectorAll('.pipeline-node');
            for (let i = 0; i < nodes.length - 1; i++) {
                const from = nodes[i];
                const to = nodes[i + 1];

                const fromRect = from.getBoundingClientRect();
                const toRect = to.getBoundingClientRect();
                const canvasRect = pipelineCanvas.getBoundingClientRect();

                const x1 = fromRect.right - canvasRect.left + pipelineCanvas.scrollLeft;
                const y1 = fromRect.top + fromRect.height/2 - canvasRect.top + pipelineCanvas.scrollTop;
                const x2 = toRect.left - canvasRect.left + pipelineCanvas.scrollLeft;
                const y2 = toRect.top + toRect.height/2 - canvasRect.top + pipelineCanvas.scrollTop;

                // Curva bezier
                const midX = (x1 + x2) / 2;
                paths += `<path d="M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}"
                    stroke="#3b82f6" stroke-width="2" fill="none" marker-end="url(#arrowhead)"
                    class="connection-line" style="filter: drop-shadow(0 0 4px rgba(59, 130, 246, 0.3));"/>`;
            }
            connectionsSvg.innerHTML = paths;
        }

        function autoLayoutNodes() {
            if (canvasNodes.length === 0) return;
            renderCanvas();
            setTimeout(drawConnections, 100);
            addLog("SUCCESS", "Nodos reorganizados autom√°ticamente");
        }

        // Validaci√≥n en tiempo real
        function validateFlowRealtime() {
            const panel = document.getElementById('validation-panel');
            const messages = document.getElementById('validation-messages');
            const statusEl = document.getElementById('flow-status');
            if (!panel || !messages) return;

            const ids = canvasNodes.map(n => n.id);
            const errors = [];
            const warnings = [];
            const tips = [];

            // Validaciones
            if (ids.includes('whisper') && !ids.includes('ffmpeg'))
                warnings.push({ icon: 'fa-triangle-exclamation', color: 'yellow', msg: 'Whisper necesita FFmpeg para procesar audio' });
            if (ids.includes('clip') && !ids.includes('pillow'))
                warnings.push({ icon: 'fa-triangle-exclamation', color: 'yellow', msg: 'CLIP necesita Pillow para pre-procesar im√°genes' });
            if (ids.length > 0 && !ids.some(id => ['chroma', 'sqlite'].includes(id)))
                tips.push({ icon: 'fa-lightbulb', color: 'blue', msg: 'Considera a√±adir persistencia (ChromaDB o SQLite)' });
            if (ids.includes('fastapi') && !ids.includes('pydantic'))
                tips.push({ icon: 'fa-lightbulb', color: 'blue', msg: 'FastAPI funciona mejor con Pydantic para validaci√≥n' });
            if (ids.length > 5)
                tips.push({ icon: 'fa-info-circle', color: 'slate', msg: `Pipeline complejo: ${ids.length} componentes` });

            const allMessages = [...errors, ...warnings, ...tips];

            if (allMessages.length > 0) {
                messages.innerHTML = allMessages.map(m => `
                    <div class="flex items-start gap-2 p-2 bg-${m.color}-500/10 border border-${m.color}-500/30 rounded-lg">
                        <i class="fa-solid ${m.icon} text-${m.color}-400 text-xs mt-0.5"></i>
                        <span class="text-xs text-slate-300">${m.msg}</span>
                    </div>
                `).join('');
                panel.classList.remove('hidden');

                statusEl.innerHTML = errors.length > 0
                    ? '<span class="px-3 py-1 rounded-full text-xs font-medium bg-red-500/20 text-red-400 border border-red-500/30"><i class="fa-solid fa-times-circle mr-1"></i> Errores</span>'
                    : warnings.length > 0
                    ? '<span class="px-3 py-1 rounded-full text-xs font-medium bg-yellow-500/20 text-yellow-400 border border-yellow-500/30"><i class="fa-solid fa-exclamation-circle mr-1"></i> Avisos</span>'
                    : '<span class="px-3 py-1 rounded-full text-xs font-medium bg-green-500/20 text-green-400 border border-green-500/30"><i class="fa-solid fa-check-circle mr-1"></i> OK</span>';
                statusEl.classList.remove('hidden');
            } else if (ids.length > 0) {
                messages.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-check-circle text-green-400 text-2xl mb-2"></i><p class="text-xs text-slate-400">Pipeline v√°lido</p></div>';
                panel.classList.remove('hidden');
                statusEl.innerHTML = '<span class="px-3 py-1 rounded-full text-xs font-medium bg-green-500/20 text-green-400 border border-green-500/30"><i class="fa-solid fa-check-circle mr-1"></i> V√°lido</span>';
                statusEl.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
                statusEl.classList.add('hidden');
            }
        }

        // Redibujar conexiones al hacer scroll
        if (pipelineCanvas) {
            pipelineCanvas.addEventListener('scroll', () => setTimeout(drawConnections, 10));
            window.addEventListener('resize', () => setTimeout(drawConnections, 100));
        }

        // --- SCAFFOLD / CREAR PROYECTO ---
        function generateScaffold() {
            if (canvasNodes.length === 0) return alert("A√±ade herramientas al canvas primero");

            // Generar nombre sugerido
            const mainTool = canvasNodes[0]?.name.toLowerCase().replace(/\s+/g, '_') || 'proyecto';
            document.getElementById('project-name').value = `${mainTool}_pipeline`;

            // Generar preview de estructura
            updateScaffoldPreview();
            document.getElementById('scaffold-modal').classList.remove('hidden');
        }

        function updateScaffoldPreview() {
            const name = document.getElementById('project-name').value || 'mi_proyecto';
            const hasApi = canvasNodes.some(n => n.id === 'fastapi');
            const hasDb = canvasNodes.some(n => ['sqlite', 'chroma'].includes(n.id));
            const hasAi = canvasNodes.some(n => ['clip', 'whisper', 'ollama', 'claude'].includes(n.id));

            let structure = `${name}/
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ .gitignore`;

            if (hasApi) structure += `
‚îú‚îÄ‚îÄ routers/
‚îÇ   ‚îî‚îÄ‚îÄ api.py`;

            structure += `
‚îú‚îÄ‚îÄ services/`;

            canvasNodes.forEach(n => {
                if (!['fastapi', 'python', 'html', 'css'].includes(n.id)) {
                    structure += `
‚îÇ   ‚îî‚îÄ‚îÄ ${n.id}_service.py`;
                }
            });

            if (hasDb) structure += `
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îî‚îÄ‚îÄ connection.py`;

            if (hasAi) structure += `
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ schemas.py`;

            structure += `
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ logger.py
‚îî‚îÄ‚îÄ tests/
    ‚îî‚îÄ‚îÄ test_main.py`;

            document.getElementById('scaffold-preview').textContent = structure;
        }

        // Escuchar cambios en el nombre
        document.getElementById('project-name')?.addEventListener('input', updateScaffoldPreview);

        function copyScaffoldCommand() {
            const name = document.getElementById('project-name').value || 'mi_proyecto';
            const path = document.getElementById('project-path').value || '~/Desktop';
            const withGit = document.getElementById('opt-git').checked;
            const withVenv = document.getElementById('opt-venv').checked;

            let cmd = `cd ${path} && mkdir -p ${name}/{routers,services,db,models,utils,tests} && cd ${name}`;
            cmd += ` && touch main.py requirements.txt .env.example .gitignore`;
            if (withVenv) cmd += ` && python3 -m venv venv`;
            if (withGit) cmd += ` && git init`;
            cmd += ` && echo "Proyecto creado!"`;

            navigator.clipboard.writeText(cmd);
            addLog("SUCCESS", "Comando copiado al portapapeles");
            closeModal('scaffold-modal');
        }

        function downloadScaffoldScript() {
            const name = document.getElementById('project-name').value || 'mi_proyecto';
            const path = document.getElementById('project-path').value || '~/Desktop';
            const withGit = document.getElementById('opt-git').checked;
            const withVenv = document.getElementById('opt-venv').checked;
            const withReadme = document.getElementById('opt-readme').checked;

            // Generar requirements.txt basado en el stack
            const deps = [];
            canvasNodes.forEach(n => {
                if (n.id === 'fastapi') deps.push('fastapi', 'uvicorn[standard]');
                if (n.id === 'chroma') deps.push('chromadb');
                if (n.id === 'sqlite') deps.push('aiosqlite');
                if (n.id === 'clip') deps.push('transformers', 'torch', 'pillow');
                if (n.id === 'whisper') deps.push('openai-whisper');
                if (n.id === 'ollama') deps.push('ollama');
                if (n.id === 'pydantic') deps.push('pydantic');
                if (n.id === 'loguru') deps.push('loguru');
                if (n.id === 'httpx') deps.push('httpx');
                if (n.id === 'bs4') deps.push('beautifulsoup4', 'lxml');
            });

            let script = `#!/bin/bash
# DirectOS Pipeline Scaffold - ${name}
# Generado autom√°ticamente

set -e

PROJECT_NAME="${name}"
BASE_PATH="${path}"

echo "üöÄ Creando proyecto $PROJECT_NAME..."

cd "$BASE_PATH"
mkdir -p "$PROJECT_NAME"/{routers,services,db,models,utils,tests}
cd "$PROJECT_NAME"

# Archivos base
touch main.py .env.example

# requirements.txt
cat > requirements.txt << 'EOF'
${[...new Set(deps)].join('\n')}
python-dotenv
EOF

# .gitignore
cat > .gitignore << 'EOF'
venv/
__pycache__/
*.pyc
.env
*.db
.DS_Store
EOF

# main.py base
cat > main.py << 'EOF'
"""
${name} - Pipeline generado con DirectOS
Stack: ${canvasNodes.map(n => n.name).join(' ‚Üí ')}
"""
from loguru import logger

def main():
    logger.info("Pipeline iniciado")
    # TODO: Implementar l√≥gica

if __name__ == "__main__":
    main()
EOF
`;

            if (withReadme) {
                script += `
# README.md
cat > README.md << 'EOF'
# ${name}

Pipeline generado con DirectOS v8.0

## Stack
${canvasNodes.map(n => `- **${n.name}**: ${n.tag}`).join('\n')}

## Instalaci√≥n
\`\`\`bash
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
\`\`\`

## Uso
\`\`\`bash
python main.py
\`\`\`
EOF
`;
            }

            if (withVenv) script += `\n# Crear entorno virtual\npython3 -m venv venv\necho "‚úÖ venv creado"`;
            if (withGit) script += `\n# Inicializar git\ngit init\ngit add .\ngit commit -m "Initial commit - ${name} scaffold"\necho "‚úÖ Git inicializado"`;

            script += `\n\necho ""\necho "‚úÖ Proyecto $PROJECT_NAME creado en $BASE_PATH"\necho "üìÅ cd $BASE_PATH/$PROJECT_NAME"\necho "üêç source venv/bin/activate && pip install -r requirements.txt"`;

            // Descargar como archivo .sh
            const blob = new Blob([script], { type: 'text/x-shellscript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `create_${name}.sh`;
            a.click();
            URL.revokeObjectURL(url);

            addLog("SUCCESS", `Script create_${name}.sh descargado`);
            closeModal('scaffold-modal');
        }

        // --- PRESETS ---
        function initPresets() {
            const selector = document.getElementById('preset-selector');
            presets.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.name;
                selector.appendChild(opt);
            });
        }

        function loadPreset(presetId) {
            if (!presetId) {
                document.getElementById('preset-info').classList.add('hidden');
                return;
            }

            const preset = presets.find(p => p.id === presetId);
            if (!preset) return;

            // Mostrar info del preset
            document.getElementById('preset-info').classList.remove('hidden');
            document.getElementById('preset-desc').textContent = preset.desc;
            document.getElementById('preset-flow').textContent = preset.flow;
            document.getElementById('preset-usecase').textContent = `Casos: ${preset.useCase}`;

            // Limpiar canvas y cargar herramientas del preset
            canvasNodes = [];
            preset.tools.forEach(toolId => {
                const tool = tools.find(t => t.id === toolId);
                if (tool) canvasNodes.push(tool);
            });
            renderCanvas();
        }

        // --- CORE UI ---
        function compileArchitecture() {
            if(canvasNodes.length===0) return alert("A√±ade herramientas al canvas primero");

            // Generar c√≥digo Python real basado en el stack
            const ids = canvasNodes.map(n => n.id);
            const stack = [...new Set(canvasNodes.map(n => n.name))].join(", ");

            let imports = `"""
Pipeline generado con DirectOS v8.0
Stack: ${stack}
"""
import os
from pathlib import Path
from dotenv import load_dotenv
`;
            let code = '';

            // A√±adir imports seg√∫n el stack
            if (ids.includes('loguru')) imports += `from loguru import logger\n`;
            if (ids.includes('fastapi')) imports += `from fastapi import FastAPI, HTTPException, Depends\nfrom fastapi.middleware.cors import CORSMiddleware\n`;
            if (ids.includes('pydantic')) imports += `from pydantic import BaseModel, Field\n`;
            if (ids.includes('chroma')) imports += `import chromadb\nfrom chromadb.config import Settings\n`;
            if (ids.includes('sqlite')) imports += `import sqlite3\nfrom contextlib import contextmanager\n`;
            if (ids.includes('httpx')) imports += `import httpx\n`;
            if (ids.includes('clip')) imports += `from transformers import CLIPProcessor, CLIPModel\nfrom PIL import Image\nimport torch\n`;
            if (ids.includes('whisper')) imports += `import whisper\n`;
            if (ids.includes('ollama')) imports += `import ollama\n`;

            imports += `\nload_dotenv()\n\n`;

            // Generar c√≥digo seg√∫n componentes
            if (ids.includes('fastapi')) {
                code += `# ============================================
# FastAPI App
# ============================================
app = FastAPI(
    title="Pipeline API",
    description="Generado con DirectOS",
    version="1.0.0"
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

`;
            }

            if (ids.includes('chroma')) {
                code += `# ============================================
# ChromaDB Client
# ============================================
def get_chroma_client():
    return chromadb.PersistentClient(path="./db/chroma")

def get_collection(name: str = "default"):
    client = get_chroma_client()
    return client.get_or_create_collection(name)

`;
            }

            if (ids.includes('sqlite')) {
                code += `# ============================================
# SQLite Connection
# ============================================
DB_PATH = Path("./db/data.db")

@contextmanager
def get_db():
    DB_PATH.parent.mkdir(exist_ok=True)
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    try:
        yield conn
    finally:
        conn.close()

`;
            }

            if (ids.includes('clip')) {
                code += `# ============================================
# CLIP Model
# ============================================
DEVICE = "mps" if torch.backends.mps.is_available() else "cpu"
clip_model = CLIPModel.from_pretrained("openai/clip-vit-base-patch32").to(DEVICE)
clip_processor = CLIPProcessor.from_pretrained("openai/clip-vit-base-patch32")

def get_image_embedding(image_path: str):
    image = Image.open(image_path).convert("RGB")
    inputs = clip_processor(images=image, return_tensors="pt").to(DEVICE)
    with torch.no_grad():
        embedding = clip_model.get_image_features(**inputs)
    return embedding.cpu().numpy().flatten().tolist()

`;
            }

            if (ids.includes('whisper')) {
                code += `# ============================================
# Whisper Model
# ============================================
whisper_model = whisper.load_model("base")

def transcribe_audio(audio_path: str) -> str:
    result = whisper_model.transcribe(audio_path)
    return result["text"]

`;
            }

            if (ids.includes('ollama')) {
                code += `# ============================================
# Ollama LLM
# ============================================
def query_llm(prompt: str, model: str = "llama3") -> str:
    response = ollama.chat(model=model, messages=[
        {"role": "user", "content": prompt}
    ])
    return response["message"]["content"]

`;
            }

            // A√±adir endpoints si hay FastAPI
            if (ids.includes('fastapi')) {
                code += `# ============================================
# API Endpoints
# ============================================
@app.get("/health")
async def health_check():
    return {"status": "ok", "stack": "${stack}"}

@app.get("/")
async def root():
    return {"message": "Pipeline API - DirectOS v8.0"}

`;
                if (ids.includes('chroma')) {
                    code += `@app.post("/search")
async def semantic_search(query: str, limit: int = 5):
    collection = get_collection()
    results = collection.query(query_texts=[query], n_results=limit)
    return {"results": results}

`;
                }
            }

            // Main
            code += `# ============================================
# Main
# ============================================
if __name__ == "__main__":
`;
            if (ids.includes('fastapi')) {
                code += `    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
`;
            } else {
                code += `    ${ids.includes('loguru') ? 'logger.info("Pipeline iniciado")' : 'print("Pipeline iniciado")'}
    # TODO: Implementar l√≥gica del pipeline
    pass
`;
            }

            const fullCode = imports + code;
            document.getElementById('architect-prompt-output').textContent = fullCode;
            document.getElementById('architect-output-modal').classList.remove('hidden');
            addLog("SUCCESS", "C√≥digo Python generado");
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function copyArchitectPrompt() { navigator.clipboard.writeText(document.getElementById('architect-prompt-output').textContent); }

        function switchView(view) {
            ['architect', 'generator', 'grid', 'flow', 'monitor'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                const b = document.getElementById(`btn-${v}`);
                if(b) { b.classList.replace('bg-blue-600', 'text-slate-400'); b.classList.replace('text-white', 'hover:bg-slate-800'); b.classList.remove('shadow-lg'); }
            });
            document.getElementById(`view-${view}`).classList.remove('hidden');
            const btn = document.getElementById(`btn-${view}`);
            if(btn) { btn.classList.replace('text-slate-400', 'bg-blue-600'); btn.classList.replace('hover:bg-slate-800', 'text-white'); btn.classList.add('shadow-lg'); }
            
            const headerTools = document.getElementById('header-tools');
            if(view === 'architect') headerTools.classList.remove('hidden'); else headerTools.classList.add('hidden');
            
            document.getElementById('page-title').textContent = { 'architect': 'Pipeline Builder', 'generator': 'Generador', 'grid': 'Glosario', 'flow': 'Recetas', 'monitor': 'Monitor' }[view];
        }

        // Monitor & Generator
        let isOnline = false; const term = document.getElementById('terminal-window');
        function addLog(t,m){const time=new Date().toLocaleTimeString('es-ES',{hour12:false});let c="text-slate-300";if(t==="SUCCESS")c="text-green-400";if(t==="ERROR")c="text-red-400";term.innerHTML+=`<div class="terminal-line"><span class="text-slate-600">[${time}]</span> <span class="${c} font-bold w-16 inline-block">${t}</span> ${m}</div>`;term.scrollTop=term.scrollHeight;}
        setTimeout(()=>{addLog("INFO","Conectado a DirectOS v8.0 - Pipeline Builder")},1000);
        
        // ============================================
        // GLOSARIO - FILTROS, B√öSQUEDA Y PERSISTENCIA
        // ============================================

        // Cargar estados desde localStorage
        function loadToolStates() {
            const saved = localStorage.getItem('directos_tool_states');
            if (saved) {
                const states = JSON.parse(saved);
                tools.forEach(t => {
                    if (states[t.id]) t.status = states[t.id];
                });
            }
        }

        // Guardar estados en localStorage
        function saveToolStates() {
            const states = {};
            tools.forEach(t => states[t.id] = t.status);
            localStorage.setItem('directos_tool_states', JSON.stringify(states));
        }

        // Cambiar estado de herramienta
        function changeToolStatus(toolId, newStatus) {
            const tool = tools.find(t => t.id === toolId);
            if (tool) {
                tool.status = newStatus;
                saveToolStates();
                renderToolsGrid();
                updateProgress();
                // Actualizar modal si est√° abierto
                if (currentTool && currentTool.id === toolId) {
                    currentTool.status = newStatus;
                    const statusEl = document.getElementById('tool-modal-status');
                    statusEl.textContent = statusLabels[newStatus];
                    statusEl.className = `status-badge status-${newStatus}`;
                }
                addLog("SUCCESS", `"${tool.name}" marcada como ${statusLabels[newStatus]}`);
            }
        }

        // Filtrar herramientas
        function filterTools() {
            renderToolsGrid();
        }

        // Filtro r√°pido por estado
        function setStatusFilter(status) {
            document.getElementById('filter-status').value = status;
            // Actualizar botones activos
            document.querySelectorAll('.status-filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-500');
                btn.classList.add('bg-slate-800', 'text-slate-300', 'border-slate-700');
            });
            const activeBtn = document.querySelector(`.status-filter-btn[data-status="${status}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-slate-800', 'text-slate-300', 'border-slate-700');
                activeBtn.classList.add('bg-blue-600', 'text-white', 'border-blue-500');
            }
            filterTools();
        }

        // Renderizar grid con filtros
        function renderToolsGrid() {
            const grid = document.getElementById('tools-grid');
            const noResults = document.getElementById('no-results');
            if (!grid) return;

            const searchTerm = (document.getElementById('tools-search')?.value || '').toLowerCase();
            const categoryFilter = document.getElementById('filter-category')?.value || 'all';
            const statusFilter = document.getElementById('filter-status')?.value || 'all';

            grid.innerHTML = '';

            const filteredTools = getTools().filter(t => {
                const matchSearch = t.name.toLowerCase().includes(searchTerm) ||
                                   t.desc.toLowerCase().includes(searchTerm) ||
                                   t.tag.toLowerCase().includes(searchTerm);
                const matchCategory = categoryFilter === 'all' || t.cat === categoryFilter;
                const matchStatus = statusFilter === 'all' || t.status === statusFilter;
                return matchSearch && matchCategory && matchStatus;
            });

            if (filteredTools.length === 0) {
                noResults?.classList.remove('hidden');
            } else {
                noResults?.classList.add('hidden');
            }

            filteredTools.forEach(t => {
                const card = document.createElement('div');
                card.className = `bg-slate-900 border border-slate-800 border-l-4 ${catStyles[t.cat]} p-5 rounded-xl flex flex-col justify-between hover:border-slate-600 transition card-hover cursor-pointer`;
                card.onclick = () => openToolModal(t.id);
                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-3">
                            <i class="fa-solid ${t.icon} ${t.color} text-xl"></i>
                            <span class="status-badge status-${t.status}">${statusLabels[t.status]}</span>
                        </div>
                        <h3 class="text-lg font-bold text-white mb-1">${t.name}</h3>
                        <span class="text-[10px] bg-slate-950 px-2 py-0.5 rounded text-slate-500 uppercase tracking-wider">${t.tag}</span>
                        <p class="text-sm text-slate-400 mt-3 leading-relaxed">${t.desc}</p>
                    </div>
                    <div class="mt-4 pt-3 border-t border-slate-800 flex flex-wrap gap-1">
                        ${t.cases.slice(0, 2).map(c => `<span class="text-[10px] bg-slate-800 text-slate-400 px-2 py-1 rounded">${c}</span>`).join('')}
                        ${t.cases.length > 2 ? `<span class="text-[10px] text-slate-600">+${t.cases.length - 2}</span>` : ''}
                    </div>`;
                grid.appendChild(card);
            });

            updateCounts();
        }

        // Actualizar contadores
        function updateCounts() {
            const counts = { all: getTools().length, used: 0, learning: 0, new: 0 };
            getTools().forEach(t => counts[t.status]++);

            document.getElementById('count-all').textContent = counts.all;
            document.getElementById('count-used').textContent = counts.used;
            document.getElementById('count-learning').textContent = counts.learning;
            document.getElementById('count-new').textContent = counts.new;
        }

        // Actualizar progreso
        function updateProgress() {
            const total = tools.length;
            const dominated = tools.filter(t => t.status === 'used').length;
            const percent = Math.round((dominated / total) * 100);

            document.getElementById('progress-count').textContent = dominated;
            document.getElementById('progress-total').textContent = total;
            document.getElementById('progress-percent').textContent = `${percent}%`;

            // Actualizar c√≠rculo SVG (circunferencia = 2 * PI * 24 = 150.8)
            const circle = document.getElementById('progress-circle');
            if (circle) {
                const offset = 150.8 - (150.8 * percent / 100);
                circle.style.strokeDashoffset = offset;
            }
        }

        // Inicializar Glosario (async para cargar desde API)
        async function initGlosario() {
            // Primero cargar tools desde API (o fallback)
            await loadToolsFromAPI();

            // Luego renderizar
            loadToolStates();
            renderToolsGrid();
            updateProgress();
            setStatusFilter('all');
        }

        // Render inicial (se llamar√° desde init)
        initGlosario();

        // Render Stack Selector
        const stackContainer = document.getElementById('stack-selector');
        const categories = {}; getTools().forEach(t => { if(!categories[t.cat]) categories[t.cat] = []; categories[t.cat].push(t); });
        for (const [cat, items] of Object.entries(categories)) {
            const g = document.createElement('div'); g.className="mb-4"; g.innerHTML=`<h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 sticky top-0 bg-slate-900 py-1">${cat}</h4>`;
            items.forEach(t=>{ const l=document.createElement('label'); l.className="flex items-center gap-3 p-2 rounded-lg cursor-pointer hover:bg-slate-800/50 transition group"; l.innerHTML=`<input type="checkbox" value="${t.name}" class="peer sr-only tool-checkbox"><div class="w-4 h-4 rounded border border-slate-600 bg-slate-900 peer-checked:bg-blue-500 flex items-center justify-center"><i class="fa-solid fa-check text-[10px] text-white opacity-0 check-icon"></i></div><span class="text-sm text-slate-300 peer-checked:text-white">${t.name}</span>`; g.appendChild(l); });
            stackContainer.appendChild(g);
        }

        // INTERACTIVIDAD COMPLETA
        function openNodeDetails(nodeId) {
            const data = nodeDetails[nodeId];
            if(!data) return;
            const modal = document.getElementById('node-modal');
            modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('translate-x-full'), 10);
            
            document.getElementById('modal-content').innerHTML = `
                <div class="mb-6"><span class="text-xs font-mono text-blue-400 border border-blue-500/30 px-2 py-1 rounded bg-blue-500/10 mb-2 inline-block">INSPECTOR</span><h2 class="text-2xl font-bold text-white">${data.title}</h2><p class="text-slate-400 mt-2 text-sm leading-relaxed">${data.desc}</p></div>
                <div class="mb-6"><h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">C√≥digo T√°ctico</h3><div class="bg-slate-950 border border-slate-800 rounded-lg p-3 font-mono text-xs text-green-400 overflow-x-auto"><pre>${data.code}</pre></div></div>
                <div class="mt-8 pt-6 border-t border-slate-800"><h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Generar Prompt para...</h3><div class="grid grid-cols-1 gap-2">
                     <button onclick="jumpToGenerator('${nodeId}', 'scaffold')" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 p-2 rounded-lg text-xs font-bold border border-slate-700 flex items-center gap-2">üèóÔ∏è Scaffold</button>
                     <button onclick="jumpToGenerator('${nodeId}', 'explain')" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 p-2 rounded-lg text-xs font-bold border border-slate-700 flex items-center gap-2">üìñ Explicar</button>
                     <button onclick="jumpToGenerator('${nodeId}', 'optimize')" class="w-full bg-slate-800 hover:bg-blue-600 hover:text-white text-slate-300 p-2 rounded-lg text-xs font-bold border border-slate-700">üöÄ Optimizar</button>
                </div></div>`;
        }
        function closeNodeDetails() { const m = document.getElementById('node-modal'); m.classList.add('translate-x-full'); setTimeout(() => m.classList.add('hidden'), 300); }
        
        function jumpToGenerator(nodeId, mode) {
            const data = nodeDetails[nodeId]; closeNodeDetails(); switchView('generator');
            document.getElementById('prompt-role').value = data.role;
            let g = data.goal;
            if (mode === 'scaffold') g = `Generar el c√≥digo base (scaffold) para implementar ${data.title}.`;
            if (mode === 'explain') g = `Explicar l√≠nea por l√≠nea c√≥mo funciona ${data.title}.`;
            if (mode === 'optimize') g = `Analizar y optimizar el c√≥digo de ${data.title}.`;
            document.getElementById('prompt-goal').value = g;
        }

        // Helpers
        function setGoal(t) { document.getElementById('prompt-goal').value = t; }
        function clearSelection() { document.querySelectorAll('.tool-checkbox').forEach(c => c.checked = false); }
        function copyToClipboard() { navigator.clipboard.writeText(document.getElementById('prompt-output').textContent); }
        function generatePrompt() {
            const r = document.getElementById('prompt-role').value; const g = document.getElementById('prompt-goal').value || "[Objetivo]"; const s = Array.from(document.querySelectorAll('.tool-checkbox:checked')).map(cb => cb.value).join(", ") || "stack";
            document.getElementById('prompt-output').textContent = `**ROL:** ${r}\n**STACK:** ${s}\n**OBJETIVO:** ${g}\n**ESTILO:** Local-first.`;
        }
        function loadProjectPreset() { const v=document.getElementById('project-select').value; canvasNodes=[]; if(v==='videomine')['fastapi','ffmpeg','whisper','clip','chroma'].forEach(id=>addNodeToCanvas(id)); else if(v==='docmine')['fastapi','python','clip','chroma','sqlite'].forEach(id=>addNodeToCanvas(id)); renderCanvas(); }

        setInterval(() => { document.getElementById('clock').textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }, 1000);

        // ============================================
        // FLUJOS T√ÅCTICOS - FUNCIONES
        // ============================================
        let currentFlow = null;
        let currentFlowFilter = 'all';

        function initFlowsGallery() {
            renderFlowsGrid('all');
        }

        function renderFlowsGrid(filter) {
            currentFlowFilter = filter;
            const grid = document.getElementById('flows-grid');
            if (!grid) return;

            grid.innerHTML = '';

            // Filtrar flujos
            const flowEntries = Object.entries(FLOWS_DATA).filter(([key, flow]) => {
                return filter === 'all' || flow.category === filter;
            });

            // Renderizar tarjetas
            flowEntries.forEach(([flowId, flow]) => {
                const cat = FLOW_CATEGORIES[flow.category];
                const complexity = COMPLEXITY_LABELS[flow.complexity];
                const cost = COST_LABELS[flow.cost];

                const card = document.createElement('div');
                card.className = `flow-card bg-slate-900 border border-slate-800 rounded-xl overflow-hidden hover:border-slate-600 transition-all duration-300 cursor-pointer group hover:shadow-xl hover:shadow-blue-500/5 hover:-translate-y-1`;
                card.setAttribute('data-category', flow.category);
                card.onclick = () => openFlowModal(flowId);

                card.innerHTML = `
                    <!-- Header con emoji y badges -->
                    <div class="p-4 border-b border-slate-800 ${cat.bg}">
                        <div class="flex items-start justify-between">
                            <span class="text-3xl">${flow.emoji}</span>
                            <div class="flex flex-col gap-1 items-end">
                                <span class="text-[10px] px-2 py-0.5 rounded border ${complexity.class}">${complexity.icon} ${complexity.label}</span>
                                <span class="text-[10px] px-2 py-0.5 rounded border ${cost.class}">${cost.icon} ${cost.label}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Body -->
                    <div class="p-4">
                        <h3 class="text-lg font-bold text-white mb-2 group-hover:text-blue-400 transition">${flow.title}</h3>
                        <p class="text-sm text-slate-400 mb-4 line-clamp-2">${flow.desc}</p>

                        <!-- Stack visual -->
                        <div class="flex flex-wrap gap-1 mb-4">
                            ${flow.stack.slice(0, 4).map(toolId => {
                                const tool = tools.find(t => t.id === toolId);
                                if (!tool) return '';
                                return `<span class="inline-flex items-center gap-1 bg-slate-800 border border-slate-700 px-1.5 py-0.5 rounded text-[10px]">
                                    <i class="fa-solid ${tool.icon} ${tool.color}"></i>
                                </span>`;
                            }).join('')}
                            ${flow.stack.length > 4 ? `<span class="text-[10px] text-slate-500 px-1">+${flow.stack.length - 4}</span>` : ''}
                        </div>

                        <!-- Categor√≠a -->
                        <div class="flex items-center gap-2">
                            <i class="fa-solid ${cat.icon} ${cat.color} text-xs"></i>
                            <span class="text-[10px] text-slate-500 uppercase tracking-wider">${cat.name}</span>
                        </div>
                    </div>

                    <!-- Footer con acci√≥n r√°pida -->
                    <div class="px-4 pb-4">
                        <button onclick="event.stopPropagation(); quickCloneFlow('${flowId}')" class="w-full bg-slate-800 hover:bg-blue-600 text-slate-300 hover:text-white text-xs py-2 rounded-lg font-medium transition flex items-center justify-center gap-2 border border-slate-700 hover:border-blue-500">
                            <i class="fa-solid fa-clone"></i> Clonar al Arquitecto
                        </button>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function filterFlows(category) {
            // Actualizar botones
            document.querySelectorAll('.flow-filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-slate-800', 'text-slate-300', 'border', 'border-slate-700');
            });

            const activeBtn = document.getElementById(`flow-filter-${category}`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-slate-800', 'text-slate-300', 'border', 'border-slate-700');
                activeBtn.classList.add('bg-blue-600', 'text-white');
            }

            renderFlowsGrid(category);
        }

        function openFlowModal(flowId) {
            const flow = FLOWS_DATA[flowId];
            if (!flow) return;

            currentFlow = { id: flowId, ...flow };

            const cat = FLOW_CATEGORIES[flow.category];
            const complexity = COMPLEXITY_LABELS[flow.complexity];
            const cost = COST_LABELS[flow.cost];

            // Rellenar datos
            document.getElementById('flow-modal-emoji').textContent = flow.emoji;
            document.getElementById('flow-modal-title').textContent = flow.title;
            document.getElementById('flow-modal-desc').textContent = flow.desc;
            document.getElementById('flow-modal-usecase').textContent = flow.useCase;
            document.getElementById('flow-modal-flowdesc').textContent = flow.flowDesc;
            document.getElementById('flow-modal-prompt').textContent = flow.prompt;

            // Badges
            const catEl = document.getElementById('flow-modal-category');
            catEl.textContent = cat.name;
            catEl.className = `text-xs px-2 py-0.5 rounded border ${cat.bg} ${cat.border} ${cat.color}`;

            const complexEl = document.getElementById('flow-modal-complexity');
            complexEl.textContent = `${complexity.icon} ${complexity.label}`;
            complexEl.className = `text-xs px-2 py-0.5 rounded border ${complexity.class}`;

            const costEl = document.getElementById('flow-modal-cost');
            costEl.textContent = `${cost.icon} ${cost.label}`;
            costEl.className = `text-xs px-2 py-0.5 rounded border ${cost.class}`;

            // Stack visual
            const stackContainer = document.getElementById('flow-modal-stack');
            stackContainer.innerHTML = flow.stack.map(toolId => {
                const tool = tools.find(t => t.id === toolId);
                if (!tool) return '';
                return `<span class="inline-flex items-center gap-1.5 bg-slate-800 border border-slate-700 px-2 py-1 rounded text-xs">
                    <i class="fa-solid ${tool.icon} ${tool.color}"></i>
                    <span class="text-slate-300">${tool.name}</span>
                </span>`;
            }).join('<span class="text-slate-600 mx-1">‚Üí</span>');

            document.getElementById('flow-detail-modal').classList.remove('hidden');
        }

        function cloneFlowToArchitect() {
            if (!currentFlow) return;

            // Limpiar canvas y cargar herramientas del flujo
            canvasNodes = [];
            currentFlow.stack.forEach(toolId => {
                const tool = tools.find(t => t.id === toolId);
                if (tool) canvasNodes.push(tool);
            });
            renderCanvas();

            closeModal('flow-detail-modal');
            switchView('architect');

            // Notificaci√≥n
            addLog("SUCCESS", `Flujo "${currentFlow.title}" clonado al Arquitecto`);
        }

        function quickCloneFlow(flowId) {
            const flow = FLOWS_DATA[flowId];
            if (!flow) return;

            // Limpiar canvas y cargar herramientas
            canvasNodes = [];
            flow.stack.forEach(toolId => {
                const tool = tools.find(t => t.id === toolId);
                if (tool) canvasNodes.push(tool);
            });
            renderCanvas();

            switchView('architect');
            addLog("SUCCESS", `Flujo "${flow.title}" clonado al Arquitecto`);
        }

        function copyFlowPrompt() {
            if (!currentFlow) return;
            navigator.clipboard.writeText(currentFlow.prompt);
            addLog("SUCCESS", `Prompt de "${currentFlow.title}" copiado al portapapeles`);
        }

        // ============================================
        // BIBLIOTECA DE PATRONES - FUNCIONES
        // ============================================
        let currentPattern = null;

        function initPatternsAccordion() {
            const container = document.getElementById('patterns-accordion');
            if (!container) return;

            container.innerHTML = '';

            for (const [catId, category] of Object.entries(promptPatterns)) {
                const catDiv = document.createElement('div');
                catDiv.className = 'border border-slate-800 rounded-lg overflow-hidden';

                // Header del acorde√≥n
                const header = document.createElement('button');
                header.className = 'w-full flex items-center justify-between p-3 bg-slate-950 hover:bg-slate-800 transition text-left';
                header.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fa-solid ${category.icon} text-slate-500 text-xs"></i>
                        <span class="text-sm font-medium text-slate-300">${category.name}</span>
                        <span class="text-[10px] bg-slate-800 text-slate-500 px-1.5 py-0.5 rounded">${category.patterns.length}</span>
                    </div>
                    <i class="fa-solid fa-chevron-down text-slate-600 text-xs transition-transform accordion-icon"></i>
                `;

                // Contenido del acorde√≥n
                const content = document.createElement('div');
                content.className = 'hidden bg-slate-900/50 border-t border-slate-800';

                category.patterns.forEach(pattern => {
                    const patternBtn = document.createElement('button');
                    patternBtn.className = 'w-full text-left p-2.5 hover:bg-slate-800 transition flex items-center gap-2 border-b border-slate-800/50 last:border-0';
                    patternBtn.innerHTML = `
                        <span class="text-base">${pattern.emoji}</span>
                        <span class="text-xs text-slate-400">${pattern.name}</span>
                    `;
                    patternBtn.onclick = () => openPatternModal(pattern);
                    content.appendChild(patternBtn);
                });

                // Toggle acorde√≥n
                header.onclick = () => {
                    const isOpen = !content.classList.contains('hidden');
                    // Cerrar todos
                    container.querySelectorAll('.accordion-content').forEach(c => c.classList.add('hidden'));
                    container.querySelectorAll('.accordion-icon').forEach(i => i.style.transform = 'rotate(0deg)');
                    // Abrir actual si estaba cerrado
                    if (!isOpen) {
                        content.classList.remove('hidden');
                        header.querySelector('.accordion-icon').style.transform = 'rotate(180deg)';
                    }
                };

                content.classList.add('accordion-content');
                catDiv.appendChild(header);
                catDiv.appendChild(content);
                container.appendChild(catDiv);
            }
        }

        function openPatternModal(pattern) {
            currentPattern = pattern;

            document.getElementById('pattern-modal-emoji').textContent = pattern.emoji;
            document.getElementById('pattern-modal-title').textContent = pattern.name;
            document.getElementById('pattern-modal-problem').textContent = pattern.problem;
            document.getElementById('pattern-modal-prompt').textContent = pattern.prompt;
            document.getElementById('pattern-modal-flowdesc').textContent = pattern.flowDesc;

            // Renderizar herramientas del flujo
            const flowContainer = document.getElementById('pattern-modal-flow');
            flowContainer.innerHTML = pattern.flow.map(toolId => {
                const tool = tools.find(t => t.id === toolId);
                if (!tool) return '';
                return `<span class="inline-flex items-center gap-1.5 bg-slate-800 border border-slate-700 px-2 py-1 rounded text-xs">
                    <i class="fa-solid ${tool.icon} ${tool.color}"></i>
                    <span class="text-slate-300">${tool.name}</span>
                </span>`;
            }).join('<span class="text-slate-600">‚Üí</span>');

            document.getElementById('pattern-modal').classList.remove('hidden');
        }

        function loadPatternToPrompt() {
            if (!currentPattern) return;

            // Copiar prompt al output
            document.getElementById('prompt-output').textContent = currentPattern.prompt;

            // Seleccionar herramientas del stack
            document.querySelectorAll('.tool-checkbox').forEach(cb => {
                const toolName = cb.value;
                const tool = tools.find(t => t.name === toolName);
                cb.checked = tool && currentPattern.flow.includes(tool.id);
            });

            closeModal('pattern-modal');

            // Notificaci√≥n
            addLog("SUCCESS", `Patr√≥n "${currentPattern.name}" cargado en Generador`);
        }

        function loadPatternToArchitect() {
            if (!currentPattern) return;

            // Limpiar canvas y cargar herramientas del patr√≥n
            canvasNodes = [];
            currentPattern.flow.forEach(toolId => {
                const tool = tools.find(t => t.id === toolId);
                if (tool) canvasNodes.push(tool);
            });
            renderCanvas();

            closeModal('pattern-modal');
            switchView('architect');

            // Notificaci√≥n
            addLog("SUCCESS", `Patr√≥n "${currentPattern.name}" cargado en Arquitecto Pro`);
        }

        // ============================================
        // FICHA T√âCNICA - FUNCIONES
        // ============================================
        let currentTool = null;

        function openToolModal(toolId) {
            const tool = tools.find(t => t.id === toolId);
            if (!tool) return;
            currentTool = tool;

            // Rellenar datos
            const iconEl = document.getElementById('tool-modal-icon');
            iconEl.className = `fa-solid ${tool.icon} ${tool.color} text-2xl`;
            document.getElementById('tool-modal-title').textContent = tool.name;
            document.getElementById('tool-modal-tag').textContent = `${tool.cat} ‚Ä¢ ${tool.tag}`;

            const statusEl = document.getElementById('tool-modal-status');
            statusEl.textContent = statusLabels[tool.status];
            statusEl.className = `status-badge status-${tool.status}`;

            document.getElementById('tool-modal-desc').textContent = tool.desc;
            document.getElementById('tool-modal-why').textContent = tool.why;
            document.getElementById('tool-modal-code').textContent = tool.code;

            // Renderizar casos de uso
            const casesContainer = document.getElementById('tool-modal-cases');
            casesContainer.innerHTML = tool.cases.map(c =>
                `<span class="bg-slate-800 border border-slate-700 text-slate-300 text-xs px-3 py-1.5 rounded-lg">${c}</span>`
            ).join('');

            document.getElementById('tool-modal').classList.remove('hidden');
        }

        function addToolToArchitect() {
            if (!currentTool) return;
            addNodeToCanvas(currentTool.id);
            closeModal('tool-modal');
            switchView('architect');
            addLog("SUCCESS", `"${currentTool.name}" a√±adido al Arquitecto`);
        }

        function copyToolCode() {
            if (!currentTool) return;
            navigator.clipboard.writeText(currentTool.code);
            addLog("SUCCESS", `C√≥digo de "${currentTool.name}" copiado`);
        }

        // ============================================
        // 6. BACKEND API CONNECTION
        // ============================================
        const API_URL = 'http://localhost:8000';

        // Health Check
        async function checkHealth() {
            try {
                const start = Date.now();
                const res = await fetch(`${API_URL}/api/health`);
                const latency = Date.now() - start;
                const data = await res.json();

                document.getElementById('health-metric').textContent = latency;
                document.getElementById('health-msg').textContent = `Online - v${data.version}`;
                document.getElementById('health-bar').style.width = Math.min(100, 100 - latency/5) + '%';
                document.getElementById('term-dot').classList.add('bg-green-500');
                document.getElementById('term-dot').classList.remove('bg-red-500/20');
                addLog("SUCCESS", `Backend conectado (${latency}ms)`);

                // Mostrar estado de m√≥dulos
                if (data.modules) {
                    addLog("INFO", `Knowledge: ${data.modules.knowledge ? '‚úì' : '‚úó'} | Scout: ${data.modules.scout ? '‚úì' : '‚úó'}`);
                }
            } catch (e) {
                document.getElementById('health-metric').textContent = '--';
                document.getElementById('health-msg').textContent = 'Backend offline';
                document.getElementById('health-bar').style.width = '0%';
                addLog("ERROR", "No se pudo conectar al backend. Ejecuta: ./start.sh");
            }
        }

        // Knowledge Base - B√∫squeda Sem√°ntica
        async function searchKnowledgeBase() {
            const query = document.getElementById('kb-search').value.trim();
            if (!query) return;

            const resultsDiv = document.getElementById('kb-results');
            resultsDiv.innerHTML = '<p class="text-slate-500 text-sm">Buscando...</p>';
            resultsDiv.classList.remove('hidden');

            try {
                const res = await fetch(`${API_URL}/api/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, limit: 5 })
                });
                const results = await res.json();

                if (results.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-slate-500 text-sm">No se encontraron resultados. ¬øHas indexado tus archivos?</p>';
                    return;
                }

                resultsDiv.innerHTML = results.map(r => `
                    <div class="bg-slate-950 border border-slate-800 rounded-lg p-3">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] text-slate-500 font-mono">${r.source.split('/').pop()}</span>
                            <span class="text-[10px] bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded">${Math.round(r.score * 100)}% match</span>
                        </div>
                        <p class="text-sm text-slate-300 leading-relaxed">${r.text.substring(0, 300)}${r.text.length > 300 ? '...' : ''}</p>
                    </div>
                `).join('');
                addLog("SUCCESS", `B√∫squeda: "${query}" ‚Üí ${results.length} resultados`);
            } catch (e) {
                resultsDiv.innerHTML = '<p class="text-red-400 text-sm">Error: Backend no disponible</p>';
                addLog("ERROR", "Knowledge Base no disponible");
            }
        }

        // Knowledge Base - Indexar
        async function indexKnowledgeBase() {
            addLog("INFO", "Indexando archivos markdown del Desktop...");
            try {
                const res = await fetch(`${API_URL}/api/index`, { method: 'POST' });
                const data = await res.json();
                addLog("SUCCESS", `Indexados ${data.indexed} chunks de ${data.path}`);
                alert(`Indexaci√≥n completada: ${data.indexed} fragmentos`);
            } catch (e) {
                addLog("ERROR", "Error al indexar");
            }
        }

        // Scout - Analizar Error
        async function analyzeWithScout() {
            const errorText = document.getElementById('scout-input').value.trim();
            if (!errorText) return alert("Pega un error para analizar");

            const btn = document.getElementById('scout-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analizando...';
            addLog("INFO", "Scout analizando error...");

            try {
                const res = await fetch(`${API_URL}/api/scout/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ error_text: errorText, context: "DirectOS / minerOS stack" })
                });
                const data = await res.json();

                // Mostrar resultado en terminal
                addLog("SUCCESS", "Scout encontr√≥ una soluci√≥n:");
                term.innerHTML += `<div class="terminal-line mt-2 p-3 bg-purple-500/10 border border-purple-500/30 rounded-lg"><pre class="text-purple-300 whitespace-pre-wrap">${data.analysis}</pre></div>`;
                term.scrollTop = term.scrollHeight;

            } catch (e) {
                addLog("ERROR", "Scout no disponible. ¬øConfiguraste ANTHROPIC_API_KEY?");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-magnifying-glass-chart"></i> Analizar Error';
            }
        }

        // Enter para buscar
        document.getElementById('kb-search')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchKnowledgeBase();
        });

        // Check health on load
        setTimeout(checkHealth, 1500);
        setInterval(checkHealth, 30000); // cada 30s

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        initPresets();
        initPatternsAccordion();
        initFlowsGallery();
        switchView('architect');
        renderCanvas();
    </script>
</body>
</html>